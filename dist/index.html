<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BambooClaw Companion</title>
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --card-bg: #1a1a2e;
            --accent-emerald: #00ff9d;
            --accent-emerald-dark: #00c47a;
            --text-primary: #e0e0ff;
            --text-secondary: #a0a0c0;
            --error: #ff4d6d;
            --success: #00ff9d;
            --warning: #ffcc00;
            --glass-bg: rgba(26, 26, 46, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--accent-emerald);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            color: var(--bg-dark);
        }

        .logo-text {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-emerald), #00b373);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .step.active .step-number {
            background: var(--accent-emerald);
            color: var(--bg-dark);
        }

        .step-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .step.active .step-label {
            color: var(--accent-emerald);
            font-weight: 600;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
        }

        .step:last-child::after {
            display: none;
        }

        .phase-content {
            display: none;
        }

        .phase-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .card-title {
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--accent-emerald);
        }

        .prerequisite-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .prerequisite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        .prerequisite-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .prerequisite-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 255, 157, 0.1);
        }

        .prerequisite-name {
            font-weight: 600;
        }

        .prerequisite-status {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-detected {
            background: var(--success);
        }

        .status-not-found {
            background: var(--error);
        }

        .status-error {
            background: var(--warning);
        }

        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-line {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-line:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: var(--text-secondary);
            margin-right: 10px;
        }

        .log-content {
            color: var(--text-primary);
        }

        .copy-button {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            float: right;
            transition: all 0.2s;
        }

        .copy-button:hover {
            background: rgba(0, 255, 157, 0.1);
            border-color: var(--accent-emerald);
        }

        .copy-button.copied {
            background: rgba(0, 255, 157, 0.2);
            border-color: var(--accent-emerald);
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--accent-emerald);
            color: var(--bg-dark);
        }

        .btn-primary:hover {
            background: var(--accent-emerald-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 157, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .hidden {
            display: none;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-radius: 12px 12px 0 0;
            background: rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--card-bg);
            color: var(--accent-emerald);
            border-bottom: 2px solid var(--accent-emerald);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-emerald);
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-running {
            background: rgba(0, 255, 157, 0.15);
            color: var(--success);
        }

        .status-stopped {
            background: rgba(255, 77, 109, 0.15);
            color: var(--error);
        }

        .chat-container {
            height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 12px;
            max-width: 80%;
        }

        .user-message {
            background: rgba(0, 255, 157, 0.1);
            margin-left: auto;
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.05);
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
        }

        .error-message {
            color: var(--error);
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">BC</div>
                <div class="logo-text">BambooClaw</div>
            </div>
            <div class="user-info">
                <span>Admin</span>
            </div>
        </header>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-label">System Check</div>
            </div>
            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-label">Install Prerequisites</div>
            </div>
            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-label">Install BambooClaw</div>
            </div>
            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-label">Finalization</div>
            </div>
        </div>

        <!-- Installer Wizard -->
        <div id="installer" class="phase-content active">
            <!-- Step 1: System Check -->
            <div id="step1-content" class="card">
                <h2 class="card-title">System Check</h2>
                <p>Checking your system for required dependencies and prerequisites...</p>
                
                <div class="prerequisite-grid" id="prerequisites-list">
                    <!-- Prerequisite items will be added here dynamically -->
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="back-btn1" disabled>Back</button>
                    <button class="btn btn-primary" id="next-btn1" disabled>Next</button>
                </div>
            </div>

            <!-- Step 2: Install Prerequisites -->
            <div id="step2-content" class="card hidden">
                <h2 class="card-title">Install Prerequisites</h2>
                <p id="install-ops">Installing prerequisites for your system...</p>
                
                <div class="log-container">
                    <div class="log-header">
                        <button class="copy-button" id="copy-log-btn2">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 4h4v4m0-4H8a4 4 0 0 0 0 8h4m0 0h4m0 0v4m0-4v-4m0 0H8m0 0v-4"></path>
                            </svg>
                            Copy Log
                        </button>
                    </div>
                    <div id="install-log2" class="log-content">
                        <!-- Log lines will be added here dynamically -->
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="back-btn2">Back</button>
                    <button class="btn btn-primary" id="next-btn2">Next</button>
                </div>
            </div>

            <!-- Step 3: Install BambooClaw -->
            <div id="step3-content" class="card hidden">
                <h2 class="card-title">Install BambooClaw</h2>
                <p id="install-type">Downloading and installing BambooClaw...</p>
                
                <div class="log-container">
                    <div class="log-header">
                        <button class="copy-button" id="copy-log-btn3">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 4h4v4m0-4H8a4 4 0 0 0 0 8h4m0 0h4m0 0v4m0-4v-4m0 0H8m0 0v-4"></path>
                            </svg>
                            Copy Log
                        </button>
                    </div>
                    <div id="install-log3" class="log-content">
                        <!-- Log lines will be added here dynamically -->
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="back-btn3">Back</button>
                    <button class="btn btn-primary" id="next-btn3">Next</button>
                </div>
            </div>

            <!-- Step 4: Finalization -->
            <div id="step4-content" class="card hidden">
                <h2 class="card-title">Finalization</h2>
                <p>Installing BambooClaw to your system. This may take a few minutes...</p>
                
                <div class="log-container">
                    <div class="log-header">
                        <button class="copy-button" id="copy-log-btn4">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 4h4v4m0-4H8a4 4 0 0 0 0 8h4m0 0h4m0 0v4m0-4v-4m0 0H8m0 0v-4"></path>
                            </svg>
                            Copy Log
                        </button>
                    </div>
                    <div id="install-log4" class="log-content">
                        <!-- Log lines will be added here dynamically -->
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-secondary" id="back-btn4" disabled>Back</button>
                    <button class="btn btn-primary" id="finish-btn">Finish</button>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <div class="tabs">
                <div class="tab active" data-tab="llm">LLM Configuration</div>
                <div class="tab" data-tab="channel">Channel Setup</div>
                <div class="tab" data-tab="agent">Agent Control</div>
                <div class="tab" data-tab="settings">Settings</div>
            </div>

            <!-- LLM Configuration Tab -->
            <div class="tab-content active" id="tab-llm">
                <div class="card">
                    <h2 class="card-title">LLM Configuration</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="provider">Provider</label>
                            <select class="form-control" id="provider">
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="google">Google Gemini</option>
                                <option value="openrouter">OpenRouter</option>
                                <option value="ollama">Ollama</option>
                                <option value="deepseek">DeepSeek</option>
                                <option value="groq">Groq</option>
                                <option value="mistral">Mistral</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="model">Model</label>
                            <select class="form-control" id="model">
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-3.5">GPT-3.5</option>
                                <option value="claude-2">Claude 2</option>
                                <option value="gemini-pro">Gemini Pro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="api-key">API Key</label>
                        <input type="password" class="form-control" id="api-key" placeholder="Enter your API key">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="memory-backend">Memory Backend</label>
                            <select class="form-control" id="memory-backend">
                                <option value="sqlite">SQLite</option>
                                <option value="redis">Redis</option>
                                <option value="postgres">PostgreSQL</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="autonomy-level">Autonomy Level</label>
                            <select class="form-control" id="autonomy-level">
                                <option value="minimal">Minimal</option>
                                <option value="balanced">Balanced</option>
                                <option value="aggressive">Aggressive</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="save-llm-btn">Save Configuration</button>
                    <button class="btn btn-secondary" id="test-llm-btn">Test Connection</button>
                </div>
            </div>

            <!-- Channel Setup Tab -->
            <div class="tab-content" id="tab-channel">
                <div class="card">
                    <h2 class="card-title">Channel Setup</h2>
                    <p>Set up communication channels for your BambooClaw agent.</p>
                    
                    <div class="form-group">
                        <label>Telegram Integration</label>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <input type="text" class="form-control" id="telegram-token" placeholder="Enter Bot Token">
                            </div>
                            <button class="btn btn-secondary">Test Channel</button>
                        </div>
                        <small>Get a token from @BotFather on Telegram</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Discord Integration</label>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <input type="text" class="form-control" id="discord-token" placeholder="Enter Bot Token">
                            </div>
                            <button class="btn btn-secondary">Test Channel</button>
                        </div>
                        <small>Get a token from Discord Developer Portal</small>
                    </div>
                    
                    <div class="form-group">
                        <label>WhatsApp Business API</label>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <input type="text" class="form-control" id="whatsapp-token" placeholder="Enter API Key">
                            </div>
                            <button class="btn btn-secondary">Test Channel</button>
                        </div>
                        <small>Set up via WhatsApp Business Cloud API</small>
                    </div>
                </div>
            </div>

            <!-- Agent Control Tab -->
            <div class="tab-content" id="tab-agent">
                <div class="card">
                    <h2 class="card-title">Agent Control</h2>
                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span>Agent Status: </span>
                            <span class="status-badge status-running">Running</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <button class="btn btn-primary" id="start-agent-btn">Start Agent</button>
                            <button class="btn btn-secondary" id="stop-agent-btn">Stop Agent</button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-secondary">View Logs</button>
                            <button class="btn btn-secondary">Diagnostics</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="card-title">Chat Interface</h2>
                    <div class="chat-container">
                        <div class="chat-message user-message">Hello, BambooClaw! How can I help you today?</div>
                        <div class="chat-message ai-message">Hello! I'm ready to assist you. What would you like to discuss?</div>
                    </div>
                    <div class="chat-input">
                        <input type="text" class="form-control" placeholder="Type your message...">
                        <button class="btn btn-primary">Send</button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="tab-settings">
                <div class="card">
                    <h2 class="card-title">Advanced Settings</h2>
                    <div class="form-group">
                        <label for="runtime-adapter">Runtime Adapter</label>
                        <select class="form-control" id="runtime-adapter">
                            <option value="default">Default</option>
                            <option value="docker">Docker</option>
                            <option value="podman">Podman</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gateway-port">Gateway Port</label>
                        <input type="text" class="form-control" id="gateway-port" value="8080">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="identity-format">Identity Format</label>
                            <select class="form-control" id="identity-format">
                                <option value="uuid">UUID</option>
                                <option value="hash">Hash</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="security">Security Level</label>
                            <select class="form-control" id="security">
                                <option value="standard">Standard</option>
                                <option value="high">High</option>
                                <option value="maximum">Maximum</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="save-settings-btn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let detectedOS = "unknown";
        let installLog2 = [];
        let installLog3 = [];
        let installLog4 = [];
        let currentStep = 1;

        // DOM elements
        const stepIndicators = document.querySelectorAll('.step');
        const phaseContents = document.querySelectorAll('.phase-content');
        const tabElements = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Utility functions
        function invokeWithTimeout(cmd, args = {}, timeoutMs = 8000) {
            return Promise.race([
                window.__TAURI__.invoke(cmd, args),
                new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout: " + cmd)), timeoutMs))
            ]);
        }

        function addLogLine(logContainer, message, type = 'info') {
            const timestamp = new Date().toISOString().slice(11, 23);
            const logLine = document.createElement('div');
            logLine.className = 'log-line';
            logLine.innerHTML = `
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-content ${type}">${message}</span>
            `;
            logContainer.appendChild(logLine);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStep(stepNumber) {
            // Update step indicators
            stepIndicators.forEach((step, index) => {
                if (index + 1 === stepNumber) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
            
            // Update phase content
            phaseContents.forEach((content, index) => {
                if (index + 1 === stepNumber) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            currentStep = stepNumber;
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if BambooClaw is already installed
            try {
                const config = await invokeWithTimeout("read_config");
                if (config && config.installed) {
                    document.getElementById('installer').classList.remove('active');
                    document.getElementById('dashboard').classList.add('active');
                    return;
                }
            } catch (err) {
                console.error("Error checking installation status:", err);
            }
            
            // Start installer wizard
            setupEventListeners();
            await initializeSystemCheck();
        });

        // Event listeners
        function setupEventListeners() {
            // Step navigation
            document.getElementById('next-btn1').addEventListener('click', nextStep1);
            document.getElementById('back-btn1').addEventListener('click', () => updateStep(1));
            document.getElementById('next-btn2').addEventListener('click', nextStep2);
            document.getElementById('back-btn2').addEventListener('click', () => updateStep(2));
            document.getElementById('next-btn3').addEventListener('click', nextStep3);
            document.getElementById('back-btn3').addEventListener('click', () => updateStep(3));
            document.getElementById('finish-btn').addEventListener('click', finishInstallation);
            document.getElementById('back-btn4').addEventListener('click', () => updateStep(4));
            
            // Tab switching
            tabElements.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    tabElements.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show active content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `tab-${tabId}`) {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // Copy log buttons
            document.getElementById('copy-log-btn2').addEventListener('click', () => copyLog(installLog2));
            document.getElementById('copy-log-btn3').addEventListener('click', () => copyLog(installLog3));
            document.getElementById('copy-log-btn4').addEventListener('click', () => copyLog(installLog4));
            
            // Buttons in dashboard
            document.getElementById('save-llm-btn').addEventListener('click', saveLLMConfig);
            document.getElementById('test-llm-btn').addEventListener('click', testLLMConnection);
            document.getElementById('start-agent-btn').addEventListener('click', startAgent);
            document.getElementById('stop-agent-btn').addEventListener('click', stopAgent);
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
        }

        // System Check Step
        async function initializeSystemCheck() {
            try {
                const platform = await invokeWithTimeout("get_platform");
                detectedOS = platform || "windows";
                addLogLine(document.getElementById('install-log2'), `Detected OS: ${detectedOS}`);
                updateNextButton(1, true);
                
                // Check prerequisites
                const checks = [
                    { name: "rustc", displayName: "Rust Compiler" },
                    { name: "cargo", displayName: "Cargo Package Manager" },
                    { name: "build-essential", displayName: "Build Essentials" },
                    { name: "docker", displayName: "Docker" }
                ];
                
                const promises = checks.map(check => checkPrerequisite(check.name, check.displayName));
                await Promise.allSettled(promises);
                
            } catch (err) {
                const msg = err?.message || err?.toString() || "Unknown error";
                console.error("Error in system check:", err);
                addLogLine(document.getElementById('install-log2'), `Error: ${msg}`, 'error');
            }
        }

        async function checkPrerequisite(name, displayName) {
            try {
                const result = await invokeWithTimeout("check_prerequisite", { name: name });
                const statusIndicator = document.querySelector(`[data-prereq="${name}"] .status-indicator`);
                const statusText = document.querySelector(`[data-prereq="${name}"] .status-text`);
                
                if (result) {
                    statusIndicator.className = 'status-indicator status-detected';
                    statusText.textContent = result.version || 'Detected';
                    addLogLine(document.getElementById('install-log2'), `✓ ${displayName}: ${result.version || 'Installed'}`);
                } else {
                    statusIndicator.className = 'status-indicator status-not-found';
                    statusText.textContent = 'Not Found';
                    addLogLine(document.getElementById('install-log2'), `✗ ${displayName}: Not Found`, 'error');
                }
            } catch (err) {
                const msg = err?.message || err?.toString() || "Unknown error";
                console.error(`Error checking ${name}:`, err);
                addLogLine(document.getElementById('install-log2'), `✗ ${displayName}: ${msg}`, 'error');
                const statusIndicator = document.querySelector(`[data-prereq="${name}"] .status-indicator`);
                const statusText = document.querySelector(`[data-prereq="${name}"] .status-text`);
                if (statusIndicator) {
                    statusIndicator.className = 'status-indicator status-error';
                    statusText.textContent = 'Error';
                }
            }
        }

        // Navigation between steps
        async function nextStep1() {
            updateStep(2);
            await installPrerequisites();
        }

        async function installPrerequisites() {
            try {
                const installOps = document.getElementById('install-ops');
                const logContainer = document.getElementById('install-log2');
                
                addLogLine(logContainer, `Starting installation on ${detectedOS}...`);
                
                switch(detectedOS) {
                    case 'windows':
                        installOps.textContent = 'Installing Windows prerequisites (Visual Studio Build Tools)...';
                        await invokeWithTimeout("run_shell_command", { commandName: "winget", args: ["install", "--id", "Microsoft.VisualStudio.2022.BuildTools", "--source", "winget"] });
                        addLogLine(logContainer, '✓ Visual Studio Build Tools installed');
                        await invokeWithTimeout("run_shell_command", { commandName: "winget", args: ["install", "--id", "Rustlang.Rust", "--source", "winget"] });
                        addLogLine(logContainer, '✓ Rust installed');
                        break;
                    case 'macos':
                        installOps.textContent = 'Installing macOS prerequisites (Xcode Command Line Tools + Rust)...';
                        await invokeWithTimeout("run_shell_command", { commandName: "xcode-select", args: ["--install"] });
                        addLogLine(logContainer, '✓ Xcode Command Line Tools installed');
                        await invokeWithTimeout("run_shell_command", { commandName: "curl", args: ["--proto", "=https", "--tlsv1.2", "-sSf", "https://sh.rustup.rs", "-o", "rustup.sh"] });
                        await invokeWithTimeout("run_shell_command", { commandName: "sh", args: ["rustup.sh", "-y"] });
                        addLogLine(logContainer, '✓ Rust installed via rustup');
                        break;
                    case 'linux':
                        installOps.textContent = 'Installing Linux prerequisites (build-essential + Rust)...';
                        await invokeWithTimeout("run_shell_command", { commandName: "apt", args: ["update"] });
                        await invokeWithTimeout("run_shell_command", { commandName: "apt", args: ["install", "-y", "build-essential"] });
                        addLogLine(logContainer, '✓ build-essential installed');
                        await invokeWithTimeout("run_shell_command", { commandName: "curl", args: ["--proto", "=https", "--tlsv1.2", "-sSf", "https://sh.rustup.rs", "-o", "rustup.sh"] });
                        await invokeWithTimeout("run_shell_command", { commandName: "sh", args: ["rustup.sh", "-y"] });
                        addLogLine(logContainer, '✓ Rust installed via rustup');
                        break;
                    default:
                        addLogLine(logContainer, `⚠ Unknown OS: ${detectedOS}. Proceeding with default installation...`);
                        // Default to Windows installation as fallback
                        await invokeWithTimeout("run_shell_command", { commandName: "winget", args: ["install", "--id", "Microsoft.VisualStudio.2022.BuildTools", "--source", "winget"] });
                        await invokeWithTimeout("run_shell_command", { commandName: "winget", args: ["install", "--id", "Rustlang.Rust", "--source", "winget"] });
                }
                
                addLogLine(logContainer, '✓ All prerequisites installed successfully');
                installLog2 = []; // Clear logs for next step
                updateNextButton(2, true);
                
            } catch (err) {
                const msg = err?.message || err?.toString() || "Unknown error";
                console.error("Error installing prerequisites:", err);
                addLogLine(document.getElementById('install-log2'), `✗ Error installing prerequisites: ${msg}`, 'error');
            }
        }

        function nextStep2() {
            updateStep(3);
            installBambooClaw();
        }

        async function installBambooClaw() {
            try {
                const logContainer = document.getElementById('install-log3');
                const installType = document.getElementById('install-type');
                
                addLogLine(logContainer, 'Starting installation of BambooClaw...');
                
                // Use pre-built binary approach - in a real app, we'd have a binary download URL
                await invokeWithTimeout("download_binary", { url: "https://example.com/bambooclaw-binary", dest: "bambooclaw" });
                addLogLine(logContainer, '✓ Binary downloaded successfully');
                
                // Verify installation
                const version = await invokeWithTimeout("run_bambooclaw", { args: ["--version"] });
                addLogLine(logContainer, `✓ BambooClaw installed: ${version}`);
                
                installLog3 = []; // Clear logs for next step
                updateNextButton(3, true);
                
            } catch (err) {
                const msg = err?.message || err?.toString() || "Unknown error";
                console.error("Error installing BambooClaw:", err);
                addLogLine(document.getElementById('install-log3'), `✗ Error installing BambooClaw: ${msg}`, 'error');
            }
        }

        function nextStep3() {
            updateStep(4);
            finalizeInstallation();
        }

        async function finalizeInstallation() {
            try {
                const logContainer = document.getElementById('install-log4');
                
                addLogLine(logContainer, 'Finalizing installation...');
                addLogLine(logContainer, 'Saving configuration...');
                await invokeWithTimeout("write_config", { content: JSON.stringify({ installed: true }) });
                addLogLine(logContainer, '✓ Configuration saved');
                
                addLogLine(logContainer, 'Starting BambooClaw daemon...');
                await invokeWithTimeout("start_daemon");
                addLogLine(logContainer, '✓ Daemon started');
                
                addLogLine(logContainer, 'Installation complete!');
                
                installLog4 = []; // Clear logs for next step
                updateNextButton(4, true);
                
            } catch (err) {
                const msg = err?.message || err?.toString() || "Unknown error";
                console.error("Error during finalization:", err);
                addLogLine(document.getElementById('install-log4'), `✗ Error during finalization: ${msg}`, 'error');
            }
        }

        function finishInstallation() {
            // Show dashboard
            document.getElementById('installer').classList.remove('active');
            document.getElementById('dashboard').classList.add('active');
            
            // Optionally save state to localStorage
            localStorage.setItem('bambooclaw-installed', 'true');
        }

        function updateNextButton(step, enabled) {
            const nextBtn = document.getElementById(`next-btn${step}`);
            if (nextBtn) {
                nextBtn.disabled = !enabled;
            }
        }

        // Dashboard functions
        async function saveLLMConfig() {
            try {
                const provider = document.getElementById('provider').value;
                const model = document.getElementById('model').value;
                const apiKey = document.getElementById('api-key').value;
                const memoryBackend = document.getElementById('memory-backend').value;
                const autonomyLevel = document.getElementById('autonomy-level').value;
                
                // In a real app, this would send the config to the backend
                console.log('Saving LLM config:', { provider, model, apiKey, memoryBackend, autonomyLevel });
                
                addLogLine(document.getElementById('install-log2'), 'LLM Configuration saved successfully');
            } catch (err) {
                console.error('Error saving LLM config:', err);
                addLogLine(document.getElementById('install-log2'), `Error saving config: ${err.message}`, 'error');
            }
        }

        async function testLLMConnection() {
            try {
                addLogLine(document.getElementById('install-log3'), 'Testing LLM connection...');
                await invokeWithTimeout("run_bambooclaw", { args: ["agent", "-m", "ping"] });
                addLogLine(document.getElementById('install-log3'), '✓ LLM connection successful');
            } catch (err) {
                const msg = err?.message || err?.toString() || "Unknown error";
                console.error('Error testing LLM connection:', err);
                addLogLine(document.getElementById('install-log3'), `✗ Error testing connection: ${msg}`, 'error');
            }
        }

        async function startAgent() {
            try {
                addLogLine(document.getElementById('install-log4'), 'Starting BambooClaw agent...');
                await invokeWithTimeout("start_daemon");
                addLogLine(document.getElementById('install-log4'), '✓ Agent started');
            } catch (err) {
                const msg = err?.message || err?.toString() || "Unknown error";
                console.error('Error starting agent:', err);
                addLogLine(document.getElementById('install-log4'), `✗ Error starting agent: ${msg}`, 'error');
            }
        }

        async function stopAgent() {
            try {
                addLogLine(document.getElementById('install-log4'), 'Stopping BambooClaw agent...');
                await invokeWithTimeout("stop_daemon");
                addLogLine(document.getElementById('install-log4'), '✓ Agent stopped');
            } catch (err) {
                const msg = err?.message || err?.toString() || "Unknown error";
                console.error('Error stopping agent:', err);
                addLogLine(document.getElementById('install-log4'), `✗ Error stopping agent: ${msg}`, 'error');
            }
        }

        async function saveSettings() {
            try {
                const runtimeAdapter = document.getElementById('runtime-adapter').value;
                const gatewayPort = document.getElementById('gateway-port').value;
                const identityFormat = document.getElementById('identity-format').value;
                const security = document.getElementById('security').value;
                
                console.log('Saving settings:', { runtimeAdapter, gatewayPort, identityFormat, security });
                addLogLine(document.getElementById('install-log4'), 'Settings saved successfully');
            } catch (err) {
                const msg = err?.message || err?.toString() || "Unknown error";
                console.error('Error saving settings:', err);
                addLogLine(document.getElementById('install-log4'), `✗ Error saving settings: ${msg}`, 'error');
            }
        }

        function copyLog(logArray) {
            const logText = logArray.join('\n');
            navigator.clipboard.writeText(logText)
                .then(() => {
                    const button = event.target.closest('.copy-button');
                    button.classList.add('copied');
                    button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L17 7"></path></svg>Copied!';
                    setTimeout(() => {
                        button.classList.remove('copied');
                        button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h4v4m0-4H8a4 4 0 0 0 0 8h4m0 0h4m0 0v4m0-4v-4m0 0H8m0 0v-4"></path></svg>Copy Log';
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy log:', err);
                });
        }
    </script>
</body>
</html>