<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BambooClaw Companion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f;
            --card: #12121e;
            --accent: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.2);
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --border: #1e293b;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        /* Layout */
        #app { display: flex; flex-direction: column; height: 100vh; }
        header { 
            padding: 1.5rem 2rem; 
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        .logo { font-weight: 800; font-size: 1.25rem; letter-spacing: -0.025em; color: var(--accent); }
        
        main { flex: 1; overflow-y: auto; padding: 2rem; position: relative; }

        /* Wizard & Dashboard UI */
        .container { max-width: 800px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* Step Indicator */
        .steps { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .step-dot { flex: 1; height: 4px; background: var(--border); border-radius: 2px; transition: 0.3s; }
        .step-dot.active { background: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        /* Cards */
        .glass-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
        p.subtitle { color: var(--text-dim); margin-bottom: 2rem; }

        /* List Rows */
        .check-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .status-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; }
        .status-detecting { color: var(--text-dim); }
        .status-found { color: var(--accent); }
        .status-not-installed { color: var(--warning); background: rgba(245, 158, 11, 0.1); }
        .status-error { color: var(--error); }

        /* Log Panel */
        .log-container {
            margin-top: 1.5rem;
            position: relative;
            background: #050507;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #1a1a2e;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        #install-log {
            height: 250px;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .copy-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 4px;
        }
        .copy-btn:hover { color: var(--accent); }

        /* Buttons */
        .btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--accent); }

        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 2rem; }
        .tab { padding: 1rem 2rem; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* Forms */
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; color: var(--text-dim); font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            background: #050507;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.75rem;
            border-radius: 6px;
            outline: none;
        }
        input:focus { border-color: var(--accent); }

        /* Animations */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div class="logo">BAMBOOCLAW COMPANION</div>
        <div id="app-status" class="status-badge status-found">v1.0.0-stable</div>
    </header>

    <main>
        <div id="wizard" class="container">
            <div class="steps">
                <div class="step-dot active" id="dot-1"></div>
                <div class="step-dot" id="dot-2"></div>
                <div class="step-dot" id="dot-3"></div>
                <div class="step-dot" id="dot-4"></div>
            </div>

            <!-- STEP 1: System Check -->
            <section id="step-1" class="glass-card">
                <h1>Environment Audit</h1>
                <p class="subtitle">Ensuring your system is prepared for BambooClaw edge deployment.</p>
                <div id="check-list">
                    <div class="check-row"><span>Operating System</span><span id="os-status" class="status-badge status-detecting">Detecting...</span></div>
                    <div class="check-row"><span>Rust Toolchain</span><span id="rust-status" class="status-badge status-detecting">Detecting...</span></div>
                    <div class="check-row"><span>Git CLI</span><span id="git-status" class="status-badge status-detecting">Detecting...</span></div>
                    <div class="check-row"><span>Build Tools</span><span id="build-status" class="status-badge status-detecting">Detecting...</span></div>
                </div>
                <div style="margin-top:2rem; text-align:right;">
                    <button class="btn" id="btn-next-1" disabled onclick="navTo(2)">Initialize Environment &rarr;</button>
                </div>
            </section>

            <!-- STEP 2: Prerequisite Installation -->
            <section id="step-2" class="glass-card hidden">
                <h1>Readying Prereqs</h1>
                <p class="subtitle">Applying required system dependencies and development toolchains.</p>
                <div class="log-container">
                    <div class="log-header">
                        <span>SYSTEM INSTALLATION LOG</span>
                        <button class="copy-btn" onclick="copyLog('install-log')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                    <div id="install-log"></div>
                </div>
                <div style="margin-top:2rem; display:flex; justify-content:space-between; align-items:center;">
                    <div id="step2-spinner" class="spinner hidden" style="color:var(--accent)">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                    </div>
                    <button class="btn" id="btn-next-2" disabled onclick="navTo(3)">Deploy Core Agent &rarr;</button>
                </div>
            </section>

            <!-- STEP 3: BambooClaw Install -->
            <section id="step-3" class="glass-card hidden">
                <h1>Deploy BambooClaw</h1>
                <div class="form-group">
                    <label>Installation Method</label>
                    <div style="display:flex; gap:1rem;">
                        <button class="btn" id="method-binary" onclick="setMethod('binary')">Pre-built Binary (Fastest)</button>
                        <button class="btn btn-outline" id="method-source" onclick="setMethod('source')">Build from Source</button>
                    </div>
                </div>
                <div class="log-container">
                    <div class="log-header">
                        <span>DEPLOYMENT LOG</span>
                        <button class="copy-btn" onclick="copyLog('deploy-log')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                    <div id="deploy-log"></div>
                </div>
                <div style="margin-top:2rem; text-align:right;">
                    <button class="btn" id="btn-start-deploy" onclick="runDeployment()">Begin Deployment</button>
                    <button class="btn hidden" id="btn-next-3" onclick="navTo(4)">Finalize &rarr;</button>
                </div>
            </section>

            <!-- STEP 4: Finalization -->
            <section id="step-4" class="glass-card hidden" style="text-align:center;">
                <div style="color:var(--accent); font-size:4rem; margin-bottom:1rem;">âœ“</div>
                <h1>Installation Complete</h1>
                <p class="subtitle">BambooClaw is now registered as a system service.</p>
                <div class="form-group" style="text-align:left;">
                    <label>Storage Path</label>
                    <input type="text" id="final-path" readonly value="~/.bambooclaw/bin">
                </div>
                <button class="btn" style="width:100%" onclick="enterDashboard()">Enter Companion Dashboard</button>
            </section>
        </div>

        <!-- DASHBOARD (Hidden during install) -->
        <div id="dashboard" class="container hidden">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('llm')">LLM Settings</div>
                <div class="tab" onclick="switchTab('channels')">Channels</div>
                <div class="tab" onclick="switchTab('control')">Agent Control</div>
                <div class="tab" onclick="switchTab('settings')">Settings</div>
            </div>

            <div id="tab-llm" class="tab-content">
                <div class="glass-card">
                    <div class="form-group">
                        <label>AI Provider</label>
                        <select id="config-provider">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="groq">Groq (Ultra-Fast)</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="ollama">Ollama (Local)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Secret API Key</label>
                        <input type="password" id="config-key" placeholder="sk-...">
                    </div>
                    <button class="btn" onclick="saveConfig()">Apply Configuration</button>
                </div>
            </div>
            
            <div id="tab-control" class="tab-content hidden">
                <div class="glass-card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3>Daemon Status</h3>
                        <p id="daemon-status-text" class="status-detecting">Service Stopped</p>
                    </div>
                    <button id="daemon-toggle" class="btn" onclick="toggleDaemon()">Start Agent Daemon</button>
                </div>
            </div>

            <div id="tab-channels" class="tab-content hidden">
                <div class="glass-card">
                    <h3>Active Channels</h3>
                    <p class="subtitle">Connect your agent to external messaging platforms.</p>
                    <!-- Simulated List -->
                    <div class="check-row"><span>Telegram Bot</span><button class="btn btn-outline">Setup</button></div>
                    <div class="check-row"><span>Discord App</span><button class="btn btn-outline">Setup</button></div>
                </div>
            </div>

            <div id="tab-settings" class="tab-content hidden">
                 <div class="glass-card">
                    <div class="form-group">
                        <label>Autonomy Level</label>
                        <select>
                            <option>Observation Only</option>
                            <option>Collaborative (Needs Approval)</option>
                            <option selected>Full Autonomy</option>
                        </select>
                    </div>
                    <p class="subtitle">Security levels determine which shell commands the agent can run without explicit user consent.</p>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    // Constants & Global State
    let detectedOS = "windows";
    let installMethod = "binary";
    const PROXY_URL = "https://mjmdhqglpratbyzmgndm.supabase.co/functions/v1/github-release-proxy";
    const LONG_TIMEOUT = 600000;
    const SHORT_TIMEOUT = 8000;

    // Timeout Wrapper
    async function invokeWithTimeout(cmd, args = {}, timeoutMs = SHORT_TIMEOUT) {
        return Promise.race([
            window.__TAURI__.invoke(cmd, args),
            new Promise((_, reject) => setTimeout(() => reject(new Error(`Timeout: ${cmd} after ${timeoutMs}ms`)), timeoutMs))
        ]);
    }

    // Step 1: Logic
    async function runPrerequisiteChecks() {
        const statuses = {
            os: document.getElementById('os-status'),
            rust: document.getElementById('rust-status'),
            git: document.getElementById('git-status'),
            build: document.getElementById('build-status')
        };

        // Determine OS
        try {
            detectedOS = await invokeWithTimeout("get_platform");
            statuses.os.textContent = detectedOS;
            statuses.os.className = "status-badge status-found";
        } catch (e) {
            console.error("OS detection failed", e);
            detectedOS = "windows"; // Fallback
            statuses.os.textContent = "windows (fallback)";
        }

        const checks = [
            { id: 'rust', name: 'rustc' },
            { id: 'git', name: 'git' },
            { id: 'build', name: (detectedOS === "windows" ? "cl" : "make") }
        ];

        let completedChecks = 0;
        checks.forEach(async check => {
            try {
                const version = await invokeWithTimeout("check_prerequisite", { name: check.name });
                statuses[check.id].textContent = version || "Found";
                statuses[check.id].className = "status-badge status-found";
                statuses[check.id].setAttribute('data-installed', 'true');
            } catch (err) {
                const msg = err?.message || err?.toString() || "";
                if (msg.toLowerCase().includes("not found") || msg.includes("Timeout")) {
                    statuses[check.id].textContent = "Not Installed";
                    statuses[check.id].className = "status-badge status-not-installed";
                } else {
                    statuses[check.id].textContent = "Error";
                    statuses[check.id].className = "status-badge status-error";
                }
                statuses[check.id].setAttribute('data-installed', 'false');
            } finally {
                completedChecks++;
                if (completedChecks === checks.length) {
                    document.getElementById('btn-next-1').disabled = false;
                }
            }
        });
    }

    // Step 2: Logic
    async function runPrereqInstallation() {
        const log = document.getElementById('install-log');
        const nextBtn = document.getElementById('btn-next-2');
        const spinner = document.getElementById('step2-spinner');
        
        function addLog(text, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'var(--error)' : (type === 'skip' ? 'var(--warning)' : 'var(--text)');
            log.innerHTML += `<div style="color:${color}">[${time}] ${text}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        spinner.classList.remove('hidden');
        addLog(`Detected Environment: ${detectedOS.toUpperCase()}`);

        const installQueue = [];
        const rustInstalled = document.getElementById('rust-status').getAttribute('data-installed') === 'true';

        if (detectedOS === "windows") {
            if (!rustInstalled) {
                installQueue.push({ 
                    name: "Rust via Winget", 
                    cmd: "winget", 
                    args: ["install", "--id", "Rustlang.Rustup", "--silent", "--accept-package-agreements"] 
                });
            }
            installQueue.push({ 
                name: "VS Build Tools", 
                cmd: "winget", 
                args: ["install", "--id", "Microsoft.VisualStudio.2022.BuildTools", "--silent", "--override", "--wait --add Microsoft.VisualStudio.Workload.VCTools ; --includeRecommended"] 
            });
        } else if (detectedOS === "macos") {
            installQueue.push({ name: "Xcode Select", cmd: "xcode-select", args: ["--install"] });
            if (!rustInstalled) installQueue.push({ name: "Rustup", cmd: "sh", args: ["-c", "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y"] });
        }

        for (const item of installQueue) {
            addLog(`Executing Task: ${item.name}...`);
            try {
                const output = await invokeWithTimeout("run_shell_command", { 
                    commandName: item.cmd, 
                    args: item.args 
                }, LONG_TIMEOUT);
                addLog(`Success: ${item.name}`);
                if (output) addLog(`Output: ${output.substring(0, 200)}...`);
            } catch (err) {
                addLog(`Warning: ${item.name} failed. Error: ${err}`, 'error');
            }
        }

        addLog(`[DONE] Prerequisite phase complete.`, 'skip');
        spinner.classList.add('hidden');
        nextBtn.disabled = false;
    }

    // Step 3: Logic
    function setMethod(m) {
        installMethod = m;
        document.getElementById('method-binary').className = m === 'binary' ? 'btn' : 'btn btn-outline';
        document.getElementById('method-source').className = m === 'source' ? 'btn' : 'btn btn-outline';
    }

    async function runDeployment() {
        const log = document.getElementById('deploy-log');
        const startBtn = document.getElementById('btn-start-deploy');
        startBtn.disabled = true;

        function addLog(text) {
            log.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${text}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        try {
            if (installMethod === 'binary') {
                addLog("Fetching release metadata from proxy...");
                const res = await fetch(PROXY_URL);
                const data = await res.json();
                
                let ext = detectedOS === 'windows' ? '.exe' : (detectedOS === 'macos' ? '.dmg' : '.AppImage');
                const asset = data.assets.find(a => a.name.endsWith(ext));
                
                if (!asset) throw new Error(`No compatible asset found for ${ext}`);
                
                const home = await invokeWithTimeout("run_shell_command", { 
                    commandName: detectedOS === 'windows' ? 'cmd' : 'sh', 
                    args: detectedOS === 'windows' ? ["/C", "echo %USERPROFILE%"] : ["-c", "echo $HOME"] 
                });
                
                const filename = detectedOS === 'windows' ? 'bambooclaw.exe' : 'bambooclaw';
                const dest = `${home.trim()}/.bambooclaw/${filename}`;

                addLog(`Downloading ${asset.name} to ${dest}...`);
                await invokeWithTimeout("download_binary", {
                    url: `${PROXY_URL}?asset=${asset.name}`,
                    dest: dest
                }, LONG_TIMEOUT);

                addLog("Deployment complete.");
            } else {
                addLog("Initializing source build (this will take several minutes)...");
                // Using full path trick for Windows
                const cmd = detectedOS === 'windows' ? 'cmd' : 'cargo';
                const args = detectedOS === 'windows' 
                    ? ["/C", "%USERPROFILE%\\.cargo\\bin\\cargo install --git https://github.com/Enigmara-Technologies/bambooclaw-core --force"]
                    : ["install", "--git", "https://github.com/Enigmara-Technologies/bambooclaw-core"];
                
                await invokeWithTimeout("run_shell_command", { commandName: cmd, args }, LONG_TIMEOUT);
                addLog("Cargo build successful.");
            }
            
            document.getElementById('btn-next-3').classList.remove('hidden');
        } catch (err) {
            addLog(`CRITICAL ERROR: ${err?.message || err}`);
            startBtn.disabled = false;
        }
    }

    // Wizard Navigation
    function navTo(step) {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.getElementById(`step-${step}`).classList.remove('hidden');
        document.querySelectorAll('.step-dot').forEach((d, i) => {
            if (i < step) d.classList.add('active');
            else d.classList.remove('active');
        });
        
        if (step === 2) runPrereqInstallation();
    }

    function copyLog(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text);
        alert("Log copied to clipboard!");
    }

    function enterDashboard() {
        localStorage.setItem('bc_installed', 'true');
        document.getElementById('wizard').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
    }

    // Dashboard Actions
    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }

    async function toggleDaemon() {
        const btn = document.getElementById('daemon-toggle');
        const status = document.getElementById('daemon-status-text');
        
        if (btn.innerText.includes("Start")) {
            await window.__TAURI__.invoke("start_daemon");
            btn.innerText = "Stop Agent Daemon";
            status.innerText = "Service Online";
            status.className = "status-badge status-found";
        } else {
            await window.__TAURI__.invoke("stop_daemon");
            btn.innerText = "Start Agent Daemon";
            status.innerText = "Service Offline";
            status.className = "status-badge status-detecting";
        }
    }

    // Init
    window.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('bc_installed')) {
            enterDashboard();
        } else {
            runPrerequisiteChecks();
        }
    });
</script>

</body>
</html>