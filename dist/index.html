<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BambooClaw Companion</title>
    <style>
        /*
         * ===================================================================
         *  BambooClaw Companion: Global Styles & Obsidian Theme
         * ===================================================================
         */
        :root {
            --bg-deep-space: #0a0a0f;
            --bg-card: #1a1a2e;
            --bg-card-glass: rgba(26, 26, 46, 0.75);
            --accent-emerald: #34d399;
            --accent-emerald-dark: #059669;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-error: #f87171;
            --text-success: #4ade80;
            --border-color: rgba(148, 163, 184, 0.2);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            background-color: var(--bg-deep-space);
            color: var(--text-primary);
            font-family: var(--font-family);
            font-size: 16px;
            line-height: 1.6;
            overflow: hidden; /* Prevent body scrollbars */
            height: 100%;
        }

        #app {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
            padding: 2rem;
            background: radial-gradient(ellipse at bottom, var(--bg-card) 0%, var(--bg-deep-space) 70%);
        }

        .hidden {
            display: none !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /*
         * ===================================================================
         *  Card, Wizard, and Dashboard Layout
         * ===================================================================
         */
        .wizard-container, .dashboard-container {
            width: 100%;
            max-width: 800px;
            height: 80%;
            max-height: 600px;
            background: var(--bg-card-glass);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
        }

        .wizard-header, .dashboard-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
        }

        .wizard-header h1, .dashboard-header h1 {
            font-size: 1.25rem;
            margin-left: 0.75rem;
        }
        
        .bambooclaw-logo {
            width: 32px;
            height: 32px;
        }

        .wizard-content {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .wizard-step {
            animation: fadeIn 0.3s ease-in-out;
        }

        .wizard-step h2 {
            color: var(--accent-emerald);
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }

        .wizard-step p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .wizard-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        .dashboard-main {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        
        .dashboard-nav {
            display: flex;
            flex-direction: column;
            padding: 1rem;
            border-right: 1px solid var(--border-color);
            background-color: rgba(0,0,0,0.1);
        }
        
        .dashboard-content {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        /*
         * ===================================================================
         *  UI Components: Buttons, Inputs, Lists, Tabs
         * ===================================================================
         */

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: var(--accent-emerald);
            color: var(--bg-card);
        }
        .btn-primary:hover {
            background-color: var(--accent-emerald-dark);
        }
        .btn-primary:disabled {
            background-color: #374151;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #374151;
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .nav-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.75rem 1rem;
            text-align: left;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s, color 0.2s;
            width: 100%;
            margin-bottom: 0.5rem;
        }
        .nav-button:hover {
            background-color: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }
        .nav-button.active {
            background-color: var(--accent-emerald);
            color: var(--bg-card);
            font-weight: 600;
        }

        .check-list li {
            list-style: none;
            display: flex;
            align-items: center;
            background-color: rgba(0,0,0,0.2);
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .status-icon {
            margin-right: 1rem;
            font-weight: bold;
        }
        .status-icon.pending { color: var(--text-secondary); }
        .status-icon.success { color: var(--text-success); }
        .status-icon.error { color: var(--text-error); }

        .check-details {
            color: var(--text-secondary);
            font-family: monospace;
            font-size: 0.9rem;
            margin-left: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--bg-deep-space);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-emerald);
            box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.5);
        }

        /* Terminal/Log view */
        .terminal-output {
            background-color: #000;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            color: #ddd;
        }
        .terminal-output .log-info { color: #87cefa; }
        .terminal-output .log-success { color: var(--text-success); }
        .terminal-output .log-error { color: var(--text-error); }
        .terminal-output .log-warn { color: #facc15; }

        /* Agent Control Toggle */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #374151;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-emerald);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>

    <div id="app">
        <!-- PHASE 1: INSTALLER WIZARD -->
        <div id="installer-wizard" class="wizard-container fade-in">
            <header class="wizard-header">
                <svg class="bambooclaw-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 3.5C14.5 3.5 18 2 22 4" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"></path><path d="M12 21C8.13401 21 5 17.866 5 14C5 10.134 8.13401 7 12 7C15.866 7 19 10.134 19 14" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"></path><path d="M12 7V4.5C12 3.4 11.1 2.5 10 2.5C8.9 2.5 8 3.4 8 4.5V9" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"></path><path d="M19 14H21.5C21.7761 14 22 14.2239 22 14.5C22 15.6 21.1 16.5 20 16.5C18.9 16.5 18 15.6 18 14.5V12" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"></path><path d="M5 14H2.5C2.22386 14 2 14.2239 2 14.5C2 15.6 2.9 16.5 4 16.5C5.1 16.5 6 15.6 6 14.5V11" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"></path><path d="M12 21V22" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"></path></svg>
                <h1>BambooClaw Installer</h1>
            </header>
            <main class="wizard-content">
                <!-- Step 1: System Check -->
                <div id="step-1" class="wizard-step">
                    <h2>Step 1: System Check</h2>
                    <p>Verifying your system has the required components.</p>
                    <ul class="check-list" id="system-check-list">
                        <li><span class="status-icon pending">...</span>Operating System <span class="check-details" id="os-check">Detecting...</span></li>
                        <li><span class="status-icon pending">...</span>Rust Compiler (rustc) <span class="check-details" id="rustc-check">Checking...</span></li>
                        <li><span class="status-icon pending">...</span>Cargo Package Manager <span class="check-details" id="cargo-check">Checking...</span></li>
                        <li id="ms-build-tools-check-item" class="hidden"><span class="status-icon pending">...</span>MSVC Build Tools <span class="check-details" id="ms-build-tools-check">Checking...</span></li>
                    </ul>
                </div>

                <!-- Step 2: Install Prerequisites -->
                <div id="step-2" class="wizard-step hidden">
                    <h2>Step 2: Install Prerequisites</h2>
                    <p>Some dependencies are missing. We'll install them for you.</p>
                    <div id="prereq-instructions"></div>
                    <div class="terminal-output" id="prereq-output">Awaiting instructions...</div>
                </div>

                <!-- Step 3: Install BambooClaw -->
                <div id="step-3" class="wizard-step hidden">
                    <h2>Step 3: Install BambooClaw Core</h2>
                    <p>Choose your preferred installation method.</p>
                    <div class="form-group">
                        <button id="install-prebuilt-btn" class="btn btn-primary">Download Pre-built Binary (Recommended)</button>
                        <br><br>
                        <button id="install-from-source-btn" class="btn btn-secondary">Build from Source (Advanced)</button>
                    </div>
                    <div class="terminal-output" id="install-output">Awaiting selection...</div>
                </div>

                <!-- Step 4: Finalization -->
                <div id="step-4" class="wizard-step hidden">
                    <h2>Installation Complete!</h2>
                    <p>BambooClaw Core has been successfully installed on your system.</p>
                    <ul class="check-list">
                        <li><span class="status-icon success">✓</span>BambooClaw Version<span class="check-details" id="final-version"></span></li>
                    </ul>
                    <p style="margin-top: 1rem;">You will now be taken to the BambooClaw Companion dashboard.</p>
                </div>
            </main>
            <footer class="wizard-footer">
                <button id="back-btn" class="btn btn-secondary hidden">Back</button>
                <button id="next-btn" class="btn btn-primary" disabled>Next</button>
            </footer>
        </div>

        <!-- PHASE 2: COMPANION DASHBOARD -->
        <div id="dashboard" class="dashboard-container hidden">
            <header class="dashboard-header">
                <svg class="bambooclaw-logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 3.5C14.5 3.5 18 2 22 4" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"></path><path d="M12 21C8.13401 21 5 17.866 5 14C5 10.134 8.13401 7 12 7C15.866 7 19 10.134 19 14" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"></path><path d="M12 7V4.5C12 3.4 11.1 2.5 10 2.5C8.9 2.5 8 3.4 8 4.5V9" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"></path><path d="M19 14H21.5C21.7761 14 22 14.2239 22 14.5C22 15.6 21.1 16.5 20 16.5C18.9 16.5 18 15.6 18 14.5V12" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"></path><path d="M5 14H2.5C2.22386 14 2 14.2239 2 14.5C2 15.6 2.9 16.5 4 16.5C5.1 16.5 6 15.6 6 14.5V11" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"></path><path d="M12 21V22" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" stroke="currentColor"></path></svg>
                <h1>BambooClaw Companion</h1>
            </header>
            <main class="dashboard-main">
                <nav id="dashboard-nav" class="dashboard-nav">
                    <button class="nav-button active" data-tab="llm-config">LLM Config</button>
                    <button class="nav-button" data-tab="channel-setup">Channels</button>
                    <button class="nav-button" data-tab="agent-control">Agent Control</button>
                    <button class="nav-button" data-tab="settings">Settings</button>
                </nav>
                <div class="dashboard-content">
                    <!-- Tab 1: LLM Config -->
                    <div id="tab-llm-config" class="dashboard-tab">
                        <h2>LLM Configuration</h2>
                        <form id="llm-config-form">
                            <div class="form-group">
                                <label for="llm-provider">LLM Provider</label>
                                <select id="llm-provider" name="provider">
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Anthropic</option>
                                    <option value="google">Google Gemini</option>
                                    <option value="openrouter">OpenRouter</option>
                                    <option value="ollama">Ollama (local)</option>
                                    <option value="deepseek">DeepSeek</option>
                                    <option value="groq">Groq</option>
                                    <option value="mistral">Mistral</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="api-key">API Key</label>
                                <input type="password" id="api-key" name="apiKey" placeholder="Enter your API key">
                            </div>
                            <div class="form-group">
                                <label for="model">Model Name</label>
                                <input type="text" id="model" name="model" placeholder="e.g., gpt-4o, claude-3-opus-20240229, llama3">
                            </div>
                            <button id="save-config-btn" type="submit" class="btn btn-primary">Save & Test Config</button>
                        </form>
                        <div class="terminal-output" id="config-test-output" style="margin-top: 1rem;"></div>
                    </div>
                    <!-- Tab 2: Channel Setup -->
                    <div id="tab-channel-setup" class="dashboard-tab hidden">
                        <h2>Channel Setup</h2>
                        <p>Configure your agent's communication channels.</p>
                        <!-- Add channel setup UI here -->
                         <div class="form-group">
                            <label for="telegram-token">Telegram Bot Token</label>
                            <input type="password" id="telegram-token" placeholder="Paste token from @BotFather">
                        </div>
                        <button class="btn btn-secondary">Test Telegram</button>
                    </div>
                    <!-- Tab 3: Agent Control -->
                    <div id="tab-agent-control" class="dashboard-tab hidden">
                        <h2>Agent Control</h2>
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                            <div>
                                <h3 style="margin-bottom: 0.25rem;">BambooClaw Daemon</h3>
                                <span id="daemon-status" style="color: var(--text-secondary)">Status: Inactive</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="daemon-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <h3>Agent Logs</h3>
                        <div class="terminal-output" id="agent-log-output">Agent is not running.</div>
                    </div>
                    <!-- Tab 4: Settings -->
                    <div id="tab-settings" class="dashboard-tab hidden">
                        <h2>Advanced Settings</h2>
                        <div class="form-group">
                            <label for="autonomy-level">Autonomy Level</label>
                            <select id="autonomy-level">
                                <option value="0">Manual Approval</option>
                                <option value="1">Restricted Autonomy</option>
                                <option value="2">Full Autonomy</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gateway-port">Gateway Port</label>
                            <input type="number" id="gateway-port" value="8080">
                        </div>
                        <button class="btn btn-primary">Save Settings</button>
                    </div>
                </div>
            </main>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ===================================================================
            //  STATE & DOM REFERENCES
            // ===================================================================
            const appState = {
                platform: '',
                prerequisites: {
                    rustc: false,
                    cargo: false,
                    msBuildTools: true, // Assume true unless on windows
                },
                needsPrereqInstall: false,
                currentStep: 1,
            };

            const installerWizard = document.getElementById('installer-wizard');
            const dashboard = document.getElementById('dashboard');

            // Wizard elements
            const steps = [
                document.getElementById('step-1'),
                document.getElementById('step-2'),
                document.getElementById('step-3'),
                document.getElementById('step-4'),
            ];
            const nextBtn = document.getElementById('next-btn');
            const backBtn = document.getElementById('back-btn');
            
            // Dashboard elements
            const dashboardNav = document.getElementById('dashboard-nav');
            const dashboardTabs = document.querySelectorAll('.dashboard-tab');
            const daemonToggle = document.getElementById('daemon-toggle');
            const daemonStatus = document.getElementById('daemon-status');
            const agentLogOutput = document.getElementById('agent-log-output');

            // ===================================================================
            //  TAURI API WRAPPER
            // ===================================================================
            // A robust wrapper for all Tauri `invoke` calls.
            // This is critical for debugging and centralized error handling.
            async function tauriInvoke(command, args = {}) {
                if (!window.__TAURI__) {
                    console.error("Tauri API not found. Are you running in a Tauri context?");
                    // Faking responses for browser-based development
                    logToTerminal('prereq-output', `[WARN] Tauri API not found. Faking response for: ${command}`, 'warn');
                    if (command === 'get_platform') return 'windows';
                    if (command === 'check_prerequisite') return 'not_found';
                    return;
                }
                const { invoke } = window.__TAURI__.core;
                try {
                    console.log(`[TAURI] Invoking: ${command}`, args);
                    const result = await invoke(command, args);
                    console.log(`[TAURI] Result for ${command}:`, result);
                    return result;
                } catch (error) {
                    console.error(`[TAURI] Error invoking ${command}:`, error);
                    logToTerminal(getVisibleTerminalId(), `[ERROR] Command '${command}' failed: ${error}`, 'error');
                    throw error;
                }
            }


            // ===================================================================
            //  UTILITY FUNCTIONS
            // ===================================================================
            
            // Updates a status list item in Step 1
            function updateCheckStatus(elementId, success, details) {
                const el = document.getElementById(elementId);
                const icon = el.previousElementSibling;
                const detailSpan = document.getElementById(elementId + '-detail');

                icon.textContent = success ? '✓' : '✗';
                icon.className = `status-icon ${success ? 'success' : 'error'}`;
                el.textContent = details;
            }

            // Logs messages to a specified terminal-like view
            function logToTerminal(terminalId, message, type = 'info') {
                const terminal = document.getElementById(terminalId);
                if (terminal) {
                    const line = document.createElement('div');
                    line.className = `log-${type}`;
                    line.textContent = `> ${message}`;
                    terminal.appendChild(line);
                    terminal.scrollTop = terminal.scrollHeight; // Auto-scroll
                }
            }

            function getVisibleTerminalId() {
                if (!steps[1].classList.contains('hidden')) return 'prereq-output';
                if (!steps[2].classList.contains('hidden')) return 'install-output';
                if (!dashboard.classList.contains('hidden')) return 'agent-log-output';
                return 'prereq-output'; // Default
            }

            // Manages visibility of wizard steps
            function showStep(stepNumber) {
                appState.currentStep = stepNumber;
                steps.forEach((step, index) => {
                    step.classList.toggle('hidden', index + 1 !== stepNumber);
                });
                backBtn.classList.toggle('hidden', stepNumber === 1);
                nextBtn.textContent = stepNumber === 4 ? 'Finish' : 'Next';
                nextBtn.disabled = true; // Disable by default on step change
            }

            // ===================================================================
            //  INSTALLER LOGIC
            // ===================================================================

            async function runStep1SystemChecks() {
                try {
                    // Check OS
                    const platform = await tauriInvoke('get_platform');
                    appState.platform = platform;
                    updateCheckStatus('os-check', true, platform);

                    const checks = [
                        tauriInvoke('check_prerequisite', { name: 'rustc' }),
                        tauriInvoke('check_prerequisite', { name: 'cargo' }),
                    ];

                    if (platform === 'windows') {
                         document.getElementById('ms-build-tools-check-item').classList.remove('hidden');
                         checks.push(tauriInvoke('check_prerequisite', { name: 'msvc' }));
                    }

                    const [rustc, cargo, msvc] = await Promise.all(checks);
                    
                    appState.prerequisites.rustc = rustc !== 'not_found';
                    updateCheckStatus('rustc-check', appState.prerequisites.rustc, rustc);

                    appState.prerequisites.cargo = cargo !== 'not_found';
                    updateCheckStatus('cargo-check', appState.prerequisites.cargo, cargo);
                    
                    if (platform === 'windows') {
                        appState.prerequisites.msBuildTools = msvc !== 'not_found';
                        updateCheckStatus('ms-build-tools-check', appState.prerequisites.msBuildTools, msvc);
                    }
                    
                    appState.needsPrereqInstall = !Object.values(appState.prerequisites).every(Boolean);

                    nextBtn.disabled = false;
                } catch (err) {
                    console.error("System check failed:", err);
                    nextBtn.disabled = true;
                }
            }

            function setupStep2Prerequisites() {
                const instructionsEl = document.getElementById('prereq-instructions');
                const outputEl = document.getElementById('prereq-output');
                outputEl.innerHTML = ''; // Clear previous logs
                
                let commandName, args, instructionsText;
                
                switch (appState.platform) {
                    case 'windows':
                        instructionsText = "We will use Winget to install the required Microsoft C++ Build Tools and Rust.";
                        commandName = 'winget';
                        args = ['install', '--id', 'Microsoft.VisualStudio.2022.BuildTools', '--override', '"--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --add Microsoft.VisualStudio.Component.Windows11SDK.22621 --quiet"'];
                        break;
                    case 'macos':
                        instructionsText = "We will start the command-line tools installer, then install Rust using rustup.";
                                                commandName = 'xcode-select';
                        args = ['--install'];
                        break;
                    case 'linux':
                        instructionsText = "We will use apt-get to install build-essential, then install Rust using rustup.";
                        commandName = 'sudo';
                        args = ['apt-get', 'install', '-y', 'build-essential'];
                        break;
                    default:
                        instructionsText = "Unsupported OS. Cannot automatically install prerequisites.";
                        nextBtn.disabled = true;
                        return;
                }
                
                instructionsEl.textContent = instructionsText;
                nextBtn.disabled = false;
                
                // Attach a one-time event listener to the "Next" button for this step
                nextBtn.onclick = async () => {
                    nextBtn.disabled = true;
                    logToTerminal('prereq-output', `Running: ${commandName} ${args.join(' ')}`, 'info');
                    try {
                        const result = await tauriInvoke('run_shell_command', { commandName, args });
                        logToTerminal('prereq-output', result, 'info');

                        // Install rustup separately if not on Windows
                        if (appState.platform !== 'windows') {
                           logToTerminal('prereq-output', 'Now installing Rust via rustup...', 'info');
                           const rustupResult = await tauriInvoke('run_shell_command', { 
                               commandName: 'curl', 
                               args: ['--proto', '=https', '--tlsv1.2', '-sSf', 'https://sh.rustup.rs', '|', 'sh', '-s', '--', '-y'] 
                            });
                           logToTerminal('prereq-output', rustupResult || 'Rustup installation initiated.', 'info');
                        }

                        logToTerminal('prereq-output', 'Prerequisites installed successfully.', 'success');
                        showStep(3);
                    } catch (err) {
                        logToTerminal('prereq-output', `Installation failed: ${err}`, 'error');
                    } finally {
                        nextBtn.disabled = false;
                        nextBtn.onclick = handleNext; // Re-attach generic handler
                    }
                };
            }

            function setupStep3Install() {
                const installOutput = document.getElementById('install-output');
                installOutput.innerHTML = '';
                nextBtn.disabled = true; // Stay on this step until install is done
                
                document.getElementById('install-prebuilt-btn').onclick = async () => {
                    logToTerminal('install-output', 'Downloading pre-built binary...', 'info');
                    // NOTE: Replace with actual binary URL from your CI/CD
                    const url = `https://github.com/your-org/bambooclaw-core/releases/latest/download/bambooclaw-${appState.platform}-x86_64`;
                    const dest = `bambooclaw${appState.platform === 'windows' ? '.exe' : ''}`;
                    
                    try {
                        await tauriInvoke('download_binary', { url, dest });
                        logToTerminal('install-output', `Binary saved to ${dest}`, 'success');
                        verifyInstallationAndProceed();
                    } catch(e) {
                        logToTerminal('install-output', 'Failed to download pre-built binary. Please try building from source.', 'error');
                    }
                };
                
                document.getElementById('install-from-source-btn').onclick = async () => {
                    logToTerminal('install-output', 'Building from source via `cargo install`... This may take a while.', 'info');
                    try {
                         // NOTE: Using a fork is not standard for cargo install.
                         // Normally, you'd install from crates.io or a git repo.
                         // This assumes the name on crates.io is 'bambooclaw-core'.
                        const result = await tauriInvoke('run_shell_command', {
                            commandName: 'cargo',
                            args: ['install', 'bambooclaw-core', '--locked'] 
                        });
                        logToTerminal('install-output', result, 'info');
                        logToTerminal('install-output', 'Build successful!', 'success');
                        verifyInstallationAndProceed();
                    } catch(e) {
                         logToTerminal('install-output', `Build failed: ${e}. Ensure Rust and build tools are correctly installed and in your PATH.`, 'error');
                    }
                }
            }
            
            async function verifyInstallationAndProceed() {
                try {
                    const version = await tauriInvoke('run_bambooclaw', { args: ['--version'] });
                    document.getElementById('final-version').textContent = version.trim();
                    showStep(4);
                    nextBtn.disabled = false;
                } catch(e) {
                    logToTerminal('install-output', `Verification failed. Could not run BambooClaw. ${e}`, 'error');
                }
            }

            function handleNext() {
                if (appState.currentStep === 1) {
                    if (appState.needsPrereqInstall) {
                        showStep(2);
                        setupStep2Prerequisites();
                    } else {
                        showStep(3);
                        setupStep3Install();
                    }
                } else if (appState.currentStep === 2) {
                    // Logic is handled by one-time click handler in setupStep2Prerequisites
                    // This is a fallback
                    showStep(3);
                    setupStep3Install();
                } else if (appState.currentStep === 3) {
                    // This step automatically advances on success
                } else if (appState.currentStep === 4) {
                    // Final step: transition to dashboard
                    localStorage.setItem('bambooclaw_installed', 'true');
                    showDashboard();
                }
            }

            function handleBack() {
                if (appState.currentStep > 1) {
                    showStep(appState.currentStep - 1);
                    nextBtn.disabled = false; // Re-enable next on back
                }
            }
            
            function startInstaller() {
                installerWizard.classList.remove('hidden');
                dashboard.classList.add('hidden');
                nextBtn.onclick = handleNext;
                backBtn.onclick = handleBack;
                showStep(1);
                runStep1SystemChecks();
            }

            // ===================================================================
            //  DASHBOARD LOGIC
            // ===================================================================
            function showDashboard() {
                installerWizard.classList.add('hidden');
                dashboard.classList.remove('hidden');
                dashboard.classList.add('fade-in');
                
                // Load config into form
                tauriInvoke('read_config').then(configStr => {
                    if (configStr) {
                        const config = JSON.parse(configStr);
                        document.getElementById('llm-provider').value = config.provider || 'openai';
                        document.getElementById('api-key').value = config.apiKey || '';
                        document.getElementById('model').value = config.model || '';
                    }
                });
            }
            
            // Tab switching
            dashboardNav.addEventListener('click', (e) => {
                if (e.target.matches('.nav-button')) {
                    const targetTabId = `tab-${e.target.dataset.tab}`;
                    
                    // Update button styles
                    dashboardNav.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Update tab visibility
                    dashboardTabs.forEach(tab => tab.classList.toggle('hidden', tab.id !== targetTabId));
                }
            });

            // LLM Config Save
            document.getElementById('llm-config-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const config = {
                    provider: form.elements.provider.value,
                    apiKey: form.elements.apiKey.value,
                    model: form.elements.model.value,
                };

                const outputEl = document.getElementById('config-test-output');
                outputEl.innerHTML = '';
                
                try {
                    logToTerminal('config-test-output', 'Saving configuration...', 'info');
                    await tauriInvoke('write_config', { content: JSON.stringify(config, null, 2) });
                    logToTerminal('config-test-output', 'Configuration saved successfully.', 'success');
                    
                    logToTerminal('config-test-output', 'Testing connection with `ping` command...', 'info');
                    const result = await tauriInvoke('run_bambooclaw', { args: ['agent', '-m', 'ping'] });
                    logToTerminal('config-test-output', result, 'success');
                } catch(err) {
                    logToTerminal('config-test-output', `An error occurred: ${err}`, 'error');
                }
            });

            // Agent Daemon Control
            daemonToggle.addEventListener('change', async (e) => {
                agentLogOutput.innerHTML = '';
                const isChecked = e.target.checked;
                if (isChecked) {
                    daemonStatus.textContent = 'Status: Starting...';
                    logToTerminal('agent-log-output', 'Starting BambooClaw daemon...', 'info');
                    try {
                        const result = await tauriInvoke('start_daemon');
                        daemonStatus.textContent = 'Status: Active';
                        logToTerminal('agent-log-output', `Daemon started successfully. PID: ${result}`, 'success');
                    } catch (err) {
                        daemonStatus.textContent = 'Status: Error';
                        logToTerminal('agent-log-output', `Failed to start daemon: ${err}`, 'error');
                        e.target.checked = false; // Revert toggle on failure
                    }
                } else {
                    daemonStatus.textContent = 'Status: Stopping...';
                    logToTerminal('agent-log-output', 'Stopping BambooClaw daemon...', 'info');
                    try {
                        await tauriInvoke('stop_daemon');
                        daemonStatus.textContent = 'Status: Inactive';
                        logToTerminal('agent-log-output', 'Daemon stopped successfully.', 'success');
                    } catch (err) {
                        daemonStatus.textContent = 'Status: Error';
                        logToTerminal('agent-log-output', `Failed to stop daemon: ${err}`, 'error');
                        e.target.checked = true; // Revert toggle on failure
                    }
                }
            });


            // ===================================================================
            //  INITIALIZATION
            // ===================================================================
            function init() {
                // Check if the app is already installed.
                // localStorage is a simple way to persist this state across app restarts.
                if (localStorage.getItem('bambooclaw_installed') === 'true') {
                    showDashboard();
                } else {
                    startInstaller();
                }
            }

            init();
        });
    </script>
</body>
</html>