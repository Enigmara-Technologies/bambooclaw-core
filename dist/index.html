<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src *; img-src 'self' data:;">
    <title>BambooClaw Companion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f;
            --card: #12121e;
            --accent: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.2);
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --border: #1e293b;
            --error: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }
        #app { display: flex; flex-direction: column; height: 100vh; }
        header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        .logo { font-weight: 800; font-size: 1.25rem; letter-spacing: -0.025em; color: var(--accent); }
        main { flex: 1; overflow-y: auto; padding: 2rem; position: relative; }
        .container { max-width: 800px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* Step Indicator */
        .steps { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .step-dot { flex: 1; height: 4px; background: var(--border); border-radius: 2px; transition: 0.3s; }
        .step-dot.active { background: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        /* Cards */
        .glass-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
        p.subtitle { color: var(--text-dim); margin-bottom: 2rem; }

        /* List Rows */
        .check-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .status-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; }
        .status-detecting { color: var(--text-dim); }
        .status-found { color: var(--accent); }
        .status-not-installed { color: var(--warning); background: rgba(245, 158, 11, 0.1); }
        .status-error { color: var(--error); }

        /* Log Panel */
        .log-container {
            margin-top: 1.5rem;
            position: relative;
            background: #050507;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #1a1a2e;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .log-body {
            height: 250px;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .copy-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 4px;
        }
        .copy-btn:hover { color: var(--accent); }

        /* Buttons */
        .btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn:hover { filter: brightness(1.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--accent); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
        .btn-danger { background: var(--error); }

        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 2rem; }
        .tab { padding: 1rem 2rem; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; transition: 0.2s; user-select: none; }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* Forms */
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; color: var(--text-dim); font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            background: #050507;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.75rem;
            border-radius: 6px;
            outline: none;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); }

        /* Status indicators */
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-pill.running { background: rgba(16,185,129,0.15); color: var(--success); }
        .status-pill.stopped { background: rgba(239,68,68,0.15); color: var(--error); }

        /* Channel row */
        .channel-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }
        .channel-row .channel-name { font-weight: 600; }
        .channel-row .channel-status { font-size: 0.8rem; color: var(--text-dim); }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            font-size: 0.9rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.info { border-left: 3px solid var(--accent); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }

        /* Animations */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; display: inline-block; }

        /* Chat */
        .chat-container {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 1rem;
            background: #050507;
        }
        .chat-input-row {
            display: flex;
            border-top: 1px solid var(--border);
        }
        .chat-input-row input {
            flex: 1;
            border: none;
            border-radius: 0;
        }
        .chat-input-row button {
            border-radius: 0;
            white-space: nowrap;
        }
        .chat-msg {
            margin-bottom: 0.75rem;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        .chat-msg .role {
            font-weight: 700;
            color: var(--accent);
            margin-right: 0.5rem;
        }
        .chat-msg.assistant .role { color: var(--warning); }

        /* Settings grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        @media (max-width: 600px) {
            .settings-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="logo">BAMBOOCLAW COMPANION</div>
            <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--accent);"><span id="app-version">loading...</span></div>
        </header>
        <main>
            <!-- ========== WIZARD ========== -->
            <div id="wizard-view" class="container">
                <div class="steps">
                    <div class="step-dot active" id="dot-0"></div>
                    <div class="step-dot" id="dot-1"></div>
                    <div class="step-dot" id="dot-2"></div>
                    <div class="step-dot" id="dot-3"></div>
                </div>

                <!-- Step 1: System Check -->
                <div class="glass-card wizard-step" id="step-0">
                    <h1>Environment Audit</h1>
                    <p class="subtitle">Ensuring your system is prepared for BambooClaw edge deployment.</p>
                    <div>
                        <div class="check-row">
                            <span>Operating System</span>
                            <span class="status-badge status-detecting" id="chk-os">Detecting...</span>
                        </div>
                        <div class="check-row">
                            <span>Rust Toolchain</span>
                            <span class="status-badge status-detecting" id="chk-rust">Detecting...</span>
                        </div>
                        <div class="check-row">
                            <span>Git CLI</span>
                            <span class="status-badge status-detecting" id="chk-git">Detecting...</span>
                        </div>
                        <div class="check-row">
                            <span>Build Tools</span>
                            <span class="status-badge status-detecting" id="chk-build">Detecting...</span>
                        </div>
                    </div>
                    <div class="log-container">
                        <div class="log-header">
                            <span>BOOT TRACE LOG</span>
                            <button class="copy-btn" onclick="copyLog('boot-log')">&#128203;</button>
                        </div>
                        <div class="log-body" id="boot-log"></div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button class="btn" id="btn-step0-next" disabled>Initialize Environment ‚Üí</button>
                    </div>
                </div>

    <!-- SCRIPT 1: CANARY + ERROR BOUNDARY ‚Äî catches Script 2 parse errors -->
    <script>
    (function() {
        try {
            var el = document.getElementById("boot-log");
            if (el) el.textContent = "[CANARY] JS engine alive at " + new Date().toISOString() + "\n";
        } catch(e) {}
    })();
    // Global error boundary ‚Äî MUST be here (outside Script 2) to catch Script 2 parse errors
    window.onerror = function(msg, src, line, col, err) {
        try {
            var el = document.getElementById("boot-log");
            if (el) el.textContent += "[FATAL] " + msg + " at line " + line + ":" + col + "\n";
        } catch(e) {}
        return false;
    };
    window.addEventListener("unhandledrejection", function(event) {
        try {
            var el = document.getElementById("boot-log");
            if (el) el.textContent += "[FATAL] Unhandled rejection: " + (event.reason ? (event.reason.message || event.reason) : "unknown") + "\n";
        } catch(e) {}
    });
    </script>

                <!-- Step 2: Install Prerequisites -->
                <div class="glass-card wizard-step hidden" id="step-1">
                    <h1>Readying Prereqs</h1>
                    <p class="subtitle">Applying required system dependencies and development toolchains.</p>
                    <div class="log-container">
                        <div class="log-header">
                            <span>SYSTEM INSTALLATION LOG</span>
                            <button class="copy-btn" onclick="copyLog('install-log')">&#128203;</button>
                        </div>
                        <div class="log-body" id="install-log"></div>
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                        <button class="btn btn-outline" onclick="wizardGo(0)">‚Üê Back</button>
                        <button class="btn" id="btn-step1-next" disabled>Deploy Core Agent ‚Üí</button>
                    </div>
                </div>

                <!-- Step 3: Install BambooClaw -->
                <div class="glass-card wizard-step hidden" id="step-2">
                    <h1>Deploy BambooClaw</h1>
                    <div class="form-group">
                        <label>Installation Method</label>
                        <select id="install-method">
                            <option value="binary" selected>Pre-built Binary (Fastest)</option>
                            <option value="source">Build from Source</option>
                        </select>
                    </div>
                    <div class="log-container">
                        <div class="log-header">
                            <span>DEPLOYMENT LOG</span>
                            <button class="copy-btn" onclick="copyLog('deploy-log')">&#128203;</button>
                        </div>
                        <div class="log-body" id="deploy-log"></div>
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                        <button class="btn btn-outline" onclick="wizardGo(1)">‚Üê Back</button>
                        <button class="btn" id="btn-step2-deploy">Begin Deployment</button>
                        <button class="btn hidden" id="btn-step2-next">Finalize ‚Üí</button>
                    </div>
                </div>

                <!-- Step 4: Done -->
                <div class="glass-card wizard-step hidden" id="step-3">
                    <div style="text-align: center; padding: 2rem 0;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚úì</div>
                        <h1>Installation Complete</h1>
                        <p class="subtitle">BambooClaw is now registered as a system service.</p>
                        <div class="form-group" style="text-align: left;">
                            <label>Storage Path</label>
                            <input type="text" id="install-path-display" readonly value="~/.bambooclaw/bambooclaw" />
                        </div>
                        <button class="btn" id="btn-enter-dashboard">Enter Companion Dashboard</button>
                    </div>
                </div>
            </div>

            <!-- ========== DASHBOARD ========== -->
            <div id="dashboard-view" class="container hidden">
                <div class="tabs">
                    <div class="tab active" data-tab="tab-llm">LLM Settings</div>
                    <div class="tab" data-tab="tab-channels">Channels</div>
                    <div class="tab" data-tab="tab-agent">Agent Control</div>
                    <div class="tab" data-tab="tab-settings">Settings</div>
                </div>

                <!-- Tab: LLM Settings -->
                <div class="glass-card tab-panel" id="tab-llm">
                    <div class="form-group">
                        <label>AI Provider</label>
                        <select id="llm-provider">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google Gemini</option>
                            <option value="groq">Groq (Ultra-Fast)</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="ollama">Ollama (Local)</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="mistral">Mistral</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Secret API Key</label>
                        <input type="password" id="llm-api-key" placeholder="sk-..." />
                    </div>
                    <div class="form-group" id="llm-model-group">
                        <label>Model</label>
                        <select id="llm-model">
                            <option value="">Select provider first</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="or-models-area">
                        <label>Model <span id="or-model-count" style="color:var(--text-dim);font-size:0.8rem;"></span></label>
                        <input type="text" id="or-model-search" placeholder="Search models..." style="margin-bottom:0.5rem;" />
                        <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;flex-wrap:wrap;">
                            <button class="btn btn-sm btn-outline" id="or-sort-name">‚ñº Name</button>
                            <button class="btn btn-sm btn-outline" id="or-sort-input">‚ñº Input $/1M</button>
                            <button class="btn btn-sm btn-outline" id="or-sort-output">‚ñº Output $/1M</button>
                            <button class="btn btn-sm" id="btn-fetch-models">Fetch Models</button>
                        </div>
                        <div id="or-model-list" style="max-height:350px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;background:#050507;"></div>
                        <div id="or-selected-display" style="margin-top:0.5rem;font-size:0.85rem;color:var(--accent);"></div>
                    </div>
                    <div class="form-group">
                        <label>System Prompt (optional)</label>
                        <textarea id="llm-system-prompt" rows="3" placeholder="Custom instructions for the agent..."></textarea>
                    </div>
                    <button class="btn" id="btn-apply-llm">Apply Configuration</button>
                    <button class="btn btn-outline" style="margin-left: 0.5rem;" id="btn-test-llm">Test Connection</button>
                </div>

                <!-- Tab: Channels -->
                <div class="glass-card tab-panel hidden" id="tab-channels">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.5rem;">Active Channels</h1>
                    <p class="subtitle">Connect your agent to external messaging platforms.</p>

                    <div class="channel-row">
                        <div>
                            <div class="channel-name">ü§ñ Telegram Bot</div>
                            <div class="channel-status" id="tg-status">Not configured</div>
                        </div>
                        <button class="btn btn-sm btn-outline" id="btn-setup-tg">Setup</button>
                    </div>

                    <div class="channel-row">
                        <div>
                            <div class="channel-name">üí¨ Discord App</div>
                            <div class="channel-status" id="dc-status">Not configured</div>
                        </div>
                        <button class="btn btn-sm btn-outline" id="btn-setup-dc">Setup</button>
                    </div>

                    <div class="channel-row">
                        <div>
                            <div class="channel-name">üì± WhatsApp</div>
                            <div class="channel-status" id="wa-status">Not configured</div>
                        </div>
                        <button class="btn btn-sm btn-outline" id="btn-setup-wa">Setup</button>
                    </div>

                    <div class="channel-row">
                        <div>
                            <div class="channel-name">üîó Slack</div>
                            <div class="channel-status" id="sl-status">Not configured</div>
                        </div>
                        <button class="btn btn-sm btn-outline" id="btn-setup-sl">Setup</button>
                    </div>

                    <!-- Channel setup modal area -->
                    <div id="channel-setup-area" class="hidden" style="margin-top: 1.5rem; padding: 1.5rem; border: 1px solid var(--border); border-radius: 8px; background: #050507;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2 style="font-size: 1.1rem;" id="channel-setup-title">Setup</h2>
                            <button class="copy-btn" id="btn-close-channel" style="font-size: 1.2rem;">‚úï</button>
                        </div>
                        <div id="channel-setup-body"></div>
                    </div>
                </div>

                <!-- Tab: Agent Control -->
                <div class="glass-card tab-panel hidden" id="tab-agent">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div>
                            <h1 style="font-size: 1.3rem; margin-bottom: 0.25rem;">Daemon Status</h1>
                            <span class="status-pill stopped" id="daemon-status-pill">
                                <span id="daemon-status-dot">‚óè</span>
                                <span id="daemon-status-text">Stopped</span>
                            </span>
                        </div>
                        <button class="btn" id="btn-daemon-toggle">Start Agent Daemon</button>
                    </div>

                    <h2 style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-dim);">Agent Chat</h2>
                    <div class="chat-container">
                        <div class="chat-messages" id="agent-chat-messages">
                            <div class="chat-msg assistant"><span class="role">Agent:</span> Daemon is offline. Start the daemon to begin chatting.</div>
                        </div>
                        <div class="chat-input-row">
                            <input type="text" id="agent-chat-input" placeholder="Send a message to the agent..." />
                            <button type="button" class="btn" style="border-radius: 0;" id="btn-send-chat">Send</button>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem;">
                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-dim);">Daemon Log</h2>
                        <div class="log-container">
                            <div class="log-header">
                                <span>RUNTIME LOG</span>
                                <button class="copy-btn" onclick="copyLog('daemon-log')">&#128203;</button>
                            </div>
                            <div class="log-body" id="daemon-log">[INFO] Daemon not started.</div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Settings -->
                <div class="glass-card tab-panel hidden" id="tab-settings">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.5rem;">Agent Settings</h1>
                    <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1.5rem;">These settings are pre-configured with optimal defaults. No changes are needed unless you have specific requirements.</p>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>Autonomy Level</label>
                            <select id="set-autonomy">
                                <option value="observe">Observation Only</option>
                                <option value="collaborative" selected>Collaborative (Needs Approval)</option>
                                <option value="autonomous">Full Autonomy</option>
                            </select>
                            <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.4rem;">
                                Determines which shell commands the agent can run without explicit user consent.
                            </p>
                        </div>
                        <div class="form-group">
                            <label>Gateway Port</label>
                            <input type="number" id="set-port" value="7331" min="1024" max="65535" />
                        </div>
                        <div class="form-group">
                            <label>Tunnel Provider</label>
                            <select id="set-tunnel">
                                <option value="none" selected>None (Local Only)</option>
                                <option value="cloudflared">Cloudflare Tunnel</option>
                                <option value="tailscale">Tailscale</option>
                                <option value="ngrok">ngrok</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Identity Format</label>
                            <select id="set-identity">
                                <option value="bamboo" selected>BambooClaw Default</option>
                                <option value="custom">Custom Persona</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Runtime Adapter</label>
                            <select id="set-runtime">
                                <option value="native" selected>Native (Recommended)</option>
                                <option value="docker">Docker Container</option>
                                <option value="wasm">WASM Sandbox</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Log Level</label>
                            <select id="set-loglevel">
                                <option value="info" selected>Info</option>
                                <option value="debug">Debug</option>
                                <option value="trace">Trace</option>
                                <option value="warn">Warn</option>
                                <option value="error">Error Only</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="btn" id="btn-save-settings">Save Settings</button>
                        <button class="btn btn-outline" style="margin-left: 0.5rem;" id="btn-reset-settings">Reset Defaults</button>
                    </div>
                </div>

                <!-- Debug Log Panel (always visible in dashboard) -->
                <div style="margin-top: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.8rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace;">üìã DASHBOARD DEBUG LOG</span>
                        <button class="copy-btn" onclick="window.copyLog('dash-log')">Copy</button>
                    </div>
                    <div class="log-body" id="dash-log" style="height:180px;margin-top:0.5rem;background:#050507;border:1px solid var(--border);border-radius:6px;font-size:0.75rem;"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- SCRIPT 2: MAIN ‚Äî wrapped with global error boundary -->
    <script>
    // Error boundary is in Script 1 (canary) to catch parse errors in this script block.

    // =========== GLOBALS ===========
    var detectedOS = "unknown";
    var daemonRunning = false;
    var currentConfig = {};
    var PROXY_URL = "https://mjmdhqglpratbyzmgndm.supabase.co/functions/v1/github-release-proxy";

    // =========== TOAST ===========
    function showToast(message, type) {
        type = type || "info";
        var container = document.getElementById("toast-container");
        var t = document.createElement("div");
        t.className = "toast " + type;
        t.textContent = message;
        container.appendChild(t);
        setTimeout(function() {
            t.style.animation = "slideOut 0.3s ease forwards";
            setTimeout(function() { t.remove(); }, 300);
        }, 3000);
    }

    // =========== TAURI HELPERS ===========
    function tauriInvoke(cmd, args) {
        if (!window.__TAURI__) return Promise.reject(new Error("Tauri not available (running in browser)"));
        // Try known invoke locations first
        var inv = (window.__TAURI__.core && window.__TAURI__.core.invoke)
               || (window.__TAURI__.tauri && window.__TAURI__.tauri.invoke)
               || window.__TAURI__.invoke;
        if (typeof inv === "function") return inv(cmd, args || {});
        // Fallback: construct invoke from Tauri v1 primitives (transformCallback + __TAURI_IPC__)
        if (typeof window.__TAURI__.transformCallback === "function" && typeof window.__TAURI_IPC__ === "function") {
            return new Promise(function(resolve, reject) {
                var cbId = window.__TAURI__.transformCallback(function(r) { resolve(r); }, true);
                var errId = window.__TAURI__.transformCallback(function(e) { reject(e); }, true);
                var payload = Object.assign({ cmd: cmd, callback: cbId, error: errId }, args || {});
                window.__TAURI_IPC__(payload);
            });
        }
        var keys = Object.keys(window.__TAURI__).join(", ");
        var ipc = typeof window.__TAURI_IPC__;
        return Promise.reject(new Error("Tauri invoke not found. Keys: " + keys + ", __TAURI_IPC__: " + ipc));
    }
    function invokeShort(cmd, args) {
        return Promise.race([
            tauriInvoke(cmd, args),
            new Promise(function(_, reject) { setTimeout(function() { reject(new Error("Timeout: " + cmd)); }, 8000); })
        ]);
    }
    function invokeLong(cmd, args, ms) {
        return Promise.race([
            tauriInvoke(cmd, args),
            new Promise(function(_, reject) { setTimeout(function() { reject(new Error("Timeout: " + cmd)); }, ms || 600000); })
        ]);
    }

    // =========== COPY LOG ===========
    function copyLog(logId) {
        try {
            var el = document.getElementById(logId);
            if (el) {
                navigator.clipboard.writeText(el.textContent).then(function() {
                    showToast("Log copied to clipboard", "success");
                }).catch(function() {
                    // Fallback for environments without clipboard API
                    var ta = document.createElement("textarea");
                    ta.value = el.textContent;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand("copy");
                    document.body.removeChild(ta);
                    showToast("Log copied to clipboard", "success");
                });
            }
        } catch(e) {
            console.error("[copyLog error]", e);
        }
    }
    function appendLog(logId, line) {
        try {
            var el = document.getElementById(logId);
            if (el) {
                el.textContent += line + "\n";
                el.scrollTop = el.scrollHeight;
            }
        } catch(e) {
            console.error("[appendLog error]", e);
        }
    }

    // =========== WIZARD ===========
    var currentStep = 0;
    function wizardGo(step) {
        document.querySelectorAll(".wizard-step").forEach(function(s, i) {
            s.classList.toggle("hidden", i !== step);
        });
        document.querySelectorAll(".step-dot").forEach(function(d, i) {
            d.classList.toggle("active", i <= step);
        });
        currentStep = step;
        if (step === 0) runSystemChecks();
        if (step === 1) runPrereqInstall();
    }

    // Step 1: System Checks ‚Äî all run in PARALLEL to avoid sequential timeout hangs
    function updateBadge(id, text, cls) {
        var el = document.getElementById(id);
        if (el) { el.textContent = text; el.className = "status-badge " + cls; }
    }

    async function runSystemChecks() {
        appendLog("boot-log", "[CHECK] runSystemChecks() called");

        appendLog("boot-log", "[CHECK] get_platform: invoking...");
        var checkOS = invokeShort("get_platform").then(function(os) {
            detectedOS = os || "unknown";
            var osLabel = detectedOS === "windows" ? "Windows" : detectedOS === "macos" ? "macOS" : detectedOS === "linux" ? "Linux" : detectedOS;
            updateBadge("chk-os", osLabel, "status-found");
            appendLog("boot-log", "[CHECK] get_platform: resolved -> \"" + osLabel + "\"");
        }).catch(function(e) {
            detectedOS = "windows";
            updateBadge("chk-os", "Windows (assumed)", "status-not-installed");
            appendLog("boot-log", "[CHECK] get_platform: ERROR -> " + (e.message || e));
        });

        appendLog("boot-log", "[CHECK] check_prerequisite(rustc): invoking...");
        var checkRust = invokeShort("check_prerequisite", { name: "rustc" }).then(function(rv) {
            updateBadge("chk-rust", rv.trim().split("\n")[0], "status-found");
            appendLog("boot-log", "[CHECK] check_prerequisite(rustc): resolved -> \"" + rv.trim().split("\n")[0] + "\"");
        }).catch(function(e) {
            updateBadge("chk-rust", "Not Installed", "status-not-installed");
            appendLog("boot-log", "[CHECK] check_prerequisite(rustc): ERROR -> " + (e.message || e));
        });

        appendLog("boot-log", "[CHECK] run_shell_command(git --version): invoking...");
        var checkGit = invokeShort("run_shell_command", { commandName: "git", args: ["--version"] }).then(function(gv) {
            updateBadge("chk-git", gv.trim().split("\n")[0], "status-found");
            appendLog("boot-log", "[CHECK] run_shell_command(git): resolved -> \"" + gv.trim().split("\n")[0] + "\"");
        }).catch(function(e) {
            updateBadge("chk-git", "Not Installed", "status-not-installed");
            appendLog("boot-log", "[CHECK] run_shell_command(git): ERROR -> " + (e.message || e));
        });

        appendLog("boot-log", "[CHECK] check_prerequisite(vs_build_tools): invoking...");
        var checkBuild = invokeShort("check_prerequisite", { name: "vs_build_tools" }).then(function(bv) {
            updateBadge("chk-build", bv.trim() || "Found", "status-found");
            appendLog("boot-log", "[CHECK] check_prerequisite(vs_build_tools): resolved -> \"" + (bv.trim() || "Found") + "\"");
        }).catch(function(e) {
            updateBadge("chk-build", detectedOS === "windows" ? "Not Installed" : "N/A", detectedOS === "windows" ? "status-not-installed" : "status-found");
            appendLog("boot-log", "[CHECK] check_prerequisite(vs_build_tools): ERROR -> " + (e.message || e));
        });

        await Promise.allSettled([checkOS, checkRust, checkGit, checkBuild]);
        appendLog("boot-log", "[BOOT] All checks settled. Enabling Next button.");
        document.getElementById("btn-step0-next").disabled = false;
    }

    document.getElementById("btn-step0-next").addEventListener("click", function() { wizardGo(1); });

    // Step 2: Install Prerequisites
    async function runPrereqInstall() {
        var log = "install-log";
        document.getElementById(log).textContent = "";
        appendLog(log, "[INFO] Detected OS: " + detectedOS);
        appendLog(log, "[INFO] Starting prerequisite installation...");

        var rustBadge = document.getElementById("chk-rust");
        var rustInstalled = rustBadge && rustBadge.classList.contains("status-found");

        if (rustInstalled) {
            appendLog(log, "[SKIP] Rust already installed.");
        } else {
            appendLog(log, "[INFO] Installing Rust toolchain...");
            try {
                if (detectedOS === "windows") {
                    var result = await invokeLong("run_shell_command", { commandName: "winget", args: ["install", "--id", "Rustlang.Rustup", "-e", "--silent"] });
                    appendLog(log, result);
                } else {
                    var result = await invokeLong("run_shell_command", { commandName: "sh", args: ["-c", "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y"] });
                    appendLog(log, result);
                }
                appendLog(log, "[OK] Rust installation completed.");
            } catch(e) {
                appendLog(log, "[ERROR] Rust installation failed: " + (e.message || e));
            }
        }

        var buildBadge = document.getElementById("chk-build");
        var buildInstalled = buildBadge && buildBadge.classList.contains("status-found");

        if (detectedOS === "windows" && !buildInstalled) {
            appendLog(log, "[INFO] Installing Visual Studio Build Tools...");
            try {
                var result = await invokeLong("run_shell_command", {
                    commandName: "winget",
                    args: ["install", "--id", "Microsoft.VisualStudio.2022.BuildTools", "-e", "--silent", "--override", "--wait --passive --add Microsoft.VisualStudio.Workload.VCTools --includeRecommended"]
                });
                appendLog(log, result);
                appendLog(log, "[OK] Build Tools installation completed.");
            } catch(e) {
                appendLog(log, "[ERROR] Build Tools installation failed: " + (e.message || e));
            }
        } else if (detectedOS === "macos") {
            appendLog(log, "[INFO] Checking Xcode Command Line Tools...");
            try {
                var result = await invokeLong("run_shell_command", { commandName: "xcode-select", args: ["--install"] }, 120000);
                appendLog(log, result || "[OK] Xcode CLT ready.");
            } catch(e) {
                appendLog(log, "[INFO] Xcode CLT may already be installed: " + (e.message || e));
            }
        }

        appendLog(log, "[DONE] All prerequisites ready.");
        document.getElementById("btn-step1-next").disabled = false;
    }

    document.getElementById("btn-step1-next").addEventListener("click", function() { wizardGo(2); });

    // Step 3: Deploy BambooClaw
    document.getElementById("btn-step2-deploy").addEventListener("click", async function() {
        var log = "deploy-log";
        var method = document.getElementById("install-method").value;
        document.getElementById(log).textContent = "";
        this.disabled = true;

        if (method === "binary") {
            appendLog(log, "[INFO] Downloading pre-built binary via release proxy...");
            try {
                // Get release metadata
                appendLog(log, "[INFO] Fetching release metadata...");
                var metaRes = await fetch(PROXY_URL);
                if (!metaRes.ok) throw new Error("Proxy returned " + metaRes.status);
                var meta = await metaRes.json();
                appendLog(log, "[INFO] Latest release: " + (meta.tag_name || "unknown"));

                // Find asset
                var assets = meta.assets || [];
                var assetName = "";
                if (detectedOS === "windows") {
                    var asset = assets.find(function(a) { return a.name.endsWith(".exe"); }) || assets.find(function(a) { return a.name.endsWith(".msi"); });
                    assetName = asset ? asset.name : "";
                } else if (detectedOS === "macos") {
                    var asset = assets.find(function(a) { return a.name.endsWith(".dmg"); }) || assets.find(function(a) { return a.name.includes("macos"); });
                    assetName = asset ? asset.name : "";
                } else {
                    var asset = assets.find(function(a) { return a.name.endsWith(".AppImage"); }) || assets.find(function(a) { return a.name.includes("linux"); });
                    assetName = asset ? asset.name : "";
                }

                if (!assetName) {
                    appendLog(log, "[WARN] No matching asset found. Available: " + assets.map(function(a){return a.name;}).join(", "));
                    appendLog(log, "[INFO] Falling back to build from source...");
                    // Fall through to source build
                } else {
                    appendLog(log, "[INFO] Downloading asset: " + assetName);
                    // Get home dir for dest path
                    var homePath = "~";
                    try {
                        if (detectedOS === "windows") {
                            homePath = (await invokeShort("run_shell_command", { commandName: "cmd", args: ["/C", "echo %USERPROFILE%"] })).trim();
                        } else {
                            homePath = (await invokeShort("run_shell_command", { commandName: "sh", args: ["-c", "echo $HOME"] })).trim();
                        }
                    } catch(e) { /* use ~ fallback */ }

                    var sep = detectedOS === "windows" ? "\\" : "/";
                    var destDir = homePath + sep + ".bambooclaw";
                    var destFile = destDir + sep + (detectedOS === "windows" ? "bambooclaw.exe" : "bambooclaw");

                    // Ensure directory
                    try {
                        if (detectedOS === "windows") {
                            await invokeShort("run_shell_command", { commandName: "cmd", args: ["/C", "mkdir \"" + destDir + "\" 2>nul || echo exists"] });
                        } else {
                            await invokeShort("run_shell_command", { commandName: "mkdir", args: ["-p", destDir] });
                        }
                    } catch(e) { /* dir may already exist */ }

                    appendLog(log, "[INFO] Saving to: " + destFile);
                    var dlUrl = PROXY_URL + "?asset=" + encodeURIComponent(assetName);
                    await invokeLong("download_binary", { url: dlUrl, dest: destFile });
                    appendLog(log, "[OK] Binary downloaded successfully.");

                    // Make executable on unix
                    if (detectedOS !== "windows") {
                        try { await invokeShort("run_shell_command", { commandName: "chmod", args: ["+x", destFile] }); } catch(e) {}
                    }

                    document.getElementById("install-path-display").value = destFile;
                    appendLog(log, "[DONE] BambooClaw deployed.");
                    document.getElementById("btn-step2-next").classList.remove("hidden");
                    return;
                }
            } catch(e) {
                appendLog(log, "[ERROR] Binary download failed: " + (e.message || e));
                appendLog(log, "[INFO] You can try 'Build from Source' instead.");
                this.disabled = false;
                return;
            }
        }

        // Build from source
        appendLog(log, "[INFO] Building from source (this may take several minutes)...");
        try {
            var cargoCmd = detectedOS === "windows"
                ? { commandName: "cmd", args: ["/C", "%USERPROFILE%\\.cargo\\bin\\cargo install --git https://github.com/Enigmara-Technologies/bambooclaw-core --package BambooClawCore --force --locked"] }
                : { commandName: "sh", args: ["-c", "$HOME/.cargo/bin/cargo install --git https://github.com/Enigmara-Technologies/bambooclaw-core --package BambooClawCore --force --locked"] };
            var result = await invokeLong("run_shell_command", cargoCmd);
            appendLog(log, result);
            appendLog(log, "[DONE] BambooClaw built and installed.");
            document.getElementById("btn-step2-next").classList.remove("hidden");
        } catch(e) {
            appendLog(log, "[ERROR] Build failed: " + (e.message || e));
            this.disabled = false;
        }
    });

    document.getElementById("btn-step2-next").addEventListener("click", function() { wizardGo(3); });

    window.enterDashboard = function() {
        try {
            appendLog("boot-log", "[DASH] enterDashboard() called");
            localStorage.setItem("bambooclaw-installed", "true");
            document.getElementById("wizard-view").style.display = "none";
            document.getElementById("dashboard-view").style.display = "block";
            document.getElementById("dashboard-view").classList.remove("hidden");
            loadConfig();
        } catch(e) {
            appendLog("boot-log", "[ERROR] enterDashboard failed: " + (e.message || e));
        }
    };

    document.getElementById("btn-enter-dashboard").addEventListener("click", function() {
        window.enterDashboard();
    });

    // =========== TAB SWITCHING ===========
    document.querySelectorAll(".tab").forEach(function(tab) {
        tab.addEventListener("click", function() {
            var target = this.getAttribute("data-tab");
            document.querySelectorAll(".tab").forEach(function(t) { t.classList.remove("active"); });
            this.classList.add("active");
            document.querySelectorAll(".tab-panel").forEach(function(p) { p.classList.add("hidden"); });
            document.getElementById(target).classList.remove("hidden");
        });
    });

    // =========== LLM PROVIDER MODELS ===========
    var providerModels = {
        openai: ["gpt-4o", "gpt-4o-mini", "gpt-4-turbo", "gpt-3.5-turbo", "o1-preview", "o1-mini"],
        anthropic: ["claude-opus-4-20250514", "claude-sonnet-4-20250514", "claude-3.5-sonnet-20241022", "claude-3-haiku-20240307"],
        google: ["gemini-2.5-pro", "gemini-2.5-flash", "gemini-2.0-flash"],
        groq: ["llama-3.3-70b-versatile", "llama-3.1-8b-instant", "mixtral-8x7b-32768"],
        ollama: ["llama3.2", "mistral", "codellama", "phi3"],
        deepseek: ["deepseek-chat", "deepseek-coder", "deepseek-reasoner"],
        mistral: ["mistral-large-latest", "mistral-medium-latest", "mistral-small-latest", "codestral-latest"]
    };

    var orModels = [];
    var orSortKey = "name";
    var orSortDir = 1;
    var orSelectedModel = "";

    document.getElementById("llm-provider").addEventListener("change", function() {
        var isOR = this.value === "openrouter";
        appendLog("dash-log", "[UI] Provider changed to: " + this.value + ", isOR=" + isOR);
        document.getElementById("llm-model-group").style.display = isOR ? "none" : "block";
        if (isOR) {
            document.getElementById("or-models-area").classList.remove("hidden");
            document.getElementById("or-models-area").style.display = "block";
        } else {
            document.getElementById("or-models-area").classList.add("hidden");
            document.getElementById("or-models-area").style.display = "none";
        }
        if (isOR) {
            // Auto-fetch if we have an API key or even without (public endpoint)
            if (orModels.length === 0) {
                appendLog("dash-log", "[UI] Auto-fetching OpenRouter models...");
                window.fetchORModels();
            }
        } else {
            var models = providerModels[this.value] || [];
            var sel = document.getElementById("llm-model");
            sel.innerHTML = "";
            models.forEach(function(m) {
                var opt = document.createElement("option");
                opt.value = m;
                opt.textContent = m;
                sel.appendChild(opt);
            });
        }
    });

    // Auto-fetch models when API key is pasted while OpenRouter is selected
    document.getElementById("llm-api-key").addEventListener("input", function() {
        var provider = document.getElementById("llm-provider").value;
        if (provider === "openrouter" && this.value.trim().length > 10 && orModels.length === 0) {
            appendLog("dash-log", "[UI] API key entered, auto-fetching OpenRouter models...");
            window.fetchORModels();
        }
    });

    // Trigger initial population
    document.getElementById("llm-provider").dispatchEvent(new Event("change"));

    // =========== LLM CONFIG ===========
    async function applyLLMConfig() {
        appendLog("dash-log", "[LLM] applyLLMConfig() called");
        var provider = document.getElementById("llm-provider").value;
        var apiKey = document.getElementById("llm-api-key").value;
        var model = provider === "openrouter" ? orSelectedModel : document.getElementById("llm-model").value;
        var systemPrompt = document.getElementById("llm-system-prompt").value;
        appendLog("dash-log", "[LLM] provider=" + provider + ", model=" + model + ", hasKey=" + (apiKey.length > 0));

        if (!apiKey.trim() && provider !== "ollama") {
            showToast("API key is required for " + provider, "error");
            appendLog("dash-log", "[LLM] REJECTED: no API key");
            return;
        }
        if (provider === "openrouter" && !model) {
            showToast("Please select a model from the list first", "error");
            appendLog("dash-log", "[LLM] REJECTED: no model selected");
            return;
        }

        currentConfig.llm = { provider: provider, api_key: apiKey, model: model, system_prompt: systemPrompt };
        var tomlContent = buildConfigToml();

        try {
            await invokeShort("write_config", { content: tomlContent });
            showToast("Configuration saved to ~/.bambooclaw/config.toml", "success");
            appendLog("dash-log", "[LLM] Config saved via Tauri");
        } catch(e) {
            localStorage.setItem("bambooclaw-config", JSON.stringify(currentConfig));
            showToast("Configuration saved successfully", "success");
            appendLog("dash-log", "[LLM] Config saved to localStorage (Tauri unavailable)");
        }
    }

    async function testLLMConfig() {
        appendLog("dash-log", "[TEST] testLLMConfig() called");
        var provider = document.getElementById("llm-provider").value;
        var apiKey = document.getElementById("llm-api-key").value.trim();
        if (!apiKey && provider !== "ollama") {
            showToast("Enter an API key first", "error");
            appendLog("dash-log", "[TEST] REJECTED: no API key");
            return;
        }
        showToast("Testing connection...", "info");

        // Direct API validation ‚Äî no CLI needed
        try {
            if (provider === "openrouter") {
                appendLog("dash-log", "[TEST] Calling openrouter.ai/api/v1/models...");
                var resp = await fetch("https://openrouter.ai/api/v1/models", {
                    headers: { "Authorization": "Bearer " + apiKey }
                });
                appendLog("dash-log", "[TEST] OpenRouter response: HTTP " + resp.status);
                if (resp.ok) {
                    showToast("OpenRouter API key is valid!", "success");
                } else {
                    showToast("Invalid API key (HTTP " + resp.status + ")", "error");
                }
            } else if (provider === "ollama") {
                appendLog("dash-log", "[TEST] Calling localhost:11434/api/tags...");
                var resp2 = await fetch("http://localhost:11434/api/tags");
                if (resp2.ok) {
                    showToast("Ollama is running locally!", "success");
                } else {
                    showToast("Ollama not reachable", "error");
                }
            } else {
                showToast("Key saved. Full connection test available when agent daemon is running.", "info");
                appendLog("dash-log", "[TEST] No direct test for provider: " + provider);
            }
        } catch(e) {
            showToast("Connection test error: " + (e.message || e), "error");
            appendLog("dash-log", "[TEST] ERROR: " + (e.message || e));
        }
    }

    // =========== CONFIG SERIALIZATION ===========
    function buildConfigToml() {
        var lines = ["# BambooClaw Agent Configuration", "# Auto-generated by BambooClaw Companion", ""];

        if (currentConfig.llm) {
            lines.push("[llm]");
            lines.push('provider = "' + currentConfig.llm.provider + '"');
            if (currentConfig.llm.api_key) lines.push('api_key = "' + currentConfig.llm.api_key + '"');
            if (currentConfig.llm.model) lines.push('model = "' + currentConfig.llm.model + '"');
            if (currentConfig.llm.system_prompt) lines.push('system_prompt = "' + currentConfig.llm.system_prompt.replace(/"/g, '\\"') + '"');
            lines.push("");
        }

        if (currentConfig.channels) {
            Object.keys(currentConfig.channels).forEach(function(ch) {
                lines.push("[channels." + ch + "]");
                var c = currentConfig.channels[ch];
                Object.keys(c).forEach(function(k) {
                    lines.push(k + ' = "' + c[k] + '"');
                });
                lines.push("");
            });
        }

        if (currentConfig.settings) {
            lines.push("[agent]");
            var s = currentConfig.settings;
            if (s.autonomy) lines.push('autonomy = "' + s.autonomy + '"');
            if (s.port) lines.push("gateway_port = " + s.port);
            if (s.tunnel) lines.push('tunnel = "' + s.tunnel + '"');
            if (s.identity) lines.push('identity = "' + s.identity + '"');
            if (s.runtime) lines.push('runtime = "' + s.runtime + '"');
            if (s.loglevel) lines.push('log_level = "' + s.loglevel + '"');
            lines.push("");
        }

        return lines.join("\n");
    }

    async function loadConfig() {
        try {
            var raw = await invokeShort("read_config");
            showToast("Configuration loaded from disk", "info");
            // Basic TOML parsing for known fields
            parseAndApplyConfig(raw);
        } catch(e) {
            // Try localStorage fallback
            var saved = localStorage.getItem("bambooclaw-config");
            if (saved) {
                try {
                    currentConfig = JSON.parse(saved);
                    applyConfigToUI();
                } catch(e2) {}
            }
        }
    }

    function parseAndApplyConfig(toml) {
        // Very simple TOML parser for our known structure
        var lines = toml.split("\n");
        var section = "";
        lines.forEach(function(line) {
            line = line.trim();
            if (!line || line.startsWith("#")) return;
            var secMatch = line.match(/^\[(.+)\]$/);
            if (secMatch) { section = secMatch[1]; return; }
            var kvMatch = line.match(/^(\w+)\s*=\s*"?([^"]*)"?$/);
            if (kvMatch) {
                var key = kvMatch[1], val = kvMatch[2];
                if (section === "llm") {
                    if (!currentConfig.llm) currentConfig.llm = {};
                    currentConfig.llm[key] = val;
                }
                if (section.startsWith("channels.")) {
                    var ch = section.replace("channels.", "");
                    if (!currentConfig.channels) currentConfig.channels = {};
                    if (!currentConfig.channels[ch]) currentConfig.channels[ch] = {};
                    currentConfig.channels[ch][key] = val;
                }
                if (section === "agent") {
                    if (!currentConfig.settings) currentConfig.settings = {};
                    currentConfig.settings[key] = val;
                }
            }
        });
        applyConfigToUI();
    }

    function applyConfigToUI() {
        if (currentConfig.llm) {
            if (currentConfig.llm.provider) {
                document.getElementById("llm-provider").value = currentConfig.llm.provider;
                document.getElementById("llm-provider").dispatchEvent(new Event("change"));
            }
            if (currentConfig.llm.api_key) document.getElementById("llm-api-key").value = currentConfig.llm.api_key;
            if (currentConfig.llm.model) {
                setTimeout(function() { document.getElementById("llm-model").value = currentConfig.llm.model; }, 50);
            }
            if (currentConfig.llm.system_prompt) document.getElementById("llm-system-prompt").value = currentConfig.llm.system_prompt;
        }
        if (currentConfig.channels) {
            if (currentConfig.channels.telegram) document.getElementById("tg-status").textContent = "Token: " + currentConfig.channels.telegram.token.substring(0, 8) + "...";
            if (currentConfig.channels.discord) document.getElementById("dc-status").textContent = "Token: " + currentConfig.channels.discord.token.substring(0, 8) + "...";
        }
        if (currentConfig.settings) {
            var s = currentConfig.settings;
            if (s.autonomy) document.getElementById("set-autonomy").value = s.autonomy;
            if (s.port || s.gateway_port) document.getElementById("set-port").value = s.port || s.gateway_port;
            if (s.tunnel) document.getElementById("set-tunnel").value = s.tunnel;
            if (s.identity) document.getElementById("set-identity").value = s.identity;
            if (s.runtime) document.getElementById("set-runtime").value = s.runtime;
            if (s.loglevel || s.log_level) document.getElementById("set-loglevel").value = s.loglevel || s.log_level;
        }
    }

    // =========== CHANNEL SETUP ===========
    function closeChannelSetup() {
        appendLog("dash-log", "[CH] closeChannelSetup()");
        document.getElementById("channel-setup-area").classList.add("hidden");
    }

    function setupTelegram() {
        appendLog("dash-log", "[CH] setupTelegram() called");
        var savedToken = (currentConfig.channels && currentConfig.channels.telegram && currentConfig.channels.telegram.token) || "";
        document.getElementById("channel-setup-title").textContent = "Telegram Bot Setup";
        document.getElementById("channel-setup-body").innerHTML =
            '<p style="margin-bottom:1rem;color:var(--text-dim);">1. Open Telegram and talk to <strong>@BotFather</strong><br>2. Send /newbot and follow the prompts<br>3. Copy the bot token and paste it below</p>' +
            '<div class="form-group"><label>Bot Token</label><input type="text" id="tg-token" placeholder="123456:ABC-DEF1234ghIkl..." value="' + savedToken.replace(/"/g, '&quot;') + '" /></div>' +
            '<button class="btn btn-sm" id="btn-save-tg">Save Token</button>' +
            '<button class="btn btn-sm btn-outline" style="margin-left:0.5rem;" id="btn-test-tg">Test</button>';
        document.getElementById("channel-setup-area").classList.remove("hidden");
        document.getElementById("btn-save-tg").addEventListener("click", function() { window.saveTelegramToken(); });
        document.getElementById("btn-test-tg").addEventListener("click", function() { window.testChannel("telegram"); });
        // Try to open BotFather in Telegram
        try {
            if (window.__TAURI__) {
                // Tauri v2: shell.open moved to opener plugin or core
                var opener = (window.__TAURI__.opener && window.__TAURI__.opener.openUrl) || (window.__TAURI__.shell && window.__TAURI__.shell.open);
                if (opener) opener("https://t.me/BotFather");
            }
        } catch(e) {}
    }

    function saveTelegramToken() {
        appendLog("dash-log", "[CH] saveTelegramToken() called");
        var token = document.getElementById("tg-token").value.trim();
        if (!token) { showToast("Please enter a bot token", "error"); return; }
        if (!currentConfig.channels) currentConfig.channels = {};
        currentConfig.channels.telegram = { token: token };
        document.getElementById("tg-status").textContent = "Token: " + token.substring(0, 8) + "...";
        saveAllConfig();
        showToast("Telegram bot token saved", "success");
        closeChannelSetup();
    }

    function setupDiscord() {
        appendLog("dash-log", "[CH] setupDiscord() called");
        var savedToken = (currentConfig.channels && currentConfig.channels.discord && currentConfig.channels.discord.token) || "";
        var savedGuild = (currentConfig.channels && currentConfig.channels.discord && currentConfig.channels.discord.guild_id) || "";
        document.getElementById("channel-setup-title").textContent = "Discord App Setup";
        document.getElementById("channel-setup-body").innerHTML =
            '<p style="margin-bottom:1rem;color:var(--text-dim);">1. Go to <strong>discord.com/developers/applications</strong><br>2. Create a new application ‚Üí Bot ‚Üí Reset Token<br>3. Enable MESSAGE CONTENT INTENT<br>4. Paste the bot token below</p>' +
            '<div class="form-group"><label>Bot Token</label><input type="text" id="dc-token" placeholder="MTA..." value="' + savedToken.replace(/"/g, '&quot;') + '" /></div>' +
            '<div class="form-group"><label>Guild ID (optional)</label><input type="text" id="dc-guild" placeholder="Server ID for slash commands" value="' + savedGuild.replace(/"/g, '&quot;') + '" /></div>' +
            '<button class="btn btn-sm" id="btn-save-dc">Save Token</button>' +
            '<button class="btn btn-sm btn-outline" style="margin-left:0.5rem;" id="btn-test-dc">Test</button>';
        document.getElementById("channel-setup-area").classList.remove("hidden");
        document.getElementById("btn-save-dc").addEventListener("click", function() { window.saveDiscordToken(); });
        document.getElementById("btn-test-dc").addEventListener("click", function() { window.testChannel("discord"); });
    }

    function saveDiscordToken() {
        appendLog("dash-log", "[CH] saveDiscordToken() called");
        var token = document.getElementById("dc-token").value.trim();
        if (!token) { showToast("Please enter a bot token", "error"); return; }
        if (!currentConfig.channels) currentConfig.channels = {};
        currentConfig.channels.discord = { token: token, guild_id: document.getElementById("dc-guild").value.trim() };
        document.getElementById("dc-status").textContent = "Token: " + token.substring(0, 8) + "...";
        saveAllConfig();
        showToast("Discord bot token saved", "success");
        closeChannelSetup();
    }

    function setupWhatsApp() {
        appendLog("dash-log", "[CH] setupWhatsApp() called");
        document.getElementById("channel-setup-title").textContent = "WhatsApp Business Setup";
        document.getElementById("channel-setup-body").innerHTML =
            '<p style="margin-bottom:1rem;color:var(--text-dim);">WhatsApp Business Cloud API requires a Meta Business account and approved app.</p>' +
            '<div class="form-group"><label>Phone Number ID</label><input type="text" id="wa-phone-id" placeholder="From Meta Developer Console" /></div>' +
            '<div class="form-group"><label>Access Token</label><input type="text" id="wa-token" placeholder="EAA..." /></div>' +
            '<div class="form-group"><label>Webhook Verify Token</label><input type="text" id="wa-verify" placeholder="Your custom verify string" /></div>' +
            '<button class="btn btn-sm" id="btn-save-wa">Save Configuration</button>' +
            '<button class="btn btn-sm btn-outline" style="margin-left:0.5rem;" id="btn-test-wa">Test</button>';
        document.getElementById("channel-setup-area").classList.remove("hidden");
        document.getElementById("btn-save-wa").addEventListener("click", function() { window.saveWhatsApp(); });
        document.getElementById("btn-test-wa").addEventListener("click", function() { window.testChannel("whatsapp"); });
    }

    function saveWhatsApp() {
        appendLog("dash-log", "[CH] saveWhatsApp() called");
        var phoneId = document.getElementById("wa-phone-id").value.trim();
        var token = document.getElementById("wa-token").value.trim();
        var verify = document.getElementById("wa-verify").value.trim();
        if (!phoneId || !token) { showToast("Phone Number ID and Access Token are required", "error"); return; }
        if (!currentConfig.channels) currentConfig.channels = {};
        currentConfig.channels.whatsapp = { phone_number_id: phoneId, access_token: token, verify_token: verify };
        document.getElementById("wa-status").textContent = "Phone: " + phoneId;
        saveAllConfig();
        showToast("WhatsApp configuration saved", "success");
        closeChannelSetup();
    }

    function setupSlack() {
        appendLog("dash-log", "[CH] setupSlack() called");
        document.getElementById("channel-setup-title").textContent = "Slack App Setup";
        document.getElementById("channel-setup-body").innerHTML =
            '<p style="margin-bottom:1rem;color:var(--text-dim);">1. Go to <strong>api.slack.com/apps</strong> and create a new app<br>2. Enable Socket Mode and Event Subscriptions<br>3. Add bot scopes: chat:write, app_mentions:read, channels:history</p>' +
            '<div class="form-group"><label>Bot Token</label><input type="text" id="sl-bot-token" placeholder="xoxb-..." /></div>' +
            '<div class="form-group"><label>App Token</label><input type="text" id="sl-app-token" placeholder="xapp-..." /></div>' +
            '<button class="btn btn-sm" id="btn-save-sl">Save Configuration</button>' +
            '<button class="btn btn-sm btn-outline" style="margin-left:0.5rem;" id="btn-test-sl">Test</button>';
        document.getElementById("channel-setup-area").classList.remove("hidden");
        document.getElementById("btn-save-sl").addEventListener("click", function() { window.saveSlack(); });
        document.getElementById("btn-test-sl").addEventListener("click", function() { window.testChannel("slack"); });
    }

    function saveSlack() {
        appendLog("dash-log", "[CH] saveSlack() called");
        var botToken = document.getElementById("sl-bot-token").value.trim();
        var appToken = document.getElementById("sl-app-token").value.trim();
        if (!botToken) { showToast("Bot token is required", "error"); return; }
        if (!currentConfig.channels) currentConfig.channels = {};
        currentConfig.channels.slack = { bot_token: botToken, app_token: appToken };
        document.getElementById("sl-status").textContent = "Token: " + botToken.substring(0, 10) + "...";
        saveAllConfig();
        showToast("Slack configuration saved", "success");
        closeChannelSetup();
    }

    async function testChannel(channel) {
        appendLog("dash-log", "[CH] testChannel(" + channel + ") called");
        showToast("Testing " + channel + " connection...", "info");

        // Direct API validation per channel ‚Äî no CLI needed
        try {
            if (channel === "telegram") {
                var token = currentConfig.channels && currentConfig.channels.telegram && currentConfig.channels.telegram.token;
                if (!token) {
                    // Also try reading directly from the input field if setup panel is open
                    var tgInput = document.getElementById("tg-token");
                    if (tgInput) token = tgInput.value.trim();
                }
                if (!token) { showToast("No Telegram bot token configured. Save a token first.", "error"); return; }
                var resp = await fetch("https://api.telegram.org/bot" + token + "/getMe");
                var data = await resp.json();
                if (data.ok) {
                    showToast("Telegram bot @" + data.result.username + " is valid!", "success");
                    appendLog("dash-log", "[CH] Telegram OK: @" + data.result.username);
                } else {
                    showToast("Invalid Telegram token: " + (data.description || "unknown error"), "error");
                    appendLog("dash-log", "[CH] Telegram FAIL: " + JSON.stringify(data));
                }
            } else if (channel === "discord") {
                var dToken = currentConfig.channels && currentConfig.channels.discord && currentConfig.channels.discord.token;
                if (!dToken) {
                    var dcInput = document.getElementById("dc-token");
                    if (dcInput) dToken = dcInput.value.trim();
                }
                if (!dToken) { showToast("No Discord bot token configured", "error"); return; }
                var dresp = await fetch("https://discord.com/api/v10/users/@me", {
                    headers: { "Authorization": "Bot " + dToken }
                });
                if (dresp.ok) {
                    var ddata = await dresp.json();
                    showToast("Discord bot " + ddata.username + " is valid!", "success");
                    appendLog("dash-log", "[CH] Discord OK: " + ddata.username);
                } else {
                    showToast("Invalid Discord token (HTTP " + dresp.status + ")", "error");
                }
            } else {
                showToast("Configuration saved. Full " + channel + " test available when agent is running.", "info");
                appendLog("dash-log", "[CH] No direct API test for: " + channel);
            }
        } catch(e) {
            showToast(channel + " test error: " + (e.message || e), "error");
            appendLog("dash-log", "[CH] testChannel ERROR: " + (e.message || e));
        }
    }

    // =========== AGENT CONTROL ===========
    async function toggleDaemon() {
        appendLog("dash-log", "[DAEMON] toggleDaemon() called, daemonRunning=" + daemonRunning);

        var btn = document.getElementById("btn-daemon-toggle");
        if (daemonRunning) {
            try {
                appendLog("dash-log", "[DAEMON] Invoking stop_daemon...");
                stopTelegramPolling();
                await invokeShort("stop_daemon");
                daemonRunning = false;
                updateDaemonUI();
                // Update chat area
                var chatEl = document.getElementById("agent-chat-messages");
                if (chatEl) chatEl.innerHTML += '<div class="chat-msg assistant"><span class="role">Agent:</span> Daemon stopped.</div>';
                appendLog("daemon-log", "[INFO] Daemon stopped.");
                appendLog("dash-log", "[DAEMON] Daemon stopped OK");
                showToast("Agent daemon stopped", "info");
            } catch(e) {
                // Process may have already exited ‚Äî treat as stopped
                appendLog("dash-log", "[DAEMON] stop_daemon ERROR: " + (e.message || e));
                stopTelegramPolling();
                daemonRunning = false;
                updateDaemonUI();
                showToast("Daemon process not found (may have already stopped)", "info");
            }
        } else {
            try {
                appendLog("dash-log", "[DAEMON] Invoking start_daemon...");
                await invokeShort("start_daemon");
                daemonRunning = true;
                updateDaemonUI();
                // Update chat area to show daemon is online
                var chatEl = document.getElementById("agent-chat-messages");
                if (chatEl) chatEl.innerHTML = '<div class="chat-msg assistant"><span class="role">Agent:</span> Daemon is online. How can I help you?</div>';
                appendLog("daemon-log", "[INFO] Daemon started.");
                appendLog("dash-log", "[DAEMON] Daemon started OK");
                showToast("Agent daemon started", "success");
                // Start Telegram polling if configured
                startTelegramPolling();
            } catch(e) {
                appendLog("dash-log", "[DAEMON] start_daemon ERROR: " + (e.message || e));
                showToast("Failed to start daemon: " + (e.message || e), "error");
            }
        }
    }

    function updateDaemonUI() {
        var pill = document.getElementById("daemon-status-pill");
        var text = document.getElementById("daemon-status-text");
        var btn = document.getElementById("btn-daemon-toggle");
        if (daemonRunning) {
            pill.className = "status-pill running";
            text.textContent = "Running";
            btn.textContent = "Stop Agent Daemon";
            btn.classList.add("btn-danger");
        } else {
            pill.className = "status-pill stopped";
            text.textContent = "Stopped";
            btn.textContent = "Start Agent Daemon";
            btn.classList.remove("btn-danger");
        }
    }

    async function sendAgentMessage(e) {
        if (e) { e.preventDefault(); e.stopPropagation(); }
        appendLog("dash-log", "[CHAT] sendAgentMessage() called");
        var input = document.getElementById("agent-chat-input");
        var msg = input.value.trim();
        if (!msg) { appendLog("dash-log", "[CHAT] Empty message, ignoring"); return; }
        input.value = "";

        var chatEl = document.getElementById("agent-chat-messages");
        chatEl.innerHTML += '<div class="chat-msg"><span class="role">You:</span> ' + escapeHtml(msg) + '</div>';
        chatEl.scrollTop = chatEl.scrollHeight;

        if (!daemonRunning) {
            chatEl.innerHTML += '<div class="chat-msg assistant"><span class="role">Agent:</span> Daemon is not running. Please start it first.</div>';
            chatEl.scrollTop = chatEl.scrollHeight;
            return;
        }

        // Show typing indicator
        chatEl.innerHTML += '<div class="chat-msg assistant" id="typing-indicator"><span class="role">Agent:</span> <span class="spinner">‚ü≥</span> Thinking...</div>';
        chatEl.scrollTop = chatEl.scrollHeight;

        // Call LLM directly ‚Äî NO Tauri invoke, NO process spawn
        try {
            appendLog("dash-log", "[CHAT] Calling callLLM...");
            var reply = await callLLM(msg);
            var typing = document.getElementById("typing-indicator");
            if (typing) typing.remove();
            chatEl.innerHTML += '<div class="chat-msg assistant"><span class="role">Agent:</span> ' + escapeHtml(reply || "(no response)") + '</div>';
            appendLog("daemon-log", "[CHAT] User: " + msg.substring(0, 50) + " ‚Üí Reply: " + (reply || "").substring(0, 80));
        } catch(err) {
            var typing = document.getElementById("typing-indicator");
            if (typing) typing.remove();
            chatEl.innerHTML += '<div class="chat-msg assistant"><span class="role">Agent:</span> Error: ' + escapeHtml(err.message || String(err)) + '</div>';
            appendLog("dash-log", "[CHAT] LLM error: " + (err.message || err));
            appendLog("daemon-log", "[ERROR] Chat LLM call failed: " + (err.message || err));
        }
        chatEl.scrollTop = chatEl.scrollHeight;
        return false;
    }

    // =========== DIRECT LLM CALL ===========
    var chatHistory = [];

    async function callLLM(userMessage) {
        appendLog("dash-log", "[LLM-CALL] callLLM() msg=" + userMessage.substring(0, 50));
        var cfg = currentConfig.llm;
        if (!cfg || !cfg.api_key) throw new Error("No LLM configured. Go to LLM Settings and apply a configuration.");

        chatHistory.push({ role: "user", content: userMessage });
        // Keep last 20 messages
        if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);

        var provider = cfg.provider;
        var model = cfg.model;
        var apiKey = cfg.api_key;
        var systemPrompt = cfg.system_prompt || "You are BambooClaw, an AI agent. Be helpful and concise.";

        var apiUrl, headers, body;

        if (provider === "openrouter") {
            apiUrl = "https://openrouter.ai/api/v1/chat/completions";
            headers = { "Authorization": "Bearer " + apiKey, "Content-Type": "application/json", "HTTP-Referer": "https://bambooclaw.com" };
        } else if (provider === "openai") {
            apiUrl = "https://api.openai.com/v1/chat/completions";
            headers = { "Authorization": "Bearer " + apiKey, "Content-Type": "application/json" };
        } else if (provider === "anthropic") {
            apiUrl = "https://api.anthropic.com/v1/messages";
            headers = { "x-api-key": apiKey, "Content-Type": "application/json", "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" };
        } else if (provider === "google") {
            apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/" + model + ":generateContent?key=" + apiKey;
            headers = { "Content-Type": "application/json" };
        } else if (provider === "groq") {
            apiUrl = "https://api.groq.com/openai/v1/chat/completions";
            headers = { "Authorization": "Bearer " + apiKey, "Content-Type": "application/json" };
        } else if (provider === "deepseek") {
            apiUrl = "https://api.deepseek.com/v1/chat/completions";
            headers = { "Authorization": "Bearer " + apiKey, "Content-Type": "application/json" };
        } else if (provider === "mistral") {
            apiUrl = "https://api.mistral.ai/v1/chat/completions";
            headers = { "Authorization": "Bearer " + apiKey, "Content-Type": "application/json" };
        } else if (provider === "ollama") {
            apiUrl = "http://localhost:11434/api/chat";
            headers = { "Content-Type": "application/json" };
        } else {
            throw new Error("Unsupported provider: " + provider);
        }

        var messages = [{ role: "system", content: systemPrompt }].concat(chatHistory);

        // Anthropic uses a different format
        if (provider === "anthropic") {
            body = JSON.stringify({ model: model, max_tokens: 1024, system: systemPrompt, messages: chatHistory });
        } else if (provider === "google") {
            body = JSON.stringify({ contents: [{ parts: [{ text: userMessage }] }] });
        } else if (provider === "ollama") {
            body = JSON.stringify({ model: model, messages: messages, stream: false });
        } else {
            body = JSON.stringify({ model: model, messages: messages });
        }

        appendLog("dash-log", "[LLM-CALL] Calling " + provider + " / " + model);
        var resp = await fetch(apiUrl, { method: "POST", headers: headers, body: body });
        if (!resp.ok) {
            var errText = await resp.text();
            appendLog("dash-log", "[LLM-CALL] ERROR HTTP " + resp.status + ": " + errText.substring(0, 200));
            throw new Error("LLM API error (HTTP " + resp.status + ")");
        }
        var data = await resp.json();

        var reply = "";
        if (provider === "anthropic") {
            reply = data.content && data.content[0] && data.content[0].text || "(empty)";
        } else if (provider === "google") {
            reply = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text || "(empty)";
        } else if (provider === "ollama") {
            reply = data.message && data.message.content || "(empty)";
        } else {
            reply = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content || "(empty)";
        }

        chatHistory.push({ role: "assistant", content: reply });
        appendLog("dash-log", "[LLM-CALL] Got reply: " + reply.substring(0, 80) + "...");
        return reply;
    }

    // =========== TELEGRAM POLLING ===========
    var tgPollingInterval = null;
    var tgLastUpdateId = 0;

    function startTelegramPolling() {
        if (tgPollingInterval) return; // already polling
        var token = currentConfig.channels && currentConfig.channels.telegram && currentConfig.channels.telegram.token;
        if (!token) {
            appendLog("dash-log", "[TG-POLL] No Telegram token configured, skipping polling");
            return;
        }
        appendLog("dash-log", "[TG-POLL] Starting Telegram polling...");
        appendLog("daemon-log", "[INFO] Telegram polling started for incoming messages.");
        tgPollingInterval = setInterval(function() { pollTelegram(); }, 3000);
        // Poll immediately
        pollTelegram();
    }

    function stopTelegramPolling() {
        if (tgPollingInterval) {
            clearInterval(tgPollingInterval);
            tgPollingInterval = null;
            appendLog("dash-log", "[TG-POLL] Telegram polling stopped");
        }
    }

    async function pollTelegram() {
        var token = currentConfig.channels && currentConfig.channels.telegram && currentConfig.channels.telegram.token;
        if (!token || !daemonRunning) return;

        try {
            var url = "https://api.telegram.org/bot" + token + "/getUpdates?offset=" + (tgLastUpdateId + 1) + "&timeout=1&allowed_updates=[%22message%22]";
            var resp = await fetch(url);
            if (!resp.ok) return;
            var data = await resp.json();
            if (!data.ok || !data.result || data.result.length === 0) return;

            for (var i = 0; i < data.result.length; i++) {
                var update = data.result[i];
                tgLastUpdateId = update.update_id;
                if (update.message && update.message.text) {
                    var chatId = update.message.chat.id;
                    var text = update.message.text;
                    var from = update.message.from && update.message.from.first_name || "User";
                    appendLog("daemon-log", "[TELEGRAM] Message from " + from + ": " + text);
                    appendLog("dash-log", "[TG-POLL] Received: " + text.substring(0, 50));

                    // Get LLM reply
                    try {
                        var reply = await callLLM(text);
                        // Send reply back to Telegram
                        await fetch("https://api.telegram.org/bot" + token + "/sendMessage", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ chat_id: chatId, text: reply })
                        });
                        appendLog("daemon-log", "[TELEGRAM] Replied to " + from + ": " + reply.substring(0, 80));
                    } catch(e) {
                        appendLog("daemon-log", "[TELEGRAM] LLM error: " + (e.message || e));
                        // Send error message to user
                        await fetch("https://api.telegram.org/bot" + token + "/sendMessage", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ chat_id: chatId, text: "Sorry, I encountered an error: " + (e.message || "unknown") })
                        });
                    }
                }
            }
        } catch(e) {
            appendLog("dash-log", "[TG-POLL] Error: " + (e.message || e));
        }
    }

    function escapeHtml(str) {
        return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    // =========== SETTINGS ===========
    async function saveSettings() {
        appendLog("dash-log", "[SETTINGS] saveSettings() called");
        currentConfig.settings = {
            autonomy: document.getElementById("set-autonomy").value,
            port: document.getElementById("set-port").value,
            tunnel: document.getElementById("set-tunnel").value,
            identity: document.getElementById("set-identity").value,
            runtime: document.getElementById("set-runtime").value,
            loglevel: document.getElementById("set-loglevel").value,
        };
        saveAllConfig();
        showToast("Settings saved", "success");
    }

    function resetSettings() {
        appendLog("dash-log", "[SETTINGS] resetSettings() called");
        document.getElementById("set-autonomy").value = "collaborative";
        document.getElementById("set-port").value = "7331";
        document.getElementById("set-tunnel").value = "none";
        document.getElementById("set-identity").value = "bamboo";
        document.getElementById("set-runtime").value = "native";
        document.getElementById("set-loglevel").value = "info";
        showToast("Settings reset to defaults", "info");
    }

    // =========== SAVE ALL ===========
    async function saveAllConfig() {
        var toml = buildConfigToml();
        try {
            await invokeShort("write_config", { content: toml });
        } catch(e) {
            localStorage.setItem("bambooclaw-config", JSON.stringify(currentConfig));
        }
    }

    // =========== OPENROUTER MODEL FETCHING ===========
    function formatPrice(perToken) {
        var val = perToken * 1000000;
        if (val === 0) return "Free";
        if (val < 0.01) return "<$0.01";
        return "$" + val.toFixed(2);
    }

    window.fetchORModels = function() {
        appendLog("dash-log", "[OR] fetchORModels() called");
        var listEl = document.getElementById("or-model-list");
        if (!listEl) { appendLog("dash-log", "[OR] ERROR: or-model-list element not found!"); return; }
        listEl.innerHTML = '<div style="padding:1rem;text-align:center;color:var(--text-dim);"><span class="spinner">‚ü≥</span> Loading models from OpenRouter...</div>';
        var fetchBtn = document.getElementById("btn-fetch-models");
        if (fetchBtn) fetchBtn.disabled = true;

        appendLog("dash-log", "[OR] Fetching https://openrouter.ai/api/v1/models ...");
        fetch("https://openrouter.ai/api/v1/models", {
            headers: { "Content-Type": "application/json" }
        })
        .then(function(r) {
            appendLog("dash-log", "[OR] Response status: " + r.status);
            if (!r.ok) throw new Error("HTTP " + r.status);
            return r.json();
        })
        .then(function(data) {
            appendLog("dash-log", "[OR] Raw models count: " + (data.data ? data.data.length : 0));
            orModels = (data.data || []).filter(function(m) {
                return m.name && m.pricing;
            }).map(function(m) {
                return {
                    id: m.id,
                    name: m.name,
                    input: parseFloat(m.pricing.prompt || "0"),
                    output: parseFloat(m.pricing.completion || "0"),
                    context: m.context_length || 0
                };
            });
            appendLog("dash-log", "[OR] Filtered models: " + orModels.length);
            document.getElementById("or-model-count").textContent = "(" + orModels.length + " available)";
            renderORModels();
            showToast("Loaded " + orModels.length + " models from OpenRouter", "success");
            if (fetchBtn) fetchBtn.disabled = false;
        })
        .catch(function(e) {
            appendLog("dash-log", "[OR] FETCH ERROR: " + (e.message || String(e)));
            listEl.innerHTML = '<div style="padding:1rem;color:var(--error);text-align:center;">Failed to load models: ' + escapeHtml(e.message || String(e)) + '</div>';
            showToast("Failed to fetch models", "error");
            if (fetchBtn) fetchBtn.disabled = false;
        });
    };

    window.sortORModels = function(key) {
        if (orSortKey === key) { orSortDir *= -1; } else { orSortKey = key; orSortDir = 1; }
        renderORModels();
    };

    window.selectORModel = function(id) {
        orSelectedModel = id;
        var m = orModels.find(function(x) { return x.id === id; });
        document.getElementById("or-selected-display").textContent = "Selected: " + (m ? m.name + " (" + m.id + ")" : id);
        // Also set the hidden select so config builder picks it up
        var sel = document.getElementById("llm-model");
        sel.innerHTML = "";
        var opt = document.createElement("option");
        opt.value = id;
        opt.textContent = m ? m.name : id;
        sel.appendChild(opt);
        sel.value = id;
        renderORModels();
    };

    function renderORModels() {
        var search = (document.getElementById("or-model-search").value || "").toLowerCase();
        var filtered = orModels.filter(function(m) {
            return m.id.toLowerCase().indexOf(search) >= 0 || m.name.toLowerCase().indexOf(search) >= 0;
        });
        filtered.sort(function(a, b) {
            var cmp = 0;
            if (orSortKey === "name") cmp = a.name.localeCompare(b.name);
            else if (orSortKey === "input") cmp = a.input - b.input;
            else if (orSortKey === "output") cmp = a.output - b.output;
            return cmp * orSortDir;
        });

        var html = '<table style="width:100%;border-collapse:collapse;font-size:0.8rem;">';
        html += '<thead><tr style="background:#1a1a2e;position:sticky;top:0;">';
        html += '<th style="text-align:left;padding:0.5rem 0.75rem;">Model</th>';
        html += '<th style="text-align:right;padding:0.5rem 0.75rem;white-space:nowrap;">Input/1M</th>';
        html += '<th style="text-align:right;padding:0.5rem 0.75rem;white-space:nowrap;">Output/1M</th>';
        html += '</tr></thead><tbody>';

        filtered.forEach(function(m) {
            var sel = m.id === orSelectedModel;
            var bg = sel ? "background:rgba(16,185,129,0.15);border-left:3px solid var(--accent);" : "border-left:3px solid transparent;";
            html += '<tr data-model-id="' + escapeHtml(m.id) + '" style="cursor:pointer;border-bottom:1px solid var(--border);' + bg + '" class="or-model-row">';
            html += '<td style="padding:0.5rem 0.75rem;"><div style="font-weight:600;' + (sel ? 'color:var(--accent);' : '') + '">' + escapeHtml(m.name) + '</div><div style="color:var(--text-dim);font-size:0.7rem;">' + escapeHtml(m.id) + '</div></td>';
            html += '<td style="text-align:right;padding:0.5rem 0.75rem;font-family:monospace;color:var(--text-dim);">' + formatPrice(m.input) + '</td>';
            html += '<td style="text-align:right;padding:0.5rem 0.75rem;font-family:monospace;color:var(--text-dim);">' + formatPrice(m.output) + '</td>';
            html += '</tr>';
        });

        if (filtered.length === 0) {
            html += '<tr><td colspan="3" style="padding:1.5rem;text-align:center;color:var(--text-dim);">No models found</td></tr>';
        }
        html += '</tbody></table>';
        document.getElementById("or-model-list").innerHTML = html;
    }

    // Event delegation for model row clicks
    document.getElementById("or-model-list").addEventListener("click", function(e) {
        var row = e.target.closest ? e.target.closest(".or-model-row") : null;
        if (!row) {
            // Fallback for older browsers
            var el = e.target;
            while (el && el !== this) {
                if (el.classList && el.classList.contains("or-model-row")) { row = el; break; }
                el = el.parentElement;
            }
        }
        if (row) {
            var id = row.getAttribute("data-model-id");
            if (id) window.selectORModel(id);
        }
    });

    // Search filter
    document.getElementById("or-model-search").addEventListener("input", function() {
        renderORModels();
    });

    // Sort buttons
    document.getElementById("or-sort-name").addEventListener("click", function() { window.sortORModels("name"); });
    document.getElementById("or-sort-input").addEventListener("click", function() { window.sortORModels("input"); });
    document.getElementById("or-sort-output").addEventListener("click", function() { window.sortORModels("output"); });
    document.getElementById("btn-fetch-models").addEventListener("click", function() { window.fetchORModels(); });

    // =========== GLOBAL FUNCTION EXPOSURE ===========
    // All functions used in onclick handlers MUST be on window for Tauri webview compatibility
    window.copyLog = copyLog;
    window.wizardGo = wizardGo;
    window.applyLLMConfig = applyLLMConfig;
    window.testLLMConfig = testLLMConfig;
    window.setupTelegram = setupTelegram;
    window.setupDiscord = setupDiscord;
    window.setupWhatsApp = setupWhatsApp;
    window.setupSlack = setupSlack;
    window.closeChannelSetup = closeChannelSetup;
    window.saveTelegramToken = saveTelegramToken;
    window.saveDiscordToken = saveDiscordToken;
    window.saveWhatsApp = saveWhatsApp;
    window.saveSlack = saveSlack;
    window.testChannel = testChannel;
    window.toggleDaemon = toggleDaemon;
    window.sendAgentMessage = sendAgentMessage;
    window.saveSettings = saveSettings;
    window.resetSettings = resetSettings;
    window.escapeHtml = escapeHtml;

    // =========== BUTTON addEventListener BINDINGS (all buttons, no onclick) ===========
    document.getElementById("btn-apply-llm").addEventListener("click", function() { appendLog("dash-log", "[BTN] btn-apply-llm clicked"); applyLLMConfig(); });
    document.getElementById("btn-test-llm").addEventListener("click", function() { appendLog("dash-log", "[BTN] btn-test-llm clicked"); testLLMConfig(); });
    document.getElementById("btn-setup-tg").addEventListener("click", function() { appendLog("dash-log", "[BTN] btn-setup-tg clicked"); setupTelegram(); });
    document.getElementById("btn-setup-dc").addEventListener("click", function() { appendLog("dash-log", "[BTN] btn-setup-dc clicked"); setupDiscord(); });
    document.getElementById("btn-setup-wa").addEventListener("click", function() { appendLog("dash-log", "[BTN] btn-setup-wa clicked"); setupWhatsApp(); });
    document.getElementById("btn-setup-sl").addEventListener("click", function() { appendLog("dash-log", "[BTN] btn-setup-sl clicked"); setupSlack(); });
    document.getElementById("btn-close-channel").addEventListener("click", function() { appendLog("dash-log", "[BTN] btn-close-channel clicked"); closeChannelSetup(); });
    document.getElementById("btn-daemon-toggle").addEventListener("click", function() { appendLog("dash-log", "[BTN] btn-daemon-toggle clicked"); toggleDaemon(); });
    document.getElementById("btn-send-chat").addEventListener("click", function(e) { e.preventDefault(); e.stopPropagation(); appendLog("dash-log", "[BTN] btn-send-chat clicked"); sendAgentMessage(e); return false; });
    document.getElementById("agent-chat-input").addEventListener("keydown", function(e) { if (e.key === "Enter") { e.preventDefault(); e.stopPropagation(); appendLog("dash-log", "[BTN] chat Enter key"); sendAgentMessage(e); return false; } });
    document.getElementById("btn-save-settings").addEventListener("click", function() { appendLog("dash-log", "[BTN] btn-save-settings clicked"); saveSettings(); });
    document.getElementById("btn-reset-settings").addEventListener("click", function() { appendLog("dash-log", "[BTN] btn-reset-settings clicked"); resetSettings(); });

    // =========== VERSION FETCH ===========
    async function fetchVersion() {
        try {
            appendLog("boot-log", "[BOOT] fetchVersion: fetching from release proxy...");
            var resp = await fetch(PROXY_URL + "?action=latest");
            if (!resp.ok) throw new Error("HTTP " + resp.status);
            var data = await resp.json();
            var ver = data.tag_name || "v-unknown";
            var el = document.getElementById("app-version");
            if (el) el.textContent = ver;
            appendLog("boot-log", "[BOOT] fetchVersion: resolved -> " + ver);
        } catch(e) {
            var el = document.getElementById("app-version");
            if (el) el.textContent = "v-offline";
            appendLog("boot-log", "[BOOT] fetchVersion: ERROR -> " + (e.message || e));
        }
    }

    // =========== STARTUP ===========
    function boot() {
        try {
            var installedFlag = localStorage.getItem("bambooclaw-installed");
            appendLog("boot-log", "[BOOT] boot(): localStorage bambooclaw-installed = " + JSON.stringify(installedFlag));
            // Fire version fetch (non-blocking)
            fetchVersion();
            if (installedFlag === "true") {
                appendLog("boot-log", "[BOOT] boot(): entering dashboard (already installed)");
                window.enterDashboard();
                // Auto-save default settings if not set
                if (!currentConfig.settings) {
                    currentConfig.settings = {
                        autonomy: "autonomous",
                        port: "7331",
                        tunnel: "none",
                        identity: "bamboo",
                        runtime: "native",
                        loglevel: "info"
                    };
                    saveAllConfig();
                    appendLog("dash-log", "[BOOT] Auto-saved default settings");
                }
                // Auto-start daemon if LLM is configured and daemon not running
                setTimeout(function() {
                    if (currentConfig.llm && currentConfig.llm.api_key && !daemonRunning) {
                        appendLog("dash-log", "[BOOT] Auto-starting daemon (LLM configured)...");
                        toggleDaemon();
                    }
                }, 500);
            } else {
                appendLog("boot-log", "[BOOT] boot(): calling runSystemChecks()");
                runSystemChecks();
            }
        } catch(e) {
            appendLog("boot-log", "[FATAL] boot() crashed: " + (e.message || e));
        }
    }

    (function waitForTauri() {
        try {
            appendLog("boot-log", "[BOOT] waitForTauri: polling started at " + new Date().toISOString());
            var startTime = Date.now();
            var waited = 0;
            var interval = setInterval(function() {
                waited += 50;
                if (window.__TAURI__) {
                    clearInterval(interval);
                    appendLog("boot-log", "[BOOT] waitForTauri: __TAURI__ found after " + (Date.now() - startTime) + "ms");
                    boot();
                } else if (waited >= 3000) {
                    clearInterval(interval);
                    appendLog("boot-log", "[BOOT] waitForTauri: timeout after " + (Date.now() - startTime) + "ms, proceeding WITHOUT __TAURI__");
                    boot();
                }
            }, 50);
        } catch(e) {
            appendLog("boot-log", "[FATAL] waitForTauri crashed: " + (e.message || e));
        }
    })();
    </script>

    <!-- SCRIPT 3: VERIFICATION ‚Äî confirms Script 2 parsed successfully -->
    <script>
    (function() {
        try {
            var el = document.getElementById("boot-log");
            if (typeof boot === "undefined") {
                if (el) el.textContent += "[FATAL] Script 2 failed to parse. The boot() function does not exist. Check console for syntax errors.\n";
            } else {
                if (el) el.textContent += "[VERIFY] Script 2 parsed OK. boot() is defined.\n";
            }
        } catch(e) {
            var el2 = document.getElementById("boot-log");
            if (el2) el2.textContent += "[VERIFY] Error during verification: " + e.message + "\n";
        }
    })();
    </script>
</body>
</html>