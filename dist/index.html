<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BambooClaw Companion</title>
    <style>
        :root {
            --bg-color: #0a0a0f;
            --card-bg: #1a1a2e;
            --card-bg-glass: rgba(26, 26, 46, 0.7);
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0b0;
            --accent: #10b981; /* Emerald */
            --accent-hover: #059669;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: rgba(255, 255, 255, 0.1);
            --border-glass: rgba(255, 255, 255, 0.05);
            --radius: 12px;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-accent { color: var(--accent); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-bold { font-weight: 700; }

        /* Layout */
        #app-container {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .glass-panel {
            background: var(--card-bg-glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            width: 100%;
            max-width: 900px;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: rgba(10, 10, 15, 0.8);
            border-bottom: 1px solid var(--border);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .brand svg { width: 32px; height: 32px; fill: var(--accent); }

        /* Wizard Steps */
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #333;
            transition: all 0.3s;
        }

        .step-dot.active { background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .step-dot.completed { background: var(--accent); opacity: 0.5; }

        /* Step 1: System Check */
        .check-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .check-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: #333;
            color: #aaa;
            min-width: 80px;
            text-align: center;
        }

        .status-badge.success { background: rgba(16, 185, 129, 0.2); color: var(--accent); }
        .status-badge.warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .status-badge.error { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .status-badge.detecting { color: #888; font-style: italic; }

        /* Step 2: Install */
        .log-panel {
            flex: 1;
            background: #0d0d12;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 1rem;
            position: relative;
            min-height: 200px;
            max-height: 300px;
        }

        .log-line { margin-bottom: 4px; }
        .log-info { color: #60a5fa; }
        .log-skip { color: #f59e0b; }
        .log-success { color: var(--accent); }
        .log-error { color: var(--danger); }
        .log-cmd { color: #a78bfa; font-weight: bold; }

        .copy-log-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            color: #fff;
            font-size: 0.75rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .copy-log-btn:hover { opacity: 1; background: var(--accent); }

        .install-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .option-card {
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .option-card:hover { border-color: var(--text-secondary); }
        .option-card.selected { border-color: var(--accent); background: rgba(16, 185, 129, 0.1); }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Dashboard Tabs */
        .dashboard-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tab-btn:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }
        .tab-btn.active { color: var(--accent); background: rgba(16, 185, 129, 0.1); }

        .tab-content { display: none; flex-direction: column; gap: 1.5rem; overflow-y: auto; }
        .tab-content.active { display: flex; }

        /* Forms */
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group label { font-size: 0.875rem; color: var(--text-secondary); }
        
        input, select, textarea {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            color: var(--text-primary);
            font-family: inherit;
            width: 100%;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: #fff;
        }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .wizard-controls {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* Dashboard Widgets */
        .widget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .chat-box {
            height: 300px;
            background: #000;
            border-radius: 8px;
            padding: 1rem;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .chat-msg { margin-bottom: 0.5rem; }
        .chat-msg.user { color: var(--accent); text-align: right; }
        .chat-msg.agent { color: var(--text-primary); text-align: left; }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(26px); }

    </style>
</head>
<body>

    <header>
        <div class="brand">
            <!-- SVG Icon -->
            <svg viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
            </svg>
            <span>BambooClaw</span>
        </div>
        <div id="header-status" class="text-sm text-secondary">Initializing...</div>
    </header>

    <div id="app-container">
        
        <!-- Installer Wizard -->
        <div id="installer-view" class="glass-panel hidden">
            
            <div class="step-indicator">
                <div class="step-dot active" id="dot-1"></div>
                <div class="step-dot" id="dot-2"></div>
                <div class="step-dot" id="dot-3"></div>
                <div class="step-dot" id="dot-4"></div>
            </div>

            <!-- Step 1: System Check -->
            <div id="step-1" class="step-content h-full flex-col">
                <h2 class="font-bold text-accent" style="margin-bottom: 1.5rem;">System Compatibility Check</h2>
                <p class="text-sm text-secondary" style="margin-bottom: 1rem;">Analyzing your environment to ensure optimal performance.</p>
                
                <div class="check-list">
                    <div class="check-item">
                        <span>Operating System</span>
                        <span id="status-os" class="status-badge detecting">Detecting...</span>
                    </div>
                    <div class="check-item">
                        <span>Rust Toolchain (rustc)</span>
                        <span id="status-rust" class="status-badge detecting">Detecting...</span>
                    </div>
                    <div class="check-item">
                        <span>Go Compiler (go)</span>
                        <span id="status-go" class="status-badge detecting">Detecting...</span>
                    </div>
                    <div class="check-item">
                        <span>Package Manager</span>
                        <span id="status-pkg" class="status-badge detecting">Detecting...</span>
                    </div>
                </div>

                <div class="wizard-controls" style="border:none; padding-top:0;">
                    <div></div>
                    <button id="btn-step-1-next" class="btn btn-primary" disabled>Next: Install Prerequisites</button>
                </div>
            </div>

            <!-- Step 2: Install Prerequisites -->
            <div id="step-2" class="step-content hidden h-full flex-col">
                <h2 class="font-bold text-accent" style="margin-bottom: 1rem;">Installing Prerequisites</h2>
                
                <div class="log-panel" id="install-log-1">
                    <button class="copy-log-btn" onclick="copyLog('install-log-1')">Copy Log</button>
                    <span class="log-line text-secondary">Waiting to start...</span>
                </div>

                <div class="wizard-controls" style="border:none; padding-top:0;">
                    <button id="btn-step-2-back" class="btn btn-secondary">Back</button>
                    <button id="btn-step-2-next" class="btn btn-primary" disabled>Next: Install BambooClaw</button>
                </div>
            </div>

            <!-- Step 3: Install BambooClaw -->
            <div id="step-3" class="step-content hidden h-full flex-col">
                <h2 class="font-bold text-accent" style="margin-bottom: 1rem;">Install BambooClaw Core</h2>

                <div class="install-options">
                    <div class="option-card selected" id="opt-download" onclick="selectInstallOption('download')">
                        <div class="font-bold">Download Pre-built</div>
                        <div class="text-xs text-secondary">Fastest, no compiler needed</div>
                    </div>
                    <div class="option-card" id="opt-build" onclick="selectInstallOption('build')">
                        <div class="font-bold">Build from Source</div>
                        <div class="text-xs text-secondary">Requires Cargo/Rust</div>
                    </div>
                </div>

                <div class="log-panel" id="install-log-2">
                    <button class="copy-log-btn" onclick="copyLog('install-log-2')">Copy Log</button>
                    <span class="log-line text-secondary">Select an option and click Install...</span>
                </div>

                <div class="wizard-controls" style="border:none; padding-top:0;">
                    <button id="btn-step-3-back" class="btn btn-secondary">Back</button>
                    <button id="btn-step-3-install" class="btn btn-primary">Install</button>
                    <button id="btn-step-3-next" class="btn btn-primary hidden">Next: Finalize</button>
                </div>
            </div>

            <!-- Step 4: Finalization -->
            <div id="step-4" class="step-content hidden h-full flex-col items-center justify-center text-center">
                <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸŽ‰</div>
                <h2 class="font-bold text-accent" style="font-size: 1.5rem; margin-bottom: 0.5rem;">Installation Complete!</h2>
                <p class="text-secondary" style="margin-bottom: 2rem;">BambooClaw Core has been successfully installed.</p>
                
                <div class="widget-grid w-full" style="margin-bottom: 2rem;">
                    <div class="glass-panel" style="padding: 1rem;">
                        <div class="text-xs text-secondary">Installed Version</div>
                        <div id="final-version" class="font-bold text-accent">v0.0.0</div>
                    </div>
                    <div class="glass-panel" style="padding: 1rem;">
                        <div class="text-xs text-secondary">Platform</div>
                        <div id="final-platform" class="font-bold">Unknown</div>
                    </div>
                </div>

                <button id="btn-finish" class="btn btn-primary" style="width: 200px;">Open Dashboard</button>
            </div>

        </div>

        <!-- Companion Dashboard -->
        <div id="dashboard-view" class="glass-panel hidden">
            <div class="dashboard-nav">
                <button class="tab-btn active" onclick="switchTab('llm')">LLM Configuration</button>
                <button class="tab-btn" onclick="switchTab('channels')">Channel Setup</button>
                <button class="tab-btn" onclick="switchTab('control')">Agent Control</button>
                <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
            </div>

            <!-- Tab 1: LLM -->
            <div id="tab-llm" class="tab-content active">
                <div class="widget-grid">
                    <div class="form-group">
                        <label>Provider</label>
                        <select id="conf-provider">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google Gemini</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="ollama">Ollama (Local)</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="groq">Groq</option>
                            <option value="mistral">Mistral</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Model Name</label>
                        <input type="text" id="conf-model" placeholder="e.g. gpt-4-turbo">
                    </div>
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="conf-api-key" placeholder="sk-...">
                </div>
                <div class="widget-grid">
                    <div class="form-group">
                        <label>Memory Backend</label>
                        <select id="conf-memory">
                            <option value="redis">Redis</option>
                            <option value="sqlite">SQLite</option>
                            <option value="memory">In-Memory</option>
                        </select>
                    </div>
                    <div class="form-group" style="justify-content: flex-end;">
                        <button class="btn btn-secondary w-full" onclick="testLLM()">Test Configuration</button>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveConfig()">Save Configuration</button>
            </div>

            <!-- Tab 2: Channels -->
            <div id="tab-channels" class="tab-content">
                <div class="widget-grid">
                    <div class="glass-panel" style="padding: 1rem;">
                        <h3 class="font-bold text-accent">Telegram</h3>
                        <p class="text-xs text-secondary mb-2">Link to @BotFather to create a bot.</p>
                        <input type="text" placeholder="Bot Token" id="chan-telegram-token">
                        <button class="btn btn-secondary mt-2" onclick="testChannel('telegram')">Test Telegram</button>
                    </div>
                    <div class="glass-panel" style="padding: 1rem;">
                        <h3 class="font-bold text-accent">Discord</h3>
                        <p class="text-xs text-secondary mb-2">Bot token from Discord Developer Portal.</p>
                        <input type="text" placeholder="Bot Token" id="chan-discord-token">
                        <button class="btn btn-secondary mt-2" onclick="testChannel('discord')">Test Discord</button>
                    </div>
                </div>
                <!-- Additional channels omitted for brevity, structure follows -->
                <div class="glass-panel" style="padding: 1rem;">
                    <h3 class="font-bold text-accent">Slack</h3>
                    <p class="text-xs text-secondary mb-2">Paste App Manifest JSON or Token.</p>
                    <textarea rows="3" placeholder='{"token": "..."}' id="chan-slack-config"></textarea>
                    <button class="btn btn-secondary mt-2" onclick="testChannel('slack')">Test Slack</button>
                </div>
            </div>

            <!-- Tab 3: Agent Control -->
            <div id="tab-control" class="tab-content">
                <div class="flex items-center justify-between glass-panel p-4">
                    <div>
                        <div class="font-bold">BambooClaw Daemon</div>
                        <div id="daemon-status" class="text-xs text-secondary">Stopped</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="daemon-toggle" onchange="toggleDaemon()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="widget-grid">
                    <div class="glass-panel flex-col" style="padding: 1rem; min-height: 200px;">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-sm">Interactive Chat</span>
                            <button class="btn btn-secondary text-xs" onclick="clearChat()">Clear</button>
                        </div>
                        <div class="chat-box" id="live-chat">
                            <div class="chat-msg agent">System: Ready.</div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <input type="text" id="chat-input" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendChat()">
                            <button class="btn btn-primary" onclick="sendChat()">Send</button>
                        </div>
                    </div>
                    <div class="glass-panel flex-col" style="padding: 1rem;">
                        <span class="font-bold text-sm mb-2">Live Logs</span>
                        <div class="log-panel" id="daemon-logs" style="flex: 1; min-height: 150px;"></div>
                        <button class="btn btn-secondary text-xs mt-2" onclick="copyLog('daemon-logs')">Copy Logs</button>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Settings -->
            <div id="tab-settings" class="tab-content">
                <div class="form-group">
                    <label>Autonomy Level (0-10)</label>
                    <input type="range" id="set-autonomy" min="0" max="10" value="5">
                </div>
                <div class="form-group">
                    <label>Gateway Port</label>
                    <input type="number" id="set-port" value="8080">
                </div>
                <div class="form-group">
                    <label>Identity Format</label>
                    <select id="set-identity">
                        <option value="uuid">UUID</option>
                        <option value="hash">Content Hash</option>
                    </select>
                </div>
                <button class="btn btn-danger" onclick="uninstall()">Uninstall BambooClaw</button>
            </div>

        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let detectedOS = "unknown";
        let currentStep = 1;
        let installMethod = "download";
        let isDaemonRunning = false;

        // --- CONSTANTS ---
        const TIMEOUT_QUICK = 8000;
        const TIMEOUT_INSTALL = 600000; // 10 minutes

        // --- UTILITIES ---

        // Wrapper for Tauri Invoke with Timeout
        async function invokeWithTimeout(cmd, args = {}, timeoutMs = TIMEOUT_QUICK) {
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error(`Timeout after ${timeoutMs}ms`)), timeoutMs);
            });
            
            // Tauri v2 invoke returns a promise
            const invokePromise = window.__TAURI__.invoke(cmd, args);
            
            try {
                return await Promise.race([invokePromise, timeoutPromise]);
            } catch (err) {
                // Re-throw to be caught by caller
                throw err;
            }
        }

        // UI Logger
        function log(panelId, message, type = "info") {
            const panel = document.getElementById(panelId);
            if (!panel) return;
            
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            
            panel.appendChild(line);
            panel.scrollTop = panel.scrollHeight;
        }

        // Copy Log Functionality
        function copyLog(panelId) {
            const panel = document.getElementById(panelId);
            if (!panel) return;
            
            // Extract text content from all log-line divs
            const lines = Array.from(panel.querySelectorAll('.log-line')).map(el => el.textContent);
            const text = lines.join('\n');
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = panel.querySelector('.copy-log-btn');
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = "Copied!";
                    setTimeout(() => btn.textContent = originalText, 2000);
                }
            }).catch(err => {
                console.error("Failed to copy:", err);
                alert("Failed to copy log to clipboard");
            });
        }

        // --- INSTALLER LOGIC ---

        // Step 1: System Check
        async function runSystemCheck() {
            // 1. Get Platform
            try {
                const result = await invokeWithTimeout("get_platform", {}, TIMEOUT_QUICK);
                // Tauri returns string "windows", "linux", "darwin" (macos)
                if (result === "darwin") detectedOS = "macos";
                else if (result === "windows_nt") detectedOS = "windows"; // Tauri usually returns "windows"
                else detectedOS = result;
                
                // Normalize for UI
                if (detectedOS.includes("win")) detectedOS = "windows";
                if (detectedOS.includes("mac")) detectedOS = "macos";
                if (detectedOS.includes("linux")) detectedOS = "linux";

                document.getElementById('status-os').textContent = detectedOS.toUpperCase();
                document.getElementById('status-os').className = "status-badge success";
            } catch (err) {
                console.error("OS Detection failed:", err);
                // Default to Windows as per spec if fail
                detectedOS = "windows";
                document.getElementById('status-os').textContent = "Windows (Default)";
                document.getElementById('status-os').className = "status-badge warning";
            }

            // 2. Check Prerequisites (Parallel)
            const checks = [
                { name: "rustc", elId: "status-rust" },
                { name: "go", elId: "status-go" },
                { name: "pkg", elId: "status-pkg" } // Generic pkg check
            ];

            const checkPromises = checks.map(async (check) => {
                const el = document.getElementById(check.elId);
                try {
                    // The backend check_prerequisite returns version string or throws
                    const version = await invokeWithTimeout("check_prerequisite", { name: check.name }, TIMEOUT_QUICK);
                    el.textContent = version;
                    el.className = "status-badge success";
                    return { name: check.name, found: true, version };
                } catch (err) {
                    const msg = err?.message || "";
                    // Check for "not found" indicators
                    if (msg.toLowerCase().includes("not found") || msg.toLowerCase().includes("program not found")) {
                        el.textContent = "Not Installed";
                        el.className = "status-badge warning";
                    } else {
                        // Genuine communication error
                        el.textContent = "Error";
                        el.className = "status-badge error";
                    }
                    return { name: check.name, found: false };
                }
            });

            // Wait for all checks to settle, but update UI immediately via the promises above
            await Promise.allSettled(checkPromises);
            
            // Enable Next Button
            document.getElementById('btn-step-1-next').disabled = false;
        }

        // Step 2: Install Prerequisites
        async function installPrerequisites() {
            const logPanelId = "install-log-1";
            const nextBtn = document.getElementById('btn-step-2-next');
            const installLog = document.getElementById(logPanelId);
            
            // Clear log and show spinner visually on button if needed (handled by logs)
            installLog.innerHTML = `<button class="copy-log-btn" onclick="copyLog('${logPanelId}')">Copy Log</button>`;
            
            log(logPanelId, `[INFO] Detected OS: ${detectedOS}`, "info");
            log(logPanelId, "[INFO] Starting prerequisite installation...", "info");

            // Define install commands based on OS
            let commands = [];

            if (detectedOS === "windows") {
                // Windows: Install VS Build Tools (C++), Rust via winget/rustup
                // We also try to install Go if missing
                commands = [
                    {
                        name: "Visual Studio Build Tools",
                        cmd: "run_shell_command",
                        args: { commandName: "winget", args: ["install", "--id", "Microsoft.VisualStudio.2022.BuildTools", "--accept-source-agreements", "--accept-package-agreements"] }
                    },
                    {
                        name: "Rustup",
                        cmd: "run_shell_command",
                        args: { commandName: "cmd", args: ["/C", "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y"] }
                    }
                ];
            } else if (detectedOS === "macos") {
                commands = [
                    {
                        name: "Xcode Command Line Tools",
                        cmd: "run_shell_command",
                        args: { commandName: "xcode-select", args: ["--install"] }
                    },
                    {
                        name: "Rustup",
                        cmd: "run_shell_command",
                        args: { commandName: "sh", args: ["-c", "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y"] }
                    }
                ];
            } else if (detectedOS === "linux") {
                commands = [
                    {
                        name: "Build Essentials",
                        cmd: "run_shell_command",
                        args: { commandName: "sudo", args: ["apt-get", "update", "&&", "sudo", "apt-get", "install", "-y", "build-essential", "curl"] }
                    },
                    {
                        name: "Rustup",
                        cmd: "run_shell_command",
                        args: { commandName: "sh", args: ["-c", "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y"] }
                    }
                ];
            }

            // Execute Commands Sequentially
            for (const op of commands) {
                // Check if already installed (skip logic)
                // For this demo, we rely on the Step 1 check. If Step 1 showed "Not Installed", we proceed.
                // However, to be robust, we can check again, but let's trust the flow.
                
                log(logPanelId, `[INFO] Running: ${op.name}`, "info");
                
                try {
                    // Use LONG timeout for installs
                    const output = await invokeWithTimeout(op.cmd, op.args, TIMEOUT_INSTALL);
                    
                    // Append output (assuming backend returns string)
                    if (output) {
                        // Truncate huge output for UI sanity, but keep tail
                        const safeOutput = output.length > 500 ? output.substring(output.length - 500) : output;
                        log(logPanelId, `Output:\n${safeOutput}`, "info");
                    }
                    log(logPanelId, `[SUCCESS] ${op.name} completed.`, "success");
                    
                } catch (err) {
                    const msg = err?.message || "Unknown error";
                    log(logPanelId, `[ERROR] Failed to install ${op.name}: ${msg}`, "error");
                    // Per spec: Do not stall, enable Next button even on error so user can retry or proceed
                }
            }

            log(logPanelId, "[DONE] Prerequisite installation sequence finished.", "info");
            nextBtn.disabled = false;
        }

        // Step 3: Install BambooClaw
        async function installBambooclaw() {
            const logPanelId = "install-log-2";
            const installBtn = document.getElementById('btn-step-3-install');
            const nextBtn = document.getElementById('btn-step-3-next');
            const logPanel = document.getElementById(logPanelId);
            
            logPanel.innerHTML = `<button class="copy-log-btn" onclick="copyLog('${logPanelId}')">Copy Log</button>`;
            
            installBtn.disabled = true;
            installBtn.innerHTML = `<span class="spinner"></span> Installing...`;
            
            log(logPanelId, `[INFO] Selected Method: ${installMethod === 'download' ? 'Pre-built Binary' : 'Build from Source'}`, "info");

            try {
                let installPath = "";
                let version = "0.0.0";

                // 1. Determine Home Directory
                let homeDir = "";
                try {
                    if (detectedOS === "windows") {
                        const out = await invokeWithTimeout("run_shell_command", { commandName: "cmd", args: ["/C", "echo %USERPROFILE%"] }, TIMEOUT_QUICK);
                        homeDir = out.trim();
                        installPath = `${homeDir}\\.bambooclaw\\bambooclaw.exe`;
                    } else {
                        const out = await invokeWithTimeout("run_shell_command", { commandName: "sh", args: ["-c", "echo $HOME"] }, TIMEOUT_QUICK);
                        homeDir = out.trim();
                        installPath = `${homeDir}/.bambooclaw/bambooclaw`;
                    }
                } catch (e) {
                    log(logPanelId, "[WARN] Could not detect HOME dir, using default.", "warning");
                    installPath = detectedOS === "windows" ? "C:\\bambooclaw\\bambooclaw.exe" : "/usr/local/bin/bambooclaw";
                }

                if (installMethod === "download") {
                    log(logPanelId, "[INFO] Fetching release metadata...", "info");
                    
                    // Fetch from proxy
                    const response = await fetch("https://mjmdhqglpratbyzmgndm.supabase.co/functions/v1/github-release-proxy");
                    if (!response.ok) throw new Error("Failed to fetch release metadata");
                    const data = await response.json();
                    
                    // Find asset
                    let asset = null;
                    if (detectedOS === "windows") {
                        asset = data.assets.find(a => a.name.endsWith('.exe'));
                    } else if (detectedOS === "macos") {
                        asset = data.assets.find(a => a.name.endsWith('.dmg'));
                    } else {
                        asset = data.assets.find(a => a.name.endsWith('.AppImage'));
                    }

                    if (!asset) throw new Error(`No asset found for ${detectedOS}`);
                    
                    log(logPanelId, `[INFO] Found asset: ${asset.name} (${(asset.size / 1024 / 1024).toFixed(2)} MB)`, "info");
                    log(logPanelId, `[INFO] Downloading to: ${installPath}`, "info");

                    // Download via Tauri
                    // The proxy handles the actual URL. We pass the asset name as a param if needed, 
                    // or just use the provided download_url if the proxy returns direct links. 
                    // Assuming proxy returns { assets: [{ download_url }] }
                    const downloadUrl = asset.download_url; 
                    
                    await invokeWithTimeout("download_binary", { url: downloadUrl, dest: installPath }, TIMEOUT_INSTALL);
                    log(logPanelId, "[SUCCESS] Binary downloaded successfully.", "success");
                    version = data.tag_name;

                } else {
                    // Build from Source
                    log(logPanelId, "[INFO] Cloning repository...", "info");
                    
                    // Construct Cargo command using FULL PATH to avoid PATH issues
                    let cargoPath = "";
                    if (detectedOS === "windows") {
                        cargoPath = `%USERPROFILE%\\.cargo\\bin\\cargo`;
                        // Note: For cmd.exe, we need double quotes if path has spaces, but %USERPROFILE% usually fine.
                        // However, to be safe, we execute the install via cmd /C
                        const cmdArgs = [
                            "/C", 
                            `"${cargoPath}" install --git https://github.com/Enigmara-Technologies/bambooclaw-core --force --locked`
                        ];
                        
                        log(logPanelId, `[INFO] Running: cargo install ...`, "info");
                        await invokeWithTimeout("run_shell_command", { 
                            commandName: "cmd", 
                            args: cmdArgs 
                        }, TIMEOUT_INSTALL);
                        
                        // For windows cargo install, binary usually goes to %USERPROFILE%\.cargo\bin\bambooclaw.exe
                        installPath = `${homeDir}\\.cargo\\bin\\bambooclaw.exe`;
                    } else {
                        cargoPath = "$HOME/.cargo/bin/cargo";
                        const cmd = `curl --proto '=https' --tlsv1.2 -sSfL https://raw.githubusercontent.com/Enigmara-Technologies/bambooclaw-core/main/install.sh | sh`;
                        log(logPanelId, `[INFO] Running install script...`, "info");
                        await invokeWithTimeout("run_shell_command", { commandName: "sh", args: ["-c", cmd] }, TIMEOUT_INSTALL);
                        installPath = `${homeDir}/.cargo/bin/bambooclaw`;
                    }
                    log(logPanelId, "[SUCCESS] Built and installed from source.", "success");
                    version = "Source Build";
                }

                // 3. Verify Installation
                log(logPanelId, "[INFO] Verifying installation...", "info");
                try {
                    // Just run --version
                    // Note: Windows needs the path
                    const args = ["--version"];
                    await invokeWithTimeout("run_bambooclaw", { args: args }, TIMEOUT_QUICK);
                    log(logPanelId, "[SUCCESS] BambooClaw is functional.", "success");
                } catch (e) {
                    log(logPanelId, "[ERROR] Verification failed. Binary might not be in PATH.", "error");
                    // We still allow proceeding, user might need to configure PATH manually
                }

                // UI Update
                document.getElementById('final-version').textContent = version;
                document.getElementById('final-platform').textContent = detectedOS.toUpperCase();
                
                nextBtn.classList.remove("hidden");
                installBtn.classList.add("hidden");

            } catch (err) {
                const msg = err?.message || "Unknown error";
                log(logPanelId, `[ERROR] Installation failed: ${msg}`, "error");
                installBtn.disabled = false;
                installBtn.innerText = "Retry Install";
            }
        }

        // --- DASHBOARD LOGIC ---

        async function toggleDaemon() {
            const toggle = document.getElementById('daemon-toggle');
            const status = document.getElementById('daemon-status');
            const logs = document.getElementById('daemon-logs');

            if (toggle.checked) {
                // Start
                status.innerText = "Starting...";
                try {
                    await invokeWithTimeout("start_daemon", {}, TIMEOUT_INSTALL); // Give it time to spin up
                    status.innerText = "Running";
                    status.className = "text-xs text-accent font-bold";
                    isDaemonRunning = true;
                    log('daemon-logs', "Daemon started successfully.", "success");
                } catch (e) {
                    status.innerText = "Error";
                    status.className = "text-xs text-danger";
                    toggle.checked = false;
                    log('daemon-logs', `Failed to start: ${e.message}`, "error");
                }
            } else {
                // Stop
                status.innerText = "Stopping...";
                try {
                    await invokeWithTimeout("stop_daemon", {}, TIMEOUT_QUICK);
                    status.innerText = "Stopped";
                    status.className = "text-xs text-secondary";
                    isDaemonRunning = false;
                    log('daemon-logs', "Daemon stopped.", "info");
                } catch (e) {
                    status.innerText = "Error";
                    log('daemon-logs', `Failed to stop: ${e.message}`, "error");
                }
            }
        }

        async function testLLM() {
            if (!isDaemonRunning) {
                alert("Please start the daemon first.");
                return;
            }
            log('daemon-logs', "Sending test ping to LLM...", "info");
            try {
                // Save config first implicitly or rely on saved one? Better save first.
                await saveConfig();
                await invokeWithTimeout("run_bambooclaw", { args: ["agent", "-m", "ping"] }, TIMEOUT_QUICK);
                log('daemon-logs', "LLM Test: Success (Check daemon logs for actual output)", "success");
            } catch (e) {
                log('daemon-logs', `LLM Test Failed: ${e.message}`, "error");
            }
        }

        async function saveConfig() {
            const provider = document.getElementById('conf-provider').value;
            const model = document.getElementById('conf-model').value;
            const apiKey = document.getElementById('conf-api-key').value;
            const memory = document.getElementById('conf-memory').value;

            const content = JSON.stringify({
                llm: { provider, model, api_key: apiKey },
                memory: { backend: memory }
            });

            try {
                await invokeWithTimeout("write_config", { content }, TIMEOUT_QUICK);
                // Visual feedback
                const btn = event.target;
                if(btn) {
                    const oldText = btn.innerText;
                    btn.innerText = "Saved!";
                    setTimeout(() => btn.innerText = oldText, 1000);
                }
            } catch (e) {
                alert("Failed to save config: " + e.message);
            }
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const chatBox = document.getElementById('live-chat');
            const msg = input.value.trim();
            if (!msg) return;

            // UI User Msg
            const uDiv = document.createElement('div');
            uDiv.className = "chat-msg user";
            uDiv.innerText = msg;
            chatBox.appendChild(uDiv);
            input.value = "";
            chatBox.scrollTop = chatBox.scrollHeight;

            if (!isDaemonRunning) {
                const aDiv = document.createElement('div');
                aDiv.className = "chat-msg agent";
                aDiv.innerText = "Error: Daemon not running.";
                chatBox.appendChild(aDiv);
                return;
            }

            // Send to Rust
            try {
                // Assuming bambooclaw CLI has a chat mode or we send directly to agent
                // For demo, we use 'agent -m "message"'
                const output = await invokeWithTimeout("run_bambooclaw", { args: ["agent", "-m", msg] }, 30000);
                
                const aDiv = document.createElement('div');
                aDiv.className = "chat-msg agent";
                aDiv.innerText = output || "No response.";
                chatBox.appendChild(aDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (e) {
                const aDiv = document.createElement('div');
                aDiv.className = "chat-msg agent text-danger";
                aDiv.innerText = "Error: " + e.message;
                chatBox.appendChild(aDiv);
            }
        }

        async function uninstall() {
            if(!confirm("Are you sure you want to uninstall BambooClaw?")) return;
            try {
                // Platform specific removal
                if(detectedOS === "windows") {
                    await invokeWithTimeout("run_shell_command", { commandName: "powershell", args: ["Remove-Item", "-Recurse", "-Force", "$env:USERPROFILE\\.bambooclaw"] });
                } else {
                    await invokeWithTimeout("run_shell_command", { commandName: "rm", args: ["-rf", "$HOME/.bambooclaw"] });
                }
                localStorage.removeItem('bambooclaw_installed');
                location.reload();
            } catch (e) {
                alert("Uninstall failed: " + e.message);
            }
        }

        // --- NAVIGATION & UI HANDLERS ---

        function selectInstallOption(method) {
            installMethod = method;
            document.getElementById('opt-download').className = `option-card ${method === 'download' ? 'selected' : ''}`;
            document.getElementById('opt-build').className = `option-card ${method === 'build' ? 'selected' : ''}`;
        }

        function switchTab(tabName) {
            // Buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            // Content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            // Show target
            document.getElementById(`step-${step}`).classList.remove('hidden');
            
            // Update dots
            for(let i=1; i<=4; i++) {
                const dot = document.getElementById(`dot-${i}`);
                dot.className = "step-dot";
                if(i === step) dot.classList.add("active");
                if(i < step) dot.classList.add("completed");
            }

            currentStep = step;

            // Trigger logic for steps
            if (step === 1) runSystemCheck();
            if (step === 2) installPrerequisites(); // Auto start per spec? No, wait for button? 
            // Spec says: "Step 2 MUST SHOW LIVE PROGRESS IMMEDIATELY". 
            // But usually user clicks Next. To satisfy "Immediately when step loads", we start it on load.
            // However, to prevent accidental double runs, we check if it's already running or done.
            // For this demo, we will trigger it when entering Step 2.
        }

        // --- INITIALIZATION ---

        window.addEventListener('DOMContentLoaded', async () => {
            // 1. Check LocalStorage for existing install
            const installed = localStorage.getItem('bambooclaw_installed');
            if (installed) {
                // Skip to Dashboard
                document.getElementById('installer-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('header-status').innerText = "Dashboard";
                
                // Try to load saved config
                try {
                    const config = await invokeWithTimeout("read_config", {}, TIMEOUT_QUICK);
                    if (config) {
                        const parsed = JSON.parse(config);
                        if(parsed.llm) {
                            document.getElementById('conf-provider').value = parsed.llm.provider || 'openai';
                            document.getElementById('conf-model').value = parsed.llm.model || '';
                            document.getElementById('conf-api-key').value = parsed.llm.api_key || '';
                        }
                    }
                } catch (e) { console.log("No config loaded", e); }
                return;
            }

            // 2. Start Installer
            document.getElementById('installer-view').classList.remove('hidden');
            document.getElementById('header-status').innerText = "Installer Mode";

            // Bind Buttons
            document.getElementById('btn-step-1-next').onclick = () => goToStep(2);
            
            document.getElementById('btn-step-2-back').onclick = () => goToStep(1);
            document.getElementById('btn-step-2-next').onclick = () => goToStep(3);
            
            document.getElementById('btn-step-3-back').onclick = () => goToStep(2);
            document.getElementById('btn-step-3-install').onclick = installBambooclaw;
            document.getElementById('btn-step-3-next').onclick = () => goToStep(4);
            
            document.getElementById('btn-finish').onclick = () => {
                localStorage.setItem('bambooclaw_installed', 'true');
                location.reload();
            };

            // Initial Step
            goToStep(1);
        });

    </script>
</body>
</html>