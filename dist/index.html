<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src *; img-src 'self' data: https: asset: http://asset.localhost;">
    <title>BambooClaw‚Ñ¢</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f;
            --card: #12121e;
            --accent: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.2);
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --border: #1e293b;
            --error: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }
        #app { display: flex; flex-direction: column; height: 100vh; }
        header {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            flex-shrink: 0;
        }
        .logo { display: flex; align-items: center; gap: 0.6rem; font-weight: 800; font-size: 1.1rem; letter-spacing: -0.025em; color: var(--accent); }
        .logo img { height: 32px; width: auto; }
        main { flex: 1; overflow-y: auto; padding: 1rem 1.5rem; position: relative; min-height: 0; }
        .container { max-width: 800px; margin: 0 auto; }
        .hidden { display: none !important; }

        .steps { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .step-dot { flex: 1; height: 4px; background: var(--border); border-radius: 2px; transition: 0.3s; }
        .step-dot.active { background: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        .glass-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 { font-size: 1.5rem; margin-bottom: 0.4rem; }
        p.subtitle { color: var(--text-dim); margin-bottom: 1rem; }

        .check-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .status-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; }
        .status-detecting { color: var(--text-dim); }
        .status-found { color: var(--accent); }
        .status-not-installed { color: var(--warning); background: rgba(245, 158, 11, 0.1); }
        .status-error { color: var(--error); }

        .log-container {
            margin-top: 1.5rem;
            position: relative;
            background: #050507;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #1a1a2e;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .log-body {
            height: 150px;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn:hover { filter: brightness(1.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--accent); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
        .btn-danger { background: var(--error); }
        .btn-flush { background: transparent; border: 2px solid #ff4444; color: #ff4444; font-weight: 700; }
        .btn-flush:hover { background: #ff4444; color: #fff; }

        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1rem; flex-wrap: wrap; }
        .tab { padding: 0.6rem 1rem; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; transition: 0.2s; user-select: none; font-size: 0.85rem; }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .save-reminder { display: none; padding: 0.5rem 0.75rem; margin-top: 0.75rem; background: rgba(245,158,11,0.1); border: 1px solid var(--warning); border-radius: 6px; font-size: 0.8rem; color: var(--warning); }
        .save-reminder.visible { display: block; }
        
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; color: var(--text-dim); font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            background: #050507;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.75rem;
            border-radius: 6px;
            outline: none;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        @media (max-width: 600px) { .settings-grid { grid-template-columns: 1fr; } }

        /* Splash Screen */
        .splash-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999;
            background: #0a0a0f; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 0.8s ease;
        }
        .splash-overlay.fade-out { opacity: 0; pointer-events: none; }
        .splash-logo { width: 400px; max-width: 80vw; height: auto; margin-bottom: 1.5rem; animation: splashPulse 2s ease-in-out infinite; filter: drop-shadow(0 0 30px rgba(16, 185, 129, 0.4)); }
        .splash-title { font-family: 'Inter', sans-serif; font-size: 1.8rem; font-weight: 800; color: var(--accent); letter-spacing: -0.03em; margin-bottom: 2rem; }
        .splash-bar-track { width: 220px; height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .splash-bar-fill { width: 30%; height: 100%; background: var(--accent); border-radius: 2px; animation: splashBarPulse 1.5s ease-in-out infinite; box-shadow: 0 0 8px var(--accent-glow); }
        
        @keyframes splashPulse { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 30px rgba(16, 185, 129, 0.4)); } 50% { transform: scale(1.03); filter: drop-shadow(0 0 50px rgba(16, 185, 129, 0.6)); } }
        @keyframes splashBarPulse { 0% { width: 10%; margin-left: 0; } 50% { width: 60%; margin-left: 20%; } 100% { width: 10%; margin-left: 90%; } }

        /* Chat */
        .chat-container { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-top: 1rem; }
        .chat-messages { height: 200px; overflow-y: auto; padding: 1rem; background: #050507; }
        .chat-input-row { display: flex; border-top: 1px solid var(--border); }
        .chat-input-row input { flex: 1; border: none; border-radius: 0; }
        .chat-input-row button { border-radius: 0; white-space: nowrap; }
        .chat-msg { margin-bottom: 0.75rem; font-size: 0.85rem; line-height: 1.4; }
        .chat-msg .role { font-weight: 700; color: var(--accent); margin-right: 0.5rem; }
        .chat-msg.assistant .role { color: var(--warning); }
        
        /* Status indicators */
        .status-pill { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-pill.running { background: rgba(16,185,129,0.15); color: var(--success); }
        .status-pill.stopped { background: rgba(239,68,68,0.15); color: var(--error); }

        /* General layout utilities */
        .channel-row { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.75rem; }
        .channel-row .channel-name { font-weight: 600; }
        .channel-row .channel-status { font-size: 0.8rem; color: var(--text-dim); }

        .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem 1.5rem; font-size: 0.9rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.3s ease; max-width: 350px; }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.info { border-left: 3px solid var(--accent); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }

        .spinner { animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app">
        <div class="splash-overlay" id="splash-screen">
            <img class="splash-logo" src="logo.png" alt="BambooClaw Logo">
            <div class="splash-title">BambooClaw‚Ñ¢</div>
            <div class="splash-bar-track"><div class="splash-bar-fill"></div></div>
        </div>
        <script>
        (function() {
            var SPLASH_DURATION = 1500;
            var splashEl = document.getElementById("splash-screen");
            if (!splashEl) return;
            setTimeout(function() {
                splashEl.classList.add("fade-out");
                setTimeout(function() { if (splashEl.parentNode) splashEl.parentNode.removeChild(splashEl); }, 800);
            }, SPLASH_DURATION);
        })();
        </script>

        <header>
            <div class="logo"><span style="font-size:1.1rem;font-weight:700;color:var(--accent);">BambooClaw‚Ñ¢</span></div>
            <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent);"><span id="app-version">loading...</span></div>
        </header>

        <main>
            <div id="wizard-view" class="container">
                <div class="steps">
                    <div class="step-dot active" id="dot-0"></div>
                    <div class="step-dot" id="dot-1"></div>
                    <div class="step-dot" id="dot-2"></div>
                    <div class="step-dot" id="dot-3"></div>
                </div>

                <div class="glass-card wizard-step" id="step-0">
                    <h1>Environment Audit</h1>
                    <p class="subtitle">Ensuring your system is prepared for BambooClaw‚Ñ¢ edge deployment.</p>
                    <div>
                        <div class="check-row"><span>Operating System</span><span class="status-badge status-detecting" id="chk-os">Detecting...</span></div>
                        <div class="check-row"><span>Rust Toolchain</span><span class="status-badge status-detecting" id="chk-rust">Detecting...</span></div>
                        <div class="check-row"><span>Git CLI</span><span class="status-badge status-detecting" id="chk-git">Detecting...</span></div>
                        <div class="check-row"><span>Build Tools</span><span class="status-badge status-detecting" id="chk-build">Detecting...</span></div>
                        <div class="check-row"><span>Python</span><span class="status-badge status-detecting" id="chk-python">Detecting...</span></div>
                        <div class="check-row"><span>Node.js</span><span class="status-badge status-detecting" id="chk-node">Detecting...</span></div>
                    </div>
                    <div class="log-container">
                        <div class="log-header"><span>BOOT TRACE LOG</span><button class="btn btn-sm btn-outline" id="btn-copy-boot-log" style="padding: 2px 6px; font-size: 0.7rem;">üìã Copy</button></div>
                        <div class="log-body" id="boot-log"></div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button class="btn" id="btn-step0-next" disabled>Initialize Environment ‚Üí</button>
                    </div>
                </div>

                <div class="glass-card wizard-step hidden" id="step-1">
                    <h1>Readying Prereqs</h1>
                    <p class="subtitle">Applying required system dependencies and development toolchains.</p>
                    <div class="log-container">
                        <div class="log-header"><span>SYSTEM INSTALLATION LOG</span><button class="btn btn-sm btn-outline" id="btn-copy-install-log" style="padding: 2px 6px; font-size: 0.7rem;">üìã Copy</button></div>
                        <div class="log-body" id="install-log"></div>
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                        <button class="btn btn-outline" id="btn-back-step1">‚Üê Back</button>
                        <button class="btn" id="btn-step1-next" disabled>Agent Capabilities ‚Üí</button>
                    </div>
                </div>

                <div class="glass-card wizard-step hidden" id="step-2">
                    <h1>Agent Capabilities</h1>
                    <p class="subtitle">Select additional tools to maximize your agent's autonomous power.</p>

                    <div style="margin-bottom: 1rem;">
                        <label style="display:flex;align-items:flex-start;gap:0.75rem;padding:1rem;border:1px solid var(--border);border-radius:8px;cursor:pointer;background:rgba(16,185,129,0.05);">
                            <input type="checkbox" id="cap-python" checked style="margin-top:3px;accent-color:var(--accent);width:18px;height:18px;">
                            <div>
                                <div style="font-weight:600;color:var(--accent);">Python Ecosystem <span style="font-size:0.75rem;color:var(--text-dim);">(Recommended)</span></div>
                                <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.25rem;">Python 3.12, pyautogui, pillow, requests, beautifulsoup4, psutil, pandas, numpy</div>
                                <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.25rem;">Enables: GUI automation, screenshots, data analysis, web scraping</div>
                            </div>
                        </label>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display:flex;align-items:flex-start;gap:0.75rem;padding:1rem;border:1px solid var(--border);border-radius:8px;cursor:pointer;">
                            <input type="checkbox" id="cap-browser" style="margin-top:3px;accent-color:var(--accent);width:18px;height:18px;">
                            <div>
                                <div style="font-weight:600;">Browser Automation</div>
                                <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.25rem;">Playwright with Chromium</div>
                                <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.25rem;">Enables: Headless web browsing, form filling, web testing</div>
                            </div>
                        </label>
                    </div>

                    <div class="log-container">
                        <div class="log-header"><span>CAPABILITY INSTALL LOG</span></div>
                        <div class="log-body" id="capability-log"></div>
                    </div>

                    <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                        <button class="btn btn-outline" id="btn-back-step2">‚Üê Back</button>
                        <div style="display:flex;gap:0.75rem;">
                            <button class="btn btn-outline" id="btn-step2-skip">Skip for Now ‚Üí</button>
                            <button class="btn" id="btn-step2-install">Install Selected</button>
                        </div>
                    </div>
                </div>

                <div class="glass-card wizard-step hidden" id="step-3">
                    <div style="text-align: center; padding: 2rem 0;">
                        <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--success);">‚úì</div>
                        <h1>Installation Complete</h1>
                        <p class="subtitle">BambooClaw‚Ñ¢ is now registered as a system service.</p>
                        <div class="form-group" style="text-align: left;">
                            <label>Storage Path</label>
                            <input type="text" id="install-path-display" readonly value="~/.bambooclaw/bambooclaw" />
                        </div>
                        <button class="btn" id="btn-enter-dashboard">Enter Companion Dashboard</button>
                    </div>
                </div>
            </div>

            <div id="dashboard-view" class="container hidden">
                <div class="tabs">
                    <div class="tab active" data-tab="tab-llm">LLM Settings</div>
                    <div class="tab" data-tab="tab-channels">Channels</div>
                    <div class="tab" data-tab="tab-agent">Agent Control</div>
                    <div class="tab" data-tab="tab-settings">Settings</div>
                    <div class="tab" data-tab="tab-logs">Logs</div>
                </div>

                <div class="glass-card tab-panel" id="tab-llm">
                    <div class="form-group">
                        <label>AI Provider</label>
                        <select id="llm-provider">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google Gemini</option>
                            <option value="groq">Groq (Ultra-Fast)</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="ollama">Ollama (Local)</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="mistral">Mistral</option>
                            <option value="inception">Inception</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Secret API Key</label>
                        <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: 6px; background: #050507; overflow: hidden;">
                            <input type="password" id="llm-api-key" placeholder="sk-..." style="border: none; border-radius: 0; outline: none; background: transparent; flex: 1; padding: 0.75rem;" />
                            <button type="button" id="btn-toggle-key" class="btn btn-outline" style="border: none; border-radius: 0; padding: 0.75rem; height: 100%; border-left: 1px solid var(--border);">üëÅÔ∏è</button>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.4rem;">
                            Each provider remembers its own API key securely.
                        </p>
                    </div>

                    <div class="form-group" id="llm-model-group">
                        <label>Model</label>
                        <select id="llm-model">
                            <option value="">Select provider first</option>
                        </select>
                    </div>
                    
                    <div class="form-group hidden" id="or-models-area">
                        <label>Model</label>
                        <div class="active-model-display" id="or-active-model">
                            <span style="color:var(--text-dim);font-size:0.8rem;">Active Model:</span>
                            <strong style="color:var(--accent);margin-left:0.4rem;" id="or-active-model-name">None selected</strong>
                        </div>
                        <input type="text" id="or-model-search" placeholder="Search OpenRouter models..." style="margin-bottom:0.5rem;" />
                        <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;flex-wrap:wrap;">
                            <button type="button" class="btn btn-sm btn-outline" id="btn-fetch-models">Fetch Models</button>
                        </div>
                        <div id="or-model-list" style="height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;background:#050507;"></div>
                    </div>
                    
                    <div id="llm-save-reminder" class="save-reminder">‚ö† You have unsaved changes. Click <strong>Apply Configuration</strong> to save.</div>
                    <div style="margin-top: 1rem;">
                        <button type="button" class="btn" id="btn-apply-llm">Apply Configuration</button>
                        <button type="button" class="btn btn-outline" style="margin-left: 0.5rem;" id="btn-test-llm">Test Connection</button>
                    </div>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-channels">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.5rem;">Active Channels</h1>
                    <p class="subtitle">Connect your agent to external messaging platforms.</p>
                    
                    <div class="channel-row">
                        <div>
                            <div class="channel-name">ü§ñ Telegram Bot</div>
                            <div class="channel-status" id="tg-status">Not configured</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline" id="btn-setup-tg">Setup</button>
                    </div>

                    <div id="channel-setup-area" class="hidden" style="margin-top: 1.5rem; padding: 1.5rem; border: 1px solid var(--border); border-radius: 8px; background: #050507;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2 style="font-size: 1.1rem;" id="channel-setup-title">Setup</h2>
                            <button type="button" class="btn btn-sm btn-outline" id="btn-close-channel" style="font-size: 1.2rem; padding: 2px 8px;">‚úï</button>
                        </div>
                        <div id="channel-setup-body"></div>
                    </div>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-agent">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                        <div>
                            <h1 style="font-size: 1.3rem; margin-bottom: 0.25rem;">Daemon Status</h1>
                            <span class="status-pill stopped" id="daemon-status-pill">
                                <span id="daemon-status-dot">‚óè</span>
                                <span id="daemon-status-text">Stopped</span>
                            </span>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:10px;align-items:stretch;">
                            <button type="button" class="btn" id="btn-daemon-toggle">Start Agent Daemon</button>
                            <button type="button" class="btn btn-flush" id="btn-emergency-flush">‚ö† Emergency Flush</button>
                        </div>
                    </div>

                    <h2 style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-dim);">Agent Chat</h2>
                    <div class="chat-container">
                        <div class="chat-messages" id="agent-chat-messages">
                            <div class="chat-msg assistant"><span class="role">Agent:</span> Daemon is offline. Start the daemon to begin chatting.</div>
                        </div>
                        <div class="chat-input-row">
                            <input type="text" id="agent-chat-input" placeholder="Send a message to the agent..." />
                            <button type="button" class="btn" style="border-radius: 0;" id="btn-send-chat">Send</button>
                        </div>
                    </div>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-settings">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.5rem;">Agent Settings</h1>
                    
                    <div class="settings-grid" style="margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label>Autonomy Level</label>
                            <select id="set-autonomy">
                                <option value="observe">Observation Only</option>
                                <option value="collaborative">Collaborative (Needs Approval)</option>
                                <option value="autonomous" selected>Full Autonomy</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Active Persona</label>
                            <select id="set-identity">
                                <option value="-1">‚Äî BambooClaw Default (System Prompt Only) ‚Äî</option>
                            </select>
                            <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.4rem;">
                                Select a persona to inject specific rules. Manage them below.
                            </p>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label>Base System Prompt</label>
                        <textarea id="settings-system-prompt" rows="8" placeholder="Global instructions applied to EVERY conversation..." style="resize:vertical;"></textarea>
                    </div>

                    <div style="border-top: 1px solid var(--border); padding-top: 1.5rem;">
                        <h2 style="font-size: 1.1rem; margin-bottom: 0.5rem;">üé≠ Manage Personas</h2>
                        <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1rem;">Create specialized roles for your agent.</p>
                        
                        <div id="persona-list" style="margin-bottom: 1rem;"></div>

                        <details id="persona-details-block" style="border: 1px solid var(--border); border-radius: 8px; padding: 0; background: #050507;">
                            <summary style="padding: 0.75rem 1rem; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: var(--accent); user-select: none; list-style: none;">+ Create / Edit Persona</summary>
                            <div style="padding: 1rem;">
                                <div class="form-group">
                                    <label>Persona Name</label>
                                    <input type="text" id="new-persona-name" placeholder="e.g. Expert Python Developer..." />
                                </div>
                                <div class="form-group">
                                    <label>Persona Instructions</label>
                                    <textarea id="new-persona-prompt" rows="8" placeholder="Define how the agent should behave..." style="resize:vertical;"></textarea>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button type="button" class="btn btn-sm" id="btn-create-persona">Save Persona</button>
                                    <button type="button" class="btn btn-sm btn-outline hidden" id="btn-cancel-edit-persona">Cancel</button>
                                </div>
                            </div>
                        </details>
                    </div>

                    <div id="settings-save-reminder" class="save-reminder" style="margin-top: 1.5rem;">‚ö† You have unsaved changes. Click <strong>Save Settings</strong> to apply.</div>
                    <div style="margin-top: 1rem;">
                        <button type="button" class="btn" id="btn-save-settings">Save Settings</button>
                        <button type="button" class="btn btn-outline" style="margin-left: 0.5rem;" id="btn-reset-settings">Reset Defaults</button>
                    </div>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-logs">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.75rem;">üìã Session Log</h1>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <span style="font-size: 0.75rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace;">SESSION LOG ‚Äî <span id="session-id-label">...</span></span>
                        <button type="button" class="btn btn-sm btn-outline" id="btn-copy-log">üìã Copy Log</button>
                    </div>
                    <div class="log-body" id="unified-log" style="height:400px;background:#050507;border:1px solid var(--border);border-radius:6px;font-size:0.72rem;line-height:1.6;"></div>
                    
                    <div id="dash-log" style="display:none;"></div>
                </div>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
    // ==========================================
    // CORE STATE & GLOBALS
    // ==========================================
    var detectedOS = "unknown";
    var daemonRunning = false;
    var currentConfig = {
        llm: { provider: "openai", api_key: "", model: "", system_prompt: "" },
        api_keys: {}, 
        settings: { autonomy: "autonomous", identity: "-1", maxToolIterations: 10 },
        channels: {},
        enabledSkills: {},
        composioApiKey: ""
    };
    var PROXY_URL = "https://mjmdhqglpratbyzmgndm.supabase.co/functions/v1/github-release-proxy";
    var MAX_TOOL_ITERATIONS = 10;
    
    var personas = [];
    var activePersonaIndex = -1;
    var editingPersonaIndex = -1;

    var SESSION_ID = "session-" + Math.random().toString(16).substring(2, 8);
    var LOG_FOLDER = "~/.bambooclaw/logs/";
    var LOG_FILE_PATH = LOG_FOLDER + SESSION_ID + ".log";

    setTimeout(() => {
        var lbl = document.getElementById("session-id-label"); if (lbl) lbl.textContent = SESSION_ID;
        var pathEl = document.getElementById("log-path-display"); if (pathEl) pathEl.value = LOG_FILE_PATH;
        var aboutVer = document.getElementById("about-version");
        var appVer = document.getElementById("app-version");
        if (aboutVer && appVer) aboutVer.textContent = appVer.textContent;
        var copyrightEl = document.getElementById("about-copyright");
        if (copyrightEl) copyrightEl.textContent = "¬© " + new Date().getFullYear() + " Bamboo Synergy Technologies, Inc.";
    }, 0);

    // ==========================================
    // UTILITIES
    // ==========================================
    function showToast(message, type) {
        var t = document.createElement("div");
        t.className = "toast " + (type || "info");
        t.textContent = message;
        document.getElementById("toast-container").appendChild(t);
        setTimeout(() => { t.style.animation = "slideOut 0.3s ease forwards"; setTimeout(() => t.remove(), 300); }, 3000);
    }

    function tauriInvoke(cmd, args) {
        if (!window.__TAURI__) return Promise.reject(new Error("Tauri not available"));
        var inv = (window.__TAURI__.core && window.__TAURI__.core.invoke) || (window.__TAURI__.tauri && window.__TAURI__.tauri.invoke) || window.__TAURI__.invoke;
        if (typeof inv === "function") return inv(cmd, args || {});
        return Promise.reject(new Error("Tauri invoke not found."));
    }

    function invokeShort(cmd, args) { return Promise.race([tauriInvoke(cmd, args), new Promise((_, r) => setTimeout(() => r(new Error("Timeout: " + cmd)), 8000))]); }
    function invokeLong(cmd, args, ms) { return Promise.race([tauriInvoke(cmd, args), new Promise((_, r) => setTimeout(() => r(new Error("Timeout: " + cmd)), ms || 600000))]); }

    function appendLog(logId, line) {
        var now = new Date();
        var ts = `[${("0"+now.getHours()).slice(-2)}:${("0"+now.getMinutes()).slice(-2)}:${("0"+now.getSeconds()).slice(-2)}]`;
        var el = document.getElementById(logId);
        if (el) { el.textContent += ts + " " + line + "\n"; el.scrollTop = el.scrollHeight; }
        var uni = document.getElementById("unified-log");
        if (uni && logId !== "unified-log") { uni.textContent += ts + " " + line + "\n"; uni.scrollTop = uni.scrollHeight; }
    }

    function copyLog(logId) {
        var el = document.getElementById(logId);
        if (el) navigator.clipboard.writeText(el.textContent).then(() => showToast("Log copied", "success")).catch(() => showToast("Failed to copy", "error"));
    }

    // ==========================================
    // CONFIGURATION SAVING & LOADING
    // ==========================================
    function buildConfigToml() {
        var lines = ["# BambooClaw Agent Configuration", ""];
        
        if (currentConfig.llm) {
            lines.push("[llm]");
            if (currentConfig.llm.provider) lines.push('provider = ' + JSON.stringify(currentConfig.llm.provider));
            if (currentConfig.llm.api_key) lines.push('api_key = ' + JSON.stringify(currentConfig.llm.api_key));
            if (currentConfig.llm.model) lines.push('model = ' + JSON.stringify(currentConfig.llm.model));
            if (currentConfig.llm.system_prompt != null) lines.push('system_prompt = ' + JSON.stringify(currentConfig.llm.system_prompt));
            lines.push("");
        }

        if (currentConfig.api_keys && Object.keys(currentConfig.api_keys).length > 0) {
            lines.push("[api_keys]");
            Object.keys(currentConfig.api_keys).forEach(k => { if (currentConfig.api_keys[k]) lines.push(k + ' = ' + JSON.stringify(currentConfig.api_keys[k])); });
            lines.push("");
        }

        if (currentConfig.channels) {
            Object.keys(currentConfig.channels).forEach(ch => {
                lines.push("[channels." + ch + "]");
                var c = currentConfig.channels[ch];
                Object.keys(c).forEach(k => { lines.push(k + ' = ' + JSON.stringify(c[k] || "")); });
                lines.push("");
            });
        }

        if (currentConfig.settings) {
            lines.push("[agent]");
            var s = currentConfig.settings;
            if (s.autonomy) lines.push('autonomy = ' + JSON.stringify(s.autonomy));
            if (s.identity !== undefined) lines.push('identity = ' + JSON.stringify(String(s.identity)));
            if (s.maxToolIterations) lines.push('maxToolIterations = ' + JSON.stringify(String(s.maxToolIterations)));
            if (currentConfig.composioApiKey) lines.push('composio_api_key = ' + JSON.stringify(currentConfig.composioApiKey));
            lines.push("");
        }

        if (personas && personas.length > 0) {
            personas.forEach(p => {
                lines.push("[[personas]]");
                lines.push('name = ' + JSON.stringify(p.name));
                lines.push('prompt = ' + JSON.stringify(p.prompt));
                lines.push("");
            });
        }
        return lines.join("\n");
    }

    async function saveAllConfig() {
        var toml = buildConfigToml();
        try {
            await invokeShort("write_config", { content: toml });
            appendLog("dash-log", "[CONFIG] Saved to disk.");
        } catch(e) {
            localStorage.setItem("bambooclaw-config", JSON.stringify(currentConfig));
            localStorage.setItem("bambooclaw-personas-fallback", JSON.stringify(personas));
            appendLog("dash-log", "[CONFIG] Saved to localStorage (Fallback).");
        }
    }

    async function loadConfig() {
        appendLog("dash-log", "[CONFIG] loadConfig() started...");
        try {
            var raw = await invokeShort("read_config");
            parseAndApplyConfig(raw);
            appendLog("dash-log", "[CONFIG] Loaded from disk.");
        } catch(e) {
            var saved = localStorage.getItem("bambooclaw-config");
            var savedP = localStorage.getItem("bambooclaw-personas-fallback");
            if (saved) { try { currentConfig = JSON.parse(saved); } catch(e2) {} }
            if (savedP) { try { personas = JSON.parse(savedP); } catch(e2) {} }
            applyConfigToUI();
            renderPersonas();
        }
    }

    function parseAndApplyConfig(toml) {
        var lines = toml.split("\n");
        var section = "";
        personas = []; 
        
        lines.forEach(line => {
            line = line.trim();
            if (!line || line.startsWith("#")) return;
            
            if (line === "[[personas]]") { section = "personas"; personas.push({}); return; }
            
            var secMatch = line.match(/^\[(.+)\]$/);
            if (secMatch) { section = secMatch[1]; return; }
            
            var kvMatch = line.match(/^(\w+)\s*=\s*(.*)$/);
            if (kvMatch) {
                var key = kvMatch[1], valRaw = kvMatch[2].trim();
                var val = valRaw;
                if (valRaw.startsWith('"')) { try { val = JSON.parse(valRaw); } catch(e) { val = valRaw.replace(/^"|"$/g, ''); } } else if (!isNaN(valRaw)) { val = Number(valRaw); }
                
                if (section === "llm") { if (!currentConfig.llm) currentConfig.llm = {}; currentConfig.llm[key] = String(val); }
                else if (section === "api_keys") { if (!currentConfig.api_keys) currentConfig.api_keys = {}; currentConfig.api_keys[key] = String(val); }
                else if (section.startsWith("channels.")) {
                    var ch = section.replace("channels.", "");
                    if (!currentConfig.channels) currentConfig.channels = {};
                    if (!currentConfig.channels[ch]) currentConfig.channels[ch] = {};
                    currentConfig.channels[ch][key] = String(val);
                }
                else if (section === "agent") {
                    if (key === "composio_api_key") currentConfig.composioApiKey = String(val);
                    else { if (!currentConfig.settings) currentConfig.settings = {}; currentConfig.settings[key] = String(val); }
                }
                else if (section === "personas") { var lastP = personas[personas.length - 1]; if (lastP) lastP[key] = String(val); }
            }
        });
        applyConfigToUI();
        renderPersonas();
    }

    function applyConfigToUI() {
        if (currentConfig.llm) {
            if (currentConfig.llm.api_key && currentConfig.llm.provider) {
                if (!currentConfig.api_keys) currentConfig.api_keys = {};
                if (!currentConfig.api_keys[currentConfig.llm.provider]) { currentConfig.api_keys[currentConfig.llm.provider] = currentConfig.llm.api_key; }
            }
            if (currentConfig.llm.provider) {
                var provEl = document.getElementById("llm-provider");
                if (provEl) { provEl.value = currentConfig.llm.provider; provEl.dispatchEvent(new Event("change")); }
            }
            if (currentConfig.llm.model) {
                setTimeout(() => { 
                    var sel = document.getElementById("llm-model");
                    if (sel) sel.value = currentConfig.llm.model; 
                    if (currentConfig.llm.provider === "openrouter") {
                        orSelectedModel = currentConfig.llm.model;
                        var nameEl = document.getElementById("or-active-model-name");
                        if (nameEl) nameEl.textContent = currentConfig.llm.model;
                    }
                }, 50);
            }
            if (currentConfig.llm.system_prompt != null) {
                var sp = document.getElementById("settings-system-prompt");
                if (sp) sp.value = currentConfig.llm.system_prompt;
            }
        }
        if (currentConfig.channels) {
            if (currentConfig.channels.telegram && currentConfig.channels.telegram.token) {
                var tgStatus = document.getElementById("tg-status");
                if (tgStatus) tgStatus.textContent = "Token Configured";
            }
        }
        if (currentConfig.settings) {
            var s = currentConfig.settings;
            if (s.autonomy) { var autEl = document.getElementById("set-autonomy"); if (autEl) autEl.value = s.autonomy; }
            if (s.identity !== undefined) {
                activePersonaIndex = parseInt(s.identity);
                if (isNaN(activePersonaIndex)) activePersonaIndex = -1;
            }
        }
    }

    // ==========================================
    // LLM PROVIDERS & KEYS
    // ==========================================
    var providerModels = {
        openai: ["gpt-4o", "gpt-4o-mini"],
        anthropic: ["claude-3.5-sonnet-20241022", "claude-3-haiku-20240307"],
        google: ["gemini-2.5-pro", "gemini-2.0-flash"],
        groq: ["llama-3.3-70b-versatile"],
        ollama: ["llama3.2", "mistral"],
        deepseek: ["deepseek-chat", "deepseek-reasoner"],
        mistral: ["mistral-large-latest", "codestral-latest"],
        inception: ["mercury-2"]
    };

    var orModels = [];
    var orSelectedModel = "";
    var orSortKey = "name";
    var orSortDir = 1;

    document.getElementById("llm-provider")?.addEventListener("change", function() {
        var provider = this.value;
        var isOR = provider === "openrouter";
        appendLog("dash-log", "[UI] Provider changed to: " + provider);
        
        var keyInput = document.getElementById("llm-api-key");
        if (keyInput) {
            if (currentConfig.api_keys && currentConfig.api_keys[provider]) { keyInput.value = currentConfig.api_keys[provider]; } 
            else { keyInput.value = ""; }
        }

        var group = document.getElementById("llm-model-group");
        if (group) group.style.display = isOR ? "none" : "block";
        var orArea = document.getElementById("or-models-area");
        
        if (isOR) {
            if (orArea) orArea.classList.remove("hidden");
            if (orModels.length === 0 && keyInput && keyInput.value.length > 10) window.fetchORModels();
        } else {
            if (orArea) orArea.classList.add("hidden");
            var models = providerModels[provider] || [];
            var sel = document.getElementById("llm-model");
            if (sel) {
                sel.innerHTML = "";
                models.forEach(m => { var opt = document.createElement("option"); opt.value = m; opt.textContent = m; sel.appendChild(opt); });
            }
        }
    });

    document.getElementById("btn-toggle-key")?.addEventListener("click", function() {
        var input = document.getElementById("llm-api-key");
        if (input.type === "password") { input.type = "text"; this.textContent = "üôà"; } 
        else { input.type = "password"; this.textContent = "üëÅÔ∏è"; }
    });

    async function applyLLMConfig() {
        var provider = document.getElementById("llm-provider").value;
        var apiKey = document.getElementById("llm-api-key").value.trim();
        var model = provider === "openrouter" ? orSelectedModel : document.getElementById("llm-model").value;
        
        if (!apiKey && provider !== "ollama") { showToast("API key is required", "error"); return; }
        if (provider === "openrouter" && !model) { showToast("Select a model from the list first", "error"); return; }

        if (!currentConfig.api_keys) currentConfig.api_keys = {};
        currentConfig.api_keys[provider] = apiKey;

        if (!currentConfig.llm) currentConfig.llm = {};
        currentConfig.llm.provider = provider;
        currentConfig.llm.api_key = apiKey;
        currentConfig.llm.model = model;
        
        await saveAllConfig();
        showToast("LLM Configuration Saved", "success");
        
        var r1 = document.getElementById("or-save-reminder"); if (r1) r1.classList.remove("visible");
        var r2 = document.getElementById("llm-save-reminder"); if (r2) r2.classList.remove("visible");
    }

    async function testLLMConfig() {
        var apiKey = document.getElementById("llm-api-key").value.trim();
        if (!apiKey) { showToast("Enter an API key first", "error"); return; }
        showToast("Testing...", "info");
        try {
            var resp = await fetch("https://openrouter.ai/api/v1/models", { headers: { "Authorization": "Bearer " + apiKey } });
            if (resp.ok) showToast("API key is valid!", "success");
            else showToast("Invalid API key", "error");
        } catch(e) { showToast("Test failed", "error"); }
    }

    window.fetchORModels = function() {
        var listEl = document.getElementById("or-model-list");
        if (listEl) listEl.innerHTML = '<div style="padding:1rem;text-align:center;color:var(--text-dim);"><span class="spinner">‚ü≥</span> Loading...</div>';
        fetch("https://openrouter.ai/api/v1/models").then(r => r.json()).then(data => {
            orModels = (data.data || []).map(m => ({ id: m.id, name: m.name, input: parseFloat(m.pricing.prompt||"0"), output: parseFloat(m.pricing.completion||"0") }));
            renderORModels();
        }).catch(() => { if (listEl) listEl.innerHTML = "Failed to load models"; });
    };

    window.sortORModels = function(key) {
        if (orSortKey === key) { orSortDir *= -1; } else { orSortKey = key; orSortDir = 1; }
        renderORModels();
    };

    function renderORModels() {
        var searchEl = document.getElementById("or-model-search");
        var search = searchEl ? searchEl.value.toLowerCase() : "";
        var filtered = orModels.filter(m => m.id.toLowerCase().includes(search) || m.name.toLowerCase().includes(search));
        filtered.sort((a, b) => {
            var cmp = 0;
            if (orSortKey === "name") cmp = a.name.localeCompare(b.name);
            else if (orSortKey === "input") cmp = a.input - b.input;
            else if (orSortKey === "output") cmp = a.output - b.output;
            return cmp * orSortDir;
        });

        var html = '<table style="width:100%;font-size:0.8rem;text-align:left;border-collapse:collapse;">';
        filtered.slice(0, 100).forEach(m => {
            var sel = m.id === orSelectedModel;
            var bg = sel ? "background:rgba(16,185,129,0.15);" : "";
            html += `<tr data-model-id="${m.id}" style="cursor:pointer;border-bottom:1px solid var(--border);${bg}" class="or-model-row">`;
            html += `<td style="padding:0.5rem;">${m.name}<br><span style="color:var(--text-dim);font-size:0.7rem;">${m.id}</span></td>`;
            html += `<td style="padding:0.5rem;font-family:monospace;text-align:right;">$${(m.input*1000000).toFixed(2)}</td>`;
            html += `<td style="padding:0.5rem;font-family:monospace;text-align:right;">$${(m.output*1000000).toFixed(2)}</td></tr>`;
        });
        html += '</table>';
        var listEl = document.getElementById("or-model-list");
        if (listEl) listEl.innerHTML = html;
    }

    // ==========================================
    // PERSONAS & SETTINGS
    // ==========================================
    function renderPersonas() {
        var sel = document.getElementById("set-identity");
        if (sel) {
            sel.innerHTML = '<option value="-1">‚Äî BambooClaw Default (System Prompt Only) ‚Äî</option>';
            personas.forEach((p, i) => {
                var opt = document.createElement("option"); opt.value = i; opt.textContent = p.name;
                if (i === activePersonaIndex) opt.selected = true;
                sel.appendChild(opt);
            });
            sel.value = activePersonaIndex >= 0 ? activePersonaIndex : -1;
        }

        var listEl = document.getElementById("persona-list");
        if (!listEl) return;
        if (personas.length === 0) { listEl.innerHTML = '<p style="font-size:0.8rem;color:var(--text-dim);">No personas created.</p>'; return; }
        
        var html = '';
        personas.forEach((p, i) => {
            var isActive = i === activePersonaIndex;
            html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.6rem;border:1px solid ${isActive ? 'var(--accent)' : 'var(--border)'};margin-bottom:0.5rem;border-radius:6px;background:${isActive ? 'rgba(16,185,129,0.05)' : 'transparent'};">`;
            html += `<div style="flex:1;"><strong>${p.name}</strong><br><span style="font-size:0.7rem;color:var(--text-dim);">${p.prompt.substring(0, 60)}...</span></div>`;
            html += `<div><button type="button" class="btn btn-sm btn-outline" onclick="window.editPersona(${i})">‚úé</button> <button type="button" class="btn btn-sm btn-outline" style="color:var(--error);" onclick="window.deletePersona(${i})">‚úï</button></div></div>`;
        });
        listEl.innerHTML = html;
    }

    window.editPersona = function(idx) {
        var p = personas[idx];
        document.getElementById("new-persona-name").value = p.name;
        document.getElementById("new-persona-prompt").value = p.prompt;
        document.getElementById("btn-create-persona").textContent = "Update Persona";
        document.getElementById("btn-cancel-edit-persona").classList.remove("hidden");
        editingPersonaIndex = idx;
        document.getElementById("persona-details-block").open = true;
    };

    window.deletePersona = function(idx) {
        if (!confirm("Delete the persona '" + personas[idx].name + "'?")) return;
        personas.splice(idx, 1);
        if (activePersonaIndex === idx) activePersonaIndex = -1;
        else if (activePersonaIndex > idx) activePersonaIndex--;
        
        if (!currentConfig.settings) currentConfig.settings = {};
        currentConfig.settings.identity = String(activePersonaIndex);
        saveAllConfig();
        renderPersonas();
    };

    async function saveSettings() {
        var identVal = document.getElementById("set-identity").value;
        if (!currentConfig.settings) currentConfig.settings = {};
        
        currentConfig.settings.autonomy = document.getElementById("set-autonomy").value;
        currentConfig.settings.identity = identVal;
        currentConfig.settings.maxToolIterations = parseInt(document.getElementById("set-tool-iterations")?.value) || 10;
        
        if (!currentConfig.llm) currentConfig.llm = { provider: "openai", api_key: "", model: "", system_prompt: "" };
        currentConfig.llm.system_prompt = document.getElementById("settings-system-prompt").value;
        
        await saveAllConfig();
        showToast("Settings saved", "success");
        var sr = document.getElementById("settings-save-reminder"); if (sr) sr.classList.remove("visible");
    }

    // ==========================================
    // COMPOSIO & SKILLS ENGINE
    // ==========================================
    var COMPOSIO_API_URL = "https://backend.composio.dev/api/v3";
    var composioToolkits = [];
    var composioCategories = ["All"];
    var composioActiveCategory = "All";
    var composioToolkitDetails = {};

    var builtinSkills = [
        { id: "web_browser", icon: "üåê", name: "Web Browser", desc: "Navigate and scrape websites via Playwright" },
        { id: "web_search", icon: "üîç", name: "Web Search", desc: "Search Google, DuckDuckGo, or Bing" },
        { id: "docker", icon: "üê≥", name: "Docker", desc: "Manage containers, images, and volumes" }
    ];

    function renderBuiltinSkills() {
        var el = document.getElementById("skills-builtin");
        if (!el) return;
        var html = "";
        builtinSkills.forEach(s => {
            html += `<div class="skill-card enabled" data-skill-id="${s.id}" data-skill-type="builtin"><span class="skill-always-on">Always On</span><div class="skill-icon">${s.icon}</div><div class="skill-name">${s.name}</div><div class="skill-meta"><span style="font-size:0.65rem;color:var(--text-dim);">‚óè Built-in</span></div><div class="skill-desc-full">${s.desc}</div></div>`;
        });
        el.innerHTML = html;
    }

    function renderComposioToolkits() {
        var el = document.getElementById("skills-composio");
        if (!el) return;
        var search = (document.getElementById("skill-search")?.value || "").toLowerCase();
        var filtered = composioToolkits.filter(tk => {
            if (search && !tk.name.toLowerCase().includes(search) && !tk.slug.toLowerCase().includes(search)) return false;
            if (composioActiveCategory !== "All" && !tk.categories?.includes(composioActiveCategory)) return false;
            return true;
        });

        var html = "";
        filtered.forEach(tk => {
            var isEnabled = currentConfig.enabledSkills && currentConfig.enabledSkills["composio_" + tk.slug];
            var imgSrc = tk.local_logo || tk.logo || "";
            var logoHtml = imgSrc ? `<img src="${imgSrc}" onerror="this.outerHTML='<span class=skill-icon>üß©</span>'" />` : `üß©`;
            
            html += `<div class="skill-card ${isEnabled ? 'enabled' : ''}" data-skill-id="composio_${tk.slug}">`;
            html += `<button type="button" class="skill-toggle"></button>`;
            html += `<div class="skill-icon">${logoHtml}</div><div class="skill-name">${tk.name}</div>`;
            html += `<div class="skill-meta"><span style="font-size:0.65rem;color:var(--accent);">‚óè ${tk.tools_count || 0} tools</span></div>`;
            if (tk.auth_warning) html += `<div class="auth-warning-badge">‚ö† Not connected</div>`;
            html += `</div>`;
        });
        el.innerHTML = html || '<div style="color:var(--text-dim);font-size:0.85rem;padding:0.5rem;">No matching toolkits</div>';
    }

    function renderEnabledIntegrations() {
        var section = document.getElementById("enabled-integrations-section");
        var grid = document.getElementById("skills-enabled-integrations");
        if (!section || !grid) return;
        var html = "", count = 0;
        
        Object.keys(currentConfig.enabledSkills || {}).forEach(k => {
            if (!currentConfig.enabledSkills[k] || !k.startsWith("composio_")) return;
            count++;
            var slug = k.replace("composio_", "");
            var tk = composioToolkits.find(t => t.slug === slug);
            var name = tk ? (tk.name || slug) : slug;
            var logoHtml = tk && tk.logo ? `<img src="${tk.logo}" />` : `üß©`;
            
            html += `<div class="skill-card" style="cursor:pointer;" onclick="window.toggleSkill('${k}')"><div style="display:flex;align-items:center;gap:0.5rem;"><div class="skill-icon">${logoHtml}</div><div style="flex:1;"><div style="font-size:0.85rem;font-weight:600;">${name}</div></div><span style="color:#ef4444;font-size:0.7rem;">‚úï</span></div></div>`;
        });
        
        section.style.display = count > 0 ? "" : "none";
        grid.innerHTML = html;
    }

    function renderActiveToolsSummary() {
        var badge = document.getElementById("active-tools-count-badge");
        var listEl = document.getElementById("active-tools-list");
        if (!badge || !listEl) return;
        var count = 0;
        Object.keys(currentConfig.enabledSkills || {}).forEach(k => { if (currentConfig.enabledSkills[k]) count++; });
        badge.textContent = count;
        listEl.innerHTML = `<div style="color:var(--text-dim);font-size:0.75rem;padding:0.25rem 0;">${count} Toolkits Active</div>`;
    }

    async function saveComposioKey() {
        var key = document.getElementById("composio-api-key").value.trim();
        if (!key) { showToast("Please enter a Composio API key", "error"); return; }
        currentConfig.composioApiKey = key;
        saveAllConfig();

        var statusEl = document.getElementById("composio-status");
        statusEl.style.display = "block";
        statusEl.innerHTML = '<span style="color:var(--text-dim);">‚ü≥ Fetching toolkits...</span>';

        try {
            var resp = await fetch(COMPOSIO_API_URL + "/toolkits?limit=500", { headers: { "x-api-key": key } });
            if (resp.ok) {
                var toolkitsData = await resp.json();
                composioToolkits = (toolkitsData.items || []).map(tk => ({
                    slug: tk.slug, name: tk.name || tk.slug, logo: tk.logo || "", categories: tk.categories || [], tools_count: tk.tools_count || 0
                }));
                statusEl.innerHTML = '<span style="color:var(--accent);">‚úì Connected to Composio</span>';
                document.getElementById("composio-placeholder")?.classList.add("hidden");
                document.getElementById("composio-connected-area")?.classList.remove("hidden");
                renderBuiltinSkills();
                renderComposioToolkits();
                renderEnabledIntegrations();
            } else {
                statusEl.innerHTML = '<span style="color:var(--error);">‚úó Invalid API key</span>';
            }
        } catch(e) {
            statusEl.innerHTML = '<span style="color:var(--warning);">‚ö† CORS error in preview. Saved for Desktop.</span>';
        }
    }

    window.toggleSkill = function(skillId) {
        if (!currentConfig.enabledSkills) currentConfig.enabledSkills = {};
        currentConfig.enabledSkills[skillId] = !currentConfig.enabledSkills[skillId];
        saveAllConfig();
        renderComposioToolkits();
        renderEnabledIntegrations();
        renderActiveToolsSummary();
        showToast(skillId + (currentConfig.enabledSkills[skillId] ? " enabled" : " disabled"), "info");
    };

    // ==========================================
    // AGENT CHAT & DAEMON LOGIC
    // ==========================================
    async function toggleDaemon() {
        if (daemonRunning) {
            try {
                await invokeShort("stop_daemon");
                daemonRunning = false;
                showToast("Agent daemon stopped", "info");
            } catch(e) { daemonRunning = false; }
        } else {
            try {
                await invokeShort("start_daemon");
                daemonRunning = true;
                showToast("Agent daemon started", "success");
            } catch(e) { showToast("Failed to start daemon", "error"); }
        }
        
        var pill = document.getElementById("daemon-status-pill");
        var text = document.getElementById("daemon-status-text");
        var btn = document.getElementById("btn-daemon-toggle");
        if (daemonRunning) {
            pill.className = "status-pill running"; text.textContent = "Running"; btn.textContent = "Stop Agent Daemon"; btn.classList.add("btn-danger");
        } else {
            pill.className = "status-pill stopped"; text.textContent = "Stopped"; btn.textContent = "Start Agent Daemon"; btn.classList.remove("btn-danger");
        }
    }

    async function emergencyFlush() {
        showToast("Flushing system processes...", "info");
        try { await invokeShort("emergency_flush"); } catch(e) {}
        daemonRunning = false;
        var pill = document.getElementById("daemon-status-pill");
        if (pill) pill.className = "status-pill stopped";
        showToast("System flushed successfully", "success");
    }

    async function sendAgentMessage(e) {
        if (e) { e.preventDefault(); e.stopPropagation(); }
        var input = document.getElementById("agent-chat-input");
        var msg = input.value.trim();
        if (!msg) return;
        input.value = "";
        
        var chatEl = document.getElementById("agent-chat-messages");
        chatEl.innerHTML += `<div class="chat-msg"><span class="role">You:</span> ${msg}</div>`;
        chatEl.scrollTop = chatEl.scrollHeight;

        if (!daemonRunning) {
            chatEl.innerHTML += `<div class="chat-msg assistant"><span class="role">Agent:</span> Daemon is offline. Please start it first.</div>`;
            return;
        }

        chatEl.innerHTML += `<div class="chat-msg assistant" id="typing-indicator"><span class="role">Agent:</span> <span class="spinner">‚ü≥</span> Thinking...</div>`;
        chatEl.scrollTop = chatEl.scrollHeight;
        
        setTimeout(() => {
            var typing = document.getElementById("typing-indicator"); if (typing) typing.remove();
            chatEl.innerHTML += `<div class="chat-msg assistant"><span class="role">Agent:</span> Message received. Tool execution active in background.</div>`;
            chatEl.scrollTop = chatEl.scrollHeight;
        }, 1500);
    }

    // ==========================================
    // EVENT BINDINGS (SAFE WRAPPERS)
    // ==========================================
    function safeBind(id, event, fn) {
        var el = document.getElementById(id);
        if (el) el.addEventListener(event, fn);
    }

    window.filterHelp = function(query) {
        query = query.toLowerCase();
        document.querySelectorAll(".help-section").forEach(sec => {
            sec.style.display = sec.textContent.toLowerCase().includes(query) ? "block" : "none";
        });
    };

    window.toggleActiveToolsList = function() {
        var list = document.getElementById("active-tools-list");
        if (list) list.classList.toggle("visible");
    };

    safeBind("btn-copy-boot-log", "click", () => copyLog("boot-log"));
    safeBind("btn-copy-install-log", "click", () => copyLog("install-log"));
    safeBind("btn-copy-cap-log", "click", () => copyLog("capability-log"));
    safeBind("btn-copy-log", "click", () => copyLog("unified-log"));
    safeBind("btn-copy-payload", "click", () => copyLog("llm-payload-display"));

    safeBind("btn-back-step1", "click", () => wizardGo(0));
    safeBind("btn-back-step2", "click", () => wizardGo(1));
    safeBind("btn-step0-next", "click", () => wizardGo(1));
    safeBind("btn-step1-next", "click", () => wizardGo(2));
    safeBind("btn-enter-dashboard", "click", () => window.enterDashboard());

    safeBind("btn-apply-llm", "click", applyLLMConfig);
    safeBind("btn-test-llm", "click", testLLMConfig);
    safeBind("btn-save-settings", "click", saveSettings);
    
    safeBind("btn-cancel-edit-persona", "click", () => {
        document.getElementById("new-persona-name").value = "";
        document.getElementById("new-persona-prompt").value = "";
        document.getElementById("btn-create-persona").textContent = "Save Persona";
        document.getElementById("btn-cancel-edit-persona").classList.add("hidden");
        editingPersonaIndex = -1;
    });

    safeBind("or-model-search", "input", renderORModels);
    safeBind("or-sort-name", "click", () => window.sortORModels("name"));
    safeBind("or-sort-input", "click", () => window.sortORModels("input"));
    safeBind("or-sort-output", "click", () => window.sortORModels("output"));
    safeBind("btn-fetch-models", "click", window.fetchORModels);

    safeBind("btn-daemon-toggle", "click", toggleDaemon);
    safeBind("btn-emergency-flush", "click", emergencyFlush);
    safeBind("btn-send-chat", "click", sendAgentMessage);

    safeBind("btn-save-composio", "click", saveComposioKey);
    safeBind("btn-toggle-tools-list", "click", window.toggleActiveToolsList);
    
    var chatInput = document.getElementById("agent-chat-input");
    if (chatInput) chatInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendAgentMessage(e); });

    var helpSearchEl = document.getElementById("help-search");
    if (helpSearchEl) helpSearchEl.addEventListener("input", (e) => window.filterHelp(e.target.value));

    var skillSearchEl = document.getElementById("skill-search");
    if (skillSearchEl) skillSearchEl.addEventListener("input", renderComposioToolkits);

    document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", function() {
            document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
            this.classList.add("active");
            document.querySelectorAll(".tab-panel").forEach(p => p.classList.add("hidden"));
            document.getElementById(this.getAttribute("data-tab")).classList.remove("hidden");
        });
    });

    // ==========================================
    // BOOT SEQUENCE
    // ==========================================
    window.enterDashboard = async function() {
        try {
            document.getElementById("wizard-view").style.display = "none";
            document.getElementById("dashboard-view").style.display = "block";
            document.getElementById("dashboard-view").classList.remove("hidden");
            await loadConfig();
            localStorage.setItem("bambooclaw-installed", "true");
        } catch(e) { appendLog("dash-log", "[ERROR] enterDashboard failed"); }
    };

    async function boot() {
        try {
            var installedFlag = localStorage.getItem("bambooclaw-installed");
            if (installedFlag === "true") {
                await window.enterDashboard();
                if (!currentConfig.settings) {
                    currentConfig.settings = { autonomy: "autonomous", port: "7331", tunnel: "none", identity: "-1", runtime: "native", loglevel: "info", maxToolIterations: 10 };
                    saveAllConfig();
                }
                
                if (currentConfig.composioApiKey) {
                    var ckEl = document.getElementById("composio-api-key");
                    if (ckEl) ckEl.value = currentConfig.composioApiKey;
                    setTimeout(saveComposioKey, 1000);
                }
                
                setTimeout(() => { renderActiveToolsSummary(); renderEnabledIntegrations(); }, 2000);
                setTimeout(() => { if (currentConfig.llm && currentConfig.llm.api_key && !daemonRunning) toggleDaemon(); }, 500);
            } else {
                var btn = document.getElementById("btn-step0-next");
                if (btn) btn.disabled = false;
            }
        } catch(e) { appendLog("dash-log", "[BOOT] Error: " + e); }
    }

    (function waitForTauri() {
        try {
            var waited = 0;
            var interval = setInterval(() => {
                waited += 50;
                if (window.__TAURI__) { clearInterval(interval); boot(); } 
                else if (waited >= 3000) { clearInterval(interval); boot(); }
            }, 50);
        } catch(e) {}
    })();

    </script>
</body>
</html>