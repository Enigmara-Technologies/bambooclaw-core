
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src *; img-src 'self' data: https: asset: http://asset.localhost;">
    <title>BambooClaw‚Ñ¢</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f;
            --card: #12121e;
            --accent: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.2);
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --border: #1e293b;
            --error: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }
        #app { display: flex; flex-direction: column; height: 100vh; }
        header {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            flex-shrink: 0;
        }
        .logo { display: flex; align-items: center; gap: 0.6rem; font-weight: 800; font-size: 1.1rem; letter-spacing: -0.025em; color: var(--accent); }
        .logo img { height: 32px; width: auto; }
        main { flex: 1; overflow-y: auto; padding: 1rem 1.5rem; position: relative; min-height: 0; }
        .container { max-width: 800px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* Step Indicator */
        .steps { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .step-dot { flex: 1; height: 4px; background: var(--border); border-radius: 2px; transition: 0.3s; }
        .step-dot.active { background: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        /* Cards */
        .glass-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 { font-size: 1.5rem; margin-bottom: 0.4rem; }
        p.subtitle { color: var(--text-dim); margin-bottom: 1rem; }

        /* List Rows */
        .check-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .status-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; }
        .status-detecting { color: var(--text-dim); }
        .status-found { color: var(--accent); }
        .status-not-installed { color: var(--warning); background: rgba(245, 158, 11, 0.1); }
        .status-error { color: var(--error); }

        /* Log Panel */
        .log-container {
            margin-top: 1.5rem;
            position: relative;
            background: #050507;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #1a1a2e;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .log-body {
            height: 150px;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .copy-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 4px;
        }
        .copy-btn:hover { color: var(--accent); }

        /* Buttons */
        .btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn:hover { filter: brightness(1.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--accent); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
        .btn-danger { background: var(--error); }
        .btn-flush { background: transparent; border: 2px solid #ff4444; color: #ff4444; font-weight: 700; }
        .btn-flush:hover { background: #ff4444; color: #fff; }

        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1rem; flex-wrap: wrap; }
        .tab { padding: 0.6rem 1rem; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; transition: 0.2s; user-select: none; font-size: 0.85rem; }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .save-reminder { display: none; padding: 0.5rem 0.75rem; margin-top: 0.75rem; background: rgba(245,158,11,0.1); border: 1px solid var(--warning); border-radius: 6px; font-size: 0.8rem; color: var(--warning); }
        .save-reminder.visible { display: block; }
        .active-model-display { padding: 0.6rem 0.75rem; margin-bottom: 0.75rem; background: rgba(16,185,129,0.08); border: 1px solid var(--accent); border-radius: 6px; font-size: 0.85rem; }

        /* Skill Grid */
        .skill-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; }
        .skill-card {
            background: #050507; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .skill-card:hover { border-color: var(--accent); transform: translateY(-1px); }
        .skill-card.enabled { border-color: var(--accent); background: rgba(16, 185, 129, 0.05); }
        .skill-card .skill-icon { width: 48px; height: 48px; border-radius: 8px; background: #ffffff; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 0.5rem; flex-shrink: 0; font-size: 1.5rem; }
        .skill-card .skill-icon img { width: 36px; height: 36px; object-fit: contain; display: block; }
        .skill-card .skill-name { font-weight: 600; font-size: 0.85rem; margin-bottom: 0.25rem; }
        .skill-card .skill-desc { font-size: 0.7rem; color: var(--text-dim); line-height: 1.3; display: none; }
        .skill-card .skill-meta { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.3rem; }
        .skill-info-btn {
            background: transparent; border: 1px solid var(--border); color: var(--text-dim); width: 20px; height: 20px;
            border-radius: 50%; font-size: 0.65rem; cursor: pointer; display: inline-flex; align-items: center;
            justify-content: center; transition: 0.2s; flex-shrink: 0; padding: 0; line-height: 1;
        }
        .skill-info-btn:hover { border-color: var(--accent); color: var(--accent); }
        .skill-desc-full { display: none; margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-dim); line-height: 1.4; border-top: 1px solid var(--border); padding-top: 0.5rem; max-height: 300px; overflow-y: auto; }
        .skill-desc-full.visible { display: block; }
        .toolkit-tools-list { margin-top: 0.5rem; }
        .toolkit-tool-row { padding: 0.35rem 0; border-bottom: 1px solid rgba(30,41,59,0.5); cursor: pointer; }
        .toolkit-tool-row:hover { background: rgba(16,185,129,0.05); }
        .toolkit-tool-row .tool-header { display: flex; justify-content: space-between; align-items: center; }
        .toolkit-tool-row .tool-name { font-weight: 600; font-size: 0.7rem; color: var(--text); }
        .toolkit-tool-row .tool-slug { font-size: 0.6rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
        .toolkit-tool-row .tool-desc { font-size: 0.65rem; color: var(--text-dim); margin-top: 0.2rem; }
        .toolkit-tool-params { display: none; margin-top: 0.3rem; padding: 0.3rem 0.5rem; background: rgba(5,5,7,0.5); border-radius: 4px; font-size: 0.6rem; font-family: 'JetBrains Mono', monospace; }
        .toolkit-tool-params.visible { display: block; }
        .toolkit-tool-params .param-row { display: flex; gap: 0.5rem; padding: 0.15rem 0; }
        .toolkit-tool-params .param-name { color: var(--accent); min-width: 80px; }
        .toolkit-tool-params .param-type { color: var(--warning); min-width: 60px; }
        .toolkit-tool-params .param-req { color: var(--error); font-size: 0.55rem; }

        /* Always On label for built-in skills */
        .skill-always-on {
            position: absolute; top: 0.75rem; right: 0.75rem;
            font-size: 0.6rem; font-weight: 600; color: var(--accent);
            background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3);
            padding: 2px 8px; border-radius: 10px; letter-spacing: 0.02em;
        }

        /* Active Tools Summary Panel */
        .active-tools-panel {
            margin-bottom: 1.5rem; padding: 1rem; border: 1px solid var(--border);
            border-radius: 8px; background: rgba(16,185,129,0.03);
        }
        .active-tools-header {
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; user-select: none;
        }
        .active-tools-header:hover { color: var(--accent); }
        .active-tools-count {
            font-size: 0.95rem; font-weight: 700;
        }
        .active-tools-badge {
            font-size: 0.75rem; font-weight: 700; color: #000; background: var(--accent);
            padding: 2px 10px; border-radius: 10px; min-width: 28px; text-align: center;
        }
        .active-tools-list {
            display: none; margin-top: 0.75rem; max-height: 300px; overflow-y: auto;
            border-top: 1px solid var(--border); padding-top: 0.5rem;
        }
        .active-tools-list.visible { display: block; }
        .active-tool-entry {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.25rem 0.5rem; font-size: 0.75rem; font-family: 'JetBrains Mono', monospace;
            border-radius: 4px;
        }
        .active-tool-entry:hover { background: rgba(16,185,129,0.05); }
        .active-tool-entry .tool-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        .active-tool-entry .tool-dot.builtin { background: #60a5fa; }
        .active-tool-entry .tool-dot.composio { background: var(--accent); }

        /* Auth Warning Badge */
        .auth-warning-badge {
            display: inline-flex; align-items: center; gap: 0.3rem;
            font-size: 0.6rem; color: var(--warning); background: rgba(245,158,11,0.1);
            border: 1px solid rgba(245,158,11,0.3); padding: 2px 6px; border-radius: 4px;
            margin-top: 0.3rem;
        }

        /* Connection Modal */
        .conn-modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center;
        }
        .conn-modal-overlay.visible { display: flex; }
        .conn-modal {
            background: #0f1117; border: 1px solid var(--border); border-radius: 12px;
            padding: 1.5rem; width: 90%; max-width: 420px; color: var(--text);
        }
        .conn-modal h3 { margin: 0 0 0.5rem; font-size: 1rem; }
        .conn-modal p { font-size: 0.8rem; color: var(--text-dim); margin: 0 0 1rem; line-height: 1.4; }
        .conn-modal label { display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 0.3rem; }
        .conn-modal input[type="text"], .conn-modal input[type="password"] {
            width: 100%; box-sizing: border-box; padding: 0.5rem 0.75rem; background: #050507;
            border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85rem;
            margin-bottom: 0.75rem; font-family: 'JetBrains Mono', monospace;
        }
        .conn-modal input:focus { border-color: var(--accent); outline: none; }
        .conn-modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 0.5rem; }
        .conn-modal-actions button { padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; border: none; }
        .conn-modal-actions .btn-connect { background: var(--accent); color: #000; font-weight: 600; }
        .conn-modal-actions .btn-connect:hover { opacity: 0.9; }
        .conn-modal-actions .btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
        .conn-modal-actions .btn-cancel:hover { border-color: var(--text); color: var(--text); }
        .conn-modal .conn-or { text-align: center; font-size: 0.7rem; color: var(--text-dim); margin: 0.5rem 0; }
        .conn-modal .btn-oauth { width: 100%; padding: 0.5rem; background: rgba(16,185,129,0.1); border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
        .conn-modal .btn-oauth:hover { background: rgba(16,185,129,0.2); }

        /* Trigger Entry */
        .trigger-entry {
            padding: 0.3rem 0; border-bottom: 1px solid rgba(30,41,59,0.3);
            font-size: 0.65rem;
        }
        .trigger-entry .trigger-name { font-weight: 600; color: var(--warning); }
        .trigger-entry .trigger-desc { color: var(--text-dim); margin-top: 0.1rem; }
        .trigger-info-banner {
            margin-top: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(245,158,11,0.06);
            border-left: 2px solid var(--warning); border-radius: 4px;
            font-size: 0.65rem; color: var(--text-dim); line-height: 1.4;
        }

        /* Approval Card */
        .approval-card {
            background: #1a1a2e; border: 1px solid var(--warning); border-radius: 8px; padding: 1rem; margin: 0.75rem 0;
        }
        .approval-card .approval-title { font-weight: 600; color: var(--warning); margin-bottom: 0.5rem; font-size: 0.9rem; }
        .approval-card .approval-detail { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.75rem; word-break: break-all; max-height: 100px; overflow-y: auto; }
        .approval-card .approval-actions { display: flex; gap: 0.5rem; }
        .approval-card .btn-approve { background: var(--success); color: #000; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .approval-card .btn-deny { background: var(--error); color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .approval-card .approval-timeout { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.5rem; }

        .skill-card .skill-toggle {
            position: absolute; top: 0.75rem; right: 0.75rem; width: 36px; height: 20px;
            background: var(--border); border-radius: 10px; transition: 0.2s; border: none; cursor: pointer;
        }
        .skill-card .skill-toggle::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px;
            background: var(--text-dim); border-radius: 50%; transition: 0.2s;
        }
        .skill-card.enabled .skill-toggle { background: var(--accent); }
        .skill-card.enabled .skill-toggle::after { left: 18px; background: white; }

        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; color: var(--text-dim); font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            background: #050507;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.75rem;
            border-radius: 6px;
            outline: none;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); }

        /* Status indicators */
        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-pill.running { background: rgba(16,185,129,0.15); color: var(--success); }
        .status-pill.stopped { background: rgba(239,68,68,0.15); color: var(--error); }

        /* Channel row */
        .channel-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }
        .channel-row .channel-name { font-weight: 600; }
        .channel-row .channel-status { font-size: 0.8rem; color: var(--text-dim); }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            font-size: 0.9rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.info { border-left: 3px solid var(--accent); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }

        /* Animations */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; display: inline-block; }

        /* Chat */
        .chat-container {
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 1rem;
            background: #050507;
        }
        .chat-input-row {
            display: flex;
            border-top: 1px solid var(--border);
        }
        .chat-input-row input {
            flex: 1;
            border: none;
            border-radius: 0;
        }
        .chat-input-row button {
            border-radius: 0;
            white-space: nowrap;
        }
        .chat-msg {
            margin-bottom: 0.75rem;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        .chat-msg .role {
            font-weight: 700;
            color: var(--accent);
            margin-right: 0.5rem;
        }
        .chat-msg.assistant .role { color: var(--warning); }

        /* Settings grid */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        @media (max-width: 600px) {
            .settings-grid { grid-template-columns: 1fr; }
            .tabs { flex-wrap: wrap; }
        }

        /* Help Section */
        .help-search {
            width: 100%;
            background: #050507;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            border-radius: 6px;
            outline: none;
            font-family: inherit;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        .help-search:focus { border-color: var(--accent); }
        .help-search-wrap {
            position: relative;
        }
        .help-search-wrap::before {
            content: 'üîç';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9rem;
            pointer-events: none;
        }
        .help-section {
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .help-section summary {
            padding: 1rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            background: #050507;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            user-select: none;
            transition: 0.2s;
        }
        .help-section summary:hover { background: rgba(16, 185, 129, 0.05); }
        .help-section summary::-webkit-details-marker { display: none; }
        .help-section summary::after {
            content: '‚ñ∏';
            margin-left: auto;
            transition: transform 0.2s;
            color: var(--text-dim);
        }
        .help-section[open] summary::after { transform: rotate(90deg); }
        .help-section[open] summary { border-bottom: 1px solid var(--border); background: rgba(16, 185, 129, 0.03); }
        .help-body {
            padding: 1.25rem;
            font-size: 0.85rem;
            line-height: 1.7;
            color: var(--text-dim);
        }
        .help-body p { margin-bottom: 0.75rem; }
        .help-body ol, .help-body ul { margin: 0.5rem 0 1rem 1.5rem; }
        .help-body li { margin-bottom: 0.4rem; }
        .help-body strong { color: var(--text); }
        .help-body code {
            background: rgba(16, 185, 129, 0.1);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--accent);
        }
        .help-tip, .help-warn {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin: 0.75rem 0;
            font-size: 0.8rem;
            line-height: 1.5;
        }
        .help-tip {
            background: rgba(16, 185, 129, 0.08);
            border-left: 3px solid var(--accent);
        }
        .help-warn {
            background: rgba(245, 158, 11, 0.08);
            border-left: 3px solid var(--warning);
        }
        .help-step {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            align-items: flex-start;
        }
        .help-step-num {
            min-width: 24px;
            height: 24px;
            background: var(--accent);
            color: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.75rem;
            flex-shrink: 0;
            margin-top: 0.1rem;
        }
        .help-sub {
            margin: 0.75rem 0;
            padding: 0.75rem 1rem;
            background: #050507;
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        .help-sub h4 {
            font-size: 0.85rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        /* Splash Screen */
        .splash-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 99999;
            background: #0a0a0f;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease;
        }
        .splash-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        .splash-logo {
            width: 400px;
            max-width: 80vw;
            height: auto;
            margin-bottom: 1.5rem;
            animation: splashPulse 2s ease-in-out infinite;
            filter: drop-shadow(0 0 30px rgba(16, 185, 129, 0.4));
        }
        .splash-title {
            font-family: 'Inter', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--accent);
            letter-spacing: -0.03em;
            margin-bottom: 2rem;
        }
        .splash-bar-track {
            width: 220px;
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }
        .splash-bar-fill {
            width: 30%;
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            animation: splashBarPulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 8px var(--accent-glow);
        }
        @keyframes splashPulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 30px rgba(16, 185, 129, 0.4)); }
            50% { transform: scale(1.03); filter: drop-shadow(0 0 50px rgba(16, 185, 129, 0.6)); }
        }
        @keyframes splashBarPulse {
            0% { width: 10%; margin-left: 0; }
            50% { width: 60%; margin-left: 20%; }
            100% { width: 10%; margin-left: 90%; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="splash-overlay" id="splash-screen">
            <img class="splash-logo" src="logo.png" alt="BambooClaw Logo">
            <div class="splash-title">BambooClaw‚Ñ¢</div>
            <div class="splash-bar-track"><div class="splash-bar-fill"></div></div>
        </div>
        <script>
        // Self-contained splash timer ‚Äî runs independently of boot()
        (function() {
            var SPLASH_DURATION = 3000;
            var splashEl = document.getElementById("splash-screen");
            if (!splashEl) return;
            setTimeout(function() {
                if (!splashEl) return;
                splashEl.classList.add("fade-out");
                setTimeout(function() { if (splashEl.parentNode) splashEl.parentNode.removeChild(splashEl); }, 800);
            }, SPLASH_DURATION);
        })();
        </script>
        <header>
            <div class="logo"><span style="font-size:1.1rem;font-weight:700;color:var(--accent);">BambooClaw‚Ñ¢</span></div>
            <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent);"><span id="app-version">loading...</span></div>
        </header>
        <main>
            <div id="wizard-view" class="container">
                <div class="steps">
                    <div class="step-dot active" id="dot-0"></div>
                    <div class="step-dot" id="dot-1"></div>
                    <div class="step-dot" id="dot-2"></div>
                    <div class="step-dot" id="dot-3"></div>
                </div>

                <div class="glass-card wizard-step" id="step-0">
                    <h1>Environment Audit</h1>
                    <p class="subtitle">Ensuring your system is prepared for BambooClaw‚Ñ¢ edge deployment.</p>
                    <div>
                        <div class="check-row">
                            <span>Operating System</span>
                            <span class="status-badge status-detecting" id="chk-os">Detecting...</span>
                        </div>
                        <div class="check-row">
                            <span>Rust Toolchain</span>
                            <span class="status-badge status-detecting" id="chk-rust">Detecting...</span>
                        </div>
                        <div class="check-row">
                            <span>Git CLI</span>
                            <span class="status-badge status-detecting" id="chk-git">Detecting...</span>
                        </div>
                        <div class="check-row">
                            <span>Build Tools</span>
                            <span class="status-badge status-detecting" id="chk-build">Detecting...</span>
                        </div>
                        <div class="check-row">
                            <span>Python</span>
                            <span class="status-badge status-detecting" id="chk-python">Detecting...</span>
                        </div>
                        <div class="check-row">
                            <span>Node.js</span>
                            <span class="status-badge status-detecting" id="chk-node">Detecting...</span>
                        </div>
                    </div>
                    <div class="log-container">
                        <div class="log-header">
                            <span>BOOT TRACE LOG</span>
                            <button class="btn btn-sm btn-outline" id="btn-copy-boot-log" style="padding: 2px 6px; font-size: 0.7rem;">üìã Copy</button>
                        </div>
                        <div class="log-body" id="boot-log"></div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button class="btn" id="btn-step0-next" disabled>Initialize Environment ‚Üí</button>
                    </div>
                </div>

    <script>
    (function() {
        try {
            var el = document.getElementById("boot-log");
            if (el) el.textContent = "[CANARY] JS engine alive at " + new Date().toISOString() + "\n";
            // Also init unified log
            var ul = document.getElementById("unified-log");
            if (ul && !ul.textContent) ul.textContent = "";
        } catch(e) {}
    })();
    // Global error boundary
    window.onerror = function(msg, src, line, col, err) {
        try {
            var el = document.getElementById("boot-log");
            if (el) el.textContent += "[FATAL] " + msg + " at line " + line + ":" + col + "\n";
        } catch(e) {}
        return false;
    };
    window.addEventListener("unhandledrejection", function(event) {
        try {
            var el = document.getElementById("boot-log");
            if (el) el.textContent += "[FATAL] Unhandled rejection: " + (event.reason ? (event.reason.message || event.reason) : "unknown") + "\n";
        } catch(e) {}
    });
    </script>

                <div class="glass-card wizard-step hidden" id="step-1">
                    <h1>Readying Prereqs</h1>
                    <p class="subtitle">Applying required system dependencies and development toolchains.</p>
                    <div class="log-container">
                        <div class="log-header">
                            <span>SYSTEM INSTALLATION LOG</span>
                            <button class="btn btn-sm btn-outline" id="btn-copy-install-log" style="padding: 2px 6px; font-size: 0.7rem;">üìã Copy</button>
                        </div>
                        <div class="log-body" id="install-log"></div>
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                        <button class="btn btn-outline" id="btn-back-step1">‚Üê Back</button>
                        <button class="btn" id="btn-step1-next" disabled>Agent Capabilities ‚Üí</button>
                    </div>
                </div>

                <div class="glass-card wizard-step hidden" id="step-2">
                    <h1>Agent Capabilities</h1>
                    <p class="subtitle">Select additional tools to maximize your agent's autonomous power.</p>

                    <div style="margin-bottom: 1rem;">
                        <label style="display:flex;align-items:flex-start;gap:0.75rem;padding:1rem;border:1px solid var(--border);border-radius:8px;cursor:pointer;background:rgba(16,185,129,0.05);">
                            <input type="checkbox" id="cap-python" checked style="margin-top:3px;accent-color:var(--accent);width:18px;height:18px;">
                            <div>
                                <div style="font-weight:600;color:var(--accent);">Python Ecosystem <span style="font-size:0.75rem;color:var(--text-dim);">(Recommended)</span></div>
                                <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.25rem;">Python 3.12, pyautogui, pillow, requests, beautifulsoup4, psutil, pandas, numpy</div>
                                <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.25rem;">Enables: GUI automation, screenshots, data analysis, web scraping</div>
                            </div>
                        </label>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display:flex;align-items:flex-start;gap:0.75rem;padding:1rem;border:1px solid var(--border);border-radius:8px;cursor:pointer;">
                            <input type="checkbox" id="cap-browser" style="margin-top:3px;accent-color:var(--accent);width:18px;height:18px;">
                            <div>
                                <div style="font-weight:600;">Browser Automation</div>
                                <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.25rem;">Playwright with Chromium</div>
                                <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.25rem;">Enables: Headless web browsing, form filling, web testing</div>
                            </div>
                        </label>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display:flex;align-items:flex-start;gap:0.75rem;padding:1rem;border:1px solid var(--border);border-radius:8px;cursor:pointer;">
                            <input type="checkbox" id="cap-node" style="margin-top:3px;accent-color:var(--accent);width:18px;height:18px;">
                            <div>
                                <div style="font-weight:600;">Developer Tools</div>
                                <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.25rem;">Node.js LTS</div>
                                <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.25rem;">Enables: JavaScript execution, npm package ecosystem</div>
                            </div>
                        </label>
                    </div>

                    <div class="log-container">
                        <div class="log-header">
                            <span>CAPABILITY INSTALL LOG</span>
                            <button class="btn btn-sm btn-outline" id="btn-copy-cap-log" style="padding: 2px 6px; font-size: 0.7rem;">üìã Copy</button>
                        </div>
                        <div class="log-body" id="capability-log"></div>
                    </div>

                    <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                        <button class="btn btn-outline" id="btn-back-step2">‚Üê Back</button>
                        <div style="display:flex;gap:0.75rem;">
                            <button class="btn btn-outline" id="btn-step2-skip">Skip for Now ‚Üí</button>
                            <button class="btn" id="btn-step2-install">Install Selected</button>
                        </div>
                    </div>
                </div>

                <div class="glass-card wizard-step hidden" id="step-3">
                    <div style="text-align: center; padding: 2rem 0;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚úì</div>
                        <h1>Installation Complete</h1>
                        <p class="subtitle">BambooClaw‚Ñ¢ is now registered as a system service.</p>
                        <div class="form-group" style="text-align: left;">
                            <label>Storage Path</label>
                            <input type="text" id="install-path-display" readonly value="~/.bambooclaw/bambooclaw" />
                        </div>
                        <button class="btn" id="btn-enter-dashboard">Enter Companion Dashboard</button>
                    </div>
                </div>
            </div>

            <div id="dashboard-view" class="container hidden">
                <div class="tabs">
                    <div class="tab active" data-tab="tab-llm">LLM Settings</div>
                    <div class="tab" data-tab="tab-channels">Channels</div>
                    <div class="tab" data-tab="tab-agent">Agent Control</div>
                    <div class="tab" data-tab="tab-skills">Skills</div>
                    <div class="tab" data-tab="tab-settings">Settings</div>
                    <div class="tab" data-tab="tab-logs">Logs</div>
                    <div class="tab" data-tab="tab-help">Help</div>
                    <div class="tab" data-tab="tab-about">About</div>
                </div>

                <div class="glass-card tab-panel" id="tab-llm">
                    <div class="form-group">
                        <label>AI Provider</label>
                        <select id="llm-provider">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google Gemini</option>
                            <option value="groq">Groq (Ultra-Fast)</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="ollama">Ollama (Local)</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="mistral">Mistral</option>
                            <option value="inception">Inception</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Secret API Key</label>
                        <input type="password" id="llm-api-key" placeholder="sk-..." />
                    </div>
                    <div class="form-group" id="llm-model-group">
                        <label>Model</label>
                        <select id="llm-model">
                            <option value="">Select provider first</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="or-models-area">
                        <label>Model <span id="or-model-count" style="color:var(--text-dim);font-size:0.8rem;"></span></label>
                        <div class="active-model-display" id="or-active-model">
                            <span style="color:var(--text-dim);font-size:0.8rem;">Active Model:</span>
                            <strong style="color:var(--accent);margin-left:0.4rem;" id="or-active-model-name">None selected</strong>
                        </div>
                        <div id="or-save-reminder" class="save-reminder">‚ö† You changed the model. Click <strong>Apply Configuration</strong> to save.</div>
                        <input type="text" id="or-model-search" placeholder="Search models..." style="margin-bottom:0.5rem;" />
                        <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;flex-wrap:wrap;">
                            <button class="btn btn-sm btn-outline" id="or-sort-name">‚ñº Name</button>
                            <button class="btn btn-sm btn-outline" id="or-sort-input">‚ñº Input $/1M</button>
                            <button class="btn btn-sm btn-outline" id="or-sort-output">‚ñº Output $/1M</button>
                            <button class="btn btn-sm" id="btn-fetch-models">Fetch Models</button>
                        </div>
                        <div id="or-model-list" style="height:420px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;background:#050507;"></div>
                    </div>
                    
                    <div id="llm-save-reminder" class="save-reminder">‚ö† You have unsaved changes. Click <strong>Apply Configuration</strong> to save.</div>
                    <button class="btn" id="btn-apply-llm">Apply Configuration</button>
                    <button class="btn btn-outline" style="margin-left: 0.5rem;" id="btn-test-llm">Test Connection</button>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-channels">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.5rem;">Active Channels</h1>
                    <p class="subtitle">Connect your agent to external messaging platforms.</p>

                    <div class="channel-row">
                        <div>
                            <div class="channel-name">ü§ñ Telegram Bot</div>
                            <div class="channel-status" id="tg-status">Not configured</div>
                        </div>
                        <button class="btn btn-sm btn-outline" id="btn-setup-tg">Setup</button>
                    </div>

                    <div class="channel-row">
                        <div>
                            <div class="channel-name">üí¨ Discord App</div>
                            <div class="channel-status" id="dc-status">Not configured</div>
                        </div>
                        <button class="btn btn-sm btn-outline" id="btn-setup-dc">Setup</button>
                    </div>

                    <div class="channel-row">
                        <div>
                            <div class="channel-name">üì± WhatsApp</div>
                            <div class="channel-status" id="wa-status">Not configured</div>
                        </div>
                        <button class="btn btn-sm btn-outline" id="btn-setup-wa">Setup</button>
                    </div>

                    <div class="channel-row">
                        <div>
                            <div class="channel-name">üîó Slack</div>
                            <div class="channel-status" id="sl-status">Not configured</div>
                        </div>
                        <button class="btn btn-sm btn-outline" id="btn-setup-sl">Setup</button>
                    </div>

                    <div id="channel-setup-area" class="hidden" style="margin-top: 1.5rem; padding: 1.5rem; border: 1px solid var(--border); border-radius: 8px; background: #050507;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2 style="font-size: 1.1rem;" id="channel-setup-title">Setup</h2>
                            <button class="btn btn-sm btn-outline" id="btn-close-channel" style="font-size: 1.2rem; padding: 2px 8px;">‚úï</button>
                        </div>
                        <div id="channel-setup-body"></div>
                    </div>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-agent">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                        <div>
                            <h1 style="font-size: 1.3rem; margin-bottom: 0.25rem;">Daemon Status</h1>
                            <span class="status-pill stopped" id="daemon-status-pill">
                                <span id="daemon-status-dot">‚óè</span>
                                <span id="daemon-status-text">Stopped</span>
                            </span>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:10px;align-items:stretch;">
                            <button class="btn" id="btn-daemon-toggle">Start Agent Daemon</button>
                            <button class="btn btn-flush" id="btn-emergency-flush">‚ö† Emergency Flush</button>
                        </div>
                    </div>

                    <h2 style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-dim);">Agent Chat</h2>
                    <div class="chat-container">
                        <div class="chat-messages" id="agent-chat-messages">
                            <div class="chat-msg assistant"><span class="role">Agent:</span> Daemon is offline. Start the daemon to begin chatting.</div>
                        </div>
                        <div class="chat-input-row">
                            <input type="text" id="agent-chat-input" placeholder="Send a message to the agent..." />
                            <button type="button" class="btn" style="border-radius: 0;" id="btn-send-chat">Send</button>
                        </div>
                    </div>

                </div>

                <div class="glass-card tab-panel hidden" id="tab-skills">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.5rem;">üß© Skills</h1>
                    <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1rem;">Extend your agent with real integrations. Toggle skills to inject their tools into the agent.</p>

                    <div class="active-tools-panel" id="active-tools-summary">
                        <div class="active-tools-header" id="btn-toggle-tools-list">
                            <span class="active-tools-count">Active Toolkits</span>
                            <span class="active-tools-badge" id="active-tools-count-badge">0</span>
                        </div>
                        <div class="active-tools-list" id="active-tools-list"></div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h2 style="font-size: 1rem; color: var(--text-dim); margin-bottom: 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">‚ö° Built-in Tools (always available)</h2>
                        <div class="skill-grid" id="skills-builtin"></div>
                    </div>

                    <div id="enabled-integrations-section" style="margin-bottom: 1.5rem; display: none;">
                        <h2 style="font-size: 1rem; color: var(--text-dim); margin-bottom: 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">üîó Enabled Integrations</h2>
                        <div class="skill-grid" id="skills-enabled-integrations"></div>
                    </div>

                    <div style="margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; background: #050507;">
                        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                            <div class="form-group" style="flex:1; margin-bottom: 0;">
                                <label>Composio API Key</label>
                                <input type="password" id="composio-api-key" placeholder="Your Composio API key..." />
                            </div>
                            <button class="btn btn-sm" id="btn-save-composio" style="height: 38px;">Connect</button>
                        </div>
                        <p style="font-size: 0.7rem; color: var(--text-dim); margin-top: 0.5rem;">
                            Get a free API key at <span style="color: var(--accent); cursor: pointer;" id="btn-open-composio">app.composio.dev/settings</span>
                        </p>
                        <div id="composio-status" style="font-size: 0.8rem; margin-top: 0.5rem; display: none;"></div>
                    </div>

                    <div id="composio-integrations-area">
                        <div id="composio-placeholder" style="padding: 2rem; text-align: center; color: var(--text-dim); border: 1px dashed var(--border); border-radius: 8px; margin-bottom: 1rem;">
                            Enter your Composio API key and click Connect to load available integrations.
                        </div>

                        <div id="composio-connected-area" class="hidden">
                            <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; align-items: center;">
                                <input type="text" id="skill-search" placeholder="Search toolkits..." style="flex: 1;" />
                            </div>
                            <div id="composio-category-tabs" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;"></div>
                            <div class="skill-grid" id="skills-composio"></div>
                            <div id="composio-pagination" style="text-align: center; margin-top: 1rem;"></div>
                        </div>
                    </div>

                </div>

                <div class="glass-card tab-panel hidden" id="tab-settings">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.5rem;">Agent Settings</h1>
                    <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1.5rem;">These settings are pre-configured with optimal defaults. No changes are needed unless you have specific requirements.</p>
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>Autonomy Level</label>
                            <select id="set-autonomy">
                                <option value="observe">Observation Only</option>
                                <option value="collaborative" selected>Collaborative (Needs Approval)</option>
                                <option value="autonomous">Full Autonomy</option>
                            </select>
                            <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.4rem;">
                                Determines which shell commands the agent can run without explicit user consent.
                            </p>
                        </div>
                        <div class="form-group">
                            <label>Gateway Port</label>
                            <input type="number" id="set-port" value="7331" min="1024" max="65535" />
                        </div>
                        <div class="form-group">
                            <label>Tunnel Provider</label>
                            <select id="set-tunnel">
                                <option value="none" selected>None (Local Only)</option>
                                <option value="cloudflared">Cloudflare Tunnel</option>
                                <option value="tailscale">Tailscale</option>
                                <option value="ngrok">ngrok</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Active Persona</label>
                            <select id="set-identity">
                                <option value="-1">‚Äî BambooClaw Default (System Prompt Only) ‚Äî</option>
                            </select>
                            <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.4rem;">
                                Select a persona to inject specific behavioral rules. Manage personas below.
                            </p>
                        </div>
                        <div class="form-group">
                            <label>Runtime Adapter</label>
                            <select id="set-runtime">
                                <option value="native" selected>Native (Recommended)</option>
                                <option value="docker">Docker Container</option>
                                <option value="wasm">WASM Sandbox</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Log Level</label>
                            <select id="set-loglevel">
                                <option value="info" selected>Info</option>
                                <option value="debug">Debug</option>
                                <option value="trace">Trace</option>
                                <option value="warn">Warn</option>
                                <option value="error">Error Only</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Max Tool Iterations <span id="tool-iter-value" style="color:var(--accent);font-family:'JetBrains Mono',monospace;">10</span></label>
                            <input type="range" id="set-tool-iterations" min="1" max="50" value="10" style="width:100%;accent-color:var(--accent);" />
                            <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.4rem;">
                                How many tool calls the agent can chain per message. Higher = more complex tasks, but slower responses.
                            </p>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label>System Prompt</label>
                        <textarea id="settings-system-prompt" rows="20" placeholder="Custom instructions for the agent. These are injected as highest-priority operator instructions..." style="min-height:400px;overflow-y:auto;resize:vertical;"></textarea>
                        <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.4rem;">
                            Custom instructions injected into every agent conversation as highest-priority operator directives.
                        </p>
                    </div>

                    <div style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1.5rem;">
                        <h2 style="font-size: 1.1rem; margin-bottom: 0.5rem;">üé≠ Personas</h2>
                        <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1rem;">Create reusable personas. The active persona is selected in the settings grid above and combined with the System Prompt.</p>

                        <div id="persona-list" style="margin-bottom: 1rem;"></div>

                        <details id="persona-details-block" style="border: 1px solid var(--border); border-radius: 8px; padding: 0; background: #050507;">
                            <summary style="padding: 0.75rem 1rem; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: var(--accent); user-select: none; list-style: none;">+ Create New Persona</summary>
                            <div style="padding: 1rem;">
                                <div class="form-group">
                                    <label>Persona Name</label>
                                    <input type="text" id="new-persona-name" placeholder="e.g. Code Reviewer, Creative Writer..." />
                                </div>
                                <div class="form-group">
                                    <label>Persona Prompt</label>
                                    <textarea id="new-persona-prompt" rows="20" placeholder="Define how the agent should behave when this persona is active..." style="min-height:400px;overflow-y:auto;resize:vertical;"></textarea>
                                </div>
                                <button class="btn btn-sm" id="btn-create-persona">Create Persona</button>
                            </div>
                        </details>
                    </div>

                    <div id="settings-save-reminder" class="save-reminder">‚ö† You have unsaved changes. Click <strong>Save Settings</strong> to apply.</div>
                    <div style="margin-top: 1.5rem;">
                        <button class="btn" id="btn-save-settings">Save Settings</button>
                        <button class="btn btn-outline" style="margin-left: 0.5rem;" id="btn-reset-settings">Reset Defaults</button>
                    </div>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-help">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.25rem;">üìñ BambooClaw‚Ñ¢ Help Center</h1>
                    <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1.25rem;">Everything you need to know, explained in plain English. Click any section to expand it.</p>

                    <div class="help-search-wrap">
                        <input type="text" class="help-search" id="help-search" placeholder="Search help topics..." />
                    </div>

                    <details class="help-section" open>
                        <summary>üëã What is BambooClaw‚Ñ¢?</summary>
                        <div class="help-body">
                            <p><strong>BambooClaw‚Ñ¢ is your personal AI assistant that lives on your computer.</strong> Think of it like ChatGPT, but it runs privately on your machine, talks to you through apps you already use (like Telegram or Discord), and can actually do things on your computer ‚Äî browse the web, write files, run code, and more.</p>
                            <p>This Companion App is the control panel for your assistant. From here you can:</p>
                            <ul>
                                <li>Choose which AI brain powers your assistant (ChatGPT, Claude, Gemini, etc.)</li>
                                <li>Connect messaging apps so you can chat with your assistant from your phone</li>
                                <li>Start and stop the assistant</li>
                                <li>Add new skills (like reading emails or searching the web)</li>
                                <li>Fine-tune how autonomous your assistant is</li>
                            </ul>
                            <div class="help-tip">üí° <strong>Tip:</strong> BambooClaw‚Ñ¢ runs as a background service on your computer. You don't need to keep this app open ‚Äî once your assistant is running, it stays running until you stop it.</div>
                        </div>
                    </details>

                    <details class="help-section">
                        <summary>üöÄ Getting Started (First-Time Setup)</summary>
                        <div class="help-body">
                            <p>When you first open BambooClaw‚Ñ¢, the installer wizard walks you through everything:</p>
                            <div class="help-step"><div class="help-step-num">1</div><div><strong>Environment Audit</strong> ‚Äî The app checks if your system has the required tools installed (Rust, Git, and Build Tools). Green ‚úì means it's ready. If something is missing, it will offer to install it for you automatically.</div></div>
                            <div class="help-step"><div class="help-step-num">2</div><div><strong>Initialize Environment</strong> ‚Äî Installs any missing tools. This may take a few minutes depending on your internet speed. You can watch the progress in the log window.</div></div>
                            <div class="help-step"><div class="help-step-num">3</div><div><strong>Deploy Agent</strong> ‚Äî Downloads and compiles the BambooClaw‚Ñ¢ agent binary. This is the actual AI assistant engine. It takes 3‚Äì8 minutes depending on your PC speed.</div></div>
                            <div class="help-step"><div class="help-step-num">4</div><div><strong>Enter Dashboard</strong> ‚Äî Once done, you land here ‚Äî the control panel where you configure and manage everything.</div></div>
                            <div class="help-warn">‚ö†Ô∏è <strong>Important:</strong> The first installation requires an internet connection and about 2 GB of free disk space. Subsequent updates are much faster.</div>
                            <div class="help-tip">üí° <strong>Tip:</strong> If a step fails, check the Boot Trace Log at the bottom of the screen for error details. The most common issue is a firewall blocking the download.</div>
                        </div>
                    </details>

                    <details class="help-section">
                        <summary>üß† LLM Settings (Your AI Brain)</summary>
                        <div class="help-body">
                            <p>LLM stands for "Large Language Model" ‚Äî it's the AI that makes your assistant smart. You need to connect at least one AI provider before your assistant can respond to messages.</p>

                            <div class="help-sub">
                                <h4>Choosing a Provider</h4>
                                <p>BambooClaw‚Ñ¢ supports many AI providers. Here's a quick comparison:</p>
                                <ul>
                                    <li><strong>OpenRouter</strong> (Recommended) ‚Äî One API key gives you access to hundreds of models from every provider. Best value and flexibility.</li>
                                    <li><strong>OpenAI</strong> ‚Äî For GPT-4, GPT-5, and other OpenAI models directly.</li>
                                    <li><strong>Anthropic</strong> ‚Äî For Claude models. Excellent for careful, nuanced responses.</li>
                                    <li><strong>Google Gemini</strong> ‚Äî Google's AI models with large context windows.</li>
                                    <li><strong>Groq</strong> ‚Äî Ultra-fast inference. Great for quick tasks.</li>
                                    <li><strong>Ollama</strong> ‚Äî Run models entirely on your own computer, no internet needed. Free but requires a powerful GPU.</li>
                                    <li><strong>DeepSeek</strong> ‚Äî High-quality models at very low cost.</li>
                                    <li><strong>Mistral</strong> ‚Äî European AI provider with fast, capable models.</li>
                                    <li><strong>Inception</strong> ‚Äî Mercury 2 model for ultra-fast code generation via api.inceptionlabs.ai.</li>
                                </ul>
                            </div>

                            <div class="help-sub">
                                <h4>How to Set Up</h4>
                                <div class="help-step"><div class="help-step-num">1</div><div>Pick your provider from the <strong>AI Provider</strong> dropdown.</div></div>
                                <div class="help-step"><div class="help-step-num">2</div><div>Paste your <strong>API Key</strong>. You get this from the provider's website (e.g., <code>openrouter.ai/keys</code>). It usually starts with <code>sk-</code>.</div></div>
                                <div class="help-step"><div class="help-step-num">3</div><div>Select a <strong>Model</strong>. If you chose OpenRouter, click "Fetch Models" to see all available options with pricing.</div></div>
                                <div class="help-step"><div class="help-step-num">4</div><div>Click <strong>"Apply Configuration"</strong> to save.</div></div>
                                <div class="help-step"><div class="help-step-num">5</div><div>Click <strong>"Test Connection"</strong> to verify everything works.</div></div>
                            </div>

                            <div class="help-sub">
                                <h4>System Prompt (Optional)</h4>
                                <p>The system prompt tells the AI how to behave. For example: "You are a helpful coding assistant. Be concise." Leave it blank to use the default BambooClaw‚Ñ¢ persona.</p>
                            </div>

                            <div class="help-tip">üí° <strong>Tip:</strong> If you're new, start with <strong>OpenRouter</strong>. Sign up at openrouter.ai, add $5 credit, copy your key, and you'll have access to hundreds of models instantly.</div>
                        </div>
                    </details>

                    <details class="help-section">
                        <summary>üì° Channels (Where You Talk to Your Agent)</summary>
                        <div class="help-body">
                            <p>Channels let you chat with your BambooClaw assistant from messaging apps on your phone or desktop. You can connect multiple channels at the same time.</p>

                            <div class="help-sub">
                                <h4>ü§ñ Telegram Setup</h4>
                                <p>Telegram is the easiest channel to set up. Here's how:</p>
                                <div class="help-step"><div class="help-step-num">1</div><div>Open Telegram and search for <strong>@BotFather</strong> (the official Telegram bot for creating bots).</div></div>
                                <div class="help-step"><div class="help-step-num">2</div><div>Send <code>/newbot</code> to BotFather. It will ask you for a name and username for your bot.</div></div>
                                <div class="help-step"><div class="help-step-num">3</div><div>BotFather will give you a <strong>Bot Token</strong> ‚Äî a long string of numbers and letters. Copy it.</div></div>
                                <div class="help-step"><div class="help-step-num">4</div><div>Back in BambooClaw‚Ñ¢, go to <strong>Channels ‚Üí Telegram ‚Üí Setup</strong>.</div></div>
                                <div class="help-step"><div class="help-step-num">5</div><div>Paste your Bot Token and click <strong>Save</strong>.</div></div>
                                <div class="help-step"><div class="help-step-num">6</div><div>Add your Telegram user ID to the <strong>Allowed Users</strong> list. This prevents strangers from using your bot.</div></div>
                                <div class="help-tip">üí° <strong>Tip:</strong> To find your Telegram user ID, search for <strong>@userinfobot</strong> on Telegram and send it any message. It will reply with your numeric ID.</div>
                            </div>

                            <div class="help-sub">
                                <h4>üí¨ Discord Setup</h4>
                                <div class="help-step"><div class="help-step-num">1</div><div>Go to <strong>discord.com/developers/applications</strong> and click "New Application".</div></div>
                                <div class="help-step"><div class="help-step-num">2</div><div>Give it a name (e.g., "BambooClaw"), then go to the <strong>Bot</strong> section.</div></div>
                                <div class="help-step"><div class="help-step-num">3</div><div>Click "Reset Token" and copy the new <strong>Bot Token</strong>.</div></div>
                                <div class="help-step"><div class="help-step-num">4</div><div>Enable these <strong>Privileged Gateway Intents</strong>: Message Content Intent, Server Members Intent.</div></div>
                                <div class="help-step"><div class="help-step-num">5</div><div>Go to <strong>OAuth2 ‚Üí URL Generator</strong>. Check "bot" scope, then "Send Messages" and "Read Message History" permissions. Copy the invite URL and add the bot to your server.</div></div>
                                <div class="help-step"><div class="help-step-num">6</div><div>Back in BambooClaw‚Ñ¢, go to <strong>Channels ‚Üí Discord ‚Üí Setup</strong> and paste your Bot Token.</div></div>
                            </div>

                            <div class="help-sub">
                                <h4>üì± WhatsApp & üíº Slack</h4>
                                <p>WhatsApp and Slack integrations are available but require additional setup with business APIs. Click the <strong>Setup</strong> button for each to see the step-by-step instructions specific to that platform.</p>
                            </div>

                            <div class="help-warn">‚ö†Ô∏è <strong>Important:</strong> Your BambooClaw‚Ñ¢ daemon must be running for channels to work. Messages received while the daemon is stopped will be missed.</div>
                        </div>
                    </details>

                    <details class="help-section">
                        <summary>üéÆ Agent Control (Running Your Assistant)</summary>
                        <div class="help-body">
                            <p>The Agent Control tab is where you start, stop, and chat with your BambooClaw assistant.</p>

                            <div class="help-sub">
                                <h4>Starting & Stopping</h4>
                                <p>Click <strong>"Start Daemon"</strong> to launch your assistant in the background. The status indicator will change from üî¥ Stopped to üü¢ Running.</p>
                                <p>Click <strong>"Stop Daemon"</strong> to shut it down. Any connected channels (Telegram, Discord) will stop receiving responses until you start it again.</p>
                            </div>

                            <div class="help-sub">
                                <h4>In-App Chat</h4>
                                <p>The built-in chat lets you talk to your assistant directly, without needing Telegram or Discord. Type your message and press Send. The response comes from the same AI brain you configured in LLM Settings.</p>
                            </div>

                            <div class="help-sub">
                                <h4>Runtime Log</h4>
                                <p>The log panel shows real-time activity: incoming messages, AI responses, tool executions, and errors. This is your best friend for understanding what your assistant is doing.</p>
                                <ul>
                                    <li><strong>Green text</strong> ‚Äî Successful actions</li>
                                    <li><strong>Yellow text</strong> ‚Äî Warnings (non-critical)</li>
                                    <li><strong>Red text</strong> ‚Äî Errors (something went wrong)</li>
                                </ul>
                            </div>

                            <div class="help-tip">üí° <strong>Tip:</strong> You can close the Companion App and the daemon will keep running in the background. Re-open the app anytime to check the status.</div>
                        </div>
                    </details>

                    <details class="help-section">
                        <summary>üß© Skills (Extending What Your Agent Can Do)</summary>
                        <div class="help-body">
                            <p>Skills give your assistant superpowers beyond just chatting. With skills enabled, your assistant can interact with real apps and services.</p>

                            <div class="help-sub">
                                <h4>What is Composio?</h4>
                                <p><strong>Composio</strong> is the platform that provides skills to BambooClaw. Think of it as an app store for your AI assistant. Each skill connects your assistant to a real service (Gmail, GitHub, Google Search, etc.).</p>
                            </div>

                            <div class="help-sub">
                                <h4>Setting Up Skills</h4>
                                <div class="help-step"><div class="help-step-num">1</div><div>Go to <strong>composio.dev</strong> and create a free account.</div></div>
                                <div class="help-step"><div class="help-step-num">2</div><div>Navigate to your <strong>Settings ‚Üí API Keys</strong> and copy your key.</div></div>
                                <div class="help-step"><div class="help-step-num">3</div><div>In BambooClaw‚Ñ¢, go to the <strong>Skills</strong> tab and paste your Composio API Key.</div></div>
                                <div class="help-step"><div class="help-step-num">4</div><div>Toggle on any skills you want to enable. Each skill card shows what it does.</div></div>
                            </div>

                            <div class="help-sub">
                                <h4>Skill Categories</h4>
                                <ul>
                                    <li>üîç <strong>Web Search</strong> ‚Äî Search Google, DuckDuckGo, or Brave from chat</li>
                                    <li>üìß <strong>Email</strong> ‚Äî Read, draft, and send emails via Gmail</li>
                                    <li>üìÅ <strong>File Management</strong> ‚Äî Read, create, and edit files on your computer</li>
                                    <li>üíª <strong>Code Execution</strong> ‚Äî Run Python, JavaScript, or shell commands</li>
                                    <li>üåê <strong>Web Browsing</strong> ‚Äî Visit websites and extract information</li>
                                    <li>üìä <strong>GitHub</strong> ‚Äî Create issues, read repos, submit PRs</li>
                                    <li>üìù <strong>Note-taking</strong> ‚Äî Create and organize notes</li>
                                </ul>
                            </div>

                            <div class="help-warn">‚ö†Ô∏è <strong>Important:</strong> Skills that modify files or run code can make real changes to your system. Start with the <strong>Collaborative</strong> autonomy level (in Settings) so your assistant asks for permission before doing anything potentially risky.</div>
                        </div>
                    </details>

                    <details class="help-section">
                        <summary>‚öôÔ∏è Settings (Fine-Tuning Behavior)</summary>
                        <div class="help-body">
                            <p>The Settings tab lets you control how your assistant behaves. Defaults are already configured for you ‚Äî only change these if you know what you need.</p>

                            <div class="help-sub">
                                <h4>Autonomy Levels</h4>
                                <ul>
                                    <li><strong>Observation Only</strong> ‚Äî The assistant can only read and respond. It cannot run commands or modify files. Safest option.</li>
                                    <li><strong>Collaborative (Default)</strong> ‚Äî The assistant can suggest actions and execute them after you approve. Best balance of safety and usefulness.</li>
                                    <li><strong>Full Autonomy</strong> ‚Äî The assistant can take action without asking. Powerful but use with caution ‚Äî it can run shell commands, write files, and more.</li>
                                </ul>
                            </div>

                            <div class="help-sub">
                                <h4>Other Settings</h4>
                                <ul>
                                    <li><strong>Gateway Port</strong> ‚Äî The local port the daemon listens on (default: 7331). Change only if you have a conflict.</li>
                                    <li><strong>Tunnel Provider</strong> ‚Äî If you want to access your agent from outside your network. Most users should leave this as "None".</li>
                                    <li><strong>Identity Format</strong> ‚Äî Controls the assistant's persona and name.</li>
                                    <li><strong>Runtime Adapter</strong> ‚Äî How code gets executed. "Native" is fastest and recommended.</li>
                                    <li><strong>Log Level</strong> ‚Äî How much detail shows in the logs. "Info" is fine for normal use; switch to "Debug" when troubleshooting.</li>
                                    <li><strong>Max Tool Iterations</strong> ‚Äî How many steps the AI can chain in one response. Higher values allow more complex tasks but take longer.</li>
                                </ul>
                            </div>

                            <div class="help-tip">üí° <strong>Tip:</strong> If you're just getting started, leave all settings at their defaults. The pre-configured values work well for most users.</div>
                        </div>
                    </details>

                    <details class="help-section">
                        <summary>üîß Troubleshooting / FAQ</summary>
                        <div class="help-body">
                            <div class="help-sub">
                                <h4>"Daemon won't start"</h4>
                                <ul>
                                    <li>Check the Dashboard Debug Log at the bottom of the screen for error messages.</li>
                                    <li>Make sure the installation completed successfully (all wizard steps were green).</li>
                                    <li>Try restarting the Companion App.</li>
                                    <li>Ensure port 7331 (or your custom port) is not in use by another application.</li>
                                </ul>
                            </div>

                            <div class="help-sub">
                                <h4>"Telegram not responding"</h4>
                                <ul>
                                    <li>Verify the daemon is running (check Agent Control tab).</li>
                                    <li>Make sure you saved a valid Bot Token in Channels ‚Üí Telegram.</li>
                                    <li>Check that your Telegram user ID is in the Allowed Users list.</li>
                                    <li>Try clicking "Test" in the Telegram setup to validate the token.</li>
                                </ul>
                            </div>

                            <div class="help-sub">
                                <h4>"Composio key not validating"</h4>
                                <ul>
                                    <li>Make sure you copied the full key from composio.dev (Settings ‚Üí API Keys).</li>
                                    <li>BambooClaw tries multiple API endpoints automatically. If you're in the desktop app and it still fails, check your internet connection.</li>
                                    <li>If you're viewing this in a web browser preview, CORS restrictions may block the validation. The key will still work when running in the actual desktop app.</li>
                                </ul>
                            </div>

                            <div class="help-sub">
                                <h4>"Model gives errors"</h4>
                                <ul>
                                    <li>Double-check your API key is correct and has credits/balance.</li>
                                    <li>Some models require a paid plan. Try a different, cheaper model first.</li>
                                    <li>Click "Test Connection" in the LLM Settings tab to see the exact error.</li>
                                </ul>
                            </div>

                            <div class="help-sub">
                                <h4>"Everything looks broken in the browser preview"</h4>
                                <p>If you're viewing BambooClaw‚Ñ¢ inside a web browser (e.g., the Lovable preview), some features won't work because they require the actual desktop app (Tauri). Specifically:</p>
                                <ul>
                                    <li>Starting/stopping the daemon</li>
                                    <li>System checks (OS detection, Rust, Git)</li>
                                    <li>Composio API validation (may show CORS errors)</li>
                                </ul>
                                <p>These all work correctly in the real desktop app. The browser preview is useful for checking the UI layout and reading help content like this.</p>
                            </div>

                            <div class="help-sub">
                                <h4>"How do I update BambooClaw?"</h4>
                                <p>When a new version is available, the Companion App will show an update notification on the top-right. Click it to download and install the update. Your settings and channel configurations are preserved across updates.</p>
                            </div>

                            <div class="help-sub">
                                <h4>"Where is my data stored?"</h4>
                                <p>All BambooClaw‚Ñ¢ data is stored locally on your computer in the <code>~/.bambooclaw/</code> folder. This includes your configuration, API keys, and chat history. Nothing is sent to external servers except your messages to the AI provider you chose.</p>
                            </div>
                        </div>
                    </details>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-about">
                    <h1 style="font-size: 1.3rem; margin-bottom: 1rem;">About BambooClaw‚Ñ¢</h1>
                    <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; background: #050507; margin-bottom: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <span style="color: var(--text-dim); font-size: 0.85rem;">Version</span>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent);" id="about-version">loading...</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <span style="color: var(--text-dim); font-size: 0.85rem;">Trademark</span>
                            <div style="font-size: 0.9rem;">BambooClaw‚Ñ¢ is a trademark of <a href="https://www.bamboosynergytec.com" target="_blank" style="color: var(--accent); text-decoration: none;">Bamboo Synergy Technologies</a></div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <span style="color: var(--text-dim); font-size: 0.85rem;">Developer</span>
                            <div style="font-size: 0.9rem;">Developed by <a href="https://www.enigmara.com" target="_blank" style="color: var(--accent); text-decoration: none;">Enigmara Technologies Corp.</a></div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <span style="color: var(--text-dim); font-size: 0.85rem;">Support</span>
                            <div style="font-size: 0.9rem;"><a href="mailto:info@bamboosynergytec.com" style="color: var(--accent); text-decoration: none;">info@bamboosynergytec.com</a></div>
                        </div>
                        <div>
                            <span style="font-size: 0.8rem; color: var(--text-dim);" id="about-copyright">¬© 2025 Bamboo Synergy Technologies, Inc.</span>
                        </div>
                    </div>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-logs">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.75rem;">üìã Session Log</h1>
                    <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1.25rem;">Unified continuous log for this session. All system, agent, and skill events are recorded here with timestamps.</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <span style="font-size: 0.75rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace;">SESSION LOG ‚Äî <span id="session-id-label">...</span></span>
                        <div style="display:flex;gap:0.5rem;">
                            <button class="btn btn-sm btn-outline" id="btn-copy-log">üìã Copy Log</button>
                            <button class="btn btn-sm btn-outline" id="btn-open-log-folder">üìÇ Open Folder</button>
                        </div>
                    </div>
                    <div class="log-body" id="unified-log" style="height:400px;background:#050507;border:1px solid var(--border);border-radius:6px;font-size:0.72rem;line-height:1.6;"></div>
                    <div style="margin-top:1.25rem;padding:0.6rem 0.75rem;background:#050507;border:1px solid var(--border);border-radius:6px;">
                        <label style="font-size:0.7rem;color:var(--text-dim);margin-bottom:0.25rem;">Log Storage Path</label>
                        <input type="text" id="log-path-display" readonly value="~/.bambooclaw/logs/" style="font-size:0.75rem;font-family:'JetBrains Mono',monospace;background:transparent;border:none;color:var(--accent);padding:0.25rem 0;" />
                    </div>
                    <div id="dash-log" style="display:none;"></div>
                    <div id="daemon-log" style="display:none;"></div>

                    <div style="margin-top:1.5rem;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                            <h2 style="font-size:1.1rem;margin:0;">üîç Last LLM Request Payload</h2>
                            <button class="btn btn-sm btn-outline" id="btn-copy-payload">üìã Copy Payload</button>
                        </div>
                        <p style="font-size:0.8rem;color:var(--text-dim);margin-bottom:0.75rem;">The complete request body sent to the model on the last call, including system prompt, persona, skills/tools, conversation history, and user message.</p>
                        <div id="llm-payload-display" class="log-body" style="height:400px;background:#050507;border:1px solid var(--border);border-radius:6px;font-size:0.72rem;line-height:1.6;white-space:pre-wrap;word-break:break-all;color:var(--text-dim);padding:1rem;">
                            <span style="color:var(--text-dim);font-style:italic;">No LLM call made yet. Send a message via chat, Telegram, or another channel to see the full payload here.</span>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
    // Error boundary is in Script 1 (canary) to catch parse errors in this script block.

    // =========== GLOBALS ===========
    var detectedOS = "unknown";
    var daemonRunning = false;
    var currentConfig = {};
    var PROXY_URL = "https://mjmdhqglpratbyzmgndm.supabase.co/functions/v1/github-release-proxy";

    // =========== SESSION ID ===========
    var SESSION_ID = (function() {
        var d = new Date();
        var pad = function(n) { return n < 10 ? "0" + n : "" + n; };
        var hex = Math.random().toString(16).substring(2, 8);
        return "session-" + d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate()) + "-" + hex;
    })();
    var LOG_FOLDER = "~/.bambooclaw/logs/";
    var LOG_FILE_PATH = LOG_FOLDER + SESSION_ID + ".log";
    // Set session ID in UI
    setTimeout(function() {
        var lbl = document.getElementById("session-id-label");
        if (lbl) lbl.textContent = SESSION_ID;
        var pathEl = document.getElementById("log-path-display");
        if (pathEl) pathEl.value = LOG_FILE_PATH;
        // About tab: set version and copyright year
        var aboutVer = document.getElementById("about-version");
        var appVer = document.getElementById("app-version");
        if (aboutVer && appVer) aboutVer.textContent = appVer.textContent;
        var copyrightEl = document.getElementById("about-copyright");
        if (copyrightEl) copyrightEl.textContent = "¬© " + new Date().getFullYear() + " Bamboo Synergy Technologies, Inc.";
    }, 0);

    // =========== TOAST ===========
    function showToast(message, type) {
        type = type || "info";
        var container = document.getElementById("toast-container");
        var t = document.createElement("div");
        t.className = "toast " + type;
        t.textContent = message;
        container.appendChild(t);
        setTimeout(function() {
            t.style.animation = "slideOut 0.3s ease forwards";
            setTimeout(function() { t.remove(); }, 300);
        }, 3000);
    }

    // =========== TAURI HELPERS ===========
    function tauriInvoke(cmd, args) {
        if (!window.__TAURI__) return Promise.reject(new Error("Tauri not available (running in browser)"));
        var inv = (window.__TAURI__.core && window.__TAURI__.core.invoke)
               || (window.__TAURI__.tauri && window.__TAURI__.tauri.invoke)
               || window.__TAURI__.invoke;
        if (typeof inv === "function") return inv(cmd, args || {});
        if (typeof window.__TAURI__.transformCallback === "function" && typeof window.__TAURI_IPC__ === "function") {
            return new Promise(function(resolve, reject) {
                var cbId = window.__TAURI__.transformCallback(function(r) { resolve(r); }, true);
                var errId = window.__TAURI__.transformCallback(function(e) { reject(e); }, true);
                var payload = Object.assign({ cmd: cmd, callback: cbId, error: errId }, args || {});
                window.__TAURI_IPC__(payload);
            });
        }
        return Promise.reject(new Error("Tauri invoke not found."));
    }
    function invokeShort(cmd, args) {
        return Promise.race([
            tauriInvoke(cmd, args),
            new Promise(function(_, reject) { setTimeout(function() { reject(new Error("Timeout: " + cmd)); }, 8000); })
        ]);
    }
    function invokeLong(cmd, args, ms) {
        return Promise.race([
            tauriInvoke(cmd, args),
            new Promise(function(_, reject) { setTimeout(function() { reject(new Error("Timeout: " + cmd)); }, ms || 600000); })
        ]);
    }

    // =========== COPY LOG ===========
    function copyLog(logId) {
        try {
            var el = document.getElementById(logId);
            if (el) {
                navigator.clipboard.writeText(el.textContent).then(function() {
                    showToast("Log copied to clipboard", "success");
                }).catch(function() {
                    var ta = document.createElement("textarea");
                    ta.value = el.textContent;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand("copy");
                    document.body.removeChild(ta);
                    showToast("Log copied to clipboard", "success");
                });
            }
        } catch(e) {
            console.error("[copyLog error]", e);
        }
    }
    function appendLog(logId, line) {
        try {
            var now = new Date();
            var ts = "[" + ("0"+now.getHours()).slice(-2) + ":" + ("0"+now.getMinutes()).slice(-2) + ":" + ("0"+now.getSeconds()).slice(-2) + "." + ("00"+now.getMilliseconds()).slice(-3) + "]";
            var taggedLine = ts + " " + line;

            var logLevel = (currentConfig.settings && currentConfig.settings.loglevel) || "info";
            var shouldShow = true;
            if (logLevel === "error") {
                shouldShow = /ERROR|FAIL|EXCEPTION/i.test(line);
            } else if (logLevel === "warn") {
                shouldShow = /ERROR|FAIL|EXCEPTION|WARN|WARNING/i.test(line);
            } else if (logLevel === "info") {
                shouldShow = !/^\[DEBUG\]/i.test(line);
            }

            var el = document.getElementById(logId);
            if (el && el.style.display !== "none" && shouldShow) {
                el.textContent += taggedLine + "\n";
                el.scrollTop = el.scrollHeight;
            }

            var unified = document.getElementById("unified-log");
            if (unified && shouldShow && logId !== "unified-log") {
                unified.textContent += taggedLine + "\n";
                unified.scrollTop = unified.scrollHeight;
            }

            if (window.__TAURI__) {
                try {
                    tauriInvoke("run_shell_command", {
                        commandName: detectedOS === "windows" ? "cmd" : "sh",
                        args: detectedOS === "windows"
                            ? ["/C", "mkdir \"" + LOG_FOLDER.replace("~/", "%USERPROFILE%\\") + "\" 2>nul & echo " + taggedLine.replace(/"/g, '\\"').replace(/&/g, "^&").replace(/[<>|]/g, "") + " >> \"" + LOG_FILE_PATH.replace("~/", "%USERPROFILE%\\") + "\""]
                            : ["-c", "mkdir -p " + LOG_FOLDER.replace("~", "$HOME") + " && echo " + JSON.stringify(taggedLine) + " >> " + LOG_FILE_PATH.replace("~", "$HOME")]
                    }).catch(function(){});
                } catch(e) {}
            }
        } catch(e) {
            console.error("[appendLog error]", e);
        }
    }

    // =========== WIZARD ===========
    var currentStep = 0;
    function wizardGo(step) {
        document.querySelectorAll(".wizard-step").forEach(function(s, i) {
            s.classList.toggle("hidden", i !== step);
        });
        document.querySelectorAll(".step-dot").forEach(function(d, i) {
            d.classList.toggle("active", i <= step);
        });
        currentStep = step;
        if (step === 0) runSystemChecks();
        if (step === 1) runPrereqInstall();
    }

    function updateBadge(id, text, cls) {
        var el = document.getElementById(id);
        if (el) { el.textContent = text; el.className = "status-badge " + cls; }
    }

    async function runSystemChecks() {
        appendLog("boot-log", "[CHECK] runSystemChecks() called");

        var checkOS = invokeShort("get_platform").then(function(os) {
            detectedOS = os || "unknown";
            var osLabel = detectedOS === "windows" ? "Windows" : detectedOS === "macos" ? "macOS" : detectedOS === "linux" ? "Linux" : detectedOS;
            updateBadge("chk-os", osLabel, "status-found");
        }).catch(function(e) {
            detectedOS = "windows";
            updateBadge("chk-os", "Windows (assumed)", "status-not-installed");
        });

        var checkRust = invokeShort("check_prerequisite", { name: "rustc" }).then(function(rv) {
            updateBadge("chk-rust", rv.trim().split("\n")[0], "status-found");
        }).catch(function(e) {
            updateBadge("chk-rust", "Not Installed", "status-not-installed");
        });

        var checkGit = invokeShort("run_shell_command", { commandName: "git", args: ["--version"] }).then(function(gv) {
            updateBadge("chk-git", gv.trim().split("\n")[0], "status-found");
        }).catch(function(e) {
            updateBadge("chk-git", "Not Installed", "status-not-installed");
        });

        var checkBuild = invokeShort("check_prerequisite", { name: "vs_build_tools" }).then(function(bv) {
            updateBadge("chk-build", bv.trim() || "Found", "status-found");
        }).catch(function(e) {
            updateBadge("chk-build", detectedOS === "windows" ? "Not Installed" : "N/A", detectedOS === "windows" ? "status-not-installed" : "status-found");
        });

        var checkPython = invokeShort("run_shell_command", { commandName: "python", args: ["--version"] }).then(function(pv) {
            updateBadge("chk-python", pv.trim().split("\n")[0], "status-found");
        }).catch(function() {
            return invokeShort("run_shell_command", { commandName: "python3", args: ["--version"] }).then(function(pv) {
                updateBadge("chk-python", pv.trim().split("\n")[0], "status-found");
            }).catch(function(e) {
                updateBadge("chk-python", "Not Installed", "status-not-installed");
            });
        });

        var checkNode = invokeShort("run_shell_command", { commandName: "node", args: ["--version"] }).then(function(nv) {
            updateBadge("chk-node", nv.trim().split("\n")[0], "status-found");
        }).catch(function(e) {
            updateBadge("chk-node", "Not Installed", "status-not-installed");
        });

        await Promise.allSettled([checkOS, checkRust, checkGit, checkBuild, checkPython, checkNode]);
        document.getElementById("btn-step0-next").disabled = false;
    }

    async function runPrereqInstall() {
        var log = "install-log";
        document.getElementById(log).textContent = "";
        appendLog(log, "[INFO] Detected OS: " + detectedOS);
        appendLog(log, "[INFO] Starting prerequisite installation...");

        var rustBadge = document.getElementById("chk-rust");
        var rustInstalled = rustBadge && rustBadge.classList.contains("status-found");

        if (rustInstalled) {
            appendLog(log, "[SKIP] Rust already installed.");
        } else {
            appendLog(log, "[INFO] Installing Rust toolchain...");
            try {
                if (detectedOS === "windows") {
                    var result = await invokeLong("run_shell_command", { commandName: "winget", args: ["install", "--id", "Rustlang.Rustup", "-e", "--silent", "--accept-package-agreements", "--accept-source-agreements"] });
                    appendLog(log, result);
                } else {
                    var result = await invokeLong("run_shell_command", { commandName: "sh", args: ["-c", "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y"] });
                    appendLog(log, result);
                }
                appendLog(log, "[OK] Rust installation completed.");
            } catch(e) {
                appendLog(log, "[ERROR] Rust installation failed: " + (e.message || e));
            }
        }

        var buildBadge = document.getElementById("chk-build");
        var buildInstalled = buildBadge && buildBadge.classList.contains("status-found");

        if (detectedOS === "windows" && !buildInstalled) {
            appendLog(log, "[INFO] Installing Visual Studio Build Tools...");
            try {
                var result = await invokeLong("run_shell_command", {
                    commandName: "winget",
                    args: ["install", "--id", "Microsoft.VisualStudio.2022.BuildTools", "-e", "--silent", "--override", "--wait --passive --add Microsoft.VisualStudio.Workload.VCTools --includeRecommended", "--accept-package-agreements", "--accept-source-agreements"]
                });
                appendLog(log, result);
                appendLog(log, "[OK] Build Tools installation completed.");
            } catch(e) {
                appendLog(log, "[ERROR] Build Tools installation failed: " + (e.message || e));
            }
        } else if (detectedOS === "macos") {
            appendLog(log, "[INFO] Checking Xcode Command Line Tools...");
            try {
                var result = await invokeLong("run_shell_command", { commandName: "xcode-select", args: ["--install"] }, 120000);
                appendLog(log, result || "[OK] Xcode CLT ready.");
            } catch(e) {
                appendLog(log, "[INFO] Xcode CLT may already be installed: " + (e.message || e));
            }
        }

        appendLog(log, "[DONE] All prerequisites ready.");
        document.getElementById("btn-step1-next").disabled = false;
    }

    async function deployBinary(log) {
        appendLog(log, "[INFO] Deploying pre-built binary...");
        try {
            var metaRes = await fetch(PROXY_URL);
            if (!metaRes.ok) throw new Error("Proxy returned " + metaRes.status);
            var meta = await metaRes.json();
            
            var assets = meta.assets || [];
            var assetName = "";
            if (detectedOS === "windows") {
                var asset = assets.find(function(a) { return a.name.endsWith(".exe"); }) || assets.find(function(a) { return a.name.endsWith(".msi"); });
                assetName = asset ? asset.name : "";
            } else if (detectedOS === "macos") {
                var asset = assets.find(function(a) { return a.name.endsWith(".dmg"); }) || assets.find(function(a) { return a.name.includes("macos"); });
                assetName = asset ? asset.name : "";
            } else {
                var asset = assets.find(function(a) { return a.name.endsWith(".AppImage"); }) || assets.find(function(a) { return a.name.includes("linux"); });
                assetName = asset ? asset.name : "";
            }

            if (!assetName) {
                appendLog(log, "[ERROR] Could not find a pre-built binary for your platform.");
                return;
            }

            var homePath = "~";
            try {
                if (detectedOS === "windows") {
                    homePath = (await invokeShort("run_shell_command", { commandName: "cmd", args: ["/C", "echo %USERPROFILE%"] })).trim();
                } else {
                    homePath = (await invokeShort("run_shell_command", { commandName: "sh", args: ["-c", "echo $HOME"] })).trim();
                }
            } catch(e) {}

            var sep = detectedOS === "windows" ? "\\" : "/";
            var destDir = homePath + sep + ".bambooclaw";
            var destFile = destDir + sep + (detectedOS === "windows" ? "bambooclaw.exe" : "bambooclaw");

            try {
                if (detectedOS === "windows") {
                    await invokeShort("run_shell_command", { commandName: "cmd", args: ["/C", "mkdir \"" + destDir + "\" 2>nul || echo exists"] });
                } else {
                    await invokeShort("run_shell_command", { commandName: "mkdir", args: ["-p", destDir] });
                }
            } catch(e) {}

            var dlUrl = PROXY_URL + "?asset=" + encodeURIComponent(assetName);
            await invokeLong("download_binary", { url: dlUrl, dest: destFile });
            appendLog(log, "[OK] Binary downloaded successfully.");

            if (detectedOS !== "windows") {
                try { await invokeShort("run_shell_command", { commandName: "chmod", args: ["+x", destFile] }); } catch(e) {}
            }

            document.getElementById("install-path-display").value = destFile;
            appendLog(log, "[DONE] BambooClaw deployed.");
        } catch(e) {
            appendLog(log, "[ERROR] Binary download failed: " + (e.message || e));
        }
    }

    document.getElementById("btn-step2-skip").addEventListener("click", async function() {
        var log = "capability-log";
        document.getElementById(log).textContent = "";
        appendLog(log, "[INFO] Skipping agent capabilities.");
        await deployBinary(log);
        wizardGo(3);
    });
    document.getElementById("btn-step2-install").addEventListener("click", async function() {
        var log = "capability-log";
        document.getElementById(log).textContent = "";
        this.disabled = true;
        document.getElementById("btn-step2-skip").disabled = true;

        var wantPython = document.getElementById("cap-python").checked;
        var wantBrowser = document.getElementById("cap-browser").checked;
        var wantNode = document.getElementById("cap-node").checked;

        var pipCmd = detectedOS === "windows" ? "pip" : "pip3";
        var pythonCmd = detectedOS === "windows" ? "python" : "python3";

        if (wantPython || wantBrowser || wantNode) {
            // --- Python Ecosystem ---
            if (wantPython) {
                var pyBadge = document.getElementById("chk-python");
                var pyInstalled = pyBadge && pyBadge.classList.contains("status-found");

                if (pyInstalled) {
                    appendLog(log, "[SKIP] Python already installed.");
                } else {
                    appendLog(log, "[INFO] Installing Python 3.12...");
                    try {
                        if (detectedOS === "windows") {
                            var r = await invokeLong("run_shell_command", { commandName: "winget", args: ["install", "Python.Python.3.12", "--silent", "--accept-package-agreements", "--accept-source-agreements"] });
                            appendLog(log, r);
                        } else if (detectedOS === "macos") {
                            var r = await invokeLong("run_shell_command", { commandName: "brew", args: ["install", "python3"] });
                            appendLog(log, r);
                        } else {
                            var r = await invokeLong("run_shell_command", { commandName: "sh", args: ["-c", "sudo apt install -y python3 python3-pip"] });
                            appendLog(log, r);
                        }
                        appendLog(log, "[OK] Python installed.");
                    } catch(e) {
                        appendLog(log, "[ERROR] Python installation failed: " + (e.message || e));
                    }
                }

                appendLog(log, "[INFO] Installing Python packages (pyautogui, pillow, requests, beautifulsoup4, psutil, pandas, numpy)...");
                try {
                    var r = await invokeLong("run_shell_command", { commandName: pipCmd, args: ["install", "pyautogui", "pillow", "requests", "beautifulsoup4", "psutil", "pandas", "numpy"] });
                    appendLog(log, r);
                    appendLog(log, "[OK] Python packages installed.");
                } catch(e) {
                    appendLog(log, "[ERROR] pip install failed: " + (e.message || e));
                }
            }

            // --- Browser Automation ---
            if (wantBrowser) {
                appendLog(log, "[INFO] Installing Playwright...");
                try {
                    var r = await invokeLong("run_shell_command", { commandName: pipCmd, args: ["install", "playwright"] });
                    appendLog(log, r);
                    appendLog(log, "[INFO] Installing Chromium browser for Playwright...");
                    var r2 = await invokeLong("run_shell_command", { commandName: pythonCmd, args: ["-m", "playwright", "install", "chromium"] });
                    appendLog(log, r2);
                    appendLog(log, "[OK] Playwright + Chromium installed.");
                } catch(e) {
                    appendLog(log, "[ERROR] Playwright installation failed: " + (e.message || e));
                }
            }

            // --- Developer Tools (Node.js) ---
            if (wantNode) {
                var nodeBadge = document.getElementById("chk-node");
                var nodeInstalled = nodeBadge && nodeBadge.classList.contains("status-found");

                if (nodeInstalled) {
                    appendLog(log, "[SKIP] Node.js already installed.");
                } else {
                    appendLog(log, "[INFO] Installing Node.js LTS...");
                    try {
                        if (detectedOS === "windows") {
                            var r = await invokeLong("run_shell_command", { commandName: "winget", args: ["install", "OpenJS.NodeJS.LTS", "--silent", "--accept-package-agreements", "--accept-source-agreements"] });
                            appendLog(log, r);
                        } else if (detectedOS === "macos") {
                            var r = await invokeLong("run_shell_command", { commandName: "brew", args: ["install", "node"] });
                            appendLog(log, r);
                        } else {
                            var r = await invokeLong("run_shell_command", { commandName: "sh", args: ["-c", "sudo apt install -y nodejs npm"] });
                            appendLog(log, r);
                        }
                        appendLog(log, "[OK] Node.js installed.");
                    } catch(e) {
                        appendLog(log, "[ERROR] Node.js installation failed: " + (e.message || e));
                    }
                }
            }

            appendLog(log, "[DONE] Agent capability setup complete.");
        }

        await deployBinary(log);
        this.disabled = false;
        document.getElementById("btn-step2-skip").disabled = false;
        wizardGo(3);
    });

    window.enterDashboard = async function() {
        try {
            appendLog("boot-log", "[DASH] enterDashboard() called");
            localStorage.setItem("bambooclaw-installed", "true");
            document.getElementById("wizard-view").style.display = "none";
            document.getElementById("dashboard-view").style.display = "block";
            document.getElementById("dashboard-view").classList.remove("hidden");
            await loadConfig();
        } catch(e) {
            appendLog("boot-log", "[ERROR] enterDashboard failed: " + (e.message || e));
        }
    };

    // =========== TAB SWITCHING ===========
    document.querySelectorAll(".tab").forEach(function(tab) {
        tab.addEventListener("click", function() {
            var target = this.getAttribute("data-tab");
            document.querySelectorAll(".tab").forEach(function(t) { t.classList.remove("active"); });
            this.classList.add("active");
            document.querySelectorAll(".tab-panel").forEach(function(p) { p.classList.add("hidden"); });
            document.getElementById(target).classList.remove("hidden");
        });
    });

    // =========== LLM PROVIDER MODELS ===========
    var providerModels = {
        openai: ["gpt-4o", "gpt-4o-mini", "gpt-4-turbo", "gpt-3.5-turbo", "o1-preview", "o1-mini"],
        anthropic: ["claude-opus-4-20250514", "claude-sonnet-4-20250514", "claude-3.5-sonnet-20241022", "claude-3-haiku-20240307"],
        google: ["gemini-2.5-pro", "gemini-2.5-flash", "gemini-2.0-flash"],
        groq: ["llama-3.3-70b-versatile", "llama-3.1-8b-instant", "mixtral-8x7b-32768"],
        ollama: ["llama3.2", "mistral", "codellama", "phi3"],
        deepseek: ["deepseek-chat", "deepseek-coder", "deepseek-reasoner"],
        mistral: ["mistral-large-latest", "mistral-medium-latest", "mistral-small-latest", "codestral-latest"],
        inception: ["mercury-2"]
    };

    var orModels = [];
    var orSortKey = "name";
    var orSortDir = 1;
    var orSelectedModel = "";

    document.getElementById("llm-provider").addEventListener("change", function() {
        var isOR = this.value === "openrouter";
        appendLog("dash-log", "[UI] Provider changed to: " + this.value + ", isOR=" + isOR);
        document.getElementById("llm-model-group").style.display = isOR ? "none" : "block";
        if (isOR) {
            document.getElementById("or-models-area").classList.remove("hidden");
            document.getElementById("or-models-area").style.display = "block";
        } else {
            document.getElementById("or-models-area").classList.add("hidden");
            document.getElementById("or-models-area").style.display = "none";
        }
        if (isOR) {
            if (orModels.length === 0) {
                appendLog("dash-log", "[UI] Auto-fetching OpenRouter models...");
                window.fetchORModels();
            }
        } else {
            var models = providerModels[this.value] || [];
            var sel = document.getElementById("llm-model");
            sel.innerHTML = "";
            models.forEach(function(m) {
                var opt = document.createElement("option");
                opt.value = m;
                opt.textContent = m;
                sel.appendChild(opt);
            });
        }
    });

    document.getElementById("llm-api-key").addEventListener("input", function() {
        var provider = document.getElementById("llm-provider").value;
        if (provider === "openrouter" && this.value.trim().length > 10 && orModels.length === 0) {
            appendLog("dash-log", "[UI] API key entered, auto-fetching OpenRouter models...");
            window.fetchORModels();
        }
    });

    document.getElementById("llm-provider").dispatchEvent(new Event("change"));

    // =========== LLM CONFIG ===========
    async function applyLLMConfig() {
        appendLog("dash-log", "[LLM] applyLLMConfig() called");
        var provider = document.getElementById("llm-provider").value;
        var apiKey = document.getElementById("llm-api-key").value.trim(); // FIX: Trim invisible whitespace
        var model = provider === "openrouter" ? orSelectedModel : document.getElementById("llm-model").value;
        var spEl = document.getElementById("settings-system-prompt");
        var systemPrompt = spEl ? spEl.value : "";
        appendLog("dash-log", "[LLM] provider=" + provider + ", model=" + model + ", hasKey=" + (apiKey.length > 0));

        if (!apiKey.trim() && provider !== "ollama") {
            showToast("API key is required for " + provider, "error");
            appendLog("dash-log", "[LLM] REJECTED: no API key");
            return;
        }
        if (provider === "openrouter" && !model) {
            showToast("Please select a model from the list first", "error");
            appendLog("dash-log", "[LLM] REJECTED: no model selected");
            return;
        }

        currentConfig.llm = { provider: provider, api_key: apiKey, model: model, system_prompt: systemPrompt };
        var tomlContent = buildConfigToml();

        try {
            await invokeShort("write_config", { content: tomlContent });
            showToast("Configuration saved to ~/.bambooclaw/config.toml", "success");
            appendLog("dash-log", "[LLM] Config saved via Tauri");
        } catch(e) {
            localStorage.setItem("bambooclaw-config", JSON.stringify(currentConfig));
            showToast("Configuration saved successfully", "success");
            appendLog("dash-log", "[LLM] Config saved to localStorage (Tauri unavailable)");
        }
        var r1 = document.getElementById("or-save-reminder"); if (r1) r1.classList.remove("visible");
        var r2 = document.getElementById("llm-save-reminder"); if (r2) r2.classList.remove("visible");
    }

    async function testLLMConfig() {
        appendLog("dash-log", "[TEST] testLLMConfig() called");
        var provider = document.getElementById("llm-provider").value;
        var apiKey = document.getElementById("llm-api-key").value.trim();
        if (!apiKey && provider !== "ollama") {
            showToast("Enter an API key first", "error");
            return;
        }
        showToast("Testing connection...", "info");

        try {
            if (provider === "openrouter") {
                var resp = await fetch("https://openrouter.ai/api/v1/models", {
                    headers: { "Authorization": "Bearer " + apiKey }
                });
                if (resp.ok) {
                    showToast("OpenRouter API key is valid!", "success");
                } else {
                    showToast("Invalid API key (HTTP " + resp.status + ")", "error");
                }
            } else if (provider === "ollama") {
                var resp2 = await fetch("http://localhost:11434/api/tags");
                if (resp2.ok) {
                    showToast("Ollama is running locally!", "success");
                } else {
                    showToast("Ollama not reachable", "error");
                }
            } else {
                showToast("Key saved. Full connection test available when agent daemon is running.", "info");
            }
        } catch(e) {
            showToast("Connection test error: " + (e.message || e), "error");
        }
    }

    // =========== CONFIG SERIALIZATION ===========
    function buildConfigToml() {
        var lines = ["# BambooClaw Agent Configuration", "# Auto-generated by BambooClaw Companion", ""];

        if (currentConfig.llm) {
            lines.push("[llm]");
            if (currentConfig.llm.provider) lines.push('provider = ' + JSON.stringify(currentConfig.llm.provider));
            if (currentConfig.llm.api_key) lines.push('api_key = ' + JSON.stringify(currentConfig.llm.api_key));
            if (currentConfig.llm.model) lines.push('model = ' + JSON.stringify(currentConfig.llm.model));
            if (currentConfig.llm.system_prompt != null) lines.push('system_prompt = ' + JSON.stringify(currentConfig.llm.system_prompt));
            lines.push("");
        }

        if (currentConfig.channels) {
            Object.keys(currentConfig.channels).forEach(function(ch) {
                lines.push("[channels." + ch + "]");
                var c = currentConfig.channels[ch];
                Object.keys(c).forEach(function(k) {
                    lines.push(k + ' = ' + JSON.stringify(c[k] || ""));
                });
                lines.push("");
            });
        }

        if (currentConfig.settings) {
            lines.push("[agent]");
            var s = currentConfig.settings;
            if (s.autonomy) lines.push('autonomy = ' + JSON.stringify(s.autonomy));
            if (s.port) lines.push("gateway_port = " + s.port);
            if (s.tunnel) lines.push('tunnel = ' + JSON.stringify(s.tunnel));
            if (s.identity) lines.push('identity = ' + JSON.stringify(s.identity));
            if (s.runtime) lines.push('runtime = ' + JSON.stringify(s.runtime));
            if (s.loglevel) lines.push('log_level = ' + JSON.stringify(s.loglevel));
            if (currentConfig.composioApiKey) lines.push('composio_api_key = ' + JSON.stringify(currentConfig.composioApiKey));
            lines.push("");
        }

        return lines.join("\n");
    }

    async function loadConfig() {
        appendLog("dash-log", "[CONFIG] loadConfig() started...");
        try {
            var raw = await invokeShort("read_config");
            appendLog("dash-log", "[CONFIG] Loaded from disk successfully. Length: " + raw.length);
            showToast("Configuration loaded from disk", "info");
            parseAndApplyConfig(raw);
            appendLog("dash-log", "[CONFIG] Parsed and applied successfully.");
        } catch(e) {
            appendLog("dash-log", "[CONFIG] Failed to read from disk: " + (e.message || e));
            var saved = localStorage.getItem("bambooclaw-config");
            if (saved) {
                appendLog("dash-log", "[CONFIG] Falling back to localStorage data.");
                try {
                    currentConfig = JSON.parse(saved);
                    applyConfigToUI();
                } catch(e2) {
                    appendLog("dash-log", "[CONFIG] LocalStorage parse error.");
                }
            } else {
                appendLog("dash-log", "[CONFIG] No fallback data found.");
            }
        }
    }

    function parseAndApplyConfig(toml) {
        var lines = toml.split("\n");
        var section = "";
        lines.forEach(function(line) {
            line = line.trim();
            if (!line || line.startsWith("#")) return;
            var secMatch = line.match(/^\[(.+)\]$/);
            if (secMatch) { section = secMatch[1]; return; }
            
            var kvMatch = line.match(/^(\w+)\s*=\s*(.*)$/);
            if (kvMatch) {
                var key = kvMatch[1], valRaw = kvMatch[2].trim();
                var val = valRaw;
                if (valRaw.startsWith('"')) {
                    try {
                        val = JSON.parse(valRaw);
                    } catch(e) {
                        val = valRaw.replace(/^"|"$/g, '');
                    }
                } else if (!isNaN(valRaw)) {
                    val = Number(valRaw);
                }
                
                if (section === "llm") {
                    if (!currentConfig.llm) currentConfig.llm = {};
                    currentConfig.llm[key] = String(val);
                }
                if (section.startsWith("channels.")) {
                    var ch = section.replace("channels.", "");
                    if (!currentConfig.channels) currentConfig.channels = {};
                    if (!currentConfig.channels[ch]) currentConfig.channels[ch] = {};
                    currentConfig.channels[ch][key] = String(val);
                }
                if (section === "agent") {
                    if (key === "composio_api_key") {
                        currentConfig.composioApiKey = String(val);
                    } else {
                        if (!currentConfig.settings) currentConfig.settings = {};
                        currentConfig.settings[key] = String(val);
                    }
                }
            }
        });
        applyConfigToUI();
    }

    function applyConfigToUI() {
        if (currentConfig.llm) {
            if (currentConfig.llm.provider) {
                document.getElementById("llm-provider").value = currentConfig.llm.provider;
                document.getElementById("llm-provider").dispatchEvent(new Event("change"));
            }
            if (currentConfig.llm.api_key) document.getElementById("llm-api-key").value = currentConfig.llm.api_key;
            if (currentConfig.llm.model) {
                setTimeout(function() { 
                    var sel = document.getElementById("llm-model");
                    if (sel) sel.value = currentConfig.llm.model; 
                    if (currentConfig.llm.provider === "openrouter") {
                        orSelectedModel = currentConfig.llm.model;
                        var nameEl = document.getElementById("or-active-model-name");
                        if (nameEl) nameEl.textContent = currentConfig.llm.model;
                        setTimeout(renderORModels, 200); 
                    }
                }, 50);
            }
            if (currentConfig.llm.system_prompt != null) {
                var sp = document.getElementById("settings-system-prompt");
                if (sp) sp.value = currentConfig.llm.system_prompt;
            }
        }
        if (currentConfig.channels) {
            if (currentConfig.channels.telegram) document.getElementById("tg-status").textContent = "Token: " + currentConfig.channels.telegram.token.substring(0, 8) + "...";
            if (currentConfig.channels.discord) document.getElementById("dc-status").textContent = "Token: " + currentConfig.channels.discord.token.substring(0, 8) + "...";
        }
        if (currentConfig.settings) {
            var s = currentConfig.settings;
            if (s.autonomy) document.getElementById("set-autonomy").value = s.autonomy;
            if (s.port || s.gateway_port) document.getElementById("set-port").value = s.port || s.gateway_port;
            if (s.tunnel) document.getElementById("set-tunnel").value = s.tunnel;
            if (s.runtime) document.getElementById("set-runtime").value = s.runtime;
            if (s.loglevel || s.log_level) document.getElementById("set-loglevel").value = s.loglevel || s.log_level;
            
            if (s.identity !== undefined) {
                var identVal = parseInt(s.identity);
                if (!isNaN(identVal)) {
                    activePersonaIndex = identVal;
                } else {
                    activePersonaIndex = -1;
                }
                var identEl = document.getElementById("set-identity");
                if (identEl) identEl.value = activePersonaIndex >= 0 ? activePersonaIndex : "-1";
            }
        }

    // =========== CHANNEL SETUP ===========
    function closeChannelSetup() {
        appendLog("dash-log", "[CH] closeChannelSetup()");
        document.getElementById("channel-setup-area").classList.add("hidden");
    }

    function setupTelegram() {
        appendLog("dash-log", "[CH] setupTelegram() called");
        var savedToken = (currentConfig.channels && currentConfig.channels.telegram && currentConfig.channels.telegram.token) || "";
        document.getElementById("channel-setup-title").textContent = "Telegram Bot Setup";
        document.getElementById("channel-setup-body").innerHTML =
            '<p style="margin-bottom:1rem;color:var(--text-dim);">1. Open Telegram and talk to <strong>@BotFather</strong><br>2. Send /newbot and follow the prompts<br>3. Copy the bot token and paste it below</p>' +
            '<div class="form-group"><label>Bot Token</label><input type="text" id="tg-token" placeholder="123456:ABC-DEF1234ghIkl..." value="' + savedToken.replace(/"/g, '&quot;') + '" /></div>' +
            '<button class="btn btn-sm" id="btn-save-tg">Save Token</button>' +
            '<button class="btn btn-sm btn-outline" style="margin-left:0.5rem;" id="btn-test-tg">Test</button>';
        document.getElementById("channel-setup-area").classList.remove("hidden");
        document.getElementById("btn-save-tg").addEventListener("click", function() { window.saveTelegramToken(); });
        document.getElementById("btn-test-tg").addEventListener("click", function() { window.testChannel("telegram"); });
        try {
            if (window.__TAURI__) {
                var opener = (window.__TAURI__.opener && window.__TAURI__.opener.openUrl) || (window.__TAURI__.shell && window.__TAURI__.shell.open);
                if (opener) opener("https://t.me/BotFather");
            }
        } catch(e) {}
    }

    function saveTelegramToken() {
        var token = document.getElementById("tg-token").value.trim();
        if (!token) { showToast("Please enter a bot token", "error"); return; }
        if (!currentConfig.channels) currentConfig.channels = {};
        currentConfig.channels.telegram = { token: token };
        document.getElementById("tg-status").textContent = "Token: " + token.substring(0, 8) + "...";
        saveAllConfig();
        showToast("Telegram bot token saved", "success");
        closeChannelSetup();
    }

    function setupDiscord() {
        var savedToken = (currentConfig.channels && currentConfig.channels.discord && currentConfig.channels.discord.token) || "";
        var savedGuild = (currentConfig.channels && currentConfig.channels.discord && currentConfig.channels.discord.guild_id) || "";
        document.getElementById("channel-setup-title").textContent = "Discord App Setup";
        document.getElementById("channel-setup-body").innerHTML =
            '<p style="margin-bottom:1rem;color:var(--text-dim);">1. Go to <strong>discord.com/developers/applications</strong><br>2. Create a new application ‚Üí Bot ‚Üí Reset Token<br>3. Enable MESSAGE CONTENT INTENT<br>4. Paste the bot token below</p>' +
            '<div class="form-group"><label>Bot Token</label><input type="text" id="dc-token" placeholder="MTA..." value="' + savedToken.replace(/"/g, '&quot;') + '" /></div>' +
            '<div class="form-group"><label>Guild ID (optional)</label><input type="text" id="dc-guild" placeholder="Server ID for slash commands" value="' + savedGuild.replace(/"/g, '&quot;') + '" /></div>' +
            '<button class="btn btn-sm" id="btn-save-dc">Save Token</button>' +
            '<button class="btn btn-sm btn-outline" style="margin-left:0.5rem;" id="btn-test-dc">Test</button>';
        document.getElementById("channel-setup-area").classList.remove("hidden");
        document.getElementById("btn-save-dc").addEventListener("click", function() { window.saveDiscordToken(); });
        document.getElementById("btn-test-dc").addEventListener("click", function() { window.testChannel("discord"); });
    }

    function saveDiscordToken() {
        var token = document.getElementById("dc-token").value.trim();
        if (!token) { showToast("Please enter a bot token", "error"); return; }
        if (!currentConfig.channels) currentConfig.channels = {};
        currentConfig.channels.discord = { token: token, guild_id: document.getElementById("dc-guild").value.trim() };
        document.getElementById("dc-status").textContent = "Token: " + token.substring(0, 8) + "...";
        saveAllConfig();
        showToast("Discord bot token saved", "success");
        closeChannelSetup();
    }

    function setupWhatsApp() {
        document.getElementById("channel-setup-title").textContent = "WhatsApp Business Setup";
        document.getElementById("channel-setup-body").innerHTML =
            '<p style="margin-bottom:1rem;color:var(--text-dim);">WhatsApp Business Cloud API requires a Meta Business account and approved app.</p>' +
            '<div class="form-group"><label>Phone Number ID</label><input type="text" id="wa-phone-id" placeholder="From Meta Developer Console" /></div>' +
            '<div class="form-group"><label>Access Token</label><input type="text" id="wa-token" placeholder="EAA..." /></div>' +
            '<div class="form-group"><label>Webhook Verify Token</label><input type="text" id="wa-verify" placeholder="Your custom verify string" /></div>' +
            '<button class="btn btn-sm" id="btn-save-wa">Save Configuration</button>' +
            '<button class="btn btn-sm btn-outline" style="margin-left:0.5rem;" id="btn-test-wa">Test</button>';
        document.getElementById("channel-setup-area").classList.remove("hidden");
        document.getElementById("btn-save-wa").addEventListener("click", function() { window.saveWhatsApp(); });
        document.getElementById("btn-test-wa").addEventListener("click", function() { window.testChannel("whatsapp"); });
    }

    function saveWhatsApp() {
        var phoneId = document.getElementById("wa-phone-id").value.trim();
        var token = document.getElementById("wa-token").value.trim();
        var verify = document.getElementById("wa-verify").value.trim();
        if (!phoneId || !token) { showToast("Phone Number ID and Access Token are required", "error"); return; }
        if (!currentConfig.channels) currentConfig.channels = {};
        currentConfig.channels.whatsapp = { phone_number_id: phoneId, access_token: token, verify_token: verify };
        document.getElementById("wa-status").textContent = "Phone: " + phoneId;
        saveAllConfig();
        showToast("WhatsApp configuration saved", "success");
        closeChannelSetup();
    }

    function setupSlack() {
        document.getElementById("channel-setup-title").textContent = "Slack App Setup";
        document.getElementById("channel-setup-body").innerHTML =
            '<p style="margin-bottom:1rem;color:var(--text-dim);">1. Go to <strong>api.slack.com/apps</strong> and create a new app<br>2. Enable Socket Mode and Event Subscriptions<br>3. Add bot scopes: chat:write, app_mentions:read, channels:history</p>' +
            '<div class="form-group"><label>Bot Token</label><input type="text" id="sl-bot-token" placeholder="xoxb-..." /></div>' +
            '<div class="form-group"><label>App Token</label><input type="text" id="sl-app-token" placeholder="xapp-..." /></div>' +
            '<button class="btn btn-sm" id="btn-save-sl">Save Configuration</button>' +
            '<button class="btn btn-sm btn-outline" style="margin-left:0.5rem;" id="btn-test-sl">Test</button>';
        document.getElementById("channel-setup-area").classList.remove("hidden");
        document.getElementById("btn-save-sl").addEventListener("click", function() { window.saveSlack(); });
        document.getElementById("btn-test-sl").addEventListener("click", function() { window.testChannel("slack"); });
    }

    function saveSlack() {
        var botToken = document.getElementById("sl-bot-token").value.trim();
        var appToken = document.getElementById("sl-app-token").value.trim();
        if (!botToken) { showToast("Bot token is required", "error"); return; }
        if (!currentConfig.channels) currentConfig.channels = {};
        currentConfig.channels.slack = { bot_token: botToken, app_token: appToken };
        document.getElementById("sl-status").textContent = "Token: " + botToken.substring(0, 10) + "...";
        saveAllConfig();
        showToast("Slack configuration saved", "success");
        closeChannelSetup();
    }

    async function testChannel(channel) {
        showToast("Testing " + channel + " connection...", "info");
        try {
            if (channel === "telegram") {
                var token = currentConfig.channels && currentConfig.channels.telegram && currentConfig.channels.telegram.token;
                if (!token) {
                    var tgInput = document.getElementById("tg-token");
                    if (tgInput) token = tgInput.value.trim();
                }
                if (!token) { showToast("No Telegram bot token configured.", "error"); return; }
                var resp = await fetch("https://api.telegram.org/bot" + token + "/getMe");
                var data = await resp.json();
                if (data.ok) {
                    showToast("Telegram bot @" + data.result.username + " is valid!", "success");
                } else {
                    showToast("Invalid Telegram token: " + (data.description || "unknown error"), "error");
                }
            } else if (channel === "discord") {
                var dToken = currentConfig.channels && currentConfig.channels.discord && currentConfig.channels.discord.token;
                if (!dToken) {
                    var dcInput = document.getElementById("dc-token");
                    if (dcInput) dToken = dcInput.value.trim();
                }
                if (!dToken) { showToast("No Discord bot token configured", "error"); return; }
                var dresp = await fetch("https://discord.com/api/v10/users/@me", {
                    headers: { "Authorization": "Bot " + dToken }
                });
                if (dresp.ok) {
                    var ddata = await dresp.json();
                    showToast("Discord bot " + ddata.username + " is valid!", "success");
                } else {
                    showToast("Invalid Discord token (HTTP " + dresp.status + ")", "error");
                }
            } else {
                showToast("Configuration saved. Full " + channel + " test available when agent is running.", "info");
            }
        } catch(e) {
            showToast(channel + " test error: " + (e.message || e), "error");
        }
    }

    // =========== AGENT CONTROL ===========
    async function toggleDaemon() {
        var btn = document.getElementById("btn-daemon-toggle");
        if (daemonRunning) {
            try {
                stopTelegramPolling();
                await invokeShort("stop_daemon");
                daemonRunning = false;
                updateDaemonUI();
                var chatEl = document.getElementById("agent-chat-messages");
                if (chatEl) chatEl.innerHTML += '<div class="chat-msg assistant"><span class="role">Agent:</span> Daemon stopped.</div>';
                showToast("Agent daemon stopped", "info");
            } catch(e) {
                stopTelegramPolling();
                daemonRunning = false;
                updateDaemonUI();
                showToast("Daemon process not found (may have already stopped)", "info");
            }
        } else {
            try {
                await invokeShort("start_daemon");
                daemonRunning = true;
                updateDaemonUI();
                var chatEl = document.getElementById("agent-chat-messages");
                if (chatEl) chatEl.innerHTML = '<div class="chat-msg assistant"><span class="role">Agent:</span> Daemon is online. How can I help you?</div>';
                showToast("Agent daemon started", "success");
                startTelegramPolling();
            } catch(e) {
                showToast("Failed to start daemon: " + (e.message || e), "error");
            }
        }
    }

    function updateDaemonUI() {
        var pill = document.getElementById("daemon-status-pill");
        var text = document.getElementById("daemon-status-text");
        var btn = document.getElementById("btn-daemon-toggle");
        if (daemonRunning) {
            pill.className = "status-pill running";
            text.textContent = "Running";
            btn.textContent = "Stop Agent Daemon";
            btn.classList.add("btn-danger");
        } else {
            pill.className = "status-pill stopped";
            text.textContent = "Stopped";
            btn.textContent = "Start Agent Daemon";
            btn.classList.remove("btn-danger");
        }
    }

    async function emergencyFlush() {
        showToast("Flushing system processes...", "info");
        stopTelegramPolling();
        try { await invokeShort("emergency_flush"); } catch(e) {
            try { await invokeShort("stop_daemon"); } catch(e2) {}
        }
        daemonRunning = false;
        updateDaemonUI();
        chatHistory = [];
        var chatEl = document.getElementById("agent-chat-messages");
        if (chatEl) chatEl.innerHTML = '<div class="chat-msg assistant"><span class="role">Agent:</span> System flushed. All processes stopped and memory cleared.</div>';
        showToast("System flushed successfully", "success");
    }

    async function sendAgentMessage(e) {
        if (e) { e.preventDefault(); e.stopPropagation(); }
        var input = document.getElementById("agent-chat-input");
        var msg = input.value.trim();
        if (!msg) return;
        input.value = "";

        var chatEl = document.getElementById("agent-chat-messages");
        chatEl.innerHTML += '<div class="chat-msg"><span class="role">You:</span> ' + escapeHtml(msg) + '</div>';
        chatEl.scrollTop = chatEl.scrollHeight;

        if (!daemonRunning) {
            chatEl.innerHTML += '<div class="chat-msg assistant"><span class="role">Agent:</span> Daemon is not running. Please start it first.</div>';
            chatEl.scrollTop = chatEl.scrollHeight;
            return;
        }

        chatEl.innerHTML += '<div class="chat-msg assistant" id="typing-indicator"><span class="role">Agent:</span> <span class="spinner">‚ü≥</span> Thinking...</div>';
        chatEl.scrollTop = chatEl.scrollHeight;

        try {
            var reply = await callLLM(msg);
            var typing = document.getElementById("typing-indicator");
            if (typing) typing.remove();
            chatEl.innerHTML += '<div class="chat-msg assistant"><span class="role">Agent:</span> ' + formatMarkdownToHtml(reply || "(no response)") + '</div>';
        } catch(err) {
            var typing = document.getElementById("typing-indicator");
            if (typing) typing.remove();
            chatEl.innerHTML += '<div class="chat-msg assistant"><span class="role">Agent:</span> Error: ' + escapeHtml(err.message || String(err)) + '</div>';
        }
        chatEl.scrollTop = chatEl.scrollHeight;
        return false;
    }

    // =========== DIRECT LLM CALL WITH TOOL CALLING ===========
    var chatHistory = [];
    var MAX_TOOL_ITERATIONS = 10;

    var agentTools = [
        {
            type: "function",
            function: {
                name: "run_shell",
                description: "Execute a shell command on the user's computer. Returns stdout+stderr.",
                parameters: {
                    type: "object",
                    properties: {
                        command: { type: "string" },
                        args: { type: "array", items: { type: "string" } }
                    },
                    required: ["command"],
                    additionalProperties: false
                }
            }
        },
        {
            type: "function",
            function: {
                name: "read_file",
                description: "Read the contents of a file on the user's computer.",
                parameters: {
                    type: "object",
                    properties: { path: { type: "string" } },
                    required: ["path"],
                    additionalProperties: false
                }
            }
        },
        {
            type: "function",
            function: {
                name: "write_file",
                description: "Write content to a file on the user's computer.",
                parameters: {
                    type: "object",
                    properties: { path: { type: "string" }, content: { type: "string" } },
                    required: ["path", "content"],
                    additionalProperties: false
                }
            }
        },
        {
            type: "function",
            function: {
                name: "http_request",
                description: "Make an HTTP request.",
                parameters: {
                    type: "object",
                    properties: { url: { type: "string" }, method: { type: "string" }, headers: { type: "object" }, body: { type: "string" } },
                    required: ["url"],
                    additionalProperties: false
                }
            }
        },
        {
            type: "function",
            function: {
                name: "list_directory",
                description: "List files and folders.",
                parameters: {
                    type: "object",
                    properties: { path: { type: "string" } },
                    required: ["path"],
                    additionalProperties: false
                }
            }
        },
        {
            type: "function",
            function: {
                name: "take_screenshot",
                description: "Take a screenshot of the user's screen.",
                parameters: {
                    type: "object",
                    properties: { filename: { type: "string" } },
                    additionalProperties: false
                }
            }
        }
    ];

    var pendingApprovalId = 0;
    async function awaitUserApproval(toolName, args) {
        return new Promise(function(resolve, reject) {
            pendingApprovalId++;
            var aid = "approval-" + pendingApprovalId;
            var argsStr = JSON.stringify(args);
            if (argsStr.length > 300) argsStr = argsStr.substring(0, 300) + "...";
            var chatArea = document.getElementById("chat-area");
            if (!chatArea) { resolve(true); return; }
            var card = document.createElement("div");
            card.className = "approval-card";
            card.id = aid;
            card.innerHTML = '<div class="approval-title">‚ö† Approval Required</div>' +
                '<div class="approval-detail"><strong>' + escapeHtml(toolName) + '</strong><br>' + escapeHtml(argsStr) + '</div>' +
                '<div class="approval-actions">' +
                '<button class="btn-approve" data-aid="' + aid + '">‚úì Allow</button>' +
                '<button class="btn-deny" data-aid="' + aid + '">‚úó Deny</button>' +
                '</div>' +
                '<div class="approval-timeout">Auto-denies in 120 seconds</div>';
            chatArea.appendChild(card);
            chatArea.scrollTop = chatArea.scrollHeight;
            var timeout = setTimeout(function() {
                cleanup();
                reject(new Error("User approval timed out for: " + toolName));
            }, 120000);
            function cleanup() { var el = document.getElementById(aid); if (el) el.remove(); }
            card.querySelector(".btn-approve").addEventListener("click", function() { clearTimeout(timeout); cleanup(); resolve(true); });
            card.querySelector(".btn-deny").addEventListener("click", function() { clearTimeout(timeout); cleanup(); reject(new Error("User denied tool execution")); });
        });
    }

    var DANGEROUS_TOOLS = ["run_shell", "write_file", "docker_command", "ssh_execute", "mqtt_publish"];

    async function executeTool(toolName, args) {
        appendLog("unified-log", "[AGENT] [TOOL] Executing: " + toolName + "(" + JSON.stringify(args).substring(0, 100) + ")");

        var autonomy = (currentConfig.settings && currentConfig.settings.autonomy) || "collaborative";
        try { var sel = document.getElementById("setting-autonomy"); if (sel) autonomy = sel.value; } catch(e) {}

        if (autonomy === "observe") {
            return "[BLOCKED] Observation Only mode is active.";
        }

        if (autonomy === "collaborative") {
            var isDangerous = DANGEROUS_TOOLS.indexOf(toolName) >= 0 || toolName.startsWith("composio_");
            if (isDangerous) {
                try {
                    await awaitUserApproval(toolName, args);
                } catch(e) {
                    return "Tool execution denied: " + (e.message || String(e));
                }
            }
        }

        try {
            if (toolName === "run_shell") {
                var cmd = args.command || "";
                var cmdArgs = args.args || [];
                var result = await invokeShort("run_shell_command", { commandName: cmd, args: cmdArgs });
                return result || "(no output)";
            } else if (toolName === "read_file") {
                var platform = await invokeShort("get_platform");
                var result;
                if (platform === "windows") {
                    result = await invokeShort("run_shell_command", { commandName: "cmd", args: ["/c", "type", args.path] });
                } else {
                    result = await invokeShort("run_shell_command", { commandName: "cat", args: [args.path] });
                }
                return result || "(empty file)";
            } else if (toolName === "write_file") {
                var platform = await invokeShort("get_platform");
                if (platform === "windows") {
                    var psCmd = "Set-Content -Path '" + args.path.replace(/'/g, "''") + "' -Value '" + (args.content || "").replace(/'/g, "''") + "'";
                    var result = await invokeShort("run_shell_command", { commandName: "powershell", args: ["-Command", psCmd] });
                } else {
                    var result = await invokeShort("run_shell_command", { commandName: "bash", args: ["-c", "cat > '" + args.path.replace(/'/g, "'\''") + "' << 'BCEOF'\n" + (args.content || "") + "\nBCEOF"] });
                }
                return "File written successfully: " + args.path;
            } else if (toolName === "http_request") {
                var method = (args.method || "GET").toUpperCase();
                var fetchOpts = { method: method, headers: args.headers || {} };
                if (args.body && (method === "POST" || method === "PUT" || method === "PATCH")) {
                    fetchOpts.body = args.body;
                }
                var resp = await fetch(args.url, fetchOpts);
                var text = await resp.text();
                return "HTTP " + resp.status + "\n" + text.substring(0, 5000);
            } else if (toolName === "list_directory") {
                var platform = await invokeShort("get_platform");
                var cmd = platform === "windows" ? "dir" : "ls";
                var cmdArgs = platform === "windows" ? ["/B", args.path] : ["-la", args.path];
                var result = await invokeShort("run_shell_command", { commandName: cmd, args: cmdArgs });
                return result || "(empty directory)";
            } else if (toolName === "take_screenshot") {
                var fname = args.filename || "screenshot.png";
                var platform = await invokeShort("get_platform");
                var screenshotPath = platform === "windows" ? "C:\\tmp\\" + fname : "/tmp/" + fname;
                var pyCmd = "import pyautogui; pyautogui.screenshot('" + screenshotPath.replace(/\\/g, "\\\\") + "'); print('" + screenshotPath + "')";
                var result = await invokeShort("run_shell_command", { commandName: "python", args: ["-c", pyCmd] });
                return "Screenshot saved to: " + screenshotPath + "\n" + (result || "");
            } else if (["web_browse","web_search","docker_command","ssh_execute","mqtt_publish"].indexOf(toolName) >= 0 || toolName.startsWith("composio_")) {
                return await executeSkillTool(toolName, args);
            } else {
                return "Unknown tool: " + toolName;
            }
        } catch(e) {
            return "Tool error: " + (e.message || String(e));
        }
    }

    async function callLLM(userMessage) {
        var cfg = currentConfig.llm;
        if (!cfg || !cfg.api_key) throw new Error("No LLM configured. Go to LLM Settings and apply a configuration.");

        chatHistory.push({ role: "user", content: userMessage });
        if (chatHistory.length > 30) chatHistory = chatHistory.slice(-30);

        var provider = cfg.provider;
        var model = cfg.model;
        var apiKey = cfg.api_key;

        var platform = "unknown";
        try { platform = await invokeShort("get_platform"); } catch(e) {}

        var autonomy = (currentConfig.settings && currentConfig.settings.autonomy) || "collaborative";
        var maxIter = (currentConfig.settings && currentConfig.settings.maxIterations) || MAX_TOOL_ITERATIONS;

        var systemPrompt = "You are BambooClaw, an AI agent running on the user's " + platform + " computer.\n\n";

        if (autonomy === "observe") {
            systemPrompt += "MODE: OBSERVATION ONLY.\n\n";
        } else if (autonomy === "collaborative") {
            systemPrompt += "MODE: COLLABORATIVE.\n\n";
        } else {
            systemPrompt += "MODE: FULL AUTONOMY. You have absolute control over this computer.\n\n";
            systemPrompt += "CRITICAL RULES FOR FULL AUTONOMY:\n";
            systemPrompt += "1. NEVER tell the user to do something manually. YOU execute every action.\n";
            systemPrompt += "2. For GUI tasks: Take screenshot -> Analyze -> pyautogui -> Verify screenshot.\n";
            systemPrompt += "3. For web service tasks: Use API scripts preferred. Fallback to browser automation.\n";
            systemPrompt += "4. Chain as many tool calls as needed. Do not stop halfway. Your max iterations: " + maxIter + "\n";
            systemPrompt += "5. Complete ALL steps before responding.\n";
            systemPrompt += "6. For file operations: just do them.\n";
            systemPrompt += "7. ENCODING RULE: NEVER output raw Unicode characters (like German umlauts √§, √∂, √º, or the Euro symbol ‚Ç¨) inside Python scripts. ALWAYS use standard ASCII equivalents (e.g. 'ae', 'oe', 'ue', 'EUR') to prevent Windows encoding crashes.\n\n";
        }

        var userSystemPrompt = (currentConfig.llm && currentConfig.llm.system_prompt) ? currentConfig.llm.system_prompt.trim() : "";
        var personaPrompt = "";
        if (activePersonaIndex >= 0 && activePersonaIndex < personas.length) {
            personaPrompt = personas[activePersonaIndex].prompt.trim();
        }
        if (userSystemPrompt || personaPrompt) {
            systemPrompt += "\n--- OPERATOR INSTRUCTIONS ---\n";
            if (userSystemPrompt) systemPrompt += userSystemPrompt + "\n";
            if (personaPrompt) {
                systemPrompt += "\n--- ACTIVE PERSONA ---\n" + personaPrompt + "\n--- END PERSONA ---\n";
            }
            systemPrompt += "--- END OPERATOR INSTRUCTIONS ---\n";
        }

        var apiUrl, headers;
        var supportsTools = true;

        if (provider === "openrouter") {
            apiUrl = "https://openrouter.ai/api/v1/chat/completions";
            headers = { "Authorization": "Bearer " + apiKey, "Content-Type": "application/json", "HTTP-Referer": "https://bambooclaw.com" };
        } else if (provider === "openai") {
            apiUrl = "https://api.openai.com/v1/chat/completions";
            headers = { "Authorization": "Bearer " + apiKey, "Content-Type": "application/json" };
        } else if (provider === "groq") {
            apiUrl = "https://api.groq.com/openai/v1/chat/completions";
            headers = { "Authorization": "Bearer " + apiKey, "Content-Type": "application/json" };
        } else if (provider === "deepseek") {
            apiUrl = "https://api.deepseek.com/v1/chat/completions";
            headers = { "Authorization": "Bearer " + apiKey, "Content-Type": "application/json" };
        } else if (provider === "mistral") {
            apiUrl = "https://api.mistral.ai/v1/chat/completions";
            headers = { "Authorization": "Bearer " + apiKey, "Content-Type": "application/json" };
        } else if (provider === "anthropic") {
            apiUrl = "https://api.anthropic.com/v1/messages";
            headers = { "x-api-key": apiKey, "Content-Type": "application/json", "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" };
            supportsTools = false; 
        } else if (provider === "google") {
            apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/" + model + ":generateContent?key=" + apiKey;
            headers = { "Content-Type": "application/json" };
            supportsTools = false;
        } else if (provider === "ollama") {
            apiUrl = "http://localhost:11434/api/chat";
            headers = { "Content-Type": "application/json" };
            supportsTools = false;
        } else if (provider === "inception") {
            apiUrl = "https://api.inceptionlabs.ai/v1/chat/completions";
            headers = { "Authorization": "Bearer " + apiKey, "Content-Type": "application/json" };
        } else {
            throw new Error("Unsupported provider: " + provider);
        }

        var messages = [{ role: "system", content: systemPrompt }].concat(chatHistory);

        function updatePayloadInspector(fullBody) {
            var el = document.getElementById("llm-payload-display");
            if (el) {
                var displayBody = JSON.parse(JSON.stringify(fullBody));
                el.textContent = JSON.stringify(displayBody, null, 2);
                el.scrollTop = 0;
            }
        }

        if (!supportsTools) {
            var body;
            if (provider === "anthropic") {
                body = JSON.stringify({ model: model, max_tokens: 2048, system: systemPrompt, messages: chatHistory });
            } else if (provider === "google") {
                body = JSON.stringify({ contents: [{ parts: [{ text: userMessage }] }] });
            } else if (provider === "ollama") {
                body = JSON.stringify({ model: model, messages: messages, stream: false });
            }
            updatePayloadInspector(JSON.parse(body));
            var resp = await fetch(apiUrl, { method: "POST", headers: headers, body: body });
            if (!resp.ok) throw new Error("LLM API error (HTTP " + resp.status + ")");
            var data = await resp.json();
            var reply = "";
            if (provider === "anthropic") reply = data.content && data.content[0] && data.content[0].text || "(empty)";
            else if (provider === "google") reply = data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text || "(empty)";
            else if (provider === "ollama") reply = data.message && data.message.content || "(empty)";
            chatHistory.push({ role: "assistant", content: reply });
            return reply;
        }

        for (var iteration = 0; iteration < MAX_TOOL_ITERATIONS; iteration++) {
            var dedupedTools = [];
            var seenToolNames = {};
            agentTools.forEach(function(t) {
                var tn = t.function.name;
                if (!seenToolNames[tn]) {
                    seenToolNames[tn] = true;
                    if (!t.function.description) t.function.description = tn;
                    dedupedTools.push(t);
                }
            });
            // FIX: Lowered max_tokens to 4096 to prevent HTTP 400 Bad Request on strict models
            var reqBody = { model: model, messages: messages, max_tokens: 4096 };
            if (dedupedTools.length > 0) {
                reqBody.tools = dedupedTools;
                reqBody.tool_choice = "auto";
            }
            updatePayloadInspector(reqBody);
            
            var resp = await fetch(apiUrl, { method: "POST", headers: headers, body: JSON.stringify(reqBody) });
            if (!resp.ok) {
                chatHistory.pop();
                var errText = await resp.text();
                // FIX: Explicit 401 handling to diagnose wrong API keys
                if (resp.status === 401) {
                    throw new Error("HTTP 401: Invalid API Key. Make sure you entered a valid " + provider + " key.");
                }
                throw new Error("LLM API error (HTTP " + resp.status + ") - " + errText.substring(0, 100));
            }
            var data = await resp.json();
            var choice = data.choices && data.choices[0];
            if (!choice) throw new Error("No response from LLM");

            var assistantMsg = choice.message;
            messages.push(assistantMsg);

            if (assistantMsg.tool_calls && assistantMsg.tool_calls.length > 0) {
                for (var t = 0; t < assistantMsg.tool_calls.length; t++) {
                    var tc = assistantMsg.tool_calls[t];
                    var toolName = tc.function.name;
                    var toolArgs = {};
                    try { toolArgs = JSON.parse(tc.function.arguments); } catch(e) {}

                    var toolResult = await executeTool(toolName, toolArgs);

                    messages.push({
                        role: "tool",
                        tool_call_id: tc.id,
                        content: toolResult
                    });
                }
                continue;
            }

            var reply = assistantMsg.content || "(no response)";
            chatHistory.push({ role: "assistant", content: reply });
            return reply;
        }

        var lastMsg = messages[messages.length - 1];
        var reply = (lastMsg && lastMsg.content) || "(max tool iterations reached)";
        chatHistory.push({ role: "assistant", content: reply });
        return reply;
    }

    // =========== TELEGRAM POLLING ===========
    var tgPollingTimeout = null;
    var tgLastUpdateId = 0;

    function startTelegramPolling() {
        if (tgPollingTimeout) return; 
        var token = currentConfig.channels && currentConfig.channels.telegram && currentConfig.channels.telegram.token;
        if (!token) {
            appendLog("dash-log", "[TG-POLL] No Telegram token configured, skipping polling");
            return;
        }
        appendLog("dash-log", "[TG-POLL] Starting Telegram polling...");
        pollTelegramLoop();
    }

    async function pollTelegramLoop() {
        if (!daemonRunning) return;
        await pollTelegram(); 
        tgPollingTimeout = setTimeout(pollTelegramLoop, 3000); 
    }

    function stopTelegramPolling() {
        if (tgPollingTimeout) {
            clearTimeout(tgPollingTimeout);
            tgPollingTimeout = null;
            appendLog("dash-log", "[TG-POLL] Telegram polling stopped");
        }
    }

    async function pollTelegram() {
        var token = currentConfig.channels && currentConfig.channels.telegram && currentConfig.channels.telegram.token;
        if (!token || !daemonRunning) return;

        try {
            var url = "https://api.telegram.org/bot" + token + "/getUpdates?offset=" + (tgLastUpdateId + 1) + "&timeout=1&allowed_updates=[%22message%22]";
            var resp = await fetch(url);
            if (!resp.ok) return;
            var data = await resp.json();
            if (!data.ok || !data.result || data.result.length === 0) return;

            for (var i = 0; i < data.result.length; i++) {
                var update = data.result[i];
                tgLastUpdateId = update.update_id;
                if (update.message && update.message.text) {
                    var chatId = update.message.chat.id;
                    var text = update.message.text;
                    var from = update.message.from && update.message.from.first_name || "User";
                    appendLog("unified-log", "[AGENT] [TELEGRAM] Message from " + from + ": " + text);

                    var chatEl = document.getElementById("agent-chat-messages");
                    if (chatEl) {
                        chatEl.innerHTML += '<div class="chat-msg"><span class="role">You (Telegram):</span> ' + escapeHtml(text) + '</div>';
                        chatEl.scrollTop = chatEl.scrollHeight;
                    }

                    try {
                        var reply = await callLLM(text);
                        await fetch("https://api.telegram.org/bot" + token + "/sendMessage", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ chat_id: chatId, text: stripMarkdownForTelegram(reply), parse_mode: "Markdown" })
                        });
                        if (chatEl) {
                            chatEl.innerHTML += '<div class="chat-msg assistant"><span class="role">Agent:</span> ' + formatMarkdownToHtml(reply || "(no response)") + '</div>';
                            chatEl.scrollTop = chatEl.scrollHeight;
                        }
                    } catch(e) {
                        await fetch("https://api.telegram.org/bot" + token + "/sendMessage", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ chat_id: chatId, text: "Sorry, I encountered an error: " + (e.message || "unknown") })
                        });
                    }
                }
            }
        } catch(e) {}
    }

    function escapeHtml(str) {
        return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
    }

    function formatMarkdownToHtml(str) {
        var s = escapeHtml(str);
        var BT = String.fromCharCode(96);
        s = s.replace(/^### (.+)$/gm, '<h4 style="margin:0.6em 0 0.3em;font-size:0.95em;color:var(--accent);">$1</h4>');
        s = s.replace(/^## (.+)$/gm, '<h3 style="margin:0.7em 0 0.3em;font-size:1.05em;color:var(--accent);">$1</h3>');
        s = s.replace(/^# (.+)$/gm, '<h2 style="margin:0.8em 0 0.4em;font-size:1.15em;color:var(--accent);">$1</h2>');
        s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
        var codeRe = new RegExp(BT + '([^' + BT + ']+)' + BT, 'g');
        s = s.replace(codeRe, '<code style="background:rgba(0,255,136,0.1);padding:0.1em 0.4em;border-radius:3px;font-size:0.9em;">$1</code>');
        s = s.replace(/^[\*\-] (.+)$/gm, '<li style="margin-left:1.2em;list-style:disc;">$1</li>');
        s = s.replace(/^\d+\. (.+)$/gm, '<li style="margin-left:1.2em;list-style:decimal;">$1</li>');
        s = s.replace(/((<li[^>]*>.*<\/li>\s*)+)/g, '<ul style="margin:0.3em 0;padding-left:0.5em;">$1</ul>');
        s = s.replace(/\n/g, '<br>');
        s = s.replace(/<br>\s*(<h[234]|<ul|<\/ul>)/g, '$1');
        s = s.replace(/(<\/h[234]>|<\/ul>)\s*<br>/g, '$1');
        return s;
    }

    function stripMarkdownForTelegram(str) {
        return str.replace(/^###+ (.+)$/gm, '\u25b8 $1');
    }

    // =========== PERSONA MANAGEMENT ===========
    var personas = [];
    var activePersonaIndex = -1;

    function loadPersonas() {
        try {
            var saved = localStorage.getItem("bambooclaw-personas");
            if (saved) personas = JSON.parse(saved);
        } catch(e) {}
        var activeIdx = localStorage.getItem("bambooclaw-active-persona");
        activePersonaIndex = activeIdx !== null ? parseInt(activeIdx) : -1;
        renderPersonas();
    }

    function savePersonas() {
        localStorage.setItem("bambooclaw-personas", JSON.stringify(personas));
        localStorage.setItem("bambooclaw-active-persona", String(activePersonaIndex));
    }

    function renderPersonas() {
        var sel = document.getElementById("set-identity");
        if (sel) {
            sel.innerHTML = '<option value="-1">‚Äî BambooClaw Default (System Prompt Only) ‚Äî</option>';
            personas.forEach(function(p, i) {
                var opt = document.createElement("option");
                opt.value = i;
                opt.textContent = p.name;
                if (i === activePersonaIndex) opt.selected = true;
                sel.appendChild(opt);
            });
            sel.value = activePersonaIndex >= 0 ? activePersonaIndex : -1;
        }

        var listEl = document.getElementById("persona-list");
        if (!listEl) return;
        if (personas.length === 0) {
            listEl.innerHTML = '<p style="font-size:0.8rem;color:var(--text-dim);padding:0.5rem 0;">No personas created yet.</p>';
            return;
        }
        var html = '';
        personas.forEach(function(p, i) {
            var isActive = i === activePersonaIndex;
            html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:0.6rem 0.75rem;border:1px solid ' + (isActive ? 'var(--accent)' : 'var(--border)') + ';border-radius:6px;margin-bottom:0.5rem;background:' + (isActive ? 'rgba(16,185,129,0.05)' : 'transparent') + ';">';
            html += '<div style="flex:1;"><span style="font-weight:600;font-size:0.85rem;">' + escapeHtml(p.name) + '</span>';
            html += '<div style="font-size:0.7rem;color:var(--text-dim);margin-top:0.2rem;max-height:40px;overflow:hidden;">' + escapeHtml(p.prompt).substring(0, 120) + (p.prompt.length > 120 ? '...' : '') + '</div></div>';
            html += '<div style="display:flex;gap:0.5rem;margin-left:0.75rem;">';
            html += '<button class="btn btn-sm btn-outline" id="btn-edit-persona-' + i + '" style="padding:0.3rem 0.6rem;font-size:0.75rem;">‚úé</button>';
            html += '<button class="btn btn-sm btn-outline" id="btn-del-persona-' + i + '" style="padding:0.3rem 0.6rem;font-size:0.75rem;color:var(--error);border-color:var(--error);">‚úï</button>';
            html += '</div></div>';
        });
        listEl.innerHTML = html;
        
        personas.forEach(function(p, i) {
            var editBtn = document.getElementById('btn-edit-persona-' + i);
            if (editBtn) editBtn.addEventListener("click", function() { editPersona(i); });
            var delBtn = document.getElementById('btn-del-persona-' + i);
            if (delBtn) delBtn.addEventListener("click", function() { deletePersona(i); });
        });
    }

    var editingPersonaIndex = -1;

    function editPersona(idx) {
        var p = personas[idx];
        var nameEl = document.getElementById("new-persona-name");
        var promptEl = document.getElementById("new-persona-prompt");
        if (nameEl) nameEl.value = p.name;
        if (promptEl) promptEl.value = p.prompt;
        
        var btn = document.getElementById("btn-create-persona");
        if (btn) btn.textContent = "Update Persona";
        
        editingPersonaIndex = idx;
        var detailsBlock = document.getElementById("persona-details-block");
        if (detailsBlock) detailsBlock.open = true;
    }

    function createPersona() {
        var nameEl = document.getElementById("new-persona-name");
        var promptEl = document.getElementById("new-persona-prompt");
        var name = nameEl ? nameEl.value.trim() : "";
        var prompt = promptEl ? promptEl.value.trim() : "";
        if (!name) { showToast("Please enter a persona name", "error"); return; }
        if (!prompt) { showToast("Please enter a persona prompt", "error"); return; }
        
        if (editingPersonaIndex >= 0) {
            personas[editingPersonaIndex] = { name: name, prompt: prompt };
            showToast("Persona '" + name + "' updated", "success");
            editingPersonaIndex = -1;
            var btn = document.getElementById("btn-create-persona");
            if (btn) btn.textContent = "Create Persona";
        } else {
            personas.push({ name: name, prompt: prompt });
            showToast("Persona '" + name + "' created", "success");
        }
        
        savePersonas();
        renderPersonas();
        if (nameEl) nameEl.value = "";
        if (promptEl) promptEl.value = "";
    }

    function deletePersona(idx) {
        if (idx < 0 || idx >= personas.length) return;
        var name = personas[idx].name;
        if (!confirm("Are you sure you want to delete the persona '" + name + "'?")) return;
        
        personas.splice(idx, 1);
        if (activePersonaIndex === idx) activePersonaIndex = -1;
        else if (activePersonaIndex > idx) activePersonaIndex--;
        
        savePersonas();
        renderPersonas();
        showToast("Persona '" + name + "' deleted", "info");
    }

    // =========== SETTINGS ===========
    async function saveSettings() {
        appendLog("dash-log", "[SETTINGS] saveSettings() called");
        var iterVal = parseInt(document.getElementById("set-tool-iterations").value) || 10;
        MAX_TOOL_ITERATIONS = iterVal;
        
        var identVal = document.getElementById("set-identity").value;
        currentConfig.settings = {
            autonomy: document.getElementById("set-autonomy").value,
            port: document.getElementById("set-port").value,
            tunnel: document.getElementById("set-tunnel").value,
            identity: identVal,
            runtime: document.getElementById("set-runtime").value,
            loglevel: document.getElementById("set-loglevel").value,
            maxToolIterations: iterVal,
        };
        
        // Ensure LLM config exists before assigning system prompt
        if (!currentConfig.llm) {
            currentConfig.llm = { provider: "openai", api_key: "", model: "", system_prompt: "" };
        }
        var settingsPrompt = document.getElementById("settings-system-prompt");
        currentConfig.llm.system_prompt = settingsPrompt ? settingsPrompt.value : "";
        
        saveAllConfig();
        savePersonas();
        showToast("Settings saved", "success");
        var sr = document.getElementById("settings-save-reminder"); if (sr) sr.classList.remove("visible");
    }

    ["set-autonomy","set-port","set-tunnel","set-identity","set-runtime","set-loglevel","set-tool-iterations","settings-system-prompt"].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener("change", function() {
            if (id === "set-identity") {
                activePersonaIndex = parseInt(el.value);
                if (isNaN(activePersonaIndex)) activePersonaIndex = -1;
                savePersonas();
                renderPersonas(); // Highlights the active persona in the list
            }
            var sr = document.getElementById("settings-save-reminder"); if (sr) sr.classList.add("visible");
        });
        if (el) el.addEventListener("input", function() {
            var sr = document.getElementById("settings-save-reminder"); if (sr) sr.classList.add("visible");
        });
    });

    setTimeout(function() {
        var btn = document.getElementById("btn-create-persona");
        if (btn) btn.addEventListener("click", function() { createPersona(); });
    }, 0);

    function resetSettings() {
        appendLog("dash-log", "[SETTINGS] resetSettings() called");
        document.getElementById("set-autonomy").value = "collaborative";
        document.getElementById("set-port").value = "7331";
        document.getElementById("set-tunnel").value = "none";
        document.getElementById("set-identity").value = "bamboo";
        document.getElementById("set-runtime").value = "native";
        document.getElementById("set-loglevel").value = "info";
        document.getElementById("set-tool-iterations").value = "10";
        document.getElementById("tool-iter-value").textContent = "10";
        MAX_TOOL_ITERATIONS = 10;
        var sp = document.getElementById("settings-system-prompt"); if (sp) sp.value = "";
        showToast("Settings reset to defaults", "info");
    }

    // =========== SKILLS / COMPOSIO ===========
    var COMPOSIO_API_URL = "https://backend.composio.dev/api/v3";
    var enabledSkills = {};
    var composioTools = [];
    var composioToolkits = [];
    var composioCategories = ["All"];
    var composioActiveCategory = "All";

    function sanitizeToolSchema(rawParams) {
        if (!rawParams || typeof rawParams !== "object") {
            return { type: "object", properties: {}, required: [], additionalProperties: false };
        }
        var p;
        try { p = JSON.parse(JSON.stringify(rawParams)); } catch(e) {
            return { type: "object", properties: {}, required: [], additionalProperties: false };
        }

        function cleanProp(obj) {
            if (!obj || typeof obj !== "object") return obj;
            if (Array.isArray(obj)) return obj.map(cleanProp);
            var badKeys = ["$ref", "$defs", "$schema", "$id", "default", "examples", "example", "title", "format",
                           "readOnly", "writeOnly", "deprecated", "externalDocs", "xml", "discriminator",
                           "minLength", "maxLength", "minimum", "maximum", "exclusiveMinimum", "exclusiveMaximum",
                           "multipleOf", "pattern", "minItems", "maxItems", "uniqueItems", "minProperties", "maxProperties",
                           "const", "contentMediaType", "contentEncoding", "if", "then", "else", "not"];
            badKeys.forEach(function(k) { delete obj[k]; });
            if (obj.allOf && Array.isArray(obj.allOf) && obj.allOf.length === 1) {
                var inner = cleanProp(obj.allOf[0]);
                delete obj.allOf;
                Object.keys(inner).forEach(function(k) { if (!obj[k]) obj[k] = inner[k]; });
            } else if (obj.allOf) {
                obj.allOf.forEach(function(item) {
                    var cleaned = cleanProp(item);
                    if (cleaned.properties) {
                        if (!obj.properties) obj.properties = {};
                        Object.keys(cleaned.properties).forEach(function(pk) { obj.properties[pk] = cleaned.properties[pk]; });
                    }
                    if (cleaned.required && Array.isArray(cleaned.required)) {
                        if (!obj.required) obj.required = [];
                        cleaned.required.forEach(function(r) { if (obj.required.indexOf(r) < 0) obj.required.push(r); });
                    }
                });
                delete obj.allOf;
            }
            if (obj.properties && typeof obj.properties === "object") {
                Object.keys(obj.properties).forEach(function(k) {
                    obj.properties[k] = cleanProp(obj.properties[k]);
                });
            }
            if (obj.items) obj.items = cleanProp(obj.items);
            if (obj.anyOf && Array.isArray(obj.anyOf) && obj.anyOf.length > 0) {
                var first = cleanProp(obj.anyOf[0]);
                delete obj.anyOf;
                Object.keys(first).forEach(function(fk) { if (!obj[fk]) obj[fk] = first[fk]; });
            }
            if (obj.oneOf && Array.isArray(obj.oneOf) && obj.oneOf.length > 0) {
                var first2 = cleanProp(obj.oneOf[0]);
                delete obj.oneOf;
                Object.keys(first2).forEach(function(fk) { if (!obj[fk]) obj[fk] = first2[fk]; });
            }
            if (Array.isArray(obj.type)) {
                obj.type = obj.type.find(function(t) { return t !== "null"; }) || "string";
            }
            return obj;
        }

        p = cleanProp(p);
        if (!p.type) p.type = "object";
        if (!p.properties) p.properties = {};
        if (!p.required) p.required = [];
        p.additionalProperties = false;
        p.required = p.required.filter(function(r) { return p.properties.hasOwnProperty(r); });
        return p;
    }

    function renderActiveToolsSummary() {
        var badge = document.getElementById("active-tools-count-badge");
        var listEl = document.getElementById("active-tools-list");
        if (!badge || !listEl) return;
        var enabledCount = 0;
        var html = "";
        var allKeys = Object.keys(enabledSkills);
        allKeys.forEach(function(k) {
            if (enabledSkills[k]) {
                enabledCount++;
                var isComposio = k.startsWith("composio_");
                var dotClass = isComposio ? "composio" : "builtin";
                var label = isComposio ? k.replace("composio_", "") : k;
                var toolCount = 0;
                agentTools.forEach(function(t) {
                    if (isComposio) {
                        if (t.function.name.indexOf(k.replace("composio_", "")) > -1) toolCount++;
                    } else if (t._source === k || t.function.name === k) {
                        toolCount++;
                    }
                });
                var suffix = toolCount > 0 ? " (" + toolCount + " tools)" : "";
                html += '<div class="active-tool-entry"><span class="tool-dot ' + dotClass + '"></span>' + escapeHtml(label) + '<span style="color:var(--text-dim);font-size:0.7rem;margin-left:0.3rem;">' + suffix + '</span></div>';
            }
        });
        badge.textContent = enabledCount;
        if (!html) html = '<div style="color:var(--text-dim);font-size:0.75rem;padding:0.25rem 0;">No tools loaded</div>';
        listEl.innerHTML = html;
    }

    async function checkComposioConnection(slug) {
        var composioKey = currentConfig.composioApiKey;
        if (!composioKey) return;
        try {
            var endpoint = COMPOSIO_API_URL + "/connected_accounts?toolkit=" + encodeURIComponent(slug);
            var resultJson = "";
            if (window.__TAURI__) {
                resultJson = await tauriInvoke("run_shell_command", {
                    commandName: "curl",
                    args: ["-s", "-H", "x-api-key: " + composioKey, endpoint]
                });
            } else {
                var resp = await fetch(endpoint, { headers: { "x-api-key": composioKey } });
                resultJson = await resp.text();
            }
            var data = JSON.parse(resultJson);
            var accounts = data.items || data.results || [];
            if (Array.isArray(data)) accounts = data;
            var hasConnection = accounts.length > 0;
            for (var i = 0; i < composioToolkits.length; i++) {
                if (composioToolkits[i].slug === slug) {
                    composioToolkits[i].auth_warning = !hasConnection;
                    break;
                }
            }
            renderComposioToolkits();
        } catch(e) {}
    }

    function showConnectionModal(slug) {
        var existing = document.getElementById("conn-modal-overlay");
        if (existing) existing.remove();

        var tk = null;
        for (var i = 0; i < composioToolkits.length; i++) {
            if (composioToolkits[i].slug === slug) { tk = composioToolkits[i]; break; }
        }
        var name = tk ? (tk.meta_name || tk.name || slug) : slug;

        var overlay = document.createElement("div");
        overlay.id = "conn-modal-overlay";
        overlay.className = "conn-modal-overlay visible";
        overlay.innerHTML = '<div class="conn-modal">' +
            '<h3>Connect ' + escapeHtml(name) + '</h3>' +
            '<p>Link your ' + escapeHtml(name) + ' account so the agent can use its tools on your behalf.</p>' +
            '<label for="conn-api-key">API Key / Access Token</label>' +
            '<input type="password" id="conn-api-key" placeholder="Paste your API key or token here" />' +
            '<div class="conn-modal-actions" style="margin-bottom:0.75rem;">' +
                '<button class="btn-connect" id="conn-btn-save-key">Connect with API Key</button>' +
            '</div>' +
            '<div class="conn-or">‚Äî or ‚Äî</div>' +
            '<button class="btn-oauth" id="conn-btn-oauth">üîó Connect via OAuth (opens browser)</button>' +
            '<div class="conn-modal-actions" style="margin-top:1rem;">' +
                '<button class="btn-cancel" id="conn-btn-cancel">Cancel</button>' +
            '</div>' +
        '</div>';

        document.body.appendChild(overlay);

        overlay.addEventListener("click", function(e) { if (e.target === overlay) overlay.remove(); });
        document.getElementById("conn-btn-cancel").addEventListener("click", function() { overlay.remove(); });

        document.getElementById("conn-btn-save-key").addEventListener("click", async function() {
            var apiKeyInput = document.getElementById("conn-api-key");
            var key = apiKeyInput ? apiKeyInput.value.trim() : "";
            if (!key) { showToast("Please enter an API key or token", "error"); return; }

            var composioKey = currentConfig.composioApiKey;
            if (!composioKey) { showToast("Set your Composio API key first", "error"); return; }

            showToast("Connecting " + slug + "...", "info");

            try {
                var intEndpoint = COMPOSIO_API_URL + "/integrations?appName=" + encodeURIComponent(slug);
                var intJson = "";
                if (window.__TAURI__) {
                    intJson = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-H", "x-api-key: " + composioKey, intEndpoint] });
                } else {
                    var intResp = await fetch(intEndpoint, { headers: { "x-api-key": composioKey } });
                    intJson = await intResp.text();
                }
                var intData = JSON.parse(intJson);
                var integrations = intData.items || intData || [];
                if (!integrations.length) {
                    showToast("No integration found for " + slug + ". Set it up at app.composio.dev first.", "error");
                    return;
                }
                var integrationId = integrations[0].id;

                var connEndpoint = COMPOSIO_API_URL + "/connectedAccounts";
                var connBody = JSON.stringify({
                    integrationId: integrationId,
                    entityId: "default",
                    data: { api_key: key, token: key, access_token: key }
                });
                var connJson = "";
                if (window.__TAURI__) {
                    connJson = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-X", "POST", "-H", "x-api-key: " + composioKey, "-H", "Content-Type: application/json", "-d", connBody, connEndpoint] });
                } else {
                    var connResp = await fetch(connEndpoint, { method: "POST", headers: { "x-api-key": composioKey, "Content-Type": "application/json" }, body: connBody });
                    connJson = await connResp.text();
                }
                var connData = JSON.parse(connJson);
                if (connData.connectionStatus === "ACTIVE" || connData.status === "ACTIVE" || connData.id) {
                    showToast(slug + " connected successfully!", "success");
                    for (var i = 0; i < composioToolkits.length; i++) {
                        if (composioToolkits[i].slug === slug) { composioToolkits[i].auth_warning = false; break; }
                    }
                    renderComposioToolkits();
                    renderEnabledIntegrations();
                    overlay.remove();
                } else if (connData.redirectUrl) {
                    showToast("This service requires OAuth. Opening authorization page...", "info");
                    if (window.__TAURI__ && window.__TAURI__.shell && window.__TAURI__.shell.open) {
                        window.__TAURI__.shell.open(connData.redirectUrl);
                    } else {
                        window.open(connData.redirectUrl, "_blank");
                    }
                    setTimeout(function() { checkComposioConnection(slug); }, 15000);
                    overlay.remove();
                } else {
                    showToast("Connection attempt returned unexpected response.", "error");
                }
            } catch(e) {
                showToast("Connection error: " + (e.message || e), "error");
            }
        });

        document.getElementById("conn-btn-oauth").addEventListener("click", function() {
            overlay.remove();
            performComposioOAuth(slug);
        });
    }

    async function performComposioOAuth(slug) {
        var composioKey = currentConfig.composioApiKey;
        if (!composioKey) {
            showToast("Set your Composio API key first", "error");
            return;
        }
        showToast("Connecting " + slug + "...", "info");
        try {
            var intEndpoint = COMPOSIO_API_URL + "/integrations?appName=" + encodeURIComponent(slug);
            var intJson = "";
            if (window.__TAURI__) {
                intJson = await tauriInvoke("run_shell_command", {
                    commandName: "curl",
                    args: ["-s", "-H", "x-api-key: " + composioKey, intEndpoint]
                });
            } else {
                var intResp = await fetch(intEndpoint, { headers: { "x-api-key": composioKey } });
                intJson = await intResp.text();
            }
            var intData = JSON.parse(intJson);
            var integrations = intData.items || intData || [];
            if (!integrations.length) {
                showToast("No integration found for " + slug + ". Set it up at app.composio.dev first.", "error");
                var fallbackUrl = "https://app.composio.dev/apps/" + slug;
                if (window.__TAURI__ && window.__TAURI__.shell && window.__TAURI__.shell.open) {
                    window.__TAURI__.shell.open(fallbackUrl);
                } else {
                    window.open(fallbackUrl, "_blank");
                }
                return;
            }
            var integrationId = integrations[0].id;

            var connEndpoint = COMPOSIO_API_URL + "/connectedAccounts";
            var connBody = JSON.stringify({ integrationId: integrationId, entityId: "default" });
            var connJson = "";
            if (window.__TAURI__) {
                connJson = await tauriInvoke("run_shell_command", {
                    commandName: "curl",
                    args: ["-s", "-X", "POST", "-H", "x-api-key: " + composioKey, "-H", "Content-Type: application/json", "-d", connBody, connEndpoint]
                });
            } else {
                var connResp = await fetch(connEndpoint, {
                    method: "POST",
                    headers: { "x-api-key": composioKey, "Content-Type": "application/json" },
                    body: connBody
                });
                connJson = await connResp.text();
            }
            var connData = JSON.parse(connJson);
            if (connData.redirectUrl) {
                showToast("Opening authorization page for " + slug + "...", "success");
                if (window.__TAURI__ && window.__TAURI__.shell && window.__TAURI__.shell.open) {
                    window.__TAURI__.shell.open(connData.redirectUrl);
                } else {
                    window.open(connData.redirectUrl, "_blank");
                }
                setTimeout(function() { checkComposioConnection(slug); }, 15000);
                setTimeout(function() { checkComposioConnection(slug); }, 30000);
            } else if (connData.connectionStatus === "ACTIVE") {
                showToast(slug + " already connected!", "success");
                for (var i = 0; i < composioToolkits.length; i++) {
                    if (composioToolkits[i].slug === slug) { composioToolkits[i].auth_warning = false; break; }
                }
                renderComposioToolkits();
            } else {
                showToast("Could not initiate connection.", "error");
                var fallbackUrl2 = "https://app.composio.dev/apps/" + slug;
                if (window.__TAURI__ && window.__TAURI__.shell && window.__TAURI__.shell.open) {
                    window.__TAURI__.shell.open(fallbackUrl2);
                } else {
                    window.open(fallbackUrl2, "_blank");
                }
            }
        } catch(e) {
            showToast("Connection error: " + (e.message || e), "error");
        }
    }

    async function fetchToolkitTriggers(slug) {
        var composioKey = currentConfig.composioApiKey;
        if (!composioKey) return;
        try {
            var endpoint = COMPOSIO_API_URL + "/triggers?toolkit=" + encodeURIComponent(slug) + "&limit=50";
            var resultJson = "";
            if (window.__TAURI__) {
                resultJson = await tauriInvoke("run_shell_command", {
                    commandName: "curl",
                    args: ["-s", "-H", "x-api-key: " + composioKey, endpoint]
                });
            } else {
                var resp = await fetch(endpoint, { headers: { "x-api-key": composioKey } });
                resultJson = await resp.text();
            }
            var data = JSON.parse(resultJson);
            var triggers = data.items || [];
            composioToolkitDetails[slug + "_triggers"] = triggers;
            renderToolkitTriggers(slug);
        } catch(e) {}
    }

    function renderToolkitTriggers(slug) {
        var el = document.getElementById("toolkit-triggers-" + slug);
        if (!el) return;
        var triggers = composioToolkitDetails[slug + "_triggers"];
        if (!triggers || triggers.length === 0) {
            el.innerHTML = "";
            return;
        }
        var html = '<div style="font-size:0.7rem;font-weight:600;color:var(--warning);margin-top:0.75rem;margin-bottom:0.3rem;">‚ö° Triggers (' + triggers.length + '):</div>';
        triggers.forEach(function(tr) {
            html += '<div class="trigger-entry">';
            html += '<div class="trigger-name">' + escapeHtml(tr.name || tr.slug || "Unknown") + '</div>';
            if (tr.description) html += '<div class="trigger-desc">' + escapeHtml(tr.description.substring(0, 150)) + (tr.description.length > 150 ? "‚Ä¶" : "") + '</div>';
            html += '</div>';
        });
        html += '<div class="trigger-info-banner">‚ö° Triggers require a local webhook endpoint. This feature is coming in a future update.</div>';
        el.innerHTML = html;
    }

    var builtinSkills = [
        { id: "web_browser", icon: "üåê", name: "Web Browser", desc: "Navigate and scrape websites via Playwright" },
        { id: "web_search", icon: "üîç", name: "Web Search", desc: "Search Google, DuckDuckGo, or Bing" },
        { id: "docker", icon: "üê≥", name: "Docker", desc: "Manage containers, images, and volumes" },
        { id: "ssh_remote", icon: "üîë", name: "SSH Remote", desc: "Execute commands on remote servers" },
        { id: "mqtt_bridge", icon: "üì°", name: "MQTT Bridge", desc: "Publish/subscribe to MQTT topics" },
        { id: "serial_port", icon: "üîå", name: "Serial Port", desc: "Read/write to serial devices (Arduino, ESP32)" },
        { id: "b500_telemetry", icon: "üéã", name: "B500 Telemetry", desc: "Monitor BambooCore B500 facility sensors" }
    ];

    function renderBuiltinSkills() {
        var el = document.getElementById("skills-builtin");
        if (!el) return;
        var html = "";
        builtinSkills.forEach(function(s) {
            html += '<div class="skill-card enabled" data-skill-id="' + s.id + '" data-skill-type="builtin">';
            html += '<span class="skill-always-on">Always On</span>';
            html += '<div class="skill-icon">' + s.icon + '</div>';
            html += '<div class="skill-name">' + escapeHtml(s.name) + '</div>';
            html += '<div class="skill-meta">';
            html += '<span style="font-size:0.65rem;color:var(--text-dim);">‚óè Built-in</span>';
            html += '<button class="skill-info-btn" title="Show details">i</button>';
            html += '</div>';
            html += '<div class="skill-desc-full">' + escapeHtml(s.desc) + '</div>';
            html += '</div>';
        });
        el.innerHTML = html;
    }

    function renderComposioToolkits() {
        var el = document.getElementById("skills-composio");
        if (!el) return;
        var search = (document.getElementById("skill-search") ? document.getElementById("skill-search").value : "").toLowerCase();
        var html = "";
        var filtered = composioToolkits.filter(function(tk) {
            if (search && tk.name.toLowerCase().indexOf(search) < 0 && (tk.description || "").toLowerCase().indexOf(search) < 0 && tk.slug.toLowerCase().indexOf(search) < 0) return false;
            if (composioActiveCategory !== "All") {
                var cats = tk.categories || [];
                if (cats.indexOf(composioActiveCategory) < 0) return false;
            }
            return true;
        });
        filtered.forEach(function(tk) {
            var isEnabled = enabledSkills["composio_" + tk.slug] || false;
            var toolCount = tk.tools_count || 0;
            var triggerCount = tk.triggers_count || 0;
            var desc = tk.description || "";
            var descDisplay = desc || "No description available";
            html += '<div class="skill-card ' + (isEnabled ? 'enabled' : '') + '" data-skill-id="composio_' + tk.slug + '" data-skill-type="composio" data-toolkit-slug="' + tk.slug + '">';
            html += '<button class="skill-toggle" title="' + (isEnabled ? 'Disable' : 'Enable') + '"></button>';
            var imgSrc = "";
            if (tk.local_logo && window.__TAURI__) {
                var convertFn = (window.__TAURI__.core && window.__TAURI__.core.convertFileSrc)
                    || (window.__TAURI__.tauri && window.__TAURI__.tauri.convertFileSrc)
                    || window.__TAURI__.convertFileSrc;
                if (convertFn) { try { imgSrc = convertFn(tk.local_logo); } catch(ce) { imgSrc = ""; } }
            }
            if (!imgSrc && tk.logo) imgSrc = tk.logo;
            if (imgSrc) {
                html += '<div class="skill-icon"><img src="' + escapeHtml(imgSrc) + '" data-slug="' + escapeHtml(tk.slug) + '" onerror="this.outerHTML=\'<span class=skill-icon>üß©</span>\'" /></div>';
            } else {
                html += '<div class="skill-icon">üß©</div>';
            }
            html += '<div class="skill-name">' + escapeHtml(tk.name) + '</div>';
            html += '<div class="skill-meta">';
            if (toolCount > 0) {
                html += '<span style="font-size:0.65rem;color:var(--accent);">‚óè ' + toolCount + ' tools</span>';
            }
            if (triggerCount > 0) {
                html += '<span style="font-size:0.65rem;color:var(--warning);">‚ö° ' + triggerCount + ' triggers</span>';
            }
            html += '<button class="skill-info-btn" title="Show details">i</button>';
            html += '</div>';
            if (tk.auth_warning) {
                html += '<div class="auth-warning-badge">‚ö† Not connected ‚Äî <span style="cursor:pointer;text-decoration:underline;" data-connect-slug="' + escapeHtml(tk.slug) + '">link account</span></div>';
            }
            html += '<div class="skill-desc-full" data-toolkit-slug="' + tk.slug + '">';
            html += '<div>' + escapeHtml(descDisplay) + '</div>';
            html += '<div class="toolkit-tools-list" id="toolkit-tools-' + tk.slug + '"><div style="color:var(--text-dim);font-size:0.65rem;padding:0.3rem 0;">Click to load tools...</div></div>';
            html += '<div id="toolkit-triggers-' + tk.slug + '"></div>';
            html += '</div>';
            html += '</div>';
        });
        if (!html) html = '<div style="color:var(--text-dim);font-size:0.85rem;padding:0.5rem;">No matching toolkits</div>';
        el.innerHTML = html;
        el.querySelectorAll("span[data-connect-slug]").forEach(function(span) {
            span.addEventListener("click", function(e) {
                e.stopPropagation();
                showConnectionModal(span.dataset.connectSlug);
            });
        });
    }

    function renderComposioCategories() {
        var el = document.getElementById("composio-category-tabs");
        if (!el) return;
        var html = "";
        composioCategories.forEach(function(cat) {
            var active = cat === composioActiveCategory;
            html += '<button class="btn btn-sm ' + (active ? '' : 'btn-outline') + '" style="font-size:0.75rem;" data-composio-cat="' + escapeHtml(cat) + '">' + escapeHtml(cat) + '</button>';
        });
        el.innerHTML = html;
    }

    function renderAllSkills() {
        renderBuiltinSkills();
        renderComposioToolkits();
        renderComposioCategories();
        renderEnabledIntegrations();
    }

    function renderEnabledIntegrations() {
        var section = document.getElementById("enabled-integrations-section");
        var grid = document.getElementById("skills-enabled-integrations");
        if (!section || !grid) return;
        var html = "";
        var count = 0;
        Object.keys(enabledSkills).forEach(function(k) {
            if (!enabledSkills[k] || !k.startsWith("composio_")) return;
            count++;
            var slug = k.replace("composio_", "");
            var tk = null;
            for (var i = 0; i < composioToolkits.length; i++) {
                if (composioToolkits[i].slug === slug) { tk = composioToolkits[i]; break; }
            }
            var name = tk ? (tk.meta_name || tk.name || slug) : slug;
            var imgSrc = "";
            if (tk && tk.local_logo && window.__TAURI__) {
                var convertFn = (window.__TAURI__.core && window.__TAURI__.core.convertFileSrc)
                    || (window.__TAURI__.tauri && window.__TAURI__.tauri.convertFileSrc)
                    || window.__TAURI__.convertFileSrc;
                if (convertFn) { try { imgSrc = convertFn(tk.local_logo); } catch(ce) { imgSrc = ""; } }
            }
            if (!imgSrc && tk && tk.logo) imgSrc = tk.logo;
            var logoHtml = "";
            if (imgSrc) {
                logoHtml = '<div class="skill-icon"><img src="' + escapeHtml(imgSrc) + '" onerror="this.outerHTML=\'<span class=skill-icon>üß©</span>\'" /></div>';
            } else {
                logoHtml = '<div class="skill-icon">üß©</div>';
            }
            var toolCount = 0;
            agentTools.forEach(function(t) { if (t.function.name.indexOf(slug) > -1) toolCount++; });
            var countLabel = toolCount > 0 ? '<span style="font-size:0.7rem;color:var(--text-dim);">' + toolCount + ' tools</span>' : '';
            html += '<div class="skill-card" style="cursor:pointer;" onclick="window.toggleSkill(\'' + k + '\')">';
            html += '<div style="display:flex;align-items:center;gap:0.5rem;">';
            html += logoHtml;
            html += '<div style="flex:1;"><div style="font-size:0.85rem;font-weight:600;">' + escapeHtml(name) + '</div>' + countLabel + '</div>';
            html += '<span style="color:#ef4444;font-size:0.7rem;cursor:pointer;" title="Click to disable">‚úï</span>';
            html += '</div>';
            if (tk && tk.auth_warning) {
                html += '<div class="auth-warning-badge">‚ö† Not connected ‚Äî <span style="cursor:pointer;text-decoration:underline;" data-connect-slug="' + escapeHtml(slug) + '">link account</span></div>';
            }
            html += '</div>';
        });
        if (count > 0) {
            section.style.display = "";
            grid.innerHTML = html;
            grid.querySelectorAll("span[data-connect-slug]").forEach(function(span) {
                span.addEventListener("click", function(e) {
                    e.stopPropagation();
                    showConnectionModal(span.dataset.connectSlug);
                });
            });
        } else {
            section.style.display = "none";
            grid.innerHTML = "";
        }
    }

    var logosDir = "";

    async function ensureLogosDir() {
        if (logosDir) return logosDir;
        if (!window.__TAURI__) return "";
        try {
            var home = await tauriInvoke("get_home_dir", {});
            if (!home) return "";
            var sep = (detectedOS === "windows") ? "\\" : "/";
            logosDir = home.replace(/[\\/]+$/, "") + sep + "bambooclaw" + sep + "logos";
            await tauriInvoke("run_shell_command", {
                commandName: (detectedOS === "windows") ? "cmd" : "sh",
                args: (detectedOS === "windows") ? ["/c", "mkdir", logosDir, "2>nul"] : ["-c", "mkdir -p \"" + logosDir + "\""]
            }).catch(function() {});
            return logosDir;
        } catch(e) {
            return "";
        }
    }

    async function cacheToolkitLogos() {
        var dir = await ensureLogosDir();
        if (!dir) return;
        var sep = (detectedOS === "windows") ? "\\" : "/";
        var toDownload = [];
        for (var i = 0; i < composioToolkits.length; i++) {
            var tk = composioToolkits[i];
            if (!tk.logo) continue;
            var ext = tk.logo.indexOf(".svg") > -1 ? ".svg" : ".png";
            var localPath = dir + sep + tk.slug + ext;
            tk.local_logo_path = localPath;
            toDownload.push({ idx: i, slug: tk.slug, url: tk.logo, path: localPath });
        }
        var batchSize = 15;
        for (var b = 0; b < toDownload.length; b += batchSize) {
            var batch = toDownload.slice(b, b + batchSize);
            var promises = batch.map(function(item) {
                return invokeShort("run_shell_command", {
                    commandName: (detectedOS === "windows") ? "cmd" : "sh",
                    args: (detectedOS === "windows") ? ["/c", "if", "exist", item.path, "(echo", "EXISTS)", "else", "(echo", "MISSING)"] : ["-c", "test -f \"" + item.path + "\" && echo EXISTS || echo MISSING"]
                }).then(function(result) {
                    if (result && result.indexOf("EXISTS") > -1) {
                        composioToolkits[item.idx].local_logo = item.path;
                        return;
                    }
                    return invokeShort("run_shell_command", {
                        commandName: "curl",
                        args: ["-sL", "-o", item.path, item.url]
                    }).then(function() {
                        composioToolkits[item.idx].local_logo = item.path;
                    }).catch(function(e) {});
                }).catch(function(e) {});
            });
            await Promise.allSettled(promises);
        }
        renderComposioToolkits();
    }

    async function testImageConnectivity() {
        if (!window.__TAURI__) return;
        var img = new Image();
        img.src = "https://assets.composio.dev/logos/slack.png";
    }

    function toggleSkill(skillId) {
        enabledSkills[skillId] = !enabledSkills[skillId];
        currentConfig.enabledSkills = enabledSkills;
        saveAllConfig();
        renderAllSkills();

        if (enabledSkills[skillId]) {
            if (skillId.startsWith("composio_")) {
                var slug = skillId.replace("composio_", "");
                fetchToolkitTools(slug);
            } else {
                rebuildBuiltinTools();
            }
            var name = skillId.startsWith("composio_") ? skillId.replace("composio_", "") : skillId;
            showToast(name + " enabled", "success");
        } else {
            agentTools = agentTools.filter(function(t) {
                return !t.function.name.startsWith("composio_");
            });
            Object.keys(enabledSkills).forEach(function(sk) {
                if (!enabledSkills[sk] || !sk.startsWith("composio_")) return;
                var skSlug = sk.replace("composio_", "");
                var cached = composioToolkitDetails[skSlug];
                if (cached) {
                    cached.forEach(function(tool) {
                        var rawP = tool.input_parameters || tool.parameters || { type: "object", properties: {}, required: [] };
                        var params = sanitizeToolSchema(rawP);
                        var realSlug = tool.slug || tool.name || "";
                        var safeName = ("composio_" + realSlug.replace(/[^a-zA-Z0-9_-]/g, "_")).substring(0, 64);
                        window.composioToolMap = window.composioToolMap || {};
                        window.composioToolMap[safeName] = realSlug;
                        agentTools.push({
                            type: "function",
                            function: {
                                name: safeName,
                                description: (tool.description || tool.name || skSlug + " tool").substring(0, 1024),
                                parameters: params
                            }
                        });
                    });
                }
            });
            rebuildBuiltinTools();
            var name = skillId.startsWith("composio_") ? skillId.replace("composio_", "") : skillId;
            showToast(name + " disabled", "info");
        }
        renderActiveToolsSummary();
        renderEnabledIntegrations();
    }
    window.toggleSkill = toggleSkill;

    var composioToolkitDetails = {};

    async function fetchToolkitTools(slug) {
        var composioKey = currentConfig.composioApiKey;
        if (!composioKey) return;
        try {
            var toolsJson = "";
            var endpoint = COMPOSIO_API_URL + "/tools?toolkit=" + encodeURIComponent(slug) + "&limit=200";
            if (window.__TAURI__) {
                toolsJson = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-H", "x-api-key: " + composioKey, endpoint] });
            } else {
                var resp = await fetch(endpoint, { headers: { "x-api-key": composioKey } });
                toolsJson = await resp.text();
            }

            var data = JSON.parse(toolsJson);
            var tools = data.items || [];
            composioToolkitDetails[slug] = tools;

            agentTools = agentTools.filter(function(t) { return !t.function.name.startsWith("composio_"); });

            Object.keys(enabledSkills).forEach(function(skillId) {
                if (!enabledSkills[skillId] || !skillId.startsWith("composio_")) return;
                var sk = skillId.replace("composio_", "");
                var cachedTools = composioToolkitDetails[sk];
                if (cachedTools) {
                    cachedTools.forEach(function(tool) {
                        var rawParams = tool.input_parameters || tool.parameters || { type: "object", properties: {}, required: [] };
                        var params = sanitizeToolSchema(rawParams);
                        var realSlug = tool.slug || tool.name || "";
                        var safeName = ("composio_" + realSlug.replace(/[^a-zA-Z0-9_-]/g, "_")).substring(0, 64);
                        window.composioToolMap = window.composioToolMap || {};
                        window.composioToolMap[safeName] = realSlug;
                        agentTools.push({
                            type: "function",
                            function: { name: safeName, description: (tool.description || tool.name || sk + " tool").substring(0, 1024) + " [via Composio " + sk + "]", parameters: params }
                        });
                    });
                }
            });

            showToast(slug + ": " + tools.length + " tools added to agent", "success");
            renderActiveToolsSummary();
            renderEnabledIntegrations();
            checkComposioConnection(slug);
            fetchToolkitTriggers(slug);
            renderToolkitToolsList(slug);
        } catch(e) {
            agentTools.push({
                type: "function",
                function: {
                    name: "composio_" + slug,
                    description: "Use " + slug + " via Composio. Describe the action you want to perform.",
                    parameters: { type: "object", properties: { action: { type: "string", description: "What to do (natural language)" } }, required: ["action"], additionalProperties: false }
                }
            });
        }
    }

    function renderToolkitToolsList(slug) {
        var el = document.getElementById("toolkit-tools-" + slug);
        if (!el) return;
        var tools = composioToolkitDetails[slug];
        if (!tools || tools.length === 0) {
            el.innerHTML = '<div style="color:var(--text-dim);font-size:0.65rem;padding:0.3rem 0;">No tools found for this toolkit.</div>';
            return;
        }
        var html = '<div style="font-size:0.7rem;font-weight:600;color:var(--text);margin-bottom:0.3rem;">Tools (' + tools.length + '):</div>';
        tools.forEach(function(tool, idx) {
            var toolSlug = tool.slug || "";
            var toolName = tool.name || toolSlug;
            var toolDesc = tool.description || "";
            var params = tool.input_parameters || tool.parameters || {};
            var props = params.properties || {};
            var reqList = params.required || [];
            var outParams = tool.output_parameters || {};
            var outProps = outParams.properties || {};

            html += '<div class="toolkit-tool-row" data-tool-idx="' + idx + '" data-toolkit-slug="' + slug + '">';
            html += '<div class="tool-header"><span class="tool-name">‚ñ∏ ' + escapeHtml(toolName) + '</span></div>';
            html += '<div class="tool-slug">' + escapeHtml(toolSlug) + '</div>';
            if (toolDesc) html += '<div class="tool-desc">' + escapeHtml(toolDesc.substring(0, 120)) + (toolDesc.length > 120 ? "‚Ä¶" : "") + '</div>';

            html += '<div class="toolkit-tool-params" id="tool-params-' + slug + '-' + idx + '">';
            var propKeys = Object.keys(props);
            if (propKeys.length > 0) {
                html += '<div style="color:var(--accent);margin-bottom:0.2rem;">Input Parameters:</div>';
                propKeys.forEach(function(pName) {
                    var p = props[pName];
                    var isReq = reqList.indexOf(pName) >= 0;
                    html += '<div class="param-row"><span class="param-name">' + escapeHtml(pName) + '</span><span class="param-type">' + escapeHtml(p.type || "any") + '</span>';
                    if (isReq) html += '<span class="param-req">required</span>';
                    html += '</div>';
                    if (p.description) html += '<div style="color:var(--text-dim);font-size:0.55rem;padding-left:0.5rem;margin-bottom:0.15rem;">' + escapeHtml(p.description.substring(0, 100)) + '</div>';
                });
            }
            var outKeys = Object.keys(outProps);
            if (outKeys.length > 0) {
                html += '<div style="color:var(--warning);margin-top:0.3rem;margin-bottom:0.2rem;">Output Parameters:</div>';
                outKeys.forEach(function(pName) {
                    html += '<div class="param-row"><span class="param-name">' + escapeHtml(pName) + '</span><span class="param-type">' + escapeHtml(outProps[pName].type || "any") + '</span></div>';
                });
            }
            if (propKeys.length === 0 && outKeys.length === 0) {
                html += '<div style="color:var(--text-dim);">No parameters defined</div>';
            }
            html += '</div></div>';
        });
        el.innerHTML = html;
    }

    async function loadToolkitToolsOnDemand(slug) {
        if (composioToolkitDetails[slug]) {
            renderToolkitToolsList(slug);
            return;
        }
        var el = document.getElementById("toolkit-tools-" + slug);
        if (el) el.innerHTML = '<div style="color:var(--text-dim);font-size:0.65rem;padding:0.3rem 0;">Loading tools...</div>';
        var composioKey = currentConfig.composioApiKey;
        if (!composioKey) return;
        try {
            var toolsJson = "";
            var endpoint = COMPOSIO_API_URL + "/tools?toolkit=" + encodeURIComponent(slug) + "&limit=200";
            if (window.__TAURI__) {
                toolsJson = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-H", "x-api-key: " + composioKey, endpoint] });
            } else {
                var resp = await fetch(endpoint, { headers: { "x-api-key": composioKey } });
                toolsJson = await resp.text();
            }
            var data = JSON.parse(toolsJson);
            composioToolkitDetails[slug] = data.items || [];
            renderToolkitToolsList(slug);
            if (!composioToolkitDetails[slug + "_triggers"]) fetchToolkitTriggers(slug);
            else renderToolkitTriggers(slug);
        } catch(e) {
            if (el) el.innerHTML = '<div style="color:var(--error);font-size:0.65rem;">Failed to load tools</div>';
        }
    }

    function rebuildBuiltinTools() {
        agentTools = agentTools.filter(function(t) {
            return !["web_browse","web_search","docker_command","ssh_execute","mqtt_publish"].includes(t.function.name);
        });
        builtinSkills.forEach(function(s) {
            if (!enabledSkills[s.id]) return;
            if (s.id === "web_browser") agentTools.push({ type: "function", function: { name: "web_browse", description: "Open URL in headless browser", parameters: { type: "object", properties: { url: { type: "string" } }, required: ["url"], additionalProperties: false } }});
            else if (s.id === "web_search") agentTools.push({ type: "function", function: { name: "web_search", description: "Search the web", parameters: { type: "object", properties: { query: { type: "string" }, engine: { type: "string" } }, required: ["query"], additionalProperties: false } }});
            else if (s.id === "docker") agentTools.push({ type: "function", function: { name: "docker_command", description: "Docker commands", parameters: { type: "object", properties: { args: { type: "array", items: { type: "string" } } }, required: ["args"], additionalProperties: false } }});
            else if (s.id === "ssh_remote") agentTools.push({ type: "function", function: { name: "ssh_execute", description: "SSH commands", parameters: { type: "object", properties: { host: { type: "string" }, user: { type: "string" }, command: { type: "string" }, port: { type: "number" } }, required: ["host", "user", "command"], additionalProperties: false } }});
            else if (s.id === "mqtt_bridge") agentTools.push({ type: "function", function: { name: "mqtt_publish", description: "MQTT publish", parameters: { type: "object", properties: { broker: { type: "string" }, topic: { type: "string" }, message: { type: "string" } }, required: ["broker", "topic", "message"], additionalProperties: false } }});
        });
        renderActiveToolsSummary();
        renderEnabledIntegrations();
    }

    async function saveComposioKey() {
        var key = document.getElementById("composio-api-key").value.trim();
        if (!key) { showToast("Please enter a Composio API key", "error"); return; }
        currentConfig.composioApiKey = key;
        saveAllConfig();

        var statusEl = document.getElementById("composio-status");
        statusEl.style.display = "block";
        statusEl.innerHTML = '<span style="color:var(--text-dim);">‚ü≥ Validating key and fetching toolkits...</span>';

        var validated = false;
        var toolkitsData = null;

        if (window.__TAURI__) {
            try {
                var curlResult = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-H", "x-api-key: " + key, COMPOSIO_API_URL + "/toolkits?limit=500"] });
                try {
                    toolkitsData = JSON.parse(curlResult);
                    if (toolkitsData.items) validated = true;
                    else if (toolkitsData.error || toolkitsData.status === 401) {
                        statusEl.innerHTML = '<span style="color:var(--error);">‚úó Invalid API key</span>';
                        return;
                    }
                } catch(parseErr) {
                    if ((curlResult || "").indexOf("401") >= 0) {
                        statusEl.innerHTML = '<span style="color:var(--error);">‚úó Invalid API key</span>';
                        return;
                    }
                }
            } catch(e) {}
        }

        if (!validated) {
            try {
                var resp = await fetch(COMPOSIO_API_URL + "/toolkits?limit=500", { headers: { "x-api-key": key } });
                if (resp.ok) {
                    toolkitsData = await resp.json();
                    if (toolkitsData.items) validated = true;
                } else if (resp.status === 401 || resp.status === 403) {
                    statusEl.innerHTML = '<span style="color:var(--error);">‚úó Invalid API key</span>';
                    return;
                }
            } catch(e) {}
        }

        if (!validated || !toolkitsData) {
            statusEl.innerHTML = '<span style="color:var(--warning);">‚ö† Cannot validate from browser (CORS). Key saved for desktop use.</span>';
            return;
        }

        var rawToolkits = toolkitsData.items || [];
        composioToolkits = rawToolkits.map(function(tk) {
            var m = tk.meta || {};
            return {
                slug: tk.slug,
                name: tk.name || tk.slug,
                description: m.description || tk.description || "",
                logo: m.logo || tk.logo || "",
                categories: (m.categories || tk.categories || []).map(function(c) { return (typeof c === "object" && c.name) ? c.name : String(c); }),
                tools_count: m.tools_count || tk.tools_count || 0,
                triggers_count: m.triggers_count || tk.triggers_count || 0
            };
        });
        
        statusEl.innerHTML = '<span style="color:var(--accent);">‚úì Connected to Composio</span>';
        
        var catSet = {};
        composioToolkits.forEach(function(tk) { (tk.categories || []).forEach(function(c) { catSet[c] = true; }); });
        composioCategories = ["All"].concat(Object.keys(catSet).sort());

        document.getElementById("composio-placeholder").classList.add("hidden");
        document.getElementById("composio-connected-area").classList.remove("hidden");
        renderAllSkills();
        cacheToolkitLogos();
    }

    document.getElementById("skills-builtin").addEventListener("click", function(e) {
        var infoBtn = e.target.closest ? e.target.closest(".skill-info-btn") : null;
        if (!infoBtn && e.target.classList && e.target.classList.contains("skill-info-btn")) infoBtn = e.target;
        if (infoBtn) {
            e.stopPropagation();
            var card = infoBtn.closest ? infoBtn.closest(".skill-card") : infoBtn.parentElement.parentElement;
            if (card) {
                var descEl = card.querySelector(".skill-desc-full");
                if (descEl) descEl.classList.toggle("visible");
            }
        }
    });

    document.getElementById("skills-composio").addEventListener("click", function(e) {
        var toolRow = e.target.closest ? e.target.closest(".toolkit-tool-row") : null;
        if (toolRow) {
            e.stopPropagation();
            var idx = toolRow.getAttribute("data-tool-idx");
            var tkSlug = toolRow.getAttribute("data-toolkit-slug");
            var paramsEl = document.getElementById("tool-params-" + tkSlug + "-" + idx);
            if (paramsEl) paramsEl.classList.toggle("visible");
            return;
        }

        var infoBtn = e.target.closest ? e.target.closest(".skill-info-btn") : null;
        if (!infoBtn && e.target.classList && e.target.classList.contains("skill-info-btn")) infoBtn = e.target;
        if (infoBtn) {
            e.stopPropagation();
            var card = infoBtn.closest ? infoBtn.closest(".skill-card") : infoBtn.parentElement.parentElement;
            if (card) {
                var descEl = card.querySelector(".skill-desc-full");
                if (descEl) {
                    var wasVisible = descEl.classList.contains("visible");
                    descEl.classList.toggle("visible");
                    if (!wasVisible) {
                        var tkSlug2 = descEl.getAttribute("data-toolkit-slug");
                        if (tkSlug2) loadToolkitToolsOnDemand(tkSlug2);
                    }
                }
            }
            return;
        }

        var card2 = e.target.closest ? e.target.closest(".skill-card") : null;
        if (!card2) {
            var el = e.target;
            while (el && el !== this) {
                if (el.classList && el.classList.contains("skill-card")) { card2 = el; break; }
                el = el.parentElement;
            }
        }
        if (card2) {
            var skillId = card2.getAttribute("data-skill-id");
            if (skillId) toggleSkill(skillId);
        }
    });

    document.getElementById("composio-category-tabs").addEventListener("click", function(e) {
        var btn = e.target.closest ? e.target.closest("[data-composio-cat]") : null;
        if (!btn) {
            var el = e.target;
            while (el && el !== this) {
                if (el.getAttribute && el.getAttribute("data-composio-cat")) { btn = el; break; }
                el = el.parentElement;
            }
        }
        if (btn) {
            composioActiveCategory = btn.getAttribute("data-composio-cat");
            renderAllSkills();
        }
    });

    // Replace inline onclick bindings with addEventListener
    document.getElementById("btn-copy-boot-log").addEventListener("click", function() { copyLog('boot-log'); });
    document.getElementById("btn-copy-install-log").addEventListener("click", function() { copyLog('install-log'); });
    document.getElementById("btn-copy-cap-log").addEventListener("click", function() { copyLog('capability-log'); });
    document.getElementById("btn-copy-log").addEventListener("click", function() { copyLog('unified-log'); });
    document.getElementById("btn-copy-payload").addEventListener("click", function() { copyLog('llm-payload-display'); });
    document.getElementById("btn-back-step1").addEventListener("click", function() { wizardGo(0); });
    document.getElementById("btn-back-step2").addEventListener("click", function() { wizardGo(1); });
    document.getElementById("btn-step0-next").addEventListener("click", function() { wizardGo(1); });
    document.getElementById("btn-step1-next").addEventListener("click", function() { wizardGo(2); });
    document.getElementById("btn-enter-dashboard").addEventListener("click", function() { window.enterDashboard(); });

    var toggleBtn = document.getElementById("btn-toggle-tools-list");
    if (toggleBtn) toggleBtn.addEventListener("click", function() { window.toggleActiveToolsList(); });

    var openComp = document.getElementById("btn-open-composio");
    if (openComp) {
        openComp.addEventListener("click", function() {
            if (window.__TAURI__) {
                try {
                    var opener = (window.__TAURI__.opener && window.__TAURI__.opener.openUrl) || (window.__TAURI__.shell && window.__TAURI__.shell.open);
                    if (opener) opener("https://app.composio.dev/settings");
                } catch(e) {}
            } else {
                window.open("https://app.composio.dev/settings", "_blank");
            }
        });
    }

    document.getElementById("btn-apply-llm").addEventListener("click", applyLLMConfig);
    document.getElementById("btn-test-llm").addEventListener("click", testLLMConfig);
    document.getElementById("btn-setup-tg").addEventListener("click", setupTelegram);
    document.getElementById("btn-setup-dc").addEventListener("click", setupDiscord);
    document.getElementById("btn-setup-wa").addEventListener("click", setupWhatsApp);
    document.getElementById("btn-setup-sl").addEventListener("click", setupSlack);
    document.getElementById("btn-close-channel").addEventListener("click", closeChannelSetup);
    document.getElementById("btn-daemon-toggle").addEventListener("click", toggleDaemon);
    document.getElementById("btn-emergency-flush").addEventListener("click", emergencyFlush);
    document.getElementById("btn-send-chat").addEventListener("click", sendAgentMessage);
    document.getElementById("agent-chat-input").addEventListener("keydown", function(e) { if (e.key === "Enter") { sendAgentMessage(e); } });
    document.getElementById("btn-save-settings").addEventListener("click", saveSettings);
    document.getElementById("btn-reset-settings").addEventListener("click", resetSettings);
    document.getElementById("btn-save-composio").addEventListener("click", saveComposioKey);

    // Help Center Search Listener
    var helpSearchEl = document.getElementById("help-search");
    if (helpSearchEl) {
        helpSearchEl.addEventListener("input", function(e) { 
            window.filterHelp(e.target.value); 
        });
    }

    // Composio Skills Search Listener
    var skillSearchEl = document.getElementById("skill-search");
    if (skillSearchEl) {
        skillSearchEl.addEventListener("input", function() { 
            renderComposioToolkits(); 
        });
    }

    async function saveAllConfig() {
        var toml = buildConfigToml();
        try {
            await invokeShort("write_config", { content: toml });
        } catch(e) {
            localStorage.setItem("bambooclaw-config", JSON.stringify(currentConfig));
        }
    }

    window.fetchORModels = function() {
        var listEl = document.getElementById("or-model-list");
        if (!listEl) return;
        listEl.innerHTML = '<div style="padding:1rem;text-align:center;color:var(--text-dim);"><span class="spinner">‚ü≥</span> Loading models...</div>';
        
        fetch("https://openrouter.ai/api/v1/models")
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var seen = {};
            orModels = (data.data || []).filter(function(m) {
                if (!m.name || !m.pricing || !m.id) return false;
                if (seen[m.id]) return false;
                if (m.name === m.id) return false;
                seen[m.id] = true;
                return true;
            }).map(function(m) {
                return {
                    id: m.id,
                    name: m.name,
                    input: parseFloat(m.pricing.prompt || "0"),
                    output: parseFloat(m.pricing.completion || "0")
                };
            });
            document.getElementById("or-model-count").textContent = "(" + orModels.length + " available)";
            renderORModels();
        })
        .catch(function(e) {
            listEl.innerHTML = '<div style="padding:1rem;color:var(--error);text-align:center;">Failed to load models</div>';
        });
    };

    window.sortORModels = function(key) {
        if (orSortKey === key) { orSortDir *= -1; } else { orSortKey = key; orSortDir = 1; }
        renderORModels();
    };

    window.selectORModel = function(id) {
        orSelectedModel = id;
        var m = orModels.find(function(x) { return x.id === id; });
        var nameEl = document.getElementById("or-active-model-name");
        if (nameEl) nameEl.textContent = m ? m.name + " (" + m.id + ")" : id;
        var reminder = document.getElementById("or-save-reminder");
        if (reminder) reminder.classList.add("visible");
        var sel = document.getElementById("llm-model");
        sel.innerHTML = "";
        var opt = document.createElement("option");
        opt.value = id;
        opt.textContent = m ? m.name : id;
        sel.appendChild(opt);
        sel.value = id;
        renderORModels();
    };

    function renderORModels() {
        var search = (document.getElementById("or-model-search").value || "").toLowerCase();
        var filtered = orModels.filter(function(m) {
            return m.id.toLowerCase().indexOf(search) >= 0 || m.name.toLowerCase().indexOf(search) >= 0;
        });
        filtered.sort(function(a, b) {
            var cmp = 0;
            if (orSortKey === "name") cmp = a.name.localeCompare(b.name);
            else if (orSortKey === "input") cmp = a.input - b.input;
            else if (orSortKey === "output") cmp = a.output - b.output;
            return cmp * orSortDir;
        });

        var html = '<table style="width:100%;border-collapse:collapse;font-size:0.8rem;">';
        html += '<thead><tr style="background:#1a1a2e;position:sticky;top:0;">';
        html += '<th style="text-align:left;padding:0.5rem 0.75rem;">Model</th><th style="text-align:right;padding:0.5rem 0.75rem;">Input</th><th style="text-align:right;padding:0.5rem 0.75rem;">Output</th>';
        html += '</tr></thead><tbody>';

        filtered.forEach(function(m) {
            var sel = m.id === orSelectedModel;
            var bg = sel ? "background:rgba(16,185,129,0.15);border-left:3px solid var(--accent);" : "border-left:3px solid transparent;";
            html += '<tr data-model-id="' + escapeHtml(m.id) + '" style="cursor:pointer;border-bottom:1px solid var(--border);' + bg + '" class="or-model-row">';
            html += '<td style="padding:0.5rem 0.75rem;"><div style="font-weight:600;">' + escapeHtml(m.name) + '</div><div style="color:var(--text-dim);font-size:0.7rem;">' + escapeHtml(m.id) + '</div></td>';
            html += '<td style="text-align:right;padding:0.5rem 0.75rem;font-family:monospace;">$' + (m.input*1000000).toFixed(2) + '</td>';
            html += '<td style="text-align:right;padding:0.5rem 0.75rem;font-family:monospace;">$' + (m.output*1000000).toFixed(2) + '</td>';
            html += '</tr>';
        });

        html += '</tbody></table>';
        document.getElementById("or-model-list").innerHTML = html;
    }

    document.getElementById("or-model-list").addEventListener("click", function(e) {
        var row = e.target.closest ? e.target.closest(".or-model-row") : null;
        if (!row) {
            var el = e.target;
            while (el && el !== this) {
                if (el.classList && el.classList.contains("or-model-row")) { row = el; break; }
                el = el.parentElement;
            }
        }
        if (row) window.selectORModel(row.getAttribute("data-model-id"));
    });

    document.getElementById("or-model-search").addEventListener("input", renderORModels);
    document.getElementById("or-sort-name").addEventListener("click", function() { window.sortORModels("name"); });
    document.getElementById("or-sort-input").addEventListener("click", function() { window.sortORModels("input"); });
    document.getElementById("or-sort-output").addEventListener("click", function() { window.sortORModels("output"); });
    document.getElementById("btn-fetch-models").addEventListener("click", function() { window.fetchORModels(); });

    document.getElementById("btn-open-log-folder").addEventListener("click", function() {
        if (window.__TAURI__) {
            try {
                var resolved = LOG_FOLDER.replace("~", detectedOS === "windows" ? "%USERPROFILE%" : "$HOME");
                if (window.__TAURI__.opener) window.__TAURI__.opener.openUrl(resolved);
                else if (window.__TAURI__.shell) window.__TAURI__.shell.open(resolved);
            } catch(e) {}
        }
    });

    async function fetchVersion() {
        try {
            var resp = await fetch(PROXY_URL + "?action=latest");
            if (!resp.ok) throw new Error("HTTP " + resp.status);
            var data = await resp.json();
            var ver = data.tag_name || "v-unknown";
            var el = document.getElementById("app-version");
            if (el) el.textContent = ver;
            var aboutVer = document.getElementById("about-version");
            if (aboutVer) aboutVer.textContent = ver;
        } catch(e) {}
    }

    // MAIN BOOT SEQUENCE
    async function boot() {
        try {
            var installedFlag = localStorage.getItem("bambooclaw-installed");
            fetchVersion();
            if (installedFlag === "true") {
                await window.enterDashboard();
                loadPersonas();
                testImageConnectivity();
                if (!currentConfig.settings) {
                    currentConfig.settings = {
                        autonomy: "autonomous",
                        port: "7331",
                        tunnel: "none",
                        identity: "bamboo",
                        runtime: "native",
                        loglevel: "info",
                        maxToolIterations: 10
                    };
                    saveAllConfig();
                }
                if (currentConfig.settings && currentConfig.settings.maxToolIterations) {
                    MAX_TOOL_ITERATIONS = currentConfig.settings.maxToolIterations;
                    var slider = document.getElementById("set-tool-iterations");
                    var label = document.getElementById("tool-iter-value");
                    if (slider) slider.value = MAX_TOOL_ITERATIONS;
                    if (label) label.textContent = MAX_TOOL_ITERATIONS;
                }
                if (currentConfig.enabledSkills) {
                    enabledSkills = currentConfig.enabledSkills;
                    renderBuiltinSkills();
                    rebuildBuiltinTools();
                    renderActiveToolsSummary();
                    renderEnabledIntegrations();
                }
                if (currentConfig.composioApiKey) {
                    var ckEl = document.getElementById("composio-api-key");
                    if (ckEl) ckEl.value = currentConfig.composioApiKey;
                    setTimeout(function() { saveComposioKey(); }, 1000);
                }
                setTimeout(function() { renderActiveToolsSummary(); renderEnabledIntegrations(); }, 2000);
                setTimeout(function() {
                    if (currentConfig.llm && currentConfig.llm.api_key && !daemonRunning) {
                        toggleDaemon();
                    }
                }, 500);
            } else {
                runSystemChecks();
            }
        } catch(e) {}
    }

    (function waitForTauri() {
        try {
            var startTime = Date.now();
            var waited = 0;
            var interval = setInterval(function() {
                waited += 50;
                if (window.__TAURI__) {
                    clearInterval(interval);
                    boot();
                } else if (waited >= 3000) {
                    clearInterval(interval);
                    boot();
                }
            }, 50);
        } catch(e) {}
    })();
    </script>
</body>
</html>