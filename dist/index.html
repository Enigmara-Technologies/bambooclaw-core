<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BambooClaw Companion</title>
    <style>
        :root {
            --bg-color: #0a0a0f;
            --card-color: #1a1a2e;
            --card-border-color: rgba(68, 255, 178, 0.2);
            --accent-color: #44ffb2;
            --accent-color-dark: #32c88a;
            --text-color: #e0e0e0;
            --text-muted-color: #8892b0;
            --success-color: #44ffb2;
            --error-color: #ff5555;
            --warning-color: #ffcc00;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'SF Mono', 'Fira Code', 'Fira Mono', 'Roboto Mono', monospace;
        }

        /* --- Base & Reset --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            font-size: 16px;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 2rem;
        }

        h1, h2, h3 {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5em;
        }
        
        h1 { font-size: 2.2rem; }
        h2 { font-size: 1.5rem; letter-spacing: 0.5px; }

        p {
            color: var(--text-muted-color);
            line-height: 1.6;
        }
        
        .hidden { display: none !important; }

        /* --- Glassmorphism Card --- */
        .card {
            background: rgba(26, 26, 46, 0.6); /* --card-color with alpha */
            border: 1px solid var(--card-border-color);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* --- Buttons & Inputs --- */
        .btn {
            background-color: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .btn:hover:not(:disabled) {
            background-color: var(--accent-color);
            color: var(--bg-color);
            box-shadow: 0 0 15px rgba(68, 255, 178, 0.5);
        }

        .btn.btn-primary {
            background-color: var(--accent-color);
            color: var(--bg-color);
        }

        .btn.btn-primary:hover:not(:disabled) {
            background-color: var(--accent-color-dark);
            border-color: var(--accent-color-dark);
        }
        
        .btn:disabled {
            background-color: #2a3a4a;
            border-color: #40556b;
            color: var(--text-muted-color);
            cursor: not-allowed;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
        }

        input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 0.75rem;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid #334;
            border-radius: 6px;
            color: var(--text-color);
            font-size: 1rem;
        }
        
        input[type="radio"] {
            margin-right: 0.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted-color);
            font-size: 0.9rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        /* --- Installer Wizard Layout --- */
        #installer-wizard {
            max-width: 800px;
            margin: auto;
            width: 100%;
        }

        .installer-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .installer-header .logo {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--accent-color);
        }
        
        .installer-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }
        .installer-steps::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #334;
            transform: translateY(-50%);
            z-index: 0;
        }
        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            color: var(--text-muted-color);
        }
        .step-indicator .icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #334;
            border: 2px solid #334;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .step-indicator.active .icon {
            background-color: var(--card-color);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .step-indicator.active .label {
            color: var(--text-color);
        }

        .installer-step-content {
            min-height: 300px;
        }
        
        .installer-footer {
            margin-top: 2rem;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        /* --- Installer Step 1: System Check --- */
        .system-checks {
            list-style: none;
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr 1fr;
        }
        .check-item {
            background: rgba(0,0,0,0.2);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #334;
        }
        .check-item-info {
            display: flex;
            flex-direction: column;
        }
        .check-item-name {
            font-weight: 500;
        }
        .check-item-version {
            font-size: 0.9rem;
            color: var(--text-muted-color);
            font-family: var(--font-mono);
        }
        .check-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        .check-item.success { border-left-color: var(--success-color); }
        .check-item.error { border-left-color: var(--error-color); }
        .check-item.warning { border-left-color: var(--warning-color); }
        .check-status.success { color: var(--success-color); }
        .check-status.error { color: var(--error-color); }
        .check-status.warning { color: var(--warning-color); }
        .check-status.pending { color: var(--text-muted-color); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-muted-color);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* --- Installer Step 2 & 3: Logs --- */
        .log-output {
            background-color: #000;
            border: 1px solid #334;
            border-radius: 6px;
            padding: 1rem;
            height: 200px;
            overflow-y: auto;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            white-space: pre-wrap;
            color: var(--text-muted-color);
        }
        .log-output .log-line {
            display: block;
        }
        .log-output .log-line.error {
            color: var(--error-color);
        }
        .log-output .log-line.success {
            color: var(--success-color);
        }

        /* --- Dashboard Layout --- */
        #dashboard-view {
            display: flex;
            height: 100%;
            gap: 2rem;
            flex-grow: 1;
        }
        
        .dashboard-nav {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex-shrink: 0;
            width: 200px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-muted-color);
            font-weight: 500;
            border: 1px solid transparent;
        }
        .nav-item:hover {
            background-color: rgba(255,255,255,0.05);
        }
        .nav-item.active {
            background-color: rgba(68, 255, 178, 0.1);
            color: var(--accent-color);
            border-color: rgba(68, 255, 178, 0.3);
        }
        .nav-item svg {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .dashboard-content {
            flex-grow: 1;
            overflow-y: auto;
        }

        .tab-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .dashboard-header .status-light {
             display: flex;
             align-items: center;
             gap: 0.5rem;
        }
        
        .status-light::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--error-color);
            box-shadow: 0 0 5px var(--error-color);
        }
        .status-light.online::before {
            background-color: var(--success-color);
            box-shadow: 0 0 5px var(--success-color);
        }

    </style>
</head>
<body>
    <div id="app-container">

        <!-- ===== INSTALLER WIZARD ===== -->
        <main id="installer-wizard" class="hidden">
            <div class="installer-header">
                <div class="logo">BambooClaw</div>
                <h1>Companion Installer</h1>
            </div>

            <div class="installer-steps">
                <div class="step-indicator active" data-step="1">
                    <div class="icon">1</div>
                    <div class="label">System Check</div>
                </div>
                <div class="step-indicator" data-step="2">
                    <div class="icon">2</div>
                    <div class="label">Prerequisites</div>
                </div>
                <div class="step-indicator" data-step="3">
                    <div class="icon">3</div>
                    <div class="label">Install</div>
                </div>
                <div class="step-indicator" data-step="4">
                    <div class="icon">4</div>
                    <div class="label">Finish</div>
                </div>
            </div>

            <!-- Step 1: System Check -->
            <div id="step-1" class="installer-step-content">
                <div class="card">
                    <h2>System Compatibility</h2>
                    <p>Checking if your system meets the minimum requirements to run BambooClaw.</p>
                    <ul class="system-checks" style="margin-top: 1.5rem;">
                        <li id="check-os" class="check-item">
                            <div class="check-item-info">
                                <span class="check-item-name">Operating System</span>
                                <span class="check-item-version"></span>
                            </div>
                            <div class="check-status pending"><div class="spinner"></div>Detecting...</div>
                        </li>
                        <li id="check-rustc" class="check-item">
                            <div class="check-item-info">
                                <span class="check-item-name">Rust Compiler (rustc)</span>
                                <span class="check-item-version">Required for building from source</span>
                            </div>
                            <div class="check-status pending"><div class="spinner"></div>Detecting...</div>
                        </li>
                        <li id="check-cargo" class="check-item">
                             <div class="check-item-info">
                                <span class="check-item-name">Cargo Package Manager</span>
                                <span class="check-item-version">Required for building from source</span>
                            </div>
                            <div class="check-status pending"><div class="spinner"></div>Detecting...</div>
                        </li>
                        <li id="check-git" class="check-item">
                             <div class="check-item-info">
                                <span class="check-item-name">Git</span>
                                <span class="check-item-version">Required for source installation</span>
                            </div>
                            <div class="check-status pending"><div class="spinner"></div>Detecting...</div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Step 2: Install Prerequisites -->
            <div id="step-2" class="installer-step-content hidden">
                <div class="card">
                    <h2>Install Prerequisites</h2>
                    <p id="prereq-instructions">Some required tools are missing. We can attempt to install them for you.</p>
                    <div class="btn-group" style="margin-top: 1.5rem;">
                        <button id="install-prereqs-btn" class="btn btn-primary">Install Automatically</button>
                    </div>
                    <pre id="prereq-log" class="log-output" style="margin-top: 1.5rem;"></pre>
                </div>
            </div>

            <!-- Step 3: Install BambooClaw -->
            <div id="step-3" class="installer-step-content hidden">
                <div class="card">
                    <h2>Install BambooClaw Core</h2>
                    <p>Choose your preferred installation method.</p>
                    <div style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">
                        <label>
                            <input type="radio" name="install-method" value="binary" checked> Download Pre-built Binary (Recommended)
                        </label>
                        <label>
                            <input type="radio" name="install-method" value="source"> Build from Source (Requires Rust/Cargo)
                        </label>
                    </div>
                     <div class="btn-group" style="margin-top: 1.5rem;">
                        <button id="install-bambooclaw-btn" class="btn btn-primary">Install BambooClaw</button>
                    </div>
                    <pre id="install-log" class="log-output" style="margin-top: 1.5rem;"></pre>
                </div>
            </div>

            <!-- Step 4: Finalization -->
            <div id="step-4" class="installer-step-content hidden">
                <div class="card">
                    <h2>Installation Complete!</h2>
                    <p>BambooClaw has been successfully installed on your system. You can now proceed to the companion dashboard to configure and manage your AI agent.</p>
                    <div id="final-version-info" style="margin-top: 1.5rem; font-family: var(--font-mono);"></div>
                </div>
            </div>
            
            <div class="installer-footer">
                <div class="btn-group">
                    <button id="prev-btn" class="btn" disabled>Previous</button>
                    <button id="next-btn" class="btn btn-primary" disabled>Next</button>
                    <button id="finish-btn" class="btn btn-primary hidden">Finish & Open Dashboard</button>
                </div>
            </div>
        </main>

        <!-- ===== DASHBOARD ===== -->
        <main id="dashboard-view" class="hidden">
            <nav class="dashboard-nav">
                <div class="nav-header" style="padding: 0 1rem 1rem 1rem;">
                    <h2 style="font-size: 1.2rem; color: var(--accent-color);">BambooClaw</h2>
                    <p style="font-size: 0.9rem;">Companion</p>
                </div>
                <div class="nav-item active" data-tab="llm-config">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                    <span>LLM Config</span>
                </div>
                <div class="nav-item" data-tab="channels">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>
                    <span>Channels</span>
                </div>
                <div class="nav-item" data-tab="agent-control">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/><path d="M5.45 5.45 2 2"/></svg>
                    <span>Agent Control</span>
                </div>
                <div class="nav-item" data-tab="settings">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    <span>Settings</span>
                </div>
            </nav>
            <div class="dashboard-content">

                <!-- Tab: LLM Config -->
                <div id="llm-config" class="tab-content">
                    <div class="dashboard-header">
                        <h2>LLM Configuration</h2>
                    </div>
                    <div class="card">
                        <div class="form-group">
                            <label for="llm-provider">LLM Provider</label>
                            <select id="llm-provider">
                                <option>OpenAI</option>
                                <option>Anthropic</option>
                                <option>Google Gemini</option>
                                <option>OpenRouter</option>
                                <option>Ollama</option>
                                <option>DeepSeek</option>
                                <option>Groq</option>
                                <option>Mistral</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="api-key">API Key</label>
                            <input type="password" id="api-key" placeholder="Enter your API key">
                        </div>
                        <div class="form-group">
                            <label for="model-selector">Model</label>
                            <input type="text" id="model-selector" placeholder="e.g., gpt-4o, claude-3-opus-20240229">
                        </div>
                        <div class="btn-group">
                            <button id="save-config-btn" class="btn btn-primary">Save Configuration</button>
                            <button id="test-config-btn" class="btn">Test Connection</button>
                        </div>
                        <div id="config-status" style="margin-top: 1rem; font-family: var(--font-mono);"></div>
                    </div>
                </div>

                <!-- Tab: Channels -->
                <div id="channels" class="tab-content hidden">
                    <div class="dashboard-header">
                        <h2>Channel Setup</h2>
                    </div>
                    <div class="card">
                        <h3>Connect a Channel</h3>
                        <p>Configure BambooClaw to communicate over different platforms.</p>
                        <!-- Channel setup wizards would go here -->
                        <p style="margin-top: 2rem; text-align: center; color: var(--text-muted-color);">Channel setup guides coming soon.</p>
                    </div>
                </div>
                
                <!-- Tab: Agent Control -->
                <div id="agent-control" class="tab-content hidden">
                    <div class="dashboard-header">
                        <h2>Agent Control</h2>
                        <div id="agent-status" class="status-light">Agent Offline</div>
                    </div>
                    <div class="card">
                        <h3>Daemon Control</h3>
                        <div class="btn-group">
                            <button id="start-daemon-btn" class="btn">Start Agent</button>
                            <button id="stop-daemon-btn" class="btn">Stop Agent</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Agent Logs</h3>
                        <pre id="agent-log" class="log-output">Agent logs will appear here...</pre>
                    </div>
                </div>

                <!-- Tab: Settings -->
                <div id="settings" class="tab-content hidden">
                    <div class="dashboard-header">
                        <h2>Settings</h2>
                    </div>
                    <div class="card">
                        <h3>General Settings</h3>
                        <p style="text-align: center; color: var(--text-muted-color);">Advanced settings will be available here in a future update.</p>
                    </div>
                </div>
                
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- State Management ---
            const appState = {
                platform: null,
                currentStep: 1,
                systemChecks: {
                    os: 'pending',
                    rustc: 'pending',
                    cargo: 'pending',
                    git: 'pending',
                },
                installationComplete: localStorage.getItem('bambooClawInstallationComplete') === 'true'
            };

            // --- Tauri Invoke Helper ---
            // CRITICAL: This helper enforces a timeout on all system calls to prevent UI hangs.
            function invokeWithTimeout(cmd, args = {}, timeoutMs = 8000) {
                console.log(`Invoking: ${cmd} with args:`, args);
                // Ensure __TAURI__ exists for browser development without the Tauri context
                if (!window.__TAURI__ || !window.__TAURI__.invoke) {
                    console.warn(`Tauri API not found. Simulating call for: ${cmd}`);
                    return new Promise((resolve, reject) => {
                        setTimeout(() => {
                            if (cmd === 'get_platform') resolve('simulated-os');
                            else if (cmd === 'check_prerequisite') resolve('1.78.0');
                            else if (cmd === 'run_bambooclaw') resolve('bambooclaw 0.1.0');
                            else resolve('Simulated OK');
                        }, 500);
                    });
                }
                
                return Promise.race([
                    window.__TAURI__.invoke(cmd, args),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error(`Timeout: Call to '${cmd}' took longer than ${timeoutMs}ms`)), timeoutMs)
                    )
                ]);
            }

            // --- UI Element Selectors ---
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            const installerWizard = $('#installer-wizard');
            const dashboardView = $('#dashboard-view');
            const stepIndicators = $$('.step-indicator');
            const stepContents = $$('.installer-step-content');
            const prevBtn = $('#prev-btn');
            const nextBtn = $('#next-btn');
            const finishBtn = $('#finish-btn');
            const saveConfigBtn = $('#save-config-btn');
            const testConfigBtn = $('#test-config-btn');
            const startDaemonBtn = $('#start-daemon-btn');
            const stopDaemonBtn = $('#stop-daemon-btn');
            
            // --- UI Update Functions ---
            const showView = (view) => {
                if (view === 'installer') {
                    installerWizard.classList.remove('hidden');
                    dashboardView.classList.add('hidden');
                } else {
                    installerWizard.classList.add('hidden');
                    dashboardView.classList.remove('hidden');
                }
            };

            const log = (logElement, message, type = '') => {
                const line = document.createElement('span');
                line.className = `log-line ${type}`;
                line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logElement.appendChild(line);
                logElement.scrollTop = logElement.scrollHeight;
            };

            const updateCheckUI = (checkId, status, versionText = '') => {
                const item = $(`#check-${checkId}`);
                const statusEl = item.querySelector('.check-status');
                const versionEl = item.querySelector('.check-item-version');

                item.classList.remove('success', 'error', 'warning');
                statusEl.innerHTML = '';
                
                let statusIcon, statusText;
                switch (status) {
                    case 'success':
                        item.classList.add('success');
                        statusIcon = '✔️';
                        statusText = 'Found';
                        break;
                    case 'error':
                        item.classList.add('error');
                        statusIcon = '❌';
                        statusText = 'Not Found';
                        break;
                    case 'warning':
                         item.classList.add('warning');
                        statusIcon = '⚠️';
                        statusText = 'Warning';
                        break;
                    default: // pending
                        statusIcon = '<div class="spinner"></div>';
                        statusText = 'Detecting...';
                }
                statusEl.innerHTML = `${statusIcon} ${statusText}`;
                if (versionText) {
                    versionEl.textContent = versionText;
                }
            };
            
            const goToStep = (stepNum) => {
                appState.currentStep = stepNum;

                stepIndicators.forEach(ind => {
                    ind.classList.toggle('active', parseInt(ind.dataset.step) <= stepNum);
                });
                
                stepContents.forEach(content => {
                    content.classList.toggle('hidden', parseInt(content.id.split('-')[1]) !== stepNum);
                });

                prevBtn.disabled = stepNum === 1;
                
                if (stepNum === 4) {
                    nextBtn.classList.add('hidden');
                    finishBtn.classList.remove('hidden');
                } else {
                    nextBtn.classList.remove('hidden');
                    finishBtn.classList.add('hidden');
                }
            };
            
            // --- Installer Logic ---
            const runSystemChecks = async () => {
                const checks = [
                    invokeWithTimeout('get_platform').then(platform => {
                        appState.platform = platform;
                        appState.systemChecks.os = 'success';
                        updateCheckUI('os', 'success', `Detected: ${platform}`);
                    }).catch(err => {
                        appState.systemChecks.os = 'error';
                        updateCheckUI('os', 'error', err.message);
                    }),
                    // CRITICAL: The parameter name MUST be "name", not anything else.
                    invokeWithTimeout('check_prerequisite', { name: "rustc" }).then(version => {
                        appState.systemChecks.rustc = 'success';
                        updateCheckUI('rustc', 'success', `Version: ${version}`);
                    }).catch(err => {
                        appState.systemChecks.rustc = 'error';
                        updateCheckUI('rustc', 'error', 'Not Found');
                    }),
                    invokeWithTimeout('check_prerequisite', { name: "cargo" }).then(version => {
                        appState.systemChecks.cargo = 'success';
                        updateCheckUI('cargo', 'success', `Version: ${version}`);
                    }).catch(err => {
                        appState.systemChecks.cargo = 'error';
                        updateCheckUI('cargo', 'error', 'Not Found');
                    }),
                     invokeWithTimeout('check_prerequisite', { name: "git" }).then(version => {
                        appState.systemChecks.git = 'success';
                        updateCheckUI('git', 'success', `Version: ${version}`);
                    }).catch(err => {
                        appState.systemChecks.git = 'error';
                        updateCheckUI('git', 'error', 'Not Found');
                    }),
                ];

                // CRITICAL: Use Promise.allSettled so one failure doesn't stop others.
                // Enable the 'Next' button only after all checks are complete (succeeded or failed).
                await Promise.allSettled(checks);
                
                const hasMissingBuildTools = appState.systemChecks.rustc === 'error' || appState.systemChecks.cargo === 'error';
                $('input[value="source"]').disabled = hasMissingBuildTools;
                if (hasMissingBuildTools) {
                    const label = document.querySelector('label > input[value="source"]').parentElement;
                    label.title = 'Rust and Cargo are required to build from source.';
                    label.style.color = 'var(--text-muted-color)';
                }
                
                nextBtn.disabled = false;
            };

            const handleInstallPrereqs = async () => {
                const logEl = $('#prereq-log');
                log(logEl, 'Starting prerequisite installation...');
                $('#install-prereqs-btn').disabled = true;

                let command, args;
                switch (appState.platform) {
                    case 'windows-x86_64':
                        log(logEl, 'Windows detected. Using winget to install Git and Rust build tools.');
                        // CRITICAL: The parameter name MUST be "commandName".
                        command = 'winget';
                        args = ['install', '--id', 'Git.Git', '-e', '&&', 'winget', 'install', '--id', 'Rustlang.Rustup', '-e'];
                        break;
                    case 'darwin-x86_64':
                    case 'darwin-aarch64':
                         log(logEl, 'macOS detected. Installing xcode-select and rustup.');
                         command = 'sh';
                         args = ['-c', 'xcode-select --install && curl --proto \'=https\' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y'];
                        break;
                    default: // Linux
                        log(logEl, 'Linux detected. Installing build-essential and rustup.');
                        command = 'sh';
                        args = ['-c', 'sudo apt-get update && sudo apt-get install build-essential -y && curl --proto \'=https\' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y'];
                        break;
                }
                
                try {
                    // CRITICAL: Use correct camelCase `commandName` for the Rust backend.
                    const result = await invokeWithTimeout('run_shell_command', { commandName: command, args: args }, 300000); // 5 min timeout
                    log(logEl, `Output: ${result}`, 'success');
                    log(logEl, 'Prerequisites installed successfully.', 'success');
                } catch (err) {
                    log(logEl, `Error: ${err.message}`, 'error');
                } finally {
                     $('#install-prereqs-btn').disabled = false;
                     nextBtn.disabled = false;
                }
            };
            
            const handleInstallBambooClaw = async () => {
                const logEl = $('#install-log');
                const installMethod = $('input[name="install-method"]:checked').value;
                $('#install-bambooclaw-btn').disabled = true;
                log(logEl, `Starting installation via: ${installMethod}`);

                try {
                    if (installMethod === 'binary') {
                        const baseUrl = 'https://github.com/YourOrg/BambooClaw/releases/download/v0.1.0';
                        const binaryName = `bambooclaw-${appState.platform}`;
                        const url = `${baseUrl}/${binaryName}`;
                        const dest = `bambooclaw${appState.platform.startsWith('windows') ? '.exe' : ''}`;
                        log(logEl, `Downloading from ${url}...`);
                        await invokeWithTimeout('download_binary', { url: url, dest: dest }, 120000); // 2 min timeout
                        log(logEl, 'Binary downloaded successfully.', 'success');
                    } else { // source
                        log(logEl, 'Building from source using Cargo...');
                        await invokeWithTimeout('run_shell_command', { commandName: 'cargo', args: ['install', 'bambooclaw-core', '--locked'] }, 600000); // 10 min timeout
                        log(logEl, 'Build complete.', 'success');
                    }
                    
                    log(logEl, 'Verifying installation...');
                    const version = await invokeWithTimeout('run_bambooclaw', { args: ['--version'] });
                    log(logEl, `Verification successful: ${version}`, 'success');
                    $('#final-version-info').textContent = `Installed Version: ${version}`;
                    nextBtn.disabled = false;

                } catch (err) {
                    log(logEl, `Installation failed: ${err.message}`, 'error');
                    nextBtn.disabled = true;
                } finally {
                    $('#install-bambooclaw-btn').disabled = false;
                }
            };

            // --- Dashboard Logic ---
            const setupDashboard = () => {
                // Restore config on load
                invokeWithTimeout('read_config').then(configStr => {
                    const config = JSON.parse(configStr);
                    $('#llm-provider').value = config.provider || 'OpenAI';
                    $('#api-key').value = config.api_key || '';
                    $('#model-selector').value = config.model || '';
                }).catch(err => {
                    console.error("Could not read config:", err);
                    $('#config-status').textContent = 'Error: Could not load configuration.';
                });
                
                // Tab switching
                const navItems = $$('.nav-item');
                const tabContents = $$('.tab-content');
                navItems.forEach(item => {
                    item.addEventListener('click', () => {
                        navItems.forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        tabContents.forEach(tab => tab.classList.add('hidden'));
                        $(`#${item.dataset.tab}`).classList.remove('hidden');
                    });
                });
            };
            
            const handleSaveConfig = async () => {
                const config = {
                    provider: $('#llm-provider').value,
                    api_key: $('#api-key').value,
                    model: $('#model-selector').value,
                };
                const statusEl = $('#config-status');
                statusEl.textContent = 'Saving...';
                try {
                    await invokeWithTimeout('write_config', { content: JSON.stringify(config, null, 2) });
                    statusEl.textContent = 'Configuration saved successfully.';
                } catch(err) {
                    statusEl.textContent = `Error saving config: ${err.message}`;
                }
            };

            const handleTestConfig = async () => {
                 const statusEl = $('#config-status');
                 statusEl.textContent = 'Pinging agent with current config...';
                 try {
                    const result = await invokeWithTimeout('run_bambooclaw', { args: ['agent', '-m', 'ping'] }, 15000);
                    statusEl.textContent = `Test successful! Agent responded: ${result}`;
                } catch(err) {
                    statusEl.textContent = `Test failed: ${err.message}`;
                }
            };

            const handleDaemonControl = async (action) => {
                const agentStatusEl = $('#agent-status');
                try {
                    if (action === 'start') {
                        agentStatusEl.textContent = 'Starting...';
                        await invokeWithTimeout('start_daemon');
                        agentStatusEl.textContent = 'Agent Online';
                        agentStatusEl.classList.add('online');
                        log($('#agent-log'), 'Agent daemon started.', 'success');

                    } else { // stop
                        agentStatusEl.textContent = 'Stopping...';
                        await invokeWithTimeout('stop_daemon');
                        agentStatusEl.textContent = 'Agent Offline';
                        agentStatusEl.classList.remove('online');
                        log($('#agent-log'), 'Agent daemon stopped.');
                    }
                } catch (err) {
                    agentStatusEl.textContent = 'Error';
                    log($('#agent-log'), `Daemon control error: ${err.message}`, 'error');
                }
            };
            
            // --- Event Listeners ---
            nextBtn.addEventListener('click', () => goToStep(appState.currentStep + 1));
            prevBtn.addEventListener('click', () => goToStep(appState.currentStep - 1));
            finishBtn.addEventListener('click', () => {
                localStorage.setItem('bambooClawInstallationComplete', 'true');
                appState.installationComplete = true;
                showView('dashboard');
                setupDashboard();
            });
            $('#install-prereqs-btn').addEventListener('click', handleInstallPrereqs);
            $('#install-bambooclaw-btn').addEventListener('click', handleInstallBambooClaw);
            saveConfigBtn.addEventListener('click', handleSaveConfig);
            testConfigBtn.addEventListener('click', handleTestConfig);
            startDaemonBtn.addEventListener('click', () => handleDaemonControl('start'));
            stopDaemonBtn.addEventListener('click', () => handleDaemonControl('stop'));


            // --- App Initialization ---
            const initialize = () => {
                if (appState.installationComplete) {
                    showView('dashboard');
                    setupDashboard();
                } else {
                    showView('installer');
                    goToStep(1);
                    runSystemChecks();
                }
            };

            initialize();
        });
    </script>
</body>
</html>