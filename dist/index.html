<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src *; img-src 'self' data: https: asset: http://asset.localhost;">
    <title>BambooClaw‚Ñ¢</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0f;
            --card: #12121e;
            --accent: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.2);
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --border: #1e293b;
            --error: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }
        #app { display: flex; flex-direction: column; height: 100vh; }
        header {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            flex-shrink: 0;
        }
        .logo { display: flex; align-items: center; gap: 0.6rem; font-weight: 800; font-size: 1.1rem; letter-spacing: -0.025em; color: var(--accent); }
        .logo img { height: 32px; width: auto; }
        main { flex: 1; overflow-y: auto; padding: 1rem 1.5rem; position: relative; min-height: 0; }
        .container { max-width: 800px; margin: 0 auto; }
        .hidden { display: none !important; }

        .steps { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .step-dot { flex: 1; height: 4px; background: var(--border); border-radius: 2px; transition: 0.3s; }
        .step-dot.active { background: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        .glass-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 { font-size: 1.5rem; margin-bottom: 0.4rem; }
        p.subtitle { color: var(--text-dim); margin-bottom: 1rem; }

        .check-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .status-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; }
        .status-detecting { color: var(--text-dim); }
        .status-found { color: var(--accent); }
        .status-not-installed { color: var(--warning); background: rgba(245, 158, 11, 0.1); }
        .status-error { color: var(--error); }

        .log-container {
            margin-top: 1.5rem;
            position: relative;
            background: #050507;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #1a1a2e;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .log-body {
            height: 150px;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn:hover { filter: brightness(1.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--accent); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
        .btn-danger { background: var(--error); }
        .btn-flush { background: transparent; border: 2px solid #ff4444; color: #ff4444; font-weight: 700; }
        .btn-flush:hover { background: #ff4444; color: #fff; }

        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1rem; flex-wrap: wrap; }
        .tab { padding: 0.6rem 1rem; cursor: pointer; color: var(--text-dim); border-bottom: 2px solid transparent; transition: 0.2s; user-select: none; font-size: 0.85rem; }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .save-reminder { display: none; padding: 0.5rem 0.75rem; margin-top: 0.75rem; background: rgba(245,158,11,0.1); border: 1px solid var(--warning); border-radius: 6px; font-size: 0.8rem; color: var(--warning); }
        .save-reminder.visible { display: block; }
        
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; color: var(--text-dim); font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            background: #050507;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.75rem;
            border-radius: 6px;
            outline: none;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); }

        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        @media (max-width: 600px) { .settings-grid { grid-template-columns: 1fr; } }

        /* Splash Screen */
        .splash-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999;
            background: #0a0a0f; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 0.8s ease;
        }
        .splash-overlay.fade-out { opacity: 0; pointer-events: none; }
        .splash-logo { width: 400px; max-width: 80vw; height: auto; margin-bottom: 1.5rem; animation: splashPulse 2s ease-in-out infinite; filter: drop-shadow(0 0 30px rgba(16, 185, 129, 0.4)); }
        .splash-title { font-family: 'Inter', sans-serif; font-size: 1.8rem; font-weight: 800; color: var(--accent); letter-spacing: -0.03em; margin-bottom: 2rem; }
        .splash-bar-track { width: 220px; height: 3px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .splash-bar-fill { width: 30%; height: 100%; background: var(--accent); border-radius: 2px; animation: splashBarPulse 1.5s ease-in-out infinite; box-shadow: 0 0 8px var(--accent-glow); }
        
        @keyframes splashPulse { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 30px rgba(16, 185, 129, 0.4)); } 50% { transform: scale(1.03); filter: drop-shadow(0 0 50px rgba(16, 185, 129, 0.6)); } }
        @keyframes splashBarPulse { 0% { width: 10%; margin-left: 0; } 50% { width: 60%; margin-left: 20%; } 100% { width: 10%; margin-left: 90%; } }

        /* Chat */
        .chat-container { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-top: 1rem; }
        .chat-messages { height: 200px; overflow-y: auto; padding: 1rem; background: #050507; }
        .chat-input-row { display: flex; border-top: 1px solid var(--border); }
        .chat-input-row input { flex: 1; border: none; border-radius: 0; }
        .chat-input-row button { border-radius: 0; white-space: nowrap; }
        .chat-msg { margin-bottom: 0.75rem; font-size: 0.85rem; line-height: 1.4; }
        .chat-msg .role { font-weight: 700; color: var(--accent); margin-right: 0.5rem; }
        .chat-msg.assistant .role { color: var(--warning); }
        
        /* Status indicators */
        .status-pill { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-pill.running { background: rgba(16,185,129,0.15); color: var(--success); }
        .status-pill.stopped { background: rgba(239,68,68,0.15); color: var(--error); }

        /* General layout utilities */
        .channel-row { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.75rem; }
        .channel-row .channel-name { font-weight: 600; }
        .channel-row .channel-status { font-size: 0.8rem; color: var(--text-dim); }

        .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem 1.5rem; font-size: 0.9rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.3s ease; max-width: 350px; }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.info { border-left: 3px solid var(--accent); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px); } }

        .spinner { animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app">
        <div class="splash-overlay" id="splash-screen">
            <img class="splash-logo" src="logo.png" alt="BambooClaw Logo">
            <div class="splash-title">BambooClaw‚Ñ¢</div>
            <div class="splash-bar-track"><div class="splash-bar-fill"></div></div>
        </div>
        <script>
        (function() {
            var SPLASH_DURATION = 8000;
            var splashEl = document.getElementById("splash-screen");
            if (!splashEl) return;
            setTimeout(function() {
                splashEl.classList.add("fade-out");
                setTimeout(function() { if (splashEl.parentNode) splashEl.parentNode.removeChild(splashEl); }, 800);
            }, SPLASH_DURATION);
        })();
        </script>

        <header>
            <div class="logo"><span style="font-size:1.1rem;font-weight:700;color:var(--accent);">BambooClaw‚Ñ¢</span></div>
            <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent);"><span id="app-version">loading...</span></div>
        </header>

        <main>
            <div id="wizard-view" class="container">
                <div class="steps">
                    <div class="step-dot active" id="dot-0"></div>
                    <div class="step-dot" id="dot-1"></div>
                    <div class="step-dot" id="dot-2"></div>
                    <div class="step-dot" id="dot-3"></div>
                </div>

                <div class="glass-card wizard-step" id="step-0">
                    <h1>Environment Audit</h1>
                    <p class="subtitle">Ensuring your system is prepared for BambooClaw‚Ñ¢ edge deployment.</p>
                    <div>
                        <div class="check-row"><span>Operating System</span><span class="status-badge status-detecting" id="chk-os">Detecting...</span></div>
                        <div class="check-row"><span>Rust Toolchain</span><span class="status-badge status-detecting" id="chk-rust">Detecting...</span></div>
                        <div class="check-row"><span>Git CLI</span><span class="status-badge status-detecting" id="chk-git">Detecting...</span></div>
                        <div class="check-row"><span>Build Tools</span><span class="status-badge status-detecting" id="chk-build">Detecting...</span></div>
                        <div class="check-row"><span>Python</span><span class="status-badge status-detecting" id="chk-python">Detecting...</span></div>
                        <div class="check-row"><span>Node.js</span><span class="status-badge status-detecting" id="chk-node">Detecting...</span></div>
                    </div>
                    <div class="log-container">
                        <div class="log-header"><span>BOOT TRACE LOG</span><button class="btn btn-sm btn-outline" id="btn-copy-boot-log" style="padding: 2px 6px; font-size: 0.7rem;">üìã Copy</button></div>
                        <div class="log-body" id="boot-log"></div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button class="btn" id="btn-step0-next" disabled>Initialize Environment ‚Üí</button>
                    </div>
                </div>

                <div class="glass-card wizard-step hidden" id="step-1">
                    <h1>Readying Prereqs</h1>
                    <p class="subtitle">Applying required system dependencies and development toolchains.</p>
                    <div class="log-container">
                        <div class="log-header"><span>SYSTEM INSTALLATION LOG</span><button class="btn btn-sm btn-outline" id="btn-copy-install-log" style="padding: 2px 6px; font-size: 0.7rem;">üìã Copy</button></div>
                        <div class="log-body" id="install-log"></div>
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                        <button class="btn btn-outline" id="btn-back-step1">‚Üê Back</button>
                        <button class="btn" id="btn-step1-next" disabled>Agent Capabilities ‚Üí</button>
                    </div>
                </div>

                <div class="glass-card wizard-step hidden" id="step-2">
                    <h1>Agent Capabilities</h1>
                    <p class="subtitle">Select additional tools to maximize your agent's autonomous power.</p>

                    <div style="margin-bottom: 1rem;">
                        <label style="display:flex;align-items:flex-start;gap:0.75rem;padding:1rem;border:1px solid var(--border);border-radius:8px;cursor:pointer;background:rgba(16,185,129,0.05);">
                            <input type="checkbox" id="cap-python" checked style="margin-top:3px;accent-color:var(--accent);width:18px;height:18px;">
                            <div>
                                <div style="font-weight:600;color:var(--accent);">Python Ecosystem <span style="font-size:0.75rem;color:var(--text-dim);">(Recommended)</span></div>
                                <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.25rem;">Python 3.12, pyautogui, pillow, requests, beautifulsoup4, psutil, pandas, numpy</div>
                                <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.25rem;">Enables: GUI automation, screenshots, data analysis, web scraping</div>
                            </div>
                        </label>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display:flex;align-items:flex-start;gap:0.75rem;padding:1rem;border:1px solid var(--border);border-radius:8px;cursor:pointer;">
                            <input type="checkbox" id="cap-browser" style="margin-top:3px;accent-color:var(--accent);width:18px;height:18px;">
                            <div>
                                <div style="font-weight:600;">Browser Automation</div>
                                <div style="font-size:0.8rem;color:var(--text-dim);margin-top:0.25rem;">Playwright with Chromium</div>
                                <div style="font-size:0.75rem;color:var(--text-dim);margin-top:0.25rem;">Enables: Headless web browsing, form filling, web testing</div>
                            </div>
                        </label>
                    </div>

                    <div class="log-container">
                        <div class="log-header"><span>CAPABILITY INSTALL LOG</span></div>
                        <div class="log-body" id="capability-log"></div>
                    </div>

                    <div style="margin-top: 1.5rem; display: flex; justify-content: space-between;">
                        <button class="btn btn-outline" id="btn-back-step2">‚Üê Back</button>
                        <div style="display:flex;gap:0.75rem;">
                            <button class="btn btn-outline" id="btn-step2-skip">Skip for Now ‚Üí</button>
                            <button class="btn" id="btn-step2-install">Install Selected</button>
                        </div>
                    </div>
                </div>

                <div class="glass-card wizard-step hidden" id="step-3">
                    <div style="text-align: center; padding: 2rem 0;">
                        <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--success);">‚úì</div>
                        <h1>Installation Complete</h1>
                        <p class="subtitle">BambooClaw‚Ñ¢ is now registered as a system service.</p>
                        <div class="form-group" style="text-align: left;">
                            <label>Storage Path</label>
                            <input type="text" id="install-path-display" readonly value="~/.bambooclaw/bambooclaw" />
                        </div>
                        <button class="btn" id="btn-enter-dashboard">Enter Companion Dashboard</button>
                    </div>
                </div>
            </div>

            <div id="dashboard-view" class="container hidden">
                <div class="tabs">
                    <div class="tab active" data-tab="tab-llm">LLM Settings</div>
                    <div class="tab" data-tab="tab-channels">Channels</div>
                    <div class="tab" data-tab="tab-agent">Agent Control</div>
                    <div class="tab" data-tab="tab-settings">Settings</div>
                    <div class="tab" data-tab="tab-logs">Logs</div>
                </div>

                <div class="glass-card tab-panel" id="tab-llm">
                    <div class="form-group">
                        <label>AI Provider</label>
                        <select id="llm-provider">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google Gemini</option>
                            <option value="groq">Groq (Ultra-Fast)</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="ollama">Ollama (Local)</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="mistral">Mistral</option>
                            <option value="inception">Inception</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Secret API Key</label>
                        <div style="display: flex; align-items: center; border: 1px solid var(--border); border-radius: 6px; background: #050507; overflow: hidden;">
                            <input type="password" id="llm-api-key" placeholder="sk-..." style="border: none; border-radius: 0; outline: none; background: transparent; flex: 1; padding: 0.75rem;" />
                            <button type="button" id="btn-toggle-key" class="btn btn-outline" style="border: none; border-radius: 0; padding: 0.75rem; height: 100%; border-left: 1px solid var(--border);">üëÅÔ∏è</button>
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.4rem;">
                            Each provider remembers its own API key securely.
                        </p>
                    </div>

                    <div class="form-group" id="llm-model-group">
                        <label>Model</label>
                        <select id="llm-model">
                            <option value="">Select provider first</option>
                        </select>
                    </div>
                    
                    <div class="form-group hidden" id="or-models-area">
                        <label>Model</label>
                        <div class="active-model-display" id="or-active-model">
                            <span style="color:var(--text-dim);font-size:0.8rem;">Active Model:</span>
                            <strong style="color:var(--accent);margin-left:0.4rem;" id="or-active-model-name">None selected</strong>
                        </div>
                        <input type="text" id="or-model-search" placeholder="Search OpenRouter models..." style="margin-bottom:0.5rem;" />
                        <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;flex-wrap:wrap;">
                            <button type="button" class="btn btn-sm btn-outline" id="btn-fetch-models">Fetch Models</button>
                        </div>
                        <div id="or-model-list" style="height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;background:#050507;"></div>
                    </div>
                    
                    <div id="llm-save-reminder" class="save-reminder">‚ö† You have unsaved changes. Click <strong>Apply Configuration</strong> to save.</div>
                    <div style="margin-top: 1rem;">
                        <button type="button" class="btn" id="btn-apply-llm">Apply Configuration</button>
                        <button type="button" class="btn btn-outline" style="margin-left: 0.5rem;" id="btn-test-llm">Test Connection</button>
                    </div>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-channels">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.5rem;">Active Channels</h1>
                    <p class="subtitle">Connect your agent to external messaging platforms.</p>
                    
                    <div class="channel-row">
                        <div>
                            <div class="channel-name">ü§ñ Telegram Bot</div>
                            <div class="channel-status" id="tg-status">Not configured</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline" id="btn-setup-tg">Setup</button>
                    </div>

                    <div id="channel-setup-area" class="hidden" style="margin-top: 1.5rem; padding: 1.5rem; border: 1px solid var(--border); border-radius: 8px; background: #050507;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2 style="font-size: 1.1rem;" id="channel-setup-title">Setup</h2>
                            <button type="button" class="btn btn-sm btn-outline" id="btn-close-channel" style="font-size: 1.2rem; padding: 2px 8px;">‚úï</button>
                        </div>
                        <div id="channel-setup-body"></div>
                    </div>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-agent">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                        <div>
                            <h1 style="font-size: 1.3rem; margin-bottom: 0.25rem;">Daemon Status</h1>
                            <span class="status-pill stopped" id="daemon-status-pill">
                                <span id="daemon-status-dot">‚óè</span>
                                <span id="daemon-status-text">Stopped</span>
                            </span>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:10px;align-items:stretch;">
                            <button type="button" class="btn" id="btn-daemon-toggle">Start Agent Daemon</button>
                            <button type="button" class="btn btn-flush" id="btn-emergency-flush">‚ö† Emergency Flush</button>
                        </div>
                    </div>

                    <h2 style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--text-dim);">Agent Chat</h2>
                    <div class="chat-container">
                        <div class="chat-messages" id="agent-chat-messages">
                            <div class="chat-msg assistant"><span class="role">Agent:</span> Daemon is offline. Start the daemon to begin chatting.</div>
                        </div>
                        <div class="chat-input-row">
                            <input type="text" id="agent-chat-input" placeholder="Send a message to the agent..." />
                            <button type="button" class="btn" style="border-radius: 0;" id="btn-send-chat">Send</button>
                        </div>
                    </div>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-settings">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.5rem;">Agent Settings</h1>
                    
                    <div class="settings-grid" style="margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label>Autonomy Level</label>
                            <select id="set-autonomy">
                                <option value="observe">Observation Only</option>
                                <option value="collaborative">Collaborative (Needs Approval)</option>
                                <option value="autonomous" selected>Full Autonomy</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Active Persona</label>
                            <select id="set-identity">
                                <option value="-1">‚Äî BambooClaw Default (System Prompt Only) ‚Äî</option>
                            </select>
                            <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 0.4rem;">
                                Select a persona to inject specific rules. Manage them below.
                            </p>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label>Base System Prompt</label>
                        <textarea id="settings-system-prompt" rows="8" placeholder="Global instructions applied to EVERY conversation..." style="resize:vertical;"></textarea>
                    </div>

                    <div style="border-top: 1px solid var(--border); padding-top: 1.5rem;">
                        <h2 style="font-size: 1.1rem; margin-bottom: 0.5rem;">üé≠ Manage Personas</h2>
                        <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1rem;">Create specialized roles for your agent.</p>
                        
                        <div id="persona-list" style="margin-bottom: 1rem;"></div>

                        <details id="persona-details-block" style="border: 1px solid var(--border); border-radius: 8px; padding: 0; background: #050507;">
                            <summary style="padding: 0.75rem 1rem; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: var(--accent); user-select: none; list-style: none;">+ Create / Edit Persona</summary>
                            <div style="padding: 1rem;">
                                <div class="form-group">
                                    <label>Persona Name</label>
                                    <input type="text" id="new-persona-name" placeholder="e.g. Expert Python Developer..." />
                                </div>
                                <div class="form-group">
                                    <label>Persona Instructions</label>
                                    <textarea id="new-persona-prompt" rows="8" placeholder="Define how the agent should behave..." style="resize:vertical;"></textarea>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button type="button" class="btn btn-sm" id="btn-create-persona">Save Persona</button>
                                    <button type="button" class="btn btn-sm btn-outline hidden" id="btn-cancel-edit-persona">Cancel</button>
                                </div>
                            </div>
                        </details>
                    </div>

                    <div id="settings-save-reminder" class="save-reminder" style="margin-top: 1.5rem;">‚ö† You have unsaved changes. Click <strong>Save Settings</strong> to apply.</div>
                    <div style="margin-top: 1rem;">
                        <button type="button" class="btn" id="btn-save-settings">Save Settings</button>
                        <button type="button" class="btn btn-outline" style="margin-left: 0.5rem;" id="btn-reset-settings">Reset Defaults</button>
                    </div>
                </div>

                <div class="glass-card tab-panel hidden" id="tab-logs">
                    <h1 style="font-size: 1.3rem; margin-bottom: 0.75rem;">üìã Session Log</h1>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <span style="font-size: 0.75rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace;">SESSION LOG ‚Äî <span id="session-id-label">...</span></span>
                        <button type="button" class="btn btn-sm btn-outline" id="btn-copy-log">üìã Copy Log</button>
                    </div>
                    <div class="log-body" id="unified-log" style="height:400px;background:#050507;border:1px solid var(--border);border-radius:6px;font-size:0.72rem;line-height:1.6;"></div>
                    
                    <div id="dash-log" style="display:none;"></div>
                </div>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
    // ==========================================
    // CORE STATE & GLOBALS
    // ==========================================
    var detectedOS = "unknown";
    var daemonRunning = false;
    var currentConfig = {
        llm: { provider: "openai", api_key: "", model: "", system_prompt: "" },
        api_keys: {}, // Stores keys per provider
        settings: { autonomy: "autonomous", identity: "-1", maxToolIterations: 10 },
        channels: {},
        enabledSkills: {},
        composioApiKey: ""
    };
    var PROXY_URL = "https://mjmdhqglpratbyzmgndm.supabase.co/functions/v1/github-release-proxy";
    var MAX_TOOL_ITERATIONS = 10;
    
    var personas = [];
    var activePersonaIndex = -1;
    var editingPersonaIndex = -1;

    var SESSION_ID = "session-" + Math.random().toString(16).substring(2, 8);
    var LOG_FOLDER = "~/.bambooclaw/logs/";
    var LOG_FILE_PATH = LOG_FOLDER + SESSION_ID + ".log";

    setTimeout(function() {
        var lbl = document.getElementById("session-id-label"); if (lbl) lbl.textContent = SESSION_ID;
        var pathEl = document.getElementById("log-path-display"); if (pathEl) pathEl.value = LOG_FILE_PATH;
        var aboutVer = document.getElementById("about-version");
        var appVer = document.getElementById("app-version");
        if (aboutVer && appVer) aboutVer.textContent = appVer.textContent;
        var copyrightEl = document.getElementById("about-copyright");
        if (copyrightEl) copyrightEl.textContent = "¬© " + new Date().getFullYear() + " Bamboo Synergy Technologies, Inc.";
    }, 0);

    // ==========================================
    // UTILITIES & LOGGING
    // ==========================================
    function showToast(message, type) {
        var t = document.createElement("div");
        t.className = "toast " + (type || "info");
        t.textContent = message;
        document.getElementById("toast-container").appendChild(t);
        setTimeout(function() {
            t.style.animation = "slideOut 0.3s ease forwards";
            setTimeout(function() { t.remove(); }, 300);
        }, 3000);
    }

    function tauriInvoke(cmd, args) {
        if (!window.__TAURI__) return Promise.reject(new Error("Tauri not available"));
        var inv = (window.__TAURI__.core && window.__TAURI__.core.invoke) || (window.__TAURI__.tauri && window.__TAURI__.tauri.invoke) || window.__TAURI__.invoke;
        if (typeof inv === "function") return inv(cmd, args || {});
        return Promise.reject(new Error("Tauri invoke not found."));
    }

    function invokeShort(cmd, args) { return Promise.race([tauriInvoke(cmd, args), new Promise(function(_, reject) { setTimeout(function() { reject(new Error("Timeout: " + cmd)); }, 8000); })]); }
    function invokeLong(cmd, args, ms) { return Promise.race([tauriInvoke(cmd, args), new Promise(function(_, reject) { setTimeout(function() { reject(new Error("Timeout: " + cmd)); }, ms || 600000); })]); }

    function appendLog(logId, line) {
        var now = new Date();
        var ts = "[" + ("0"+now.getHours()).slice(-2) + ":" + ("0"+now.getMinutes()).slice(-2) + ":" + ("0"+now.getSeconds()).slice(-2) + "]";
        var el = document.getElementById(logId);
        if (el) { el.textContent += ts + " " + line + "\n"; el.scrollTop = el.scrollHeight; }
        var uni = document.getElementById("unified-log");
        if (uni && logId !== "unified-log") { uni.textContent += ts + " " + line + "\n"; uni.scrollTop = uni.scrollHeight; }
    }

    function copyLog(logId) {
        var el = document.getElementById(logId);
        if (el) {
            navigator.clipboard.writeText(el.textContent).then(function() { showToast("Log copied", "success"); }).catch(function() { showToast("Failed to copy", "error"); });
        }
    }

    // ==========================================
    // CONFIGURATION SAVING & LOADING
    // ==========================================
    function buildConfigToml() {
        var lines = ["# BambooClaw Agent Configuration", ""];
        
        if (currentConfig.llm) {
            lines.push("[llm]");
            if (currentConfig.llm.provider) lines.push('provider = ' + JSON.stringify(currentConfig.llm.provider));
            if (currentConfig.llm.api_key) lines.push('api_key = ' + JSON.stringify(currentConfig.llm.api_key));
            if (currentConfig.llm.model) lines.push('model = ' + JSON.stringify(currentConfig.llm.model));
            if (currentConfig.llm.system_prompt != null) lines.push('system_prompt = ' + JSON.stringify(currentConfig.llm.system_prompt));
            lines.push("");
        }

        if (currentConfig.api_keys && Object.keys(currentConfig.api_keys).length > 0) {
            lines.push("[api_keys]");
            Object.keys(currentConfig.api_keys).forEach(function(k) { if (currentConfig.api_keys[k]) lines.push(k + ' = ' + JSON.stringify(currentConfig.api_keys[k])); });
            lines.push("");
        }

        if (currentConfig.channels) {
            Object.keys(currentConfig.channels).forEach(function(ch) {
                lines.push("[channels." + ch + "]");
                var c = currentConfig.channels[ch];
                Object.keys(c).forEach(function(k) { lines.push(k + ' = ' + JSON.stringify(c[k] || "")); });
                lines.push("");
            });
        }

        if (currentConfig.settings) {
            lines.push("[agent]");
            var s = currentConfig.settings;
            if (s.autonomy) lines.push('autonomy = ' + JSON.stringify(s.autonomy));
            if (s.identity !== undefined) lines.push('identity = ' + JSON.stringify(String(s.identity)));
            if (s.maxToolIterations) lines.push('maxToolIterations = ' + JSON.stringify(String(s.maxToolIterations)));
            if (currentConfig.composioApiKey) lines.push('composio_api_key = ' + JSON.stringify(currentConfig.composioApiKey));
            lines.push("");
        }

        if (personas && personas.length > 0) {
            personas.forEach(function(p) {
                lines.push("[[personas]]");
                lines.push('name = ' + JSON.stringify(p.name));
                lines.push('prompt = ' + JSON.stringify(p.prompt));
                lines.push("");
            });
        }
        return lines.join("\n");
    }

    async function saveAllConfig() {
        var toml = buildConfigToml();
        try {
            await invokeShort("write_config", { content: toml });
            appendLog("dash-log", "[CONFIG] Saved to disk.");
        } catch(e) {
            localStorage.setItem("bambooclaw-config", JSON.stringify(currentConfig));
            localStorage.setItem("bambooclaw-personas-fallback", JSON.stringify(personas));
            appendLog("dash-log", "[CONFIG] Saved to localStorage (Fallback).");
        }
    }

    async function loadConfig() {
        appendLog("dash-log", "[CONFIG] loadConfig() started...");
        try {
            var raw = await invokeShort("read_config");
            parseAndApplyConfig(raw);
            appendLog("dash-log", "[CONFIG] Loaded from disk.");
        } catch(e) {
            var saved = localStorage.getItem("bambooclaw-config");
            var savedP = localStorage.getItem("bambooclaw-personas-fallback");
            if (saved) { try { currentConfig = JSON.parse(saved); } catch(e2) {} }
            if (savedP) { try { personas = JSON.parse(savedP); } catch(e2) {} }
            applyConfigToUI();
            renderPersonas();
        }
    }

    function parseAndApplyConfig(toml) {
        var lines = toml.split("\n");
        var section = "";
        personas = []; 
        
        lines.forEach(function(line) {
            line = line.trim();
            if (!line || line.startsWith("#")) return;
            
            if (line === "[[personas]]") { section = "personas"; personas.push({}); return; }
            
            var secMatch = line.match(/^\[(.+)\]$/);
            if (secMatch) { section = secMatch[1]; return; }
            
            var kvMatch = line.match(/^(\w+)\s*=\s*(.*)$/);
            if (kvMatch) {
                var key = kvMatch[1], valRaw = kvMatch[2].trim();
                var val = valRaw;
                if (valRaw.startsWith('"')) { try { val = JSON.parse(valRaw); } catch(e) { val = valRaw.replace(/^"|"$/g, ''); } } else if (!isNaN(valRaw)) { val = Number(valRaw); }
                
                if (section === "llm") { if (!currentConfig.llm) currentConfig.llm = {}; currentConfig.llm[key] = String(val); }
                else if (section === "api_keys") { if (!currentConfig.api_keys) currentConfig.api_keys = {}; currentConfig.api_keys[key] = String(val); }
                else if (section.startsWith("channels.")) {
                    var ch = section.replace("channels.", "");
                    if (!currentConfig.channels) currentConfig.channels = {};
                    if (!currentConfig.channels[ch]) currentConfig.channels[ch] = {};
                    currentConfig.channels[ch][key] = String(val);
                }
                else if (section === "agent") {
                    if (key === "composio_api_key") currentConfig.composioApiKey = String(val);
                    else { if (!currentConfig.settings) currentConfig.settings = {}; currentConfig.settings[key] = String(val); }
                }
                else if (section === "personas") { var lastP = personas[personas.length - 1]; if (lastP) lastP[key] = String(val); }
            }
        });
        applyConfigToUI();
        renderPersonas();
    }

    function applyConfigToUI() {
        if (currentConfig.llm) {
            if (currentConfig.llm.api_key && currentConfig.llm.provider) {
                if (!currentConfig.api_keys) currentConfig.api_keys = {};
                if (!currentConfig.api_keys[currentConfig.llm.provider]) { currentConfig.api_keys[currentConfig.llm.provider] = currentConfig.llm.api_key; }
            }
            if (currentConfig.llm.provider) {
                var provEl = document.getElementById("llm-provider");
                if (provEl) { provEl.value = currentConfig.llm.provider; provEl.dispatchEvent(new Event("change")); }
            }
            if (currentConfig.llm.model) {
                setTimeout(function() { 
                    var sel = document.getElementById("llm-model");
                    if (sel) sel.value = currentConfig.llm.model; 
                    if (currentConfig.llm.provider === "openrouter") {
                        orSelectedModel = currentConfig.llm.model;
                        var nameEl = document.getElementById("or-active-model-name");
                        if (nameEl) nameEl.textContent = currentConfig.llm.model;
                    }
                }, 50);
            }
            if (currentConfig.llm.system_prompt != null) {
                var sp = document.getElementById("settings-system-prompt");
                if (sp) sp.value = currentConfig.llm.system_prompt;
            }
        }
        if (currentConfig.channels) {
            if (currentConfig.channels.telegram && currentConfig.channels.telegram.token) {
                var tgStatus = document.getElementById("tg-status");
                if (tgStatus) tgStatus.textContent = "Token Configured";
            }
        }
        if (currentConfig.settings) {
            var s = currentConfig.settings;
            if (s.autonomy) { var autEl = document.getElementById("set-autonomy"); if (autEl) autEl.value = s.autonomy; }
            if (s.identity !== undefined) {
                activePersonaIndex = parseInt(s.identity);
                if (isNaN(activePersonaIndex)) activePersonaIndex = -1;
            }
        }
    }

    // ==========================================
    // LLM PROVIDERS & KEYS
    // ==========================================
    var providerModels = {
        openai: ["gpt-4o", "gpt-4o-mini"],
        anthropic: ["claude-3.5-sonnet-20241022", "claude-3-haiku-20240307"],
        google: ["gemini-2.5-pro", "gemini-2.0-flash"],
        groq: ["llama-3.3-70b-versatile"],
        ollama: ["llama3.2", "mistral"],
        deepseek: ["deepseek-chat", "deepseek-reasoner"],
        mistral: ["mistral-large-latest", "codestral-latest"],
        inception: ["mercury-2"]
    };

    var orModels = [];
    var orSelectedModel = "";
    var orSortKey = "name";
    var orSortDir = 1;

    document.getElementById("llm-provider")?.addEventListener("change", function() {
        var provider = this.value;
        var isOR = provider === "openrouter";
        appendLog("dash-log", "[UI] Provider changed to: " + provider);
        
        var keyInput = document.getElementById("llm-api-key");
        if (keyInput) {
            if (currentConfig.api_keys && currentConfig.api_keys[provider]) { keyInput.value = currentConfig.api_keys[provider]; } 
            else { keyInput.value = ""; }
        }

        var group = document.getElementById("llm-model-group");
        if (group) group.style.display = isOR ? "none" : "block";
        var orArea = document.getElementById("or-models-area");
        
        if (isOR) {
            if (orArea) orArea.classList.remove("hidden");
            if (orModels.length === 0 && keyInput && keyInput.value.length > 10) window.fetchORModels();
        } else {
            if (orArea) orArea.classList.add("hidden");
            var models = providerModels[provider] || [];
            var sel = document.getElementById("llm-model");
            if (sel) {
                sel.innerHTML = "";
                models.forEach(function(m) { var opt = document.createElement("option"); opt.value = m; opt.textContent = m; sel.appendChild(opt); });
            }
        }
    });

    document.getElementById("btn-toggle-key")?.addEventListener("click", function() {
        var input = document.getElementById("llm-api-key");
        if (input.type === "password") { input.type = "text"; this.textContent = "üôà"; } 
        else { input.type = "password"; this.textContent = "üëÅÔ∏è"; }
    });

    async function applyLLMConfig() {
        var provider = document.getElementById("llm-provider").value;
        var apiKey = document.getElementById("llm-api-key").value.trim();
        var model = provider === "openrouter" ? orSelectedModel : document.getElementById("llm-model").value;
        
        if (!apiKey && provider !== "ollama") { showToast("API key is required", "error"); return; }
        if (provider === "openrouter" && !model) { showToast("Select a model from the list first", "error"); return; }

        if (!currentConfig.api_keys) currentConfig.api_keys = {};
        currentConfig.api_keys[provider] = apiKey;

        if (!currentConfig.llm) currentConfig.llm = {};
        currentConfig.llm.provider = provider;
        currentConfig.llm.api_key = apiKey;
        currentConfig.llm.model = model;
        
        await saveAllConfig();
        showToast("LLM Configuration Saved", "success");
        
        var r1 = document.getElementById("or-save-reminder"); if (r1) r1.classList.remove("visible");
        var r2 = document.getElementById("llm-save-reminder"); if (r2) r2.classList.remove("visible");
    }

    async function testLLMConfig() {
        var apiKey = document.getElementById("llm-api-key").value.trim();
        if (!apiKey) { showToast("Enter an API key first", "error"); return; }
        showToast("Testing...", "info");
        try {
            var resp = await fetch("https://openrouter.ai/api/v1/models", { headers: { "Authorization": "Bearer " + apiKey } });
            if (resp.ok) showToast("API key is valid!", "success");
            else showToast("Invalid API key", "error");
        } catch(e) { showToast("Test failed", "error"); }
    }

    window.fetchORModels = function() {
        var listEl = document.getElementById("or-model-list");
        if (listEl) listEl.innerHTML = '<div style="padding:1rem;text-align:center;color:var(--text-dim);"><span class="spinner">‚ü≥</span> Loading...</div>';
        fetch("https://openrouter.ai/api/v1/models").then(function(r) { return r.json(); }).then(function(data) {
            orModels = (data.data || []).map(function(m) { return { id: m.id, name: m.name, input: parseFloat(m.pricing.prompt||"0"), output: parseFloat(m.pricing.completion||"0") }; });
            renderORModels();
        }).catch(function() { if (listEl) listEl.innerHTML = "Failed to load models"; });
    };

    window.sortORModels = function(key) {
        if (orSortKey === key) { orSortDir *= -1; } else { orSortKey = key; orSortDir = 1; }
        renderORModels();
    };

    function renderORModels() {
        var searchEl = document.getElementById("or-model-search");
        var search = searchEl ? searchEl.value.toLowerCase() : "";
        var filtered = orModels.filter(function(m) { return m.id.toLowerCase().indexOf(search) >= 0 || m.name.toLowerCase().indexOf(search) >= 0; });
        filtered.sort(function(a, b) {
            var cmp = 0;
            if (orSortKey === "name") cmp = a.name.localeCompare(b.name);
            else if (orSortKey === "input") cmp = a.input - b.input;
            else if (orSortKey === "output") cmp = a.output - b.output;
            return cmp * orSortDir;
        });

        var html = '<table style="width:100%;font-size:0.8rem;text-align:left;border-collapse:collapse;">';
        filtered.slice(0, 100).forEach(function(m) {
            var sel = m.id === orSelectedModel;
            var bg = sel ? "background:rgba(16,185,129,0.15);" : "";
            html += '<tr data-model-id="' + escapeHtml(m.id) + '" style="cursor:pointer;border-bottom:1px solid var(--border);' + bg + '" class="or-model-row">';
            html += '<td style="padding:0.5rem;">' + escapeHtml(m.name) + '<br><span style="color:var(--text-dim);font-size:0.7rem;">' + escapeHtml(m.id) + '</span></td>';
            html += '<td style="padding:0.5rem;font-family:monospace;text-align:right;">$' + (m.input*1000000).toFixed(2) + '</td>';
            html += '<td style="padding:0.5rem;font-family:monospace;text-align:right;">$' + (m.output*1000000).toFixed(2) + '</td></tr>';
        });
        html += '</table>';
        var listEl = document.getElementById("or-model-list");
        if (listEl) listEl.innerHTML = html;
    }

    document.getElementById("or-model-list")?.addEventListener("click", function(e) {
        var row = e.target.closest(".or-model-row");
        if (row) {
            orSelectedModel = row.getAttribute("data-model-id");
            var nameEl = document.getElementById("or-active-model-name");
            if (nameEl) nameEl.textContent = orSelectedModel;
            var reminder = document.getElementById("or-save-reminder"); if (reminder) reminder.classList.add("visible");
            renderORModels();
        }
    });

    // ==========================================
    // PERSONAS & SETTINGS
    // ==========================================
    function renderPersonas() {
        var sel = document.getElementById("set-identity");
        if (sel) {
            sel.innerHTML = '<option value="-1">‚Äî BambooClaw Default (System Prompt Only) ‚Äî</option>';
            personas.forEach(function(p, i) {
                var opt = document.createElement("option"); opt.value = i; opt.textContent = p.name;
                if (i === activePersonaIndex) opt.selected = true;
                sel.appendChild(opt);
            });
            sel.value = activePersonaIndex >= 0 ? activePersonaIndex : -1;
        }

        var listEl = document.getElementById("persona-list");
        if (!listEl) return;
        if (personas.length === 0) { listEl.innerHTML = '<p style="font-size:0.8rem;color:var(--text-dim);">No personas created.</p>'; return; }
        
        var html = '';
        personas.forEach(function(p, i) {
            var isActive = i === activePersonaIndex;
            html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:0.6rem;border:1px solid ' + (isActive ? 'var(--accent)' : 'var(--border)') + ';margin-bottom:0.5rem;border-radius:6px;background:' + (isActive ? 'rgba(16,185,129,0.05)' : 'transparent') + ';">';
            html += '<div style="flex:1;"><strong>' + escapeHtml(p.name) + '</strong><br><span style="font-size:0.7rem;color:var(--text-dim);">' + escapeHtml(p.prompt.substring(0, 60)) + '...</span></div>';
            html += '<div><button type="button" class="btn btn-sm btn-outline" onclick="window.editPersona(' + i + ')">‚úé</button> <button type="button" class="btn btn-sm btn-outline" style="color:var(--error);" onclick="window.deletePersona(' + i + ')">‚úï</button></div>';
            html += '</div>';
        });
        listEl.innerHTML = html;
    }

    window.editPersona = function(idx) {
        var p = personas[idx];
        document.getElementById("new-persona-name").value = p.name;
        document.getElementById("new-persona-prompt").value = p.prompt;
        document.getElementById("btn-create-persona").textContent = "Update Persona";
        document.getElementById("btn-cancel-edit-persona").classList.remove("hidden");
        editingPersonaIndex = idx;
        document.getElementById("persona-details-block").open = true;
    };

    document.getElementById("btn-cancel-edit-persona")?.addEventListener("click", function() {
        document.getElementById("new-persona-name").value = "";
        document.getElementById("new-persona-prompt").value = "";
        document.getElementById("btn-create-persona").textContent = "Save Persona";
        this.classList.add("hidden");
        editingPersonaIndex = -1;
    });

    document.getElementById("btn-create-persona")?.addEventListener("click", function() {
        var name = document.getElementById("new-persona-name").value.trim();
        var prompt = document.getElementById("new-persona-prompt").value.trim();
        if (!name || !prompt) { showToast("Name and instructions required", "error"); return; }
        
        if (editingPersonaIndex >= 0) {
            personas[editingPersonaIndex] = { name: name, prompt: prompt };
            showToast("Persona updated", "success");
        } else {
            personas.push({ name: name, prompt: prompt });
            activePersonaIndex = personas.length - 1; 
            if (!currentConfig.settings) currentConfig.settings = {};
            currentConfig.settings.identity = String(activePersonaIndex);
            showToast("Persona created and activated", "success");
        }
        
        saveAllConfig();
        renderPersonas();
        document.getElementById("btn-cancel-edit-persona").click(); 
    });

    window.deletePersona = function(idx) {
        if (!confirm("Delete the persona '" + personas[idx].name + "'?")) return;
        personas.splice(idx, 1);
        if (activePersonaIndex === idx) activePersonaIndex = -1;
        else if (activePersonaIndex > idx) activePersonaIndex--;
        
        if (!currentConfig.settings) currentConfig.settings = {};
        currentConfig.settings.identity = String(activePersonaIndex);
        
        saveAllConfig();
        renderPersonas();
    };

    async function saveSettings() {
        var identVal = document.getElementById("set-identity").value;
        if (!currentConfig.settings) currentConfig.settings = {};
        
        currentConfig.settings.autonomy = document.getElementById("set-autonomy").value;
        currentConfig.settings.identity = identVal;
        currentConfig.settings.maxToolIterations = parseInt(document.getElementById("set-tool-iterations")?.value) || 10;
        
        if (!currentConfig.llm) currentConfig.llm = { provider: "openai", api_key: "", model: "", system_prompt: "" };
        currentConfig.llm.system_prompt = document.getElementById("settings-system-prompt").value;
        
        await saveAllConfig();
        showToast("Settings saved", "success");
        var sr = document.getElementById("settings-save-reminder"); if (sr) sr.classList.remove("visible");
    }

    // ==========================================
    // SKILLS & COMPOSIO ENGINE (RESTORED)
    // ==========================================
    var COMPOSIO_API_URL = "https://backend.composio.dev/api/v3";
    var enabledSkills = {};
    var composioTools = [];
    var composioToolkits = [];
    var composioCategories = ["All"];
    var composioActiveCategory = "All";
    var composioToolkitDetails = {};

    function sanitizeToolSchema(rawParams) {
        if (!rawParams || typeof rawParams !== "object") return { type: "object", properties: {}, required: [], additionalProperties: false };
        var p; try { p = JSON.parse(JSON.stringify(rawParams)); } catch(e) { return { type: "object", properties: {}, required: [], additionalProperties: false }; }
        function cleanProp(obj) {
            if (!obj || typeof obj !== "object") return obj;
            if (Array.isArray(obj)) return obj.map(cleanProp);
            var badKeys = ["$ref", "$defs", "$schema", "$id", "default", "examples", "example", "title", "format", "readOnly", "writeOnly", "deprecated", "externalDocs", "xml", "discriminator", "minLength", "maxLength", "minimum", "maximum", "exclusiveMinimum", "exclusiveMaximum", "multipleOf", "pattern", "minItems", "maxItems", "uniqueItems", "minProperties", "maxProperties", "const", "contentMediaType", "contentEncoding", "if", "then", "else", "not"];
            badKeys.forEach(function(k) { delete obj[k]; });
            if (obj.allOf && Array.isArray(obj.allOf) && obj.allOf.length === 1) { var inner = cleanProp(obj.allOf[0]); delete obj.allOf; Object.keys(inner).forEach(function(k) { if (!obj[k]) obj[k] = inner[k]; }); }
            else if (obj.allOf) { obj.allOf.forEach(function(item) { var cleaned = cleanProp(item); if (cleaned.properties) { if (!obj.properties) obj.properties = {}; Object.keys(cleaned.properties).forEach(function(pk) { obj.properties[pk] = cleaned.properties[pk]; }); } if (cleaned.required && Array.isArray(cleaned.required)) { if (!obj.required) obj.required = []; cleaned.required.forEach(function(r) { if (obj.required.indexOf(r) < 0) obj.required.push(r); }); } }); delete obj.allOf; }
            if (obj.properties && typeof obj.properties === "object") { Object.keys(obj.properties).forEach(function(k) { obj.properties[k] = cleanProp(obj.properties[k]); }); }
            if (obj.items) obj.items = cleanProp(obj.items);
            if (obj.anyOf && Array.isArray(obj.anyOf) && obj.anyOf.length > 0) { var first = cleanProp(obj.anyOf[0]); delete obj.anyOf; Object.keys(first).forEach(function(fk) { if (!obj[fk]) obj[fk] = first[fk]; }); }
            if (obj.oneOf && Array.isArray(obj.oneOf) && obj.oneOf.length > 0) { var first2 = cleanProp(obj.oneOf[0]); delete obj.oneOf; Object.keys(first2).forEach(function(fk) { if (!obj[fk]) obj[fk] = first2[fk]; }); }
            if (Array.isArray(obj.type)) obj.type = obj.type.find(function(t) { return t !== "null"; }) || "string";
            return obj;
        }
        p = cleanProp(p);
        if (!p.type) p.type = "object";
        if (!p.properties) p.properties = {};
        if (!p.required) p.required = [];
        p.additionalProperties = false;
        p.required = p.required.filter(function(r) { return p.properties.hasOwnProperty(r); });
        return p;
    }

    function renderActiveToolsSummary() {
        var badge = document.getElementById("active-tools-count-badge");
        var listEl = document.getElementById("active-tools-list");
        if (!badge || !listEl) return;
        var enabledCount = 0, html = "";
        Object.keys(enabledSkills).forEach(function(k) {
            if (enabledSkills[k]) {
                enabledCount++;
                var isComposio = k.startsWith("composio_");
                var dotClass = isComposio ? "composio" : "builtin";
                var label = isComposio ? k.replace("composio_", "") : k;
                var toolCount = 0;
                agentTools.forEach(function(t) { if (isComposio) { if (t.function.name.indexOf(k.replace("composio_", "")) > -1) toolCount++; } else if (t._source === k || t.function.name === k) toolCount++; });
                var suffix = toolCount > 0 ? " (" + toolCount + " tools)" : "";
                html += '<div class="active-tool-entry"><span class="tool-dot ' + dotClass + '"></span>' + escapeHtml(label) + '<span style="color:var(--text-dim);font-size:0.7rem;margin-left:0.3rem;">' + suffix + '</span></div>';
            }
        });
        badge.textContent = enabledCount;
        if (!html) html = '<div style="color:var(--text-dim);font-size:0.75rem;padding:0.25rem 0;">No tools loaded</div>';
        listEl.innerHTML = html;
    }

    async function checkComposioConnection(slug) {
        var composioKey = currentConfig.composioApiKey;
        if (!composioKey) return;
        try {
            var endpoint = COMPOSIO_API_URL + "/connected_accounts?toolkit=" + encodeURIComponent(slug);
            var resultJson = "";
            if (window.__TAURI__) resultJson = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-H", "x-api-key: " + composioKey, endpoint] });
            else { var resp = await fetch(endpoint, { headers: { "x-api-key": composioKey } }); resultJson = await resp.text(); }
            var data = JSON.parse(resultJson);
            var accounts = data.items || data.results || [];
            if (Array.isArray(data)) accounts = data;
            var hasConnection = accounts.length > 0;
            for (var i = 0; i < composioToolkits.length; i++) { if (composioToolkits[i].slug === slug) { composioToolkits[i].auth_warning = !hasConnection; break; } }
            renderComposioToolkits();
        } catch(e) {}
    }

    function showConnectionModal(slug) {
        var existing = document.getElementById("conn-modal-overlay");
        if (existing) existing.remove();

        var tk = null;
        for (var i = 0; i < composioToolkits.length; i++) { if (composioToolkits[i].slug === slug) { tk = composioToolkits[i]; break; } }
        var name = tk ? (tk.meta_name || tk.name || slug) : slug;

        var overlay = document.createElement("div");
        overlay.id = "conn-modal-overlay";
        overlay.className = "conn-modal-overlay visible";
        overlay.innerHTML = '<div class="conn-modal"><h3>Connect ' + escapeHtml(name) + '</h3><p>Link your account so the agent can use its tools on your behalf.</p><label for="conn-api-key">API Key / Access Token</label><input type="password" id="conn-api-key" placeholder="Paste your API key or token here" /><div class="conn-modal-actions" style="margin-bottom:0.75rem;"><button type="button" class="btn-connect" id="conn-btn-save-key">Connect with API Key</button></div><div class="conn-or">‚Äî or ‚Äî</div><button type="button" class="btn-oauth" id="conn-btn-oauth">üîó Connect via OAuth (opens browser)</button><div class="conn-modal-actions" style="margin-top:1rem;"><button type="button" class="btn-cancel" id="conn-btn-cancel">Cancel</button></div></div>';
        document.body.appendChild(overlay);

        overlay.addEventListener("click", function(e) { if (e.target === overlay) overlay.remove(); });
        document.getElementById("conn-btn-cancel").addEventListener("click", function() { overlay.remove(); });

        document.getElementById("conn-btn-save-key").addEventListener("click", async function() {
            var apiKeyInput = document.getElementById("conn-api-key");
            var key = apiKeyInput ? apiKeyInput.value.trim() : "";
            if (!key) { showToast("Please enter an API key or token", "error"); return; }
            var composioKey = currentConfig.composioApiKey;
            if (!composioKey) { showToast("Set your Composio API key first", "error"); return; }
            showToast("Connecting " + slug + "...", "info");
            try {
                var intEndpoint = COMPOSIO_API_URL + "/integrations?appName=" + encodeURIComponent(slug);
                var intJson = "";
                if (window.__TAURI__) intJson = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-H", "x-api-key: " + composioKey, intEndpoint] });
                else { var intResp = await fetch(intEndpoint, { headers: { "x-api-key": composioKey } }); intJson = await intResp.text(); }
                var intData = JSON.parse(intJson);
                var integrations = intData.items || intData || [];
                if (!integrations.length) { showToast("No integration found for " + slug + ".", "error"); return; }
                var connEndpoint = COMPOSIO_API_URL + "/connectedAccounts";
                var connBody = JSON.stringify({ integrationId: integrations[0].id, entityId: "default", data: { api_key: key, token: key, access_token: key } });
                var connJson = "";
                if (window.__TAURI__) connJson = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-X", "POST", "-H", "x-api-key: " + composioKey, "-H", "Content-Type: application/json", "-d", connBody, connEndpoint] });
                else { var connResp = await fetch(connEndpoint, { method: "POST", headers: { "x-api-key": composioKey, "Content-Type": "application/json" }, body: connBody }); connJson = await connResp.text(); }
                var connData = JSON.parse(connJson);
                if (connData.connectionStatus === "ACTIVE" || connData.status === "ACTIVE" || connData.id) {
                    showToast(slug + " connected successfully!", "success");
                    for (var i = 0; i < composioToolkits.length; i++) { if (composioToolkits[i].slug === slug) { composioToolkits[i].auth_warning = false; break; } }
                    renderComposioToolkits(); renderEnabledIntegrations(); overlay.remove();
                } else if (connData.redirectUrl) {
                    showToast("This service requires OAuth. Opening authorization page...", "info");
                    if (window.__TAURI__) { try { var opener = (window.__TAURI__.opener && window.__TAURI__.opener.openUrl) || (window.__TAURI__.shell && window.__TAURI__.shell.open); if (opener) opener(connData.redirectUrl); } catch(e) {} } else window.open(connData.redirectUrl, "_blank");
                    setTimeout(function() { checkComposioConnection(slug); }, 15000); overlay.remove();
                } else { showToast("Connection attempt returned unexpected response.", "error"); }
            } catch(e) { showToast("Connection error", "error"); }
        });

        document.getElementById("conn-btn-oauth").addEventListener("click", function() { overlay.remove(); performComposioOAuth(slug); });
    }

    async function performComposioOAuth(slug) {
        var composioKey = currentConfig.composioApiKey;
        if (!composioKey) { showToast("Set your Composio API key first", "error"); return; }
        showToast("Connecting " + slug + "...", "info");
        try {
            var intEndpoint = COMPOSIO_API_URL + "/integrations?appName=" + encodeURIComponent(slug);
            var intJson = "";
            if (window.__TAURI__) intJson = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-H", "x-api-key: " + composioKey, intEndpoint] });
            else { var intResp = await fetch(intEndpoint, { headers: { "x-api-key": composioKey } }); intJson = await intResp.text(); }
            var intData = JSON.parse(intJson);
            var integrations = intData.items || intData || [];
            if (!integrations.length) {
                showToast("No integration found for " + slug + ".", "error");
                var fallbackUrl = "https://app.composio.dev/apps/" + slug;
                if (window.__TAURI__) { try { var opener = (window.__TAURI__.opener && window.__TAURI__.opener.openUrl) || (window.__TAURI__.shell && window.__TAURI__.shell.open); if (opener) opener(fallbackUrl); } catch(e) {} } else window.open(fallbackUrl, "_blank");
                return;
            }
            var connEndpoint = COMPOSIO_API_URL + "/connectedAccounts";
            var connBody = JSON.stringify({ integrationId: integrations[0].id, entityId: "default" });
            var connJson = "";
            if (window.__TAURI__) connJson = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-X", "POST", "-H", "x-api-key: " + composioKey, "-H", "Content-Type: application/json", "-d", connBody, connEndpoint] });
            else { var connResp = await fetch(connEndpoint, { method: "POST", headers: { "x-api-key": composioKey, "Content-Type": "application/json" }, body: connBody }); connJson = await connResp.text(); }
            var connData = JSON.parse(connJson);
            if (connData.redirectUrl) {
                showToast("Opening authorization page for " + slug + "...", "success");
                if (window.__TAURI__) { try { var opener = (window.__TAURI__.opener && window.__TAURI__.opener.openUrl) || (window.__TAURI__.shell && window.__TAURI__.shell.open); if (opener) opener(connData.redirectUrl); } catch(e) {} } else window.open(connData.redirectUrl, "_blank");
                setTimeout(function() { checkComposioConnection(slug); }, 15000);
            } else if (connData.connectionStatus === "ACTIVE") {
                showToast(slug + " already connected!", "success");
                for (var i = 0; i < composioToolkits.length; i++) { if (composioToolkits[i].slug === slug) { composioToolkits[i].auth_warning = false; break; } }
                renderComposioToolkits();
            } else { showToast("Could not initiate connection.", "error"); }
        } catch(e) { showToast("Connection error", "error"); }
    }

    async function fetchToolkitTriggers(slug) {
        var composioKey = currentConfig.composioApiKey;
        if (!composioKey) return;
        try {
            var endpoint = COMPOSIO_API_URL + "/triggers?toolkit=" + encodeURIComponent(slug) + "&limit=50";
            var resultJson = "";
            if (window.__TAURI__) resultJson = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-H", "x-api-key: " + composioKey, endpoint] });
            else { var resp = await fetch(endpoint, { headers: { "x-api-key": composioKey } }); resultJson = await resp.text(); }
            var data = JSON.parse(resultJson);
            composioToolkitDetails[slug + "_triggers"] = data.items || [];
            renderToolkitTriggers(slug);
        } catch(e) {}
    }

    function renderToolkitTriggers(slug) {
        var el = document.getElementById("toolkit-triggers-" + slug);
        if (!el) return;
        var triggers = composioToolkitDetails[slug + "_triggers"];
        if (!triggers || triggers.length === 0) { el.innerHTML = ""; return; }
        var html = '<div style="font-size:0.7rem;font-weight:600;color:var(--warning);margin-top:0.75rem;margin-bottom:0.3rem;">‚ö° Triggers (' + triggers.length + '):</div>';
        triggers.forEach(function(tr) { html += '<div class="trigger-entry"><div class="trigger-name">' + escapeHtml(tr.name || tr.slug || "Unknown") + '</div>' + (tr.description ? '<div class="trigger-desc">' + escapeHtml(tr.description.substring(0, 150)) + (tr.description.length > 150 ? "‚Ä¶" : "") + '</div>' : '') + '</div>'; });
        html += '<div class="trigger-info-banner">‚ö° Triggers require a local webhook endpoint. This feature is coming in a future update.</div>';
        el.innerHTML = html;
    }

    var builtinSkills = [
        { id: "web_browser", icon: "üåê", name: "Web Browser", desc: "Navigate and scrape websites via Playwright" },
        { id: "web_search", icon: "üîç", name: "Web Search", desc: "Search Google, DuckDuckGo, or Bing" },
        { id: "docker", icon: "üê≥", name: "Docker", desc: "Manage containers, images, and volumes" },
        { id: "ssh_remote", icon: "üîë", name: "SSH Remote", desc: "Execute commands on remote servers" },
        { id: "mqtt_bridge", icon: "üì°", name: "MQTT Bridge", desc: "Publish/subscribe to MQTT topics" },
        { id: "serial_port", icon: "üîå", name: "Serial Port", desc: "Read/write to serial devices (Arduino, ESP32)" },
        { id: "b500_telemetry", icon: "üéã", name: "B500 Telemetry", desc: "Monitor BambooCore B500 facility sensors" }
    ];

    function renderBuiltinSkills() {
        var el = document.getElementById("skills-builtin");
        if (!el) return;
        var html = "";
        builtinSkills.forEach(function(s) {
            html += '<div class="skill-card enabled" data-skill-id="' + s.id + '" data-skill-type="builtin"><span class="skill-always-on">Always On</span><div class="skill-icon">' + s.icon + '</div><div class="skill-name">' + escapeHtml(s.name) + '</div><div class="skill-meta"><span style="font-size:0.65rem;color:var(--text-dim);">‚óè Built-in</span><button type="button" class="skill-info-btn" title="Show details">i</button></div><div class="skill-desc-full">' + escapeHtml(s.desc) + '</div></div>';
        });
        el.innerHTML = html;
    }

    function renderComposioToolkits() {
        var el = document.getElementById("skills-composio");
        if (!el) return;
        var search = (document.getElementById("skill-search") ? document.getElementById("skill-search").value : "").toLowerCase();
        var html = "";
        var filtered = composioToolkits.filter(function(tk) {
            if (search && tk.name.toLowerCase().indexOf(search) < 0 && (tk.description || "").toLowerCase().indexOf(search) < 0 && tk.slug.toLowerCase().indexOf(search) < 0) return false;
            if (composioActiveCategory !== "All") { var cats = tk.categories || []; if (cats.indexOf(composioActiveCategory) < 0) return false; }
            return true;
        });
        filtered.forEach(function(tk) {
            var isEnabled = enabledSkills["composio_" + tk.slug] || false;
            var toolCount = tk.tools_count || 0;
            var triggerCount = tk.triggers_count || 0;
            var descDisplay = tk.description || "No description available";
            html += '<div class="skill-card ' + (isEnabled ? 'enabled' : '') + '" data-skill-id="composio_' + tk.slug + '" data-skill-type="composio" data-toolkit-slug="' + tk.slug + '">';
            html += '<button type="button" class="skill-toggle" title="' + (isEnabled ? 'Disable' : 'Enable') + '"></button>';
            var imgSrc = "";
            if (tk.local_logo && window.__TAURI__) {
                var convertFn = (window.__TAURI__.core && window.__TAURI__.core.convertFileSrc) || (window.__TAURI__.tauri && window.__TAURI__.tauri.convertFileSrc) || window.__TAURI__.convertFileSrc;
                if (convertFn) { try { imgSrc = convertFn(tk.local_logo); } catch(ce) {} }
            }
            if (!imgSrc && tk.logo) imgSrc = tk.logo;
            if (imgSrc) html += '<div class="skill-icon"><img src="' + escapeHtml(imgSrc) + '" data-slug="' + escapeHtml(tk.slug) + '" onerror="this.outerHTML=\'<span class=skill-icon>üß©</span>\'" /></div>';
            else html += '<div class="skill-icon">üß©</div>';
            html += '<div class="skill-name">' + escapeHtml(tk.name) + '</div><div class="skill-meta">';
            if (toolCount > 0) html += '<span style="font-size:0.65rem;color:var(--accent);">‚óè ' + toolCount + ' tools</span>';
            if (triggerCount > 0) html += '<span style="font-size:0.65rem;color:var(--warning);">‚ö° ' + triggerCount + ' triggers</span>';
            html += '<button type="button" class="skill-info-btn" title="Show details">i</button></div>';
            if (tk.auth_warning) html += '<div class="auth-warning-badge">‚ö† Not connected ‚Äî <span style="cursor:pointer;text-decoration:underline;" data-connect-slug="' + escapeHtml(tk.slug) + '">link account</span></div>';
            html += '<div class="skill-desc-full" data-toolkit-slug="' + tk.slug + '"><div>' + escapeHtml(descDisplay) + '</div><div class="toolkit-tools-list" id="toolkit-tools-' + tk.slug + '"><div style="color:var(--text-dim);font-size:0.65rem;padding:0.3rem 0;">Click to load tools...</div></div><div id="toolkit-triggers-' + tk.slug + '"></div></div></div>';
        });
        if (!html) html = '<div style="color:var(--text-dim);font-size:0.85rem;padding:0.5rem;">No matching toolkits</div>';
        el.innerHTML = html;
        el.querySelectorAll("span[data-connect-slug]").forEach(function(span) { span.addEventListener("click", function(e) { e.stopPropagation(); showConnectionModal(span.dataset.connectSlug); }); });
    }

    function renderComposioCategories() {
        var el = document.getElementById("composio-category-tabs");
        if (!el) return;
        var html = "";
        composioCategories.forEach(function(cat) {
            var active = cat === composioActiveCategory;
            html += '<button type="button" class="btn btn-sm ' + (active ? '' : 'btn-outline') + '" style="font-size:0.75rem;" data-composio-cat="' + escapeHtml(cat) + '">' + escapeHtml(cat) + '</button>';
        });
        el.innerHTML = html;
    }

    function renderAllSkills() { renderBuiltinSkills(); renderComposioToolkits(); renderComposioCategories(); renderEnabledIntegrations(); }

    function renderEnabledIntegrations() {
        var section = document.getElementById("enabled-integrations-section");
        var grid = document.getElementById("skills-enabled-integrations");
        if (!section || !grid) return;
        var html = "", count = 0;
        Object.keys(enabledSkills).forEach(function(k) {
            if (!enabledSkills[k] || !k.startsWith("composio_")) return;
            count++;
            var slug = k.replace("composio_", "");
            var tk = null;
            for (var i = 0; i < composioToolkits.length; i++) { if (composioToolkits[i].slug === slug) { tk = composioToolkits[i]; break; } }
            var name = tk ? (tk.meta_name || tk.name || slug) : slug;
            var imgSrc = "";
            if (tk && tk.local_logo && window.__TAURI__) {
                var convertFn = (window.__TAURI__.core && window.__TAURI__.core.convertFileSrc) || (window.__TAURI__.tauri && window.__TAURI__.tauri.convertFileSrc) || window.__TAURI__.convertFileSrc;
                if (convertFn) { try { imgSrc = convertFn(tk.local_logo); } catch(ce) {} }
            }
            if (!imgSrc && tk && tk.logo) imgSrc = tk.logo;
            var logoHtml = imgSrc ? '<div class="skill-icon"><img src="' + escapeHtml(imgSrc) + '" onerror="this.outerHTML=\'<span class=skill-icon>üß©</span>\'" /></div>' : '<div class="skill-icon">üß©</div>';
            var toolCount = 0;
            agentTools.forEach(function(t) { if (t.function.name.indexOf(slug) > -1) toolCount++; });
            var countLabel = toolCount > 0 ? '<span style="font-size:0.7rem;color:var(--text-dim);">' + toolCount + ' tools</span>' : '';
            html += '<div class="skill-card" style="cursor:pointer;" onclick="window.toggleSkill(\'' + k + '\')"><div style="display:flex;align-items:center;gap:0.5rem;">' + logoHtml + '<div style="flex:1;"><div style="font-size:0.85rem;font-weight:600;">' + escapeHtml(name) + '</div>' + countLabel + '</div><span style="color:#ef4444;font-size:0.7rem;cursor:pointer;" title="Click to disable">‚úï</span></div>';
            if (tk && tk.auth_warning) html += '<div class="auth-warning-badge">‚ö† Not connected ‚Äî <span style="cursor:pointer;text-decoration:underline;" data-connect-slug="' + escapeHtml(slug) + '">link account</span></div>';
            html += '</div>';
        });
        if (count > 0) {
            section.style.display = ""; grid.innerHTML = html;
            grid.querySelectorAll("span[data-connect-slug]").forEach(function(span) { span.addEventListener("click", function(e) { e.stopPropagation(); showConnectionModal(span.dataset.connectSlug); }); });
        } else { section.style.display = "none"; grid.innerHTML = ""; }
    }

    var logosDir = "";
    async function ensureLogosDir() {
        if (logosDir) return logosDir;
        if (!window.__TAURI__) return "";
        try {
            var home = await tauriInvoke("get_home_dir", {});
            if (!home) return "";
            var sep = (detectedOS === "windows") ? "\\" : "/";
            logosDir = home.replace(/[\\/]+$/, "") + sep + "bambooclaw" + sep + "logos";
            await tauriInvoke("run_shell_command", { commandName: (detectedOS === "windows") ? "cmd" : "sh", args: (detectedOS === "windows") ? ["/c", "mkdir", logosDir, "2>nul"] : ["-c", "mkdir -p \"" + logosDir + "\""] }).catch(function() {});
            return logosDir;
        } catch(e) { return ""; }
    }

    async function cacheToolkitLogos() {
        var dir = await ensureLogosDir();
        if (!dir) return;
        var sep = (detectedOS === "windows") ? "\\" : "/";
        var toDownload = [];
        for (var i = 0; i < composioToolkits.length; i++) {
            var tk = composioToolkits[i];
            if (!tk.logo) continue;
            var ext = tk.logo.indexOf(".svg") > -1 ? ".svg" : ".png";
            var localPath = dir + sep + tk.slug + ext;
            tk.local_logo_path = localPath;
            toDownload.push({ idx: i, slug: tk.slug, url: tk.logo, path: localPath });
        }
        var batchSize = 15;
        for (var b = 0; b < toDownload.length; b += batchSize) {
            var batch = toDownload.slice(b, b + batchSize);
            var promises = batch.map(function(item) {
                return invokeShort("run_shell_command", {
                    commandName: (detectedOS === "windows") ? "cmd" : "sh",
                    args: (detectedOS === "windows") ? ["/c", "if", "exist", item.path, "(echo", "EXISTS)", "else", "(echo", "MISSING)"] : ["-c", "test -f \"" + item.path + "\" && echo EXISTS || echo MISSING"]
                }).then(function(result) {
                    if (result && result.indexOf("EXISTS") > -1) { composioToolkits[item.idx].local_logo = item.path; return; }
                    return invokeShort("run_shell_command", { commandName: "curl", args: ["-sL", "-o", item.path, item.url] }).then(function() { composioToolkits[item.idx].local_logo = item.path; }).catch(function(e) {});
                }).catch(function(e) {});
            });
            await Promise.allSettled(promises);
        }
        renderComposioToolkits();
    }

    async function testImageConnectivity() { if (!window.__TAURI__) return; var img = new Image(); img.src = "https://assets.composio.dev/logos/slack.png"; }

    window.toggleSkill = function(skillId) {
        enabledSkills[skillId] = !enabledSkills[skillId];
        currentConfig.enabledSkills = enabledSkills;
        saveAllConfig();
        renderAllSkills();

        if (enabledSkills[skillId]) {
            if (skillId.startsWith("composio_")) fetchToolkitTools(skillId.replace("composio_", ""));
            else rebuildBuiltinTools();
            var name = skillId.startsWith("composio_") ? skillId.replace("composio_", "") : skillId;
            showToast(name + " enabled", "success");
        } else {
            agentTools = agentTools.filter(function(t) { return !t.function.name.startsWith("composio_"); });
            Object.keys(enabledSkills).forEach(function(sk) {
                if (!enabledSkills[sk] || !sk.startsWith("composio_")) return;
                var skSlug = sk.replace("composio_", "");
                var cached = composioToolkitDetails[skSlug];
                if (cached) {
                    cached.forEach(function(tool) {
                        var rawP = tool.input_parameters || tool.parameters || { type: "object", properties: {}, required: [] };
                        var params = sanitizeToolSchema(rawP);
                        var realSlug = tool.slug || tool.name || "";
                        var safeName = ("composio_" + realSlug.replace(/[^a-zA-Z0-9_-]/g, "_")).substring(0, 64);
                        window.composioToolMap = window.composioToolMap || {};
                        window.composioToolMap[safeName] = realSlug;
                        agentTools.push({ type: "function", function: { name: safeName, description: (tool.description || tool.name || skSlug + " tool").substring(0, 1024), parameters: params } });
                    });
                }
            });
            rebuildBuiltinTools();
            var name = skillId.startsWith("composio_") ? skillId.replace("composio_", "") : skillId;
            showToast(name + " disabled", "info");
        }
        renderActiveToolsSummary();
        renderEnabledIntegrations();
    };

    async function fetchToolkitTools(slug) {
        var composioKey = currentConfig.composioApiKey;
        if (!composioKey) return;
        try {
            var toolsJson = "";
            var endpoint = COMPOSIO_API_URL + "/tools?toolkit=" + encodeURIComponent(slug) + "&limit=200";
            if (window.__TAURI__) toolsJson = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-H", "x-api-key: " + composioKey, endpoint] });
            else { var resp = await fetch(endpoint, { headers: { "x-api-key": composioKey } }); toolsJson = await resp.text(); }
            var data = JSON.parse(toolsJson);
            var tools = data.items || [];
            composioToolkitDetails[slug] = tools;

            agentTools = agentTools.filter(function(t) { return !t.function.name.startsWith("composio_"); });

            Object.keys(enabledSkills).forEach(function(skillId) {
                if (!enabledSkills[skillId] || !skillId.startsWith("composio_")) return;
                var sk = skillId.replace("composio_", "");
                var cachedTools = composioToolkitDetails[sk];
                if (cachedTools) {
                    cachedTools.forEach(function(tool) {
                        var rawParams = tool.input_parameters || tool.parameters || { type: "object", properties: {}, required: [] };
                        var params = sanitizeToolSchema(rawParams);
                        var realSlug = tool.slug || tool.name || "";
                        var safeName = ("composio_" + realSlug.replace(/[^a-zA-Z0-9_-]/g, "_")).substring(0, 64);
                        window.composioToolMap = window.composioToolMap || {};
                        window.composioToolMap[safeName] = realSlug;
                        agentTools.push({ type: "function", function: { name: safeName, description: (tool.description || tool.name || sk + " tool").substring(0, 1024) + " [via Composio " + sk + "]", parameters: params } });
                    });
                }
            });

            showToast(slug + ": " + tools.length + " tools added to agent", "success");
            renderActiveToolsSummary();
            renderEnabledIntegrations();
            checkComposioConnection(slug);
            fetchToolkitTriggers(slug);
            renderToolkitToolsList(slug);
        } catch(e) {
            agentTools.push({ type: "function", function: { name: "composio_" + slug, description: "Use " + slug + " via Composio. Describe the action you want to perform.", parameters: { type: "object", properties: { action: { type: "string", description: "What to do (natural language)" } }, required: ["action"], additionalProperties: false } } });
        }
    }

    function renderToolkitToolsList(slug) {
        var el = document.getElementById("toolkit-tools-" + slug);
        if (!el) return;
        var tools = composioToolkitDetails[slug];
        if (!tools || tools.length === 0) { el.innerHTML = '<div style="color:var(--text-dim);font-size:0.65rem;padding:0.3rem 0;">No tools found for this toolkit.</div>'; return; }
        var html = '<div style="font-size:0.7rem;font-weight:600;color:var(--text);margin-bottom:0.3rem;">Tools (' + tools.length + '):</div>';
        tools.forEach(function(tool, idx) {
            var toolSlug = tool.slug || ""; var toolName = tool.name || toolSlug; var toolDesc = tool.description || "";
            var params = tool.input_parameters || tool.parameters || {}; var props = params.properties || {}; var reqList = params.required || [];
            var outParams = tool.output_parameters || {}; var outProps = outParams.properties || {};

            html += '<div class="toolkit-tool-row" data-tool-idx="' + idx + '" data-toolkit-slug="' + slug + '"><div class="tool-header"><span class="tool-name">‚ñ∏ ' + escapeHtml(toolName) + '</span></div><div class="tool-slug">' + escapeHtml(toolSlug) + '</div>';
            if (toolDesc) html += '<div class="tool-desc">' + escapeHtml(toolDesc.substring(0, 120)) + (toolDesc.length > 120 ? "‚Ä¶" : "") + '</div>';
            html += '<div class="toolkit-tool-params" id="tool-params-' + slug + '-' + idx + '">';
            var propKeys = Object.keys(props);
            if (propKeys.length > 0) {
                html += '<div style="color:var(--accent);margin-bottom:0.2rem;">Input Parameters:</div>';
                propKeys.forEach(function(pName) {
                    var p = props[pName]; var isReq = reqList.indexOf(pName) >= 0;
                    html += '<div class="param-row"><span class="param-name">' + escapeHtml(pName) + '</span><span class="param-type">' + escapeHtml(p.type || "any") + '</span>';
                    if (isReq) html += '<span class="param-req">required</span>';
                    html += '</div>';
                    if (p.description) html += '<div style="color:var(--text-dim);font-size:0.55rem;padding-left:0.5rem;margin-bottom:0.15rem;">' + escapeHtml(p.description.substring(0, 100)) + '</div>';
                });
            }
            var outKeys = Object.keys(outProps);
            if (outKeys.length > 0) {
                html += '<div style="color:var(--warning);margin-top:0.3rem;margin-bottom:0.2rem;">Output Parameters:</div>';
                outKeys.forEach(function(pName) { html += '<div class="param-row"><span class="param-name">' + escapeHtml(pName) + '</span><span class="param-type">' + escapeHtml(outProps[pName].type || "any") + '</span></div>'; });
            }
            if (propKeys.length === 0 && outKeys.length === 0) html += '<div style="color:var(--text-dim);">No parameters defined</div>';
            html += '</div></div>';
        });
        el.innerHTML = html;
    }

    async function loadToolkitToolsOnDemand(slug) {
        if (composioToolkitDetails[slug]) { renderToolkitToolsList(slug); return; }
        var el = document.getElementById("toolkit-tools-" + slug);
        if (el) el.innerHTML = '<div style="color:var(--text-dim);font-size:0.65rem;padding:0.3rem 0;">Loading tools...</div>';
        var composioKey = currentConfig.composioApiKey;
        if (!composioKey) return;
        try {
            var toolsJson = "";
            var endpoint = COMPOSIO_API_URL + "/tools?toolkit=" + encodeURIComponent(slug) + "&limit=200";
            if (window.__TAURI__) toolsJson = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-H", "x-api-key: " + composioKey, endpoint] });
            else { var resp = await fetch(endpoint, { headers: { "x-api-key": composioKey } }); toolsJson = await resp.text(); }
            var data = JSON.parse(toolsJson);
            composioToolkitDetails[slug] = data.items || [];
            renderToolkitToolsList(slug);
            if (!composioToolkitDetails[slug + "_triggers"]) fetchToolkitTriggers(slug);
            else renderToolkitTriggers(slug);
        } catch(e) { if (el) el.innerHTML = '<div style="color:var(--error);font-size:0.65rem;">Failed to load tools</div>'; }
    }

    function rebuildBuiltinTools() {
        agentTools = agentTools.filter(function(t) { return !["web_browse","web_search","docker_command","ssh_execute","mqtt_publish"].includes(t.function.name); });
        builtinSkills.forEach(function(s) {
            if (!enabledSkills[s.id]) return;
            if (s.id === "web_browser") agentTools.push({ type: "function", function: { name: "web_browse", description: "Open URL in headless browser", parameters: { type: "object", properties: { url: { type: "string" } }, required: ["url"], additionalProperties: false } }});
            else if (s.id === "web_search") agentTools.push({ type: "function", function: { name: "web_search", description: "Search the web", parameters: { type: "object", properties: { query: { type: "string" }, engine: { type: "string" } }, required: ["query"], additionalProperties: false } }});
            else if (s.id === "docker") agentTools.push({ type: "function", function: { name: "docker_command", description: "Docker commands", parameters: { type: "object", properties: { args: { type: "array", items: { type: "string" } } }, required: ["args"], additionalProperties: false } }});
            else if (s.id === "ssh_remote") agentTools.push({ type: "function", function: { name: "ssh_execute", description: "SSH commands", parameters: { type: "object", properties: { host: { type: "string" }, user: { type: "string" }, command: { type: "string" }, port: { type: "number" } }, required: ["host", "user", "command"], additionalProperties: false } }});
            else if (s.id === "mqtt_bridge") agentTools.push({ type: "function", function: { name: "mqtt_publish", description: "MQTT publish", parameters: { type: "object", properties: { broker: { type: "string" }, topic: { type: "string" }, message: { type: "string" } }, required: ["broker", "topic", "message"], additionalProperties: false } }});
        });
        renderActiveToolsSummary();
        renderEnabledIntegrations();
    }

    async function saveComposioKey() {
        var key = document.getElementById("composio-api-key").value.trim();
        if (!key) { showToast("Please enter a Composio API key", "error"); return; }
        currentConfig.composioApiKey = key;
        saveAllConfig();

        var statusEl = document.getElementById("composio-status");
        statusEl.style.display = "block";
        statusEl.innerHTML = '<span style="color:var(--text-dim);">‚ü≥ Validating key and fetching toolkits...</span>';

        var validated = false;
        var toolkitsData = null;

        if (window.__TAURI__) {
            try {
                var curlResult = await tauriInvoke("run_shell_command", { commandName: "curl", args: ["-s", "-H", "x-api-key: " + key, COMPOSIO_API_URL + "/toolkits?limit=500"] });
                try {
                    toolkitsData = JSON.parse(curlResult);
                    if (toolkitsData.items) validated = true;
                    else if (toolkitsData.error || toolkitsData.status === 401) { statusEl.innerHTML = '<span style="color:var(--error);">‚úó Invalid API key</span>'; return; }
                } catch(parseErr) { if ((curlResult || "").indexOf("401") >= 0) { statusEl.innerHTML = '<span style="color:var(--error);">‚úó Invalid API key</span>'; return; } }
            } catch(e) {}
        }

        if (!validated) {
            try {
                var resp = await fetch(COMPOSIO_API_URL + "/toolkits?limit=500", { headers: { "x-api-key": key } });
                if (resp.ok) { toolkitsData = await resp.json(); if (toolkitsData.items) validated = true; }
                else if (resp.status === 401 || resp.status === 403) { statusEl.innerHTML = '<span style="color:var(--error);">‚úó Invalid API key</span>'; return; }
            } catch(e) {}
        }

        if (!validated || !toolkitsData) { statusEl.innerHTML = '<span style="color:var(--warning);">‚ö† Cannot validate from browser (CORS). Key saved for desktop use.</span>'; return; }

        var rawToolkits = toolkitsData.items || [];
        composioToolkits = rawToolkits.map(function(tk) {
            var m = tk.meta || {};
            return {
                slug: tk.slug, name: tk.name || tk.slug, description: m.description || tk.description || "",
                logo: m.logo || tk.logo || "", categories: (m.categories || tk.categories || []).map(function(c) { return (typeof c === "object" && c.name) ? c.name : String(c); }),
                tools_count: m.tools_count || tk.tools_count || 0, triggers_count: m.triggers_count || tk.triggers_count || 0
            };
        });
        
        statusEl.innerHTML = '<span style="color:var(--accent);">‚úì Connected to Composio</span>';
        
        var catSet = {};
        composioToolkits.forEach(function(tk) { (tk.categories || []).forEach(function(c) { catSet[c] = true; }); });
        composioCategories = ["All"].concat(Object.keys(catSet).sort());

        document.getElementById("composio-placeholder")?.classList.add("hidden");
        document.getElementById("composio-connected-area")?.classList.remove("hidden");
        renderAllSkills();
        cacheToolkitLogos();
    }

    // Skills Click Delegations
    document.getElementById("skills-builtin")?.addEventListener("click", function(e) {
        var infoBtn = e.target.closest ? e.target.closest(".skill-info-btn") : null;
        if (!infoBtn && e.target.classList && e.target.classList.contains("skill-info-btn")) infoBtn = e.target;
        if (infoBtn) {
            e.stopPropagation();
            var card = infoBtn.closest ? infoBtn.closest(".skill-card") : infoBtn.parentElement.parentElement;
            if (card) { var descEl = card.querySelector(".skill-desc-full"); if (descEl) descEl.classList.toggle("visible"); }
        }
    });

    document.getElementById("skills-composio")?.addEventListener("click", function(e) {
        var toolRow = e.target.closest ? e.target.closest(".toolkit-tool-row") : null;
        if (toolRow) {
            e.stopPropagation();
            var idx = toolRow.getAttribute("data-tool-idx");
            var tkSlug = toolRow.getAttribute("data-toolkit-slug");
            var paramsEl = document.getElementById("tool-params-" + tkSlug + "-" + idx);
            if (paramsEl) paramsEl.classList.toggle("visible");
            return;
        }

        var infoBtn = e.target.closest ? e.target.closest(".skill-info-btn") : null;
        if (!infoBtn && e.target.classList && e.target.classList.contains("skill-info-btn")) infoBtn = e.target;
        if (infoBtn) {
            e.stopPropagation();
            var card = infoBtn.closest ? infoBtn.closest(".skill-card") : infoBtn.parentElement.parentElement;
            if (card) {
                var descEl = card.querySelector(".skill-desc-full");
                if (descEl) {
                    var wasVisible = descEl.classList.contains("visible");
                    descEl.classList.toggle("visible");
                    if (!wasVisible) { var tkSlug2 = descEl.getAttribute("data-toolkit-slug"); if (tkSlug2) loadToolkitToolsOnDemand(tkSlug2); }
                }
            }
            return;
        }

        var card2 = e.target.closest ? e.target.closest(".skill-card") : null;
        if (!card2) { var el = e.target; while (el && el !== this) { if (el.classList && el.classList.contains("skill-card")) { card2 = el; break; } el = el.parentElement; } }
        if (card2) { var skillId = card2.getAttribute("data-skill-id"); if (skillId) window.toggleSkill(skillId); }
    });

    document.getElementById("composio-category-tabs")?.addEventListener("click", function(e) {
        var btn = e.target.closest ? e.target.closest("[data-composio-cat]") : null;
        if (!btn) { var el = e.target; while (el && el !== this) { if (el.getAttribute && el.getAttribute("data-composio-cat")) { btn = el; break; } el = el.parentElement; } }
        if (btn) { composioActiveCategory = btn.getAttribute("data-composio-cat"); renderAllSkills(); }
    });


    // ==========================================
    // EVENT BINDINGS (SAFE WRAPPERS)
    // ==========================================
    function safeBind(id, event, fn) {
        var el = document.getElementById(id);
        if (el) el.addEventListener(event, fn);
    }

    window.filterHelp = function(query) {
        query = query.toLowerCase();
        document.querySelectorAll(".help-section").forEach(function(sec) {
            var text = sec.textContent.toLowerCase();
            sec.style.display = text.includes(query) ? "block" : "none";
        });
    };

    window.toggleActiveToolsList = function() {
        var list = document.getElementById("active-tools-list");
        if (list) list.classList.toggle("visible");
    };

    safeBind("btn-copy-boot-log", "click", function() { copyLog('boot-log'); });
    safeBind("btn-copy-install-log", "click", function() { copyLog('install-log'); });
    safeBind("btn-copy-cap-log", "click", function() { copyLog('capability-log'); });
    safeBind("btn-copy-log", "click", function() { copyLog('unified-log'); });
    safeBind("btn-copy-payload", "click", function() { copyLog('llm-payload-display'); });
    safeBind("btn-back-step1", "click", function() { wizardGo(0); });
    safeBind("btn-back-step2", "click", function() { wizardGo(1); });
    safeBind("btn-step0-next", "click", function() { wizardGo(1); });
    safeBind("btn-step1-next", "click", function() { wizardGo(2); });
    safeBind("btn-enter-dashboard", "click", function() { window.enterDashboard(); });

    safeBind("btn-apply-llm", "click", applyLLMConfig);
    safeBind("btn-test-llm", "click", testLLMConfig);
    safeBind("btn-save-settings", "click", saveSettings);
    safeBind("btn-reset-settings", "click", resetSettings);

    safeBind("or-model-search", "input", renderORModels);
    safeBind("or-sort-name", "click", function() { window.sortORModels("name"); });
    safeBind("or-sort-input", "click", function() { window.sortORModels("input"); });
    safeBind("or-sort-output", "click", function() { window.sortORModels("output"); });
    safeBind("btn-fetch-models", "click", function() { window.fetchORModels(); });

    safeBind("btn-setup-tg", "click", setupTelegram);
    safeBind("btn-setup-dc", "click", setupDiscord);
    safeBind("btn-setup-wa", "click", setupWhatsApp);
    safeBind("btn-setup-sl", "click", setupSlack);
    safeBind("btn-close-channel", "click", closeChannelSetup);

    safeBind("btn-daemon-toggle", "click", toggleDaemon);
    safeBind("btn-emergency-flush", "click", emergencyFlush);
    safeBind("btn-send-chat", "click", sendAgentMessage);
    var chatInput = document.getElementById("agent-chat-input");
    if (chatInput) { chatInput.addEventListener("keydown", function(e) { if (e.key === "Enter") { sendAgentMessage(e); } }); }

    safeBind("btn-save-composio", "click", saveComposioKey);
    safeBind("btn-toggle-tools-list", "click", window.toggleActiveToolsList);
    
    safeBind("btn-open-composio", "click", function() {
        if (window.__TAURI__) {
            try { var opener = (window.__TAURI__.opener && window.__TAURI__.opener.openUrl) || (window.__TAURI__.shell && window.__TAURI__.shell.open); if (opener) opener("https://app.composio.dev/settings"); } catch(e) {}
        } else window.open("https://app.composio.dev/settings", "_blank");
    });
    
    safeBind("btn-open-log-folder", "click", function() {
        if (window.__TAURI__) {
            try {
                var resolved = LOG_FOLDER.replace("~", detectedOS === "windows" ? "%USERPROFILE%" : "$HOME");
                if (window.__TAURI__.opener) window.__TAURI__.opener.openUrl(resolved);
                else if (window.__TAURI__.shell) window.__TAURI__.shell.open(resolved);
            } catch(e) {}
        }
    });

    var helpSearchEl = document.getElementById("help-search");
    if (helpSearchEl) { helpSearchEl.addEventListener("input", function(e) { window.filterHelp(e.target.value); }); }
    var skillSearchEl = document.getElementById("skill-search");
    if (skillSearchEl) { skillSearchEl.addEventListener("input", function() { renderComposioToolkits(); }); }

    document.querySelectorAll(".tab").forEach(function(tab) {
        tab.addEventListener("click", function() {
            document.querySelectorAll(".tab").forEach(function(t) { t.classList.remove("active"); });
            this.classList.add("active");
            document.querySelectorAll(".tab-panel").forEach(function(p) { p.classList.add("hidden"); });
            document.getElementById(this.getAttribute("data-tab")).classList.remove("hidden");
        });
    });


    // ==========================================
    // AGENT EXECUTION
    // ==========================================
    var agentTools = [
        { type: "function", function: { name: "run_shell", description: "Run a shell command.", parameters: { type: "object", properties: { command: { type: "string" }, args: { type: "array", items: { type: "string" } } }, required: ["command"], additionalProperties: false } } },
        { type: "function", function: { name: "write_file", description: "Write file.", parameters: { type: "object", properties: { path: { type: "string" }, content: { type: "string" } }, required: ["path", "content"], additionalProperties: false } } }
    ];

    async function executeTool(toolName, args) {
        try {
            if (toolName === "run_shell") {
                return await invokeShort("run_shell_command", { commandName: args.command, args: args.args || [] });
            } else if (toolName === "write_file") {
                var psCmd = "Set-Content -Path '" + args.path.replace(/'/g, "''") + "' -Value '" + (args.content || "").replace(/'/g, "''") + "'";
                await invokeShort("run_shell_command", { commandName: "powershell", args: ["-Command", psCmd] });
                return "File written: " + args.path;
            }
            return "Unknown tool";
        } catch(e) { return "Error: " + e; }
    }

    async function callLLM(userMessage) {
        var cfg = currentConfig.llm;
        if (!cfg || !cfg.api_key) throw new Error("No LLM configured.");

        chatHistory.push({ role: "user", content: userMessage });
        
        var systemPrompt = "You are BambooClaw, an AI agent.\n\nCRITICAL RULES:\n1. For Windows commands use 'cmd' with args ['/c', 'command'].\n2. ENCODING RULE: NEVER output raw Unicode characters (like German umlauts √§, √∂, √º, or the Euro symbol ‚Ç¨) inside Python scripts. ALWAYS use standard ASCII equivalents (e.g. 'ae', 'oe', 'ue', 'EUR') to prevent Windows encoding crashes.\n\n";

        if (currentConfig.llm.system_prompt) systemPrompt += "\n--- OPERATOR INSTRUCTIONS ---\n" + currentConfig.llm.system_prompt + "\n";
        if (activePersonaIndex >= 0 && personas[activePersonaIndex]) systemPrompt += "\n--- ACTIVE PERSONA ---\n" + personas[activePersonaIndex].prompt + "\n";

        var apiUrl = "";
        var headers = { "Content-Type": "application/json" };
        
        if (cfg.provider === "openrouter") {
            apiUrl = "https://openrouter.ai/api/v1/chat/completions";
            headers["Authorization"] = "Bearer " + cfg.api_key;
        } else if (cfg.provider === "inception") {
            apiUrl = "https://api.inceptionlabs.ai/v1/chat/completions";
            headers["Authorization"] = "Bearer " + cfg.api_key;
        }

        var messages = [{ role: "system", content: systemPrompt }].concat(chatHistory);

        for (var i = 0; i < (currentConfig.settings.maxToolIterations || 10); i++) {
            var reqBody = { model: cfg.model, messages: messages, max_tokens: 4096, tools: agentTools, tool_choice: "auto" };
            
            var resp = await fetch(apiUrl, { method: "POST", headers: headers, body: JSON.stringify(reqBody) });
            if (!resp.ok) {
                chatHistory.pop();
                if (resp.status === 401) throw new Error("HTTP 401: Invalid API Key. Ensure you entered a valid " + cfg.provider + " key.");
                throw new Error("API error HTTP " + resp.status);
            }
            var data = await resp.json();
            var assistantMsg = data.choices[0].message;
            messages.push(assistantMsg);

            if (assistantMsg.tool_calls && assistantMsg.tool_calls.length > 0) {
                for (var t = 0; t < assistantMsg.tool_calls.length; t++) {
                    var tc = assistantMsg.tool_calls[t];
                    var toolArgs = JSON.parse(tc.function.arguments || "{}");
                    var result = await executeTool(tc.function.name, toolArgs);
                    messages.push({ role: "tool", tool_call_id: tc.id, content: result });
                }
                continue;
            }
            chatHistory.push({ role: "assistant", content: assistantMsg.content });
            return assistantMsg.content;
        }
        return "Max iterations reached.";
    }

    // ==========================================
    // BOOT SEQUENCE
    // ==========================================
    window.enterDashboard = async function() {
        try {
            appendLog("dash-log", "[DASH] enterDashboard() called");
            document.getElementById("wizard-view").style.display = "none";
            document.getElementById("dashboard-view").style.display = "block";
            document.getElementById("dashboard-view").classList.remove("hidden");
            await loadConfig();
            localStorage.setItem("bambooclaw-installed", "true");
        } catch(e) {
            appendLog("dash-log", "[ERROR] enterDashboard failed: " + (e.message || e));
        }
    };

    async function fetchVersion() {
        try {
            var resp = await fetch(PROXY_URL + "?action=latest");
            if (!resp.ok) throw new Error("HTTP " + resp.status);
            var data = await resp.json();
            var ver = data.tag_name || "v-unknown";
            var el = document.getElementById("app-version"); if (el) el.textContent = ver;
            var aboutVer = document.getElementById("about-version"); if (aboutVer) aboutVer.textContent = ver;
        } catch(e) {}
    }

    async function boot() {
        try {
            var installedFlag = localStorage.getItem("bambooclaw-installed");
            fetchVersion();
            
            if (installedFlag === "true") {
                await window.enterDashboard();
                testImageConnectivity();
                
                if (!currentConfig.settings) {
                    currentConfig.settings = { autonomy: "autonomous", port: "7331", tunnel: "none", identity: "-1", runtime: "native", loglevel: "info", maxToolIterations: 10 };
                    saveAllConfig();
                }
                
                if (currentConfig.settings && currentConfig.settings.maxToolIterations) {
                    MAX_TOOL_ITERATIONS = currentConfig.settings.maxToolIterations;
                    var slider = document.getElementById("set-tool-iterations");
                    var label = document.getElementById("tool-iter-value");
                    if (slider) slider.value = MAX_TOOL_ITERATIONS;
                    if (label) label.textContent = MAX_TOOL_ITERATIONS;
                }
                
                if (currentConfig.enabledSkills) {
                    enabledSkills = currentConfig.enabledSkills;
                    renderBuiltinSkills();
                    rebuildBuiltinTools();
                }
                
                if (currentConfig.composioApiKey) {
                    var ckEl = document.getElementById("composio-api-key");
                    if (ckEl) ckEl.value = currentConfig.composioApiKey;
                    setTimeout(function() { saveComposioKey(); }, 1000);
                }
                
                setTimeout(function() { renderActiveToolsSummary(); renderEnabledIntegrations(); }, 2000);
                setTimeout(function() { if (currentConfig.llm && currentConfig.llm.api_key && !daemonRunning) window.toggleDaemon(); }, 500);
                
            } else {
                runSystemChecks();
            }
        } catch(e) {
            appendLog("dash-log", "[BOOT] Error: " + (e.message || e));
        }
    }

    (function waitForTauri() {
        try {
            var waited = 0;
            var interval = setInterval(function() {
                waited += 50;
                // Safely wait for the Tauri bridge to inject before booting
                if (window.__TAURI__) { 
                    clearInterval(interval); 
                    boot(); 
                } else if (waited >= 3000) { 
                    clearInterval(interval); 
                    boot(); 
                }
            }, 50);
        } catch(e) {}
    })();

    </script>
</body>
</html>